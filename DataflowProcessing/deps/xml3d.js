var XML3D=XML3D||{};XML3D.version="DEVELOPMENT SNAPSHOT (26.11.2013 16:17:40 EET)";XML3D.xml3dNS="http://www.xml3d.org/2009/xml3d";XML3D.xhtmlNS="http://www.w3.org/1999/xhtml";XML3D.webglNS="http://www.xml3d.org/2009/xml3d/webgl";XML3D._xml3d=document.createElementNS(XML3D.xml3dNS,"xml3d");XML3D._native=!!XML3D._xml3d.style;XML3D._parallel=void 0!=XML3D._parallel?XML3D._parallel:!1;XML3D.createElement=function(c){return document.createElementNS(XML3D.xml3dNS,c)};
XML3D.extend=function(c,b){for(var a in b){var f=b.__lookupGetter__(a),d=b.__lookupSetter__(a);if(f||d)f&&c.__defineGetter__(a,f),d&&c.__defineSetter__(a,d);else if(void 0===b[a])delete c[a];else if("constructor"!==a||c!==window)c[a]=b[a]}return c};XML3D.isSuperclassOf=function(c,b){for(;b&&b.superclass;){if(b.superclass===c.prototype)return!0;b=b.superclass.constructor}return!1};
XML3D.createClass=function(c,b,a){a=a||{};if(b){var f=function(){};f.prototype=b.prototype;c.prototype=new f;c.prototype.constructor=c;c.superclass=b.prototype}c.isSuperclassOf=XML3D.isSuperclassOf.bind(c,c);for(var d in a)c.prototype[d]=a[d];return c};
(function(){function c(b){if(!(XML3D._native||-1<a.indexOf(b))){a.push(b);var d=XML3D.debug.setup();if(!XML3D.webgl||!XML3D.webgl.supported()){d&&XML3D.debug.logWarning("Could not initialise WebGL, sorry :-(");d=document.createElementNS(XML3D.xhtmlNS,"div");b.parentNode.insertBefore(d,b);d.appendChild(b);d.style.display="none";var e=document.createElementNS(XML3D.xhtmlNS,"div");e.setAttribute("class",b.getAttribute("class"));e.setAttribute("style",b.getAttribute("style"));e.style.border="2px solid red";
e.style.color="red";e.style.padding="10px";e.style.backgroundColor="rgba(255, 0, 0, 0.3)";var g=b.getAttribute("width");null!==g&&(e.style.width=g);g=b.getAttribute("height");null!==g&&(e.style.height=g);var g=document.createElement("h3"),c=document.createTextNode("Your browser doesn't appear to support XML3D.");g.appendChild(c);c=document.createElement("p");c.appendChild(document.createTextNode("Please visit "));var i=document.createElement("a");i.setAttribute("href","http://www.xml3d.org");i.appendChild(document.createTextNode("http://www.xml3d.org"));
c.appendChild(i);c.appendChild(document.createTextNode(" to get information about browsers supporting XML3D."));e.appendChild(g);e.appendChild(c);d.parentNode.insertBefore(e,d)}else{try{XML3D.config.configure(b)}catch(j){d&&XML3D.debug.logException(j);a.splice(a.indexOf(b),1);return}try{XML3D.webgl.configure(b)}catch(k){d&&XML3D.debug.logException(k);a.splice(a.indexOf(b),1);return}XML3D.base.sendAdapterEvent(b,{onConfigured:[]})}a.splice(a.indexOf(b),1)}}function b(){if(XML3D.document)XML3D.document.onunload()}
var a=[];document.addEventListener("DOMContentLoaded",function(){XML3D.css.init();var a=XML3D.debug.setup();a&&XML3D.debug.logInfo("xml3d.js version: "+XML3D.version);var b=document.querySelectorAll("xml3d");a&&XML3D.debug.logInfo("Found "+b.length+" xml3d nodes...");if(b.length&&XML3D._native)a&&XML3D.debug.logInfo("Using native implementation.");else{XML3D.xhtml=null!=document.xmlEncoding;for(a=0;a<b.length;a++)c(b[a])}},!1);window.addEventListener("unload",b,!1);window.addEventListener("reload",
b,!1);document.addEventListener("DOMNodeInserted",function(a){"xml3d"===a.target.tagName&&c(a.target)},!1);document.addEventListener("DOMNodeRemoved",function(b){if("xml3d"===b.target.tagName&&(b=b.target,!(-1<a.indexOf(b))&&(b._configured=void 0,b.parentNode))){var d=b.parentNode.previousElementSibling,e=b.parentNode.parentNode;e&&d&&"canvas"===d.tagName&&(e.removeChild(b.parentNode),e.removeChild(d))}},!1)})();(function(c){function b(a){var b;if(!isNaN(parseFloat(a))&&isFinite(a)){for(b in u)if(u[b]===a)return b;XML3D.debug.logDebug("Got unknown OpenCL Error Code:",a)}return"UNKNOWN_ERROR"}function a(a){var b=null;return a.name&&"string"===typeof a.name&&u[a.name]?u[a.name]:a.message&&"string"===typeof a.message&&(b=a.message.match(/-?\d+/g),b instanceof Array)?parseInt(b[b.length-1],10):!1}function f(a,b){a&&"string"!==typeof a&&(XML3D.debug.logDebug("WebCL API: WebCLError: Error name not type of String"),
a="");b&&"string"!==typeof b&&(XML3D.debug.logDebug("WebCL API: WebCLError: Error message not type of String"),b="");this.name=a||"WebCLError";this.message=b||"Generic WebCL error.";this.stack=Error().stack}function d(){return q=window.WebCL&&WebCL.getPlatforms}function e(){var a;n=!0;try{a=WebCL.getPlatforms()}catch(b){n=!1}if(!a||0===a.length)n=!1;return n}function g(e,d){var m=[];if(!d)return XML3D.debug.logError("WebCL API: getPlatformDevicesByType(): platform was not defined."),!1;e=e||o;try{"CPU"===
e?m=d.getDevices(WebCL.DEVICE_TYPE_CPU):"GPU"===e?m=d.getDevices(WebCL.DEVICE_TYPE_GPU):"ALL"===e&&(m=d.getDevices(WebCL.DEVICE_TYPE_ALL))}catch(g){if(m=a(g)){if(m!==u.DEVICE_NOT_FOUND)throw new f(b(m),"Could not get devices.");}else throw g;return!1}return m}function h(a){var b=[],f,e;for(e=m.length;e--;)(f=g(a,m[e]))&&f.forEach(function(a){b.push(a)});return b}function i(e){var d={devices:h(o)};XML3D.extend(d,e);try{p=WebCL.createContext(d)}catch(m){e=a(m);if(!e)throw m;throw new f(b(e),"Failed to create a WebCL context.");
}return p}function j(e){var d;if(!e)return XML3D.debug.logError("WebCL API: createProgram(): codeStr was not defined."),!1;try{d=p.createProgram(e)}catch(m){e=a(m);if(!e)throw m;throw new f(b(e),"Failed to create a WebCL program.");}return d}function k(e,d){d=d||r;if(!e)return XML3D.debug.logError("WebCL API: buildProgram(): program was not defined."),!1;try{e.build(d,"")}catch(m){var g=a(m);if(!g)throw m;throw new f(b(g),e.getBuildInfo(d[0],WebCL.CL_PROGRAM_BUILD_LOG));}return e}function l(e,d){var m;
if(!e)return XML3D.debug.logError("WebCL API: createKernel(): program was not defined."),!1;if(!d)return XML3D.debug.logError("WebCL API: createKernel(): name was not defined."),!1;try{m=e.createKernel(d)}catch(g){m=a(g);if(!m)throw g;throw new f(b(m),"Failed to create a WebCL kernel.");}return m}var m=[],r=[],p=null,q=!1,n=!1,o="CPU",u={SUCCESS:0,DEVICE_NOT_FOUND:-1,DEVICE_NOT_AVAILABLE:-2,COMPILER_NOT_AVAILABLE:-3,MEM_OBJECT_ALLOCATION_FAILURE:-4,OUT_OF_RESOURCES:-5,OUT_OF_HOST_MEMORY:-6,PROFILING_INFO_NOT_AVAILABLE:-7,
MEM_COPY_OVERLAP:-8,IMAGE_FORMAT_MISMATCH:-9,IMAGE_FORMAT_NOT_SUPPORTED:-10,BUILD_PROGRAM_FAILURE:-11,MAP_FAILURE:-12,INVALID_VALUE:-30,INVALID_DEVICE_TYPE:-31,INVALID_PLATFORM:-32,INVALID_DEVICE:-33,INVALID_CONTEXT:-34,INVALID_QUEUE_PROPERTIES:-35,INVALID_COMMAND_QUEUE:-36,INVALID_HOST_PTR:-37,INVALID_MEM_OBJECT:-38,INVALID_IMAGE_FORMAT_DESCRIPTOR:-39,INVALID_IMAGE_SIZE:-40,INVALID_SAMPLER:-41,INVALID_BINARY:-42,INVALID_BUILD_OPTIONS:-43,INVALID_PROGRAM:-44,INVALID_PROGRAM_EXECUTABLE:-45,INVALID_KERNEL_NAME:-46,
INVALID_KERNEL_DEFINITION:-47,INVALID_KERNEL:-48,INVALID_ARG_INDEX:-49,INVALID_ARG_VALUE:-50,INVALID_ARG_SIZE:-51,INVALID_KERNEL_ARGS:-52,INVALID_WORK_DIMENSION:-53,INVALID_WORK_GROUP_SIZE:-54,INVALID_WORK_ITEM_SIZE:-55,INVALID_GLOBAL_OFFSET:-56,INVALID_EVENT_WAIT_LIST:-57,INVALID_EVENT:-58,INVALID_OPERATION:-59,INVALID_GL_OBJECT:-60,INVALID_BUFFER_SIZE:-61,INVALID_MIP_LEVEL:-62,INVALID_GLOBAL_WORK_SIZE:-63};Object.freeze(u);f.prototype=Object.create(Error.prototype);f.prototype.constructor=f;c.webcl=
{init:function(a){if(!d())return XML3D.debug.logWarning("WebCL API: Unfortunately your system does not support WebCL. WebCL namespace is not available."),!1;if(!e())return XML3D.debug.logWarning("WebCL API: Unfortunately your system does not support WebCL. OpenCL drivers are not working properly."),!1;m=WebCL.getPlatforms();r=h(a||o);i({devices:r});return!0},createContext:i,createProgram:j,buildProgram:k,createKernel:l,createCommandQueue:function(e){var d;try{d=p.createCommandQueue(e||r[0])}catch(m){if(!a(m))throw m;
throw new f(b(a(m)),"Could not create CommandQueue.");}return d},createBuffer:function(e,d){if(e){if(isNaN(parseFloat(e))||!isFinite(e)||0>e)return XML3D.debug.logError("WebCL API: createBuffer(): Buffer size must be a positive number."),!1}else return XML3D.debug.logError("WebCL API: createBuffer(): Buffer size was not defined."),!1;if(!d)return XML3D.debug.logError("WebCL API: createBuffer(): Buffer type was not defined."),!1;try{if("r"===d)return p.createBuffer(WebCL.CL_MEM_READ_ONLY,e);if("w"===
d)return p.createBuffer(WebCL.CL_MEM_WRITE_ONLY,e);if("rw"===d)return p.createBuffer(WebCL.CL_MEM_READ_WRITE,e);XML3D.debug.logError("WebCL API: createBuffer(): Unknown buffer type:",d);return!1}catch(m){var g=a(m);if(!g)throw m;throw new f(b(g),"Could not create a WebCL buffer.");}},getContext:function(){return p},getPlatforms:function(){return m},getDevicesByType:h,getDevicePlatform:function(e){var d;if(!e)return XML3D.debug.logError("WebCL API: getDevicePlatform(): device was not defined."),!1;
try{d=e.getInfo(WebCL.DEVICE_PLATFORM)}catch(m){e=a(m);if(!e)throw m;throw new f(b(e),"Could not get the platform of the device.");}return d},kernels:new function(){var e={};return{register:function(a,b){if(e.hasOwnProperty(a))return XML3D.debug.logWarning("WebCL API: kernels.register(): Kernel with a same name is already defined."),!1;if("string"!==typeof a)return XML3D.debug.logError("WebCL API: kernels.register(): Kernel name was not defined or was not type of String."),!1;if("string"!==typeof b)return XML3D.debug.logError("WebCL API: kernels.register(): Kernel code was not defined or was not type of String."),
!1;var f,d;f=j(b);k(f);f&&(d=l(f,a));return d?(e[a]=d,!0):!1},unRegister:function(d){if(e.hasOwnProperty(d)){try{e[d].release()}catch(m){d=a(m);if(!d)throw m;throw new f(b(d),"Could not release kernel resources.");}delete e[d];return!0}return!1},getKernel:function(a){return"string"!==typeof a?!1:e.hasOwnProperty(a)?e[a]:!1},setArgs:function(){var e=Array.prototype.slice.call(arguments),d,m;if(2>e.length)return XML3D.debug.logWarning("WebCL API: setArgs(): No kernel arguments were defined."),!1;d=
e[0];e=e.slice(1);if(!d)return XML3D.debug.logWarning("WebCL API: setArgs(): WebCL kernel was not defined."),!1;m=d.getInfo(WebCL.CL_KERNEL_NUM_ARGS);if(e.length>m)XML3D.debug.logWarning("WebCL: setArgs: Input args amount > kernel program args amount! Ignoring extra arguments.");else if(e.length<m)return XML3D.debug.logError("WebCL: setArgs: Not enough arguments were given to WebCL kernel."),!1;XML3D.debug.logDebug("Args for kernel:",d.getInfo(WebCL.KERNEL_FUNCTION_NAME));try{for(;m--;)XML3D.debug.logDebug("Arg:",
m,e[m]),d.setArg(m,e[m])}catch(g){d=a(g);if(!d)throw g;throw new f(b(d),"Could not set kernel arguments.");}return!0}}},hasWebCLNamespace:d,hasOpenCLDrivers:e,isAvailable:function(){return d()&&e()},WebCLError:f,getCLErrorName:b}})(XML3D=XML3D||{});
XML3D.setParameter=function(c,b,a){if(c=document.getElementById(c))for(var c=c.childNodes,f=0;f<c.length;f++){var d=c[f];if(d.nodeType===Node.ELEMENT_NODE&&d.name==b&&"string"===typeof a){for(;d.hasChildNodes();)d.removeChild(d.lastChild);d.appendChild(document.createTextNode(a));return!0}}return!1};
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c,b){window.setTimeout(c,1E3/b)}}();
(function(){XML3D.util||(XML3D.util={});var c=XML3D.util;c.dispatchEvent=function(a,b){var d=null;if(document.createEvent){d=document.createEvent("Events");d.initEvent(b,true,true);a.dispatchEvent(d)}else if(document.createEventObject){d=document.createEventObject();a.fireEvent("on"+b,d)}};c.dispatchCustomEvent=function(a,b,d,e,g){var c=document.createEvent("CustomEvent");c.initCustomEvent(b,d,e,g);a.dispatchEvent(c)};c.getStyle=function(a,b){var d="";if(document.defaultView&&document.defaultView.getComputedStyle)d=
document.defaultView.getComputedStyle(a,"").getPropertyValue(b);else if(a.currentStyle){b=b.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()});d=a.currentStyle[b]}return d};c.evaluateXPathExpr=function(a,b){return document.evaluate(b,a,function(){return XML3D.xml3dNS},XPathResult.FIRST_ORDERED_NODE_TYPE,null)};var b=0;c.getOrCreateActiveView=function(a){var f=a.activeView;if(f){var d=XML3D.URIResolver.resolveLocal(f);if(!d)throw"XML3D Error: xml3d references view that is not defined: '"+f+"'.";
return d}if(d=XML3D.xhtml?XML3D.util.evaluateXPathExpr(a,".//xml3d:view[1]").singleNodeValue:a.getElementsByTagName("view")[0]){if(d.id&&d.id.length>0)a.activeView="#"+d.id;return d}XML3D.debug.logWarning("xml3d element has no view defined: creating one.");f="xml3d.autocreatedview_"+b++;d=XML3D.createElement("view");d.setAttribute("id",f);a.appendChild(d);a.setAttribute("activeView","#"+f);return d}})();
Array.forEach||(Array.forEach=function(c,b,a){for(var f=c.length,d=0;d<f;d++)d in c&&b.call(a,c[d],d,c)});Array.map||(Array.map=function(c,b,a){for(var f=c.length,d=[],e=0;e<f;e++)e in c&&(d[e]=b.call(a,c[e],e,c));return d});Array.filter||(Array.filter=function(c,b,a){for(var f=c.length,d=[],e=0;e<f;e++)if(e in c){var g=c[e];b.call(a,g,e,c)&&d.push(g)}return d});Array.erase||(Array.erase=function(c,b){for(var a=false,f=-1;(f=c.indexOf(b))!=-1;){c.splice(f,1);a=true}return a});
Array.set||(Array.set=function(c,b,a){for(var f=0;f<a.length;f++)c[b+f]=a[f]});Array.isArray||(Array.isArray=function(c){return Object.prototype.toString.call(c)=="[object Array]"});
XML3D.debug={ALL:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4,EXCEPTION:5,params:{},isSetup:!1,loglevel:4,loglevels:{all:0,debug:1,info:2,warning:3,error:4,exception:5},setup:function(){var c=XML3D.debug;if(!c.isSetup){window.location.search.substr(1).split("&").forEach(function(b){b=b.split("=");c.params[b[0].toLowerCase()]=decodeURIComponent(b[1])});c.loglevel=c.loglevels[c.params.xml3d_loglevel]||c.params.xml3d_loglevel||c.loglevels.error;XML3D.debug.isSetup=true}return!XML3D.debug.params.xml3d_nolog},doLog:function(c,
b){if(!(XML3D.debug.params.xml3d_nolog||c<XML3D.debug.loglevel)){b=Array.prototype.slice.call(b);if(window.console)switch(c){case XML3D.debug.INFO:window.console.info.apply(window.console,b);break;case XML3D.debug.WARNING:window.console.warn.apply(window.console,b);break;case XML3D.debug.ERROR:window.console.error.apply(window.console,b);break;case XML3D.debug.EXCEPTION:window.console.error(XML3D.debug.printStackTrace({e:b[0],guess:true}).join("\n"));break;case XML3D.debug.DEBUG:window.console.debug.apply(window.console,
b)}}},logDebug:function(){XML3D.debug.doLog(XML3D.debug.DEBUG,arguments)},logInfo:function(){XML3D.debug.doLog(XML3D.debug.INFO,arguments)},logWarning:function(){XML3D.debug.doLog(XML3D.debug.WARNING,arguments)},logError:function(){XML3D.debug.doLog(XML3D.debug.ERROR,arguments)},logException:function(){XML3D.debug.doLog(XML3D.debug.EXCEPTION,arguments)},assert:function(c,b){c||XML3D.debug.doLog(XML3D.debug.WARNING,["Assertion failed in "+XML3D.debug.assert.caller.name,b])},trace:function(c,b){b=b!==
void 0?b:XML3D.debug.ERROR;if(window.console.trace){c&&XML3D.debug.doLog(b,[c]);window.console.trace()}else{var a=XML3D.debug.printStackTrace();c&&a.splice(0,0,c);XML3D.debug.doLog(b,a)}},getNumberWithPadding:function(c,b){for(var a=""+c;a.length<b;)a=" "+a;return a},formatSourceCode:function(c){for(var b="",c=c.split("\n"),a=0;a<c.length;++a)b=b+(this.getNumberWithPadding(a+1,3)+"  "+c[a]+"\n");return b}};
XML3D.URI=function(c){c=c||"";if(c.indexOf("blob:")==0){var b=/^(?:([^:\/?\#]+):)?([^\#]*)(?:\#(.*))?/,c=c.match(b);this.valid=c!=null;this.scheme=c[1]||null;this.query=this.path=this.authority=null;this.opaqueString=c[2]||null;this.fragment=c[3]||null}else{b=/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/;c=c.match(b);this.valid=c!=null;this.scheme=c[1]||null;this.authority=c[2]||null;this.path=c[3]||null;this.query=c[4]||null;this.opaqueString=null;this.fragment=c[5]||
null}};XML3D.URI.prototype.isLocal=function(){return this.scheme!="blob"&&!this.authority&&!this.path};XML3D.URI.prototype.isAbsolute=function(){return this.scheme!=null};XML3D.URI.prototype.getAbsoluteURI=function(c){if(!this.valid||this.isAbsolute())return this;c=new XML3D.URI(c);if(this.path){c.path=this.path.indexOf("/")==0?this.path:c.path.substr(0,c.path.lastIndexOf("/")+1)+this.path;c.query=this.query}else if(this.query)c.query=this.query;c.fragment=this.fragment;return c};
XML3D.URI.prototype.toString=function(){var c="";if(this.scheme=="blob"){c="blob:"+this.opaqueString;this.fragment&&(c=c+("#"+this.fragment));return c}this.scheme&&(c=c+(this.scheme+":"));this.authority&&(c=c+("//"+this.authority));this.path&&(c=c+this.path);this.query&&(c=c+("?"+this.query));this.fragment&&(c=c+("#"+this.fragment));return c};
XML3D.URI.prototype.toStringWithoutFragment=function(){var c="";if(this.scheme=="blob")return c="blob:"+this.opaqueString;this.scheme&&(c=c+(this.scheme+":"));this.authority&&(c=c+("//"+this.authority));this.path&&(c=c+this.path);this.query&&(c=c+("?"+this.query));return c};XML3D.URIResolver=function(){};
XML3D.URIResolver.resolveLocal=function(c,b){typeof c=="string"&&(c=new XML3D.URI(c));b=b||window.document;return c.scheme=="urn"||c.scheme=="blob"?null:!c.path&&c.fragment?b.getElementById(c.fragment):null};XML3D.URIResolver.resolve=function(c,b){XML3D.debug.logWarning("You are using deprecated XML3D.URIResolver.resolve. Use XML3D.URIResolver.resolveLocal instead.");return XML3D.URIResolver.resolveLocal(c,b)};
(function(){XML3D.css={};XML3D.css.TRANSFORM_PROPERTY=null;XML3D.css.init=function(){"transform"in document.body.style?XML3D.css.TRANSFORM_PROPERTY="transform":"WebkitTransform"in document.body.style?XML3D.css.TRANSFORM_PROPERTY="-webkit-transform":"MozTransform"in document.body.style?XML3D.css.TRANSFORM_PROPERTY="-moz-transform":XML3D.debug.logWarning("No supported transform css property found")};XML3D.css.getInlinePropertyValue=function(c,b){var a=c.getAttribute("style");if(a)if(a=RegExp(b+"s*:([^;]+)",
"i").exec(a))return a[1].trim();return null};XML3D.css.getPropertyValue=function(c,b){var a=this.getInlinePropertyValue(c,b);return a?a:window.getComputedStyle(c).getPropertyValue(b)};XML3D.css.getCSSMatrix=function(c){if(!XML3D.css.TRANSFORM_PROPERTY||!XML3D.css.CSSMatrix)return null;var b=null;XML3D.css.TRANSFORM_PROPERTY!="transform"&&(b=XML3D.css.getInlinePropertyValue(c,"transform"));b||(b=XML3D.css.getPropertyValue(c,XML3D.css.TRANSFORM_PROPERTY));if(!b||b=="none")return null;c=null;try{c=new XML3D.css.CSSMatrix(b)}catch(a){XML3D.debug.logError("Error parsing transform property: "+
b)}return c}})();var FirminCSSMatrix=function(c){this.m11=this.m22=this.m33=this.m44=1;this.m12=this.m13=this.m14=this.m21=this.m23=this.m24=this.m31=this.m32=this.m34=this.m41=this.m42=this.m43=0;typeof c=="string"&&this.setMatrixValue(c)};FirminCSSMatrix.displayName="FirminCSSMatrix";FirminCSSMatrix.degreesToRadians=function(c){return c*Math.PI/180};FirminCSSMatrix.determinant2x2=function(c,b,a,f){return c*f-b*a};
FirminCSSMatrix.determinant3x3=function(c,b,a,f,d,e,g,h,i){var j=FirminCSSMatrix.determinant2x2;return c*j(d,e,h,i)-f*j(b,a,h,i)+g*j(b,a,d,e)};FirminCSSMatrix.determinant4x4=function(c){var b=FirminCSSMatrix.determinant3x3,a=c.m21,f=c.m31,d=c.m41,e=c.m12,g=c.m22,h=c.m32,i=c.m42,j=c.m13,k=c.m23,l=c.m33,m=c.m43,r=c.m14,p=c.m24,q=c.m34,n=c.m44;return c.m11*b(g,k,p,h,l,q,i,m,n)-a*b(e,j,r,h,l,q,i,m,n)+f*b(e,j,r,g,k,p,i,m,n)-d*b(e,j,r,g,k,p,h,l,q)};
FirminCSSMatrix.toMatrixString=function(c){var b=/(\w+)\(([^\)]+)\)/i,a=c.match(/(\w+)\([^\)]+\)/ig),f=a&&a.every(function(a){return/^matrix/.test(a)});if(!a||f)return c;var d=function(a){return a.value},e={matrix:function(a,b){var e=new FirminCSSMatrix(b.unparsed);return a.multiply(e)},matrix3d:function(a,b){var e=new FirminCSSMatrix(b.unparsed);return a.multiply(e)},perspective:function(a,b){var e=new FirminCSSMatrix;e.m34=e.m34-1/b.value[0].value;return a.multiply(e)},rotate:function(a,b){return a.rotate.apply(a,
b.value.map(d))},rotate3d:function(a,b){return a.rotateAxisAngle.apply(a,b.value.map(d))},rotateX:function(a,b){return a.rotate.apply(a,[b.value[0].value,0,0])},rotateY:function(a,b){return a.rotate.apply(a,[0,b.value[0].value,0])},rotateZ:function(a,b){return a.rotate.apply(a,[0,0,b.value[0].value])},scale:function(a,b){return a.scale.apply(a,b.value.map(d))},scale3d:function(a,b){return a.scale.apply(a,b.value.map(d))},scaleX:function(a,b){return a.scale.apply(a,b.value.map(d))},scaleY:function(a,
b){return a.scale.apply(a,[0,b.value[0].value,0])},scaleZ:function(a,b){return a.scale.apply(a,[0,0,b.value[0].value])},skew:function(a,b){var e=new FirminCSSMatrix("skewX("+b.value[0].unparsed+")"),e="matrix(1.00000, "+(new FirminCSSMatrix("skewY("+b.value[1].unparsed+")")).b+", "+e.c+", 1.000000, 0.000000, 0.000000)",e=new FirminCSSMatrix(e);return a.multiply(e)},skewX:function(a,b){return a.skewX.apply(a,[b.value[0].value])},skewY:function(a,b){return a.skewY.apply(a,[b.value[0].value])},translate:function(a,
b){return a.translate.apply(a,b.value.map(d))},translate3d:function(a,b){return a.translate.apply(a,b.value.map(d))},translateX:function(a,b){return a.translate.apply(a,[b.value[0].value,0,0])},translateY:function(a,b){return a.translate.apply(a,[0,b.value[0].value,0])},translateZ:function(a,b){return a.translate.apply(a,[0,0,b.value[0].value])}},c=a.map(function(a){var e=a.match(b).slice(1);return{key:e[0],value:e[1].split(/, ?/).map(function(a){var b=a.match(/([-\+]?[0-9]+[\.0-9]*)(deg|rad|grad|px|%)*/)||
[];return{value:parseFloat(b[1]),units:b[2],unparsed:a}}),unparsed:a}}),a=new FirminCSSMatrix;return c.reduce(function(a,b){b.value=b.value.map(function(a){if(a.units=="rad"){a.value=a.value*(180/Math.PI);a.units="deg"}else if(a.units=="grad"){a.value=a.value/(400/360);a.units="deg"}return a});return(0,e[b.key])(a,b)||a},a).toString()};
[["m11","a"],["m12","b"],["m21","c"],["m22","d"],["m41","e"],["m42","f"]].forEach(function(c){var b=c[0];Object.defineProperty(FirminCSSMatrix.prototype,c[1],{set:function(a){this[b]=a},get:function(){return this[b]},enumerable:true,configurable:true})});FirminCSSMatrix.prototype.isAffine=function(){return this.m13===0&&this.m14===0&&this.m23===0&&this.m24===0&&this.m31===0&&this.m32===0&&this.m33===1&&this.m34===0&&this.m43===0&&this.m44===1};
FirminCSSMatrix.prototype.multiply=function(c){if(!c)return null;var b=new FirminCSSMatrix;b.m11=c.m11*this.m11+c.m12*this.m21+c.m13*this.m31+c.m14*this.m41;b.m12=c.m11*this.m12+c.m12*this.m22+c.m13*this.m32+c.m14*this.m42;b.m13=c.m11*this.m13+c.m12*this.m23+c.m13*this.m33+c.m14*this.m43;b.m14=c.m11*this.m14+c.m12*this.m24+c.m13*this.m34+c.m14*this.m44;b.m21=c.m21*this.m11+c.m22*this.m21+c.m23*this.m31+c.m24*this.m41;b.m22=c.m21*this.m12+c.m22*this.m22+c.m23*this.m32+c.m24*this.m42;b.m23=c.m21*this.m13+
c.m22*this.m23+c.m23*this.m33+c.m24*this.m43;b.m24=c.m21*this.m14+c.m22*this.m24+c.m23*this.m34+c.m24*this.m44;b.m31=c.m31*this.m11+c.m32*this.m21+c.m33*this.m31+c.m34*this.m41;b.m32=c.m31*this.m12+c.m32*this.m22+c.m33*this.m32+c.m34*this.m42;b.m33=c.m31*this.m13+c.m32*this.m23+c.m33*this.m33+c.m34*this.m43;b.m34=c.m31*this.m14+c.m32*this.m24+c.m33*this.m34+c.m34*this.m44;b.m41=c.m41*this.m11+c.m42*this.m21+c.m43*this.m31+c.m44*this.m41;b.m42=c.m41*this.m12+c.m42*this.m22+c.m43*this.m32+c.m44*this.m42;
b.m43=c.m41*this.m13+c.m42*this.m23+c.m43*this.m33+c.m44*this.m43;b.m44=c.m41*this.m14+c.m42*this.m24+c.m43*this.m34+c.m44*this.m44;return b};FirminCSSMatrix.prototype.isIdentityOrTranslation=function(){return this.m11===1&&this.m12===0&&this.m13===0&&this.m14===0&&this.m21===0&&this.m22===1&&this.m23===0&&this.m24===0&&this.m31===0&&this.m31===0&&this.m33===1&&this.m34===0&&this.m44===1};
FirminCSSMatrix.prototype.adjoint=function(){var c=new FirminCSSMatrix,b=FirminCSSMatrix.determinant3x3,a=this.m11,f=this.m12,d=this.m13,e=this.m14,g=this.m21,h=this.m22,i=this.m23,j=this.m24,k=this.m31,l=this.m32,m=this.m33,r=this.m34,p=this.m41,q=this.m42,n=this.m43,o=this.m44;c.m11=b(h,l,q,i,m,n,j,r,o);c.m21=-b(g,k,p,i,m,n,j,r,o);c.m31=b(g,k,p,h,l,q,j,r,o);c.m41=-b(g,k,p,h,l,q,i,m,n);c.m12=-b(f,l,q,d,m,n,e,r,o);c.m22=b(a,k,p,d,m,n,e,r,o);c.m32=-b(a,k,p,f,l,q,e,r,o);c.m42=b(a,k,p,f,l,q,d,m,n);c.m13=
b(f,h,q,d,i,n,e,j,o);c.m23=-b(a,g,p,d,i,n,e,j,o);c.m33=b(a,g,p,f,h,q,e,j,o);c.m43=-b(a,g,p,f,h,q,d,i,n);c.m14=-b(f,h,l,d,i,m,e,j,r);c.m24=b(a,g,k,d,i,m,e,j,r);c.m34=-b(a,g,k,f,h,l,e,j,r);c.m44=b(a,g,k,f,h,l,d,i,m);return c};
FirminCSSMatrix.prototype.inverse=function(){var c,b,a,f;if(this.isIdentityOrTranslation()){c=new FirminCSSMatrix;if(!(this.m41===0&&this.m42===0&&this.m43===0)){c.m41=-this.m41;c.m42=-this.m42;c.m43=-this.m43}return c}b=this.adjoint();c=FirminCSSMatrix.determinant4x4(this);if(Math.abs(c)<1.0E-8)return null;for(a=1;a<5;a++)for(f=1;f<5;f++)b["m"+a+f]=b["m"+a+f]/c;return b};
FirminCSSMatrix.prototype.rotate=function(c,b,a){var f=FirminCSSMatrix.degreesToRadians;if(typeof c!="number"||isNaN(c))c=0;if((typeof b!="number"||isNaN(b))&&(typeof a!="number"||isNaN(a))){a=c;b=c=0}if(typeof b!="number"||isNaN(b))b=0;if(typeof a!="number"||isNaN(a))a=0;var c=f(c),b=f(b),a=f(a),f=new FirminCSSMatrix,d=new FirminCSSMatrix,e=new FirminCSSMatrix,g,a=a/2;g=Math.sin(a);a=Math.cos(a);e.m11=e.m22=1-2*g*g;e.m12=e.m21=2*g*a;e.m21=e.m21*-1;b=b/2;g=Math.sin(b);a=Math.cos(b);d.m11=d.m33=1-
2*g*g;d.m13=d.m31=2*g*a;d.m13=d.m13*-1;c=c/2;g=Math.sin(c);a=Math.cos(c);f.m22=f.m33=1-2*g*g;f.m23=f.m32=2*g*a;f.m32=f.m32*-1;return this.toString()===(new FirminCSSMatrix).toString()?e.multiply(d).multiply(f):this.multiply(f).multiply(d).multiply(e)};
FirminCSSMatrix.prototype.rotateAxisAngle=function(c,b,a,f){if(typeof c!="number"||isNaN(c))c=0;if(typeof b!="number"||isNaN(b))b=0;if(typeof a!="number"||isNaN(a))a=0;if(typeof f!="number"||isNaN(f))f=0;c===0&&b===0&&a===0&&(a=1);var d=new FirminCSSMatrix,e=Math.sqrt(c*c+b*b+a*a),g,h,i,f=(FirminCSSMatrix.degreesToRadians(f)||0)/2;g=Math.cos(f);h=Math.sin(f);f=h*h;if(e===0){b=c=0;a=1}else if(e!==1){c=c/e;b=b/e;a=a/e}if(c===1&&b===0&&a===0){d.m22=d.m33=1-2*f;d.m23=d.m32=2*g*h;d.m32=d.m32*-1}else if(c===
0&&b===1&&a===0){d.m11=d.m33=1-2*f;d.m13=d.m31=2*g*h;d.m13=d.m13*-1}else if(c===0&&b===0&&a===1){d.m11=d.m22=1-2*f;d.m12=d.m21=2*g*h;d.m21=d.m21*-1}else{e=h*g;g=c*c;h=b*b;i=a*a;d.m11=1-2*(h+i)*f;d.m12=2*(c*b*f+a*e);d.m13=2*(c*a*f-b*e);d.m21=2*(b*c*f-a*e);d.m22=1-2*(i+g)*f;d.m23=2*(b*a*f+c*e);d.m31=2*(a*c*f+b*e);d.m32=2*(a*b*f-c*e);d.m33=1-2*(g+h)*f}return this.multiply(d)};
FirminCSSMatrix.prototype.scale=function(c,b,a){var f=new FirminCSSMatrix;if(typeof c!="number"||isNaN(c))c=1;if(typeof b!="number"||isNaN(b))b=c;if(typeof a!="number"||isNaN(a))a=1;f.m11=c;f.m22=b;f.m33=a;return this.multiply(f)};FirminCSSMatrix.prototype.skewX=function(c){var c=FirminCSSMatrix.degreesToRadians(c),b=new FirminCSSMatrix;b.c=Math.tan(c);return this.multiply(b)};
FirminCSSMatrix.prototype.skewY=function(c){var c=FirminCSSMatrix.degreesToRadians(c),b=new FirminCSSMatrix;b.b=Math.tan(c);return this.multiply(b)};FirminCSSMatrix.prototype.translate=function(c,b,a){var f=new FirminCSSMatrix;if(typeof c!="number"||isNaN(c))c=0;if(typeof b!="number"||isNaN(b))b=0;if(typeof a!="number"||isNaN(a))a=0;f.m41=c;f.m42=b;f.m43=a;return this.multiply(f)};
FirminCSSMatrix.prototype.setMatrixValue=function(c){var c=FirminCSSMatrix.toMatrixString(c.trim()),b=c.match(/^matrix(3d)?\(\s*(.+)\s*\)$/),a,f,d,e;if(b){c=!!b[1];b=b[2].split(/\s*,\s*/);a=b.length;f=Array(a);if(!(c&&a!==16)&&(c||a===6)){for(d=0;d<a;d++){e=b[d];if(e.match(/^-?\d+(\.\d+)?$/))f[d]=parseFloat(e);else return}for(d=0;d<a;d++)this[c?"m"+(Math.floor(d/4)+1)+(d%4+1):String.fromCharCode(d+97)]=f[d]}}};
FirminCSSMatrix.prototype.toString=function(){var c=this,b,a;if(this.isAffine()){a="matrix(";b=["a","b","c","d","e","f"]}else{a="matrix3d(";b=["m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44"]}return a+b.map(function(a){return c[a].toFixed(6)}).join(", ")+")"};XML3D.css.CSSMatrix=FirminCSSMatrix;
XML3D.css.convertCssToMat4=function(c,b){var a=b||XML3D.math.mat4.create();a[0]=c.m11;a[1]=c.m12;a[2]=c.m13;a[3]=c.m14;a[4]=c.m21;a[5]=c.m22;a[6]=c.m23;a[7]=c.m24;a[8]=c.m31;a[9]=c.m32;a[10]=c.m33;a[11]=c.m34;a[12]=c.m41;a[13]=c.m42;a[14]=c.m43;a[15]=c.m44;return a};XML3D.math={};var GLU={};
(function(c){c.unProject=function(b,a,f,d,e,g,h){b=[b,a,f,1];a=[];c.multMatrices(d,e,a);if(!c.invertMatrix(a,a))return!1;b[0]=(b[0]-g[0])/g[2];b[1]=(b[1]-g[1])/g[3];b[0]=2*b[0]-1;b[1]=2*b[1]-1;b[2]=2*b[2]-1;d=[];c.multMatrixVec(a,b,d);if(0===d[3])return!1;d[0]/=d[3];d[1]/=d[3];d[2]/=d[3];h[0]=d[0];h[1]=d[1];h[2]=d[2];return!0};c.multMatrixVec=function(b,a,f){for(var d=0;4>d;d+=1)f[d]=a[0]*b[0+d]+a[1]*b[4+d]+a[2]*b[8+d]+a[3]*b[12+d]};c.multMatrices=function(b,a,f){for(var d=0;4>d;d+=1)for(var e=0;4>
e;e+=1)f[4*d+e]=b[4*d+0]*a[0+e]+b[4*d+1]*a[4+e]+b[4*d+2]*a[8+e]+b[4*d+3]*a[12+e]};c.invertMatrix=function(b,a){var f=[];f[0]=b[5]*b[10]*b[15]-b[5]*b[11]*b[14]-b[9]*b[6]*b[15]+b[9]*b[7]*b[14]+b[13]*b[6]*b[11]-b[13]*b[7]*b[10];f[4]=-b[4]*b[10]*b[15]+b[4]*b[11]*b[14]+b[8]*b[6]*b[15]-b[8]*b[7]*b[14]-b[12]*b[6]*b[11]+b[12]*b[7]*b[10];f[8]=b[4]*b[9]*b[15]-b[4]*b[11]*b[13]-b[8]*b[5]*b[15]+b[8]*b[7]*b[13]+b[12]*b[5]*b[11]-b[12]*b[7]*b[9];f[12]=-b[4]*b[9]*b[14]+b[4]*b[10]*b[13]+b[8]*b[5]*b[14]-b[8]*b[6]*b[13]-
b[12]*b[5]*b[10]+b[12]*b[6]*b[9];f[1]=-b[1]*b[10]*b[15]+b[1]*b[11]*b[14]+b[9]*b[2]*b[15]-b[9]*b[3]*b[14]-b[13]*b[2]*b[11]+b[13]*b[3]*b[10];f[5]=b[0]*b[10]*b[15]-b[0]*b[11]*b[14]-b[8]*b[2]*b[15]+b[8]*b[3]*b[14]+b[12]*b[2]*b[11]-b[12]*b[3]*b[10];f[9]=-b[0]*b[9]*b[15]+b[0]*b[11]*b[13]+b[8]*b[1]*b[15]-b[8]*b[3]*b[13]-b[12]*b[1]*b[11]+b[12]*b[3]*b[9];f[13]=b[0]*b[9]*b[14]-b[0]*b[10]*b[13]-b[8]*b[1]*b[14]+b[8]*b[2]*b[13]+b[12]*b[1]*b[10]-b[12]*b[2]*b[9];f[2]=b[1]*b[6]*b[15]-b[1]*b[7]*b[14]-b[5]*b[2]*b[15]+
b[5]*b[3]*b[14]+b[13]*b[2]*b[7]-b[13]*b[3]*b[6];f[6]=-b[0]*b[6]*b[15]+b[0]*b[7]*b[14]+b[4]*b[2]*b[15]-b[4]*b[3]*b[14]-b[12]*b[2]*b[7]+b[12]*b[3]*b[6];f[10]=b[0]*b[5]*b[15]-b[0]*b[7]*b[13]-b[4]*b[1]*b[15]+b[4]*b[3]*b[13]+b[12]*b[1]*b[7]-b[12]*b[3]*b[5];f[14]=-b[0]*b[5]*b[14]+b[0]*b[6]*b[13]+b[4]*b[1]*b[14]-b[4]*b[2]*b[13]-b[12]*b[1]*b[6]+b[12]*b[2]*b[5];f[3]=-b[1]*b[6]*b[11]+b[1]*b[7]*b[10]+b[5]*b[2]*b[11]-b[5]*b[3]*b[10]-b[9]*b[2]*b[7]+b[9]*b[3]*b[6];f[7]=b[0]*b[6]*b[11]-b[0]*b[7]*b[10]-b[4]*b[2]*
b[11]+b[4]*b[3]*b[10]+b[8]*b[2]*b[7]-b[8]*b[3]*b[6];f[11]=-b[0]*b[5]*b[11]+b[0]*b[7]*b[9]+b[4]*b[1]*b[11]-b[4]*b[3]*b[9]-b[8]*b[1]*b[7]+b[8]*b[3]*b[5];f[15]=b[0]*b[5]*b[10]-b[0]*b[6]*b[9]-b[4]*b[1]*b[10]+b[4]*b[2]*b[9]+b[8]*b[1]*b[6]-b[8]*b[2]*b[5];var d=b[0]*f[0]+b[1]*f[4]+b[2]*f[8]+b[3]*f[12];if(0===d)return!1;for(var d=1/d,e=0;16>e;e+=1)a[e]=f[e]*d;return!0}})(GLU);
(function(c){(function(b){if(!a)var a=1.0E-6;if(!f)var f="undefined"!==typeof Float32Array?Float32Array:Array;if(!d)var d=Math.random;var e={setMatrixArrayType:function(a){f=a}};"undefined"!==typeof b&&(b.glMatrix=e);var c={create:function(){var a=new f(2);a[0]=0;a[1]=0;return a},clone:function(a){var b=new f(2);b[0]=a[0];b[1]=a[1];return b},fromValues:function(a,b){var e=new f(2);e[0]=a;e[1]=b;return e},copy:function(a,b){a[0]=b[0];a[1]=b[1];return a},set:function(a,b,e){a[0]=b;a[1]=e;return a},
add:function(a,b,e){a[0]=b[0]+e[0];a[1]=b[1]+e[1];return a},subtract:function(a,b,e){a[0]=b[0]-e[0];a[1]=b[1]-e[1];return a}};c.sub=c.subtract;c.multiply=function(a,b,e){a[0]=b[0]*e[0];a[1]=b[1]*e[1];return a};c.mul=c.multiply;c.divide=function(a,b,e){a[0]=b[0]/e[0];a[1]=b[1]/e[1];return a};c.div=c.divide;c.min=function(a,b,e){a[0]=Math.min(b[0],e[0]);a[1]=Math.min(b[1],e[1]);return a};c.max=function(a,b,e){a[0]=Math.max(b[0],e[0]);a[1]=Math.max(b[1],e[1]);return a};c.scale=function(a,b,e){a[0]=b[0]*
e;a[1]=b[1]*e;return a};c.scaleAndAdd=function(a,b,e,f){a[0]=b[0]+e[0]*f;a[1]=b[1]+e[1]*f;return a};c.distance=function(a,b){var e=b[0]-a[0],f=b[1]-a[1];return Math.sqrt(e*e+f*f)};c.dist=c.distance;c.squaredDistance=function(a,b){var e=b[0]-a[0],f=b[1]-a[1];return e*e+f*f};c.sqrDist=c.squaredDistance;c.length=function(a){var b=a[0],a=a[1];return Math.sqrt(b*b+a*a)};c.len=c.length;c.squaredLength=function(a){var b=a[0],a=a[1];return b*b+a*a};c.sqrLen=c.squaredLength;c.negate=function(a,b){a[0]=-b[0];
a[1]=-b[1];return a};c.normalize=function(a,b){var e=b[0],f=b[1],e=e*e+f*f;if(e>0){e=1/Math.sqrt(e);a[0]=b[0]*e;a[1]=b[1]*e}return a};c.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};c.cross=function(a,b,e){b=b[0]*e[1]-b[1]*e[0];a[0]=a[1]=0;a[2]=b;return a};c.lerp=function(a,b,e,f){var d=b[0],b=b[1];a[0]=d+f*(e[0]-d);a[1]=b+f*(e[1]-b);return a};c.random=function(a,b){var b=b||1,e=d()*2*Math.PI;a[0]=Math.cos(e)*b;a[1]=Math.sin(e)*b;return a};c.transformMat2=function(a,b,e){var f=b[0],b=b[1];a[0]=e[0]*
f+e[2]*b;a[1]=e[1]*f+e[3]*b;return a};c.transformMat2d=function(a,b,e){var f=b[0],b=b[1];a[0]=e[0]*f+e[2]*b+e[4];a[1]=e[1]*f+e[3]*b+e[5];return a};c.transformMat3=function(a,b,e){var f=b[0],b=b[1];a[0]=e[0]*f+e[3]*b+e[6];a[1]=e[1]*f+e[4]*b+e[7];return a};c.transformMat4=function(a,b,e){var f=b[0],b=b[1];a[0]=e[0]*f+e[4]*b+e[12];a[1]=e[1]*f+e[5]*b+e[13];return a};c.forEach=function(){var a=c.create();return function(b,e,f,d,c,g){e||(e=2);f||(f=0);for(d=d?Math.min(d*e+f,b.length):b.length;f<d;f=f+e){a[0]=
b[f];a[1]=b[f+1];c(a,a,g);b[f]=a[0];b[f+1]=a[1]}return b}}();c.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};"undefined"!==typeof b&&(b.vec2=c);var h={create:function(){var a=new f(3);a[0]=0;a[1]=0;a[2]=0;return a},clone:function(a){var b=new f(3);b[0]=a[0];b[1]=a[1];b[2]=a[2];return b},fromValues:function(a,b,e){var d=new f(3);d[0]=a;d[1]=b;d[2]=e;return d},copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},set:function(a,b,e,f){a[0]=b;a[1]=e;a[2]=f;return a},add:function(a,b,e){a[0]=
b[0]+e[0];a[1]=b[1]+e[1];a[2]=b[2]+e[2];return a},subtract:function(a,b,e){a[0]=b[0]-e[0];a[1]=b[1]-e[1];a[2]=b[2]-e[2];return a}};h.sub=h.subtract;h.multiply=function(a,b,e){a[0]=b[0]*e[0];a[1]=b[1]*e[1];a[2]=b[2]*e[2];return a};h.mul=h.multiply;h.divide=function(a,b,e){a[0]=b[0]/e[0];a[1]=b[1]/e[1];a[2]=b[2]/e[2];return a};h.div=h.divide;h.min=function(a,b,e){a[0]=Math.min(b[0],e[0]);a[1]=Math.min(b[1],e[1]);a[2]=Math.min(b[2],e[2]);return a};h.max=function(a,b,e){a[0]=Math.max(b[0],e[0]);a[1]=
Math.max(b[1],e[1]);a[2]=Math.max(b[2],e[2]);return a};h.scale=function(a,b,e){a[0]=b[0]*e;a[1]=b[1]*e;a[2]=b[2]*e;return a};h.scaleAndAdd=function(a,b,e,f){a[0]=b[0]+e[0]*f;a[1]=b[1]+e[1]*f;a[2]=b[2]+e[2]*f;return a};h.distance=function(a,b){var e=b[0]-a[0],f=b[1]-a[1],d=b[2]-a[2];return Math.sqrt(e*e+f*f+d*d)};h.dist=h.distance;h.squaredDistance=function(a,b){var e=b[0]-a[0],f=b[1]-a[1],d=b[2]-a[2];return e*e+f*f+d*d};h.sqrDist=h.squaredDistance;h.length=function(a){var b=a[0],e=a[1],a=a[2];return Math.sqrt(b*
b+e*e+a*a)};h.len=h.length;h.squaredLength=function(a){var b=a[0],e=a[1],a=a[2];return b*b+e*e+a*a};h.sqrLen=h.squaredLength;h.negate=function(a,b){a[0]=-b[0];a[1]=-b[1];a[2]=-b[2];return a};h.normalize=function(a,b){var e=b[0],f=b[1],d=b[2],e=e*e+f*f+d*d;if(e>0){e=1/Math.sqrt(e);a[0]=b[0]*e;a[1]=b[1]*e;a[2]=b[2]*e}return a};h.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};h.cross=function(a,b,e){var f=b[0],d=b[1],b=b[2],c=e[0],g=e[1],e=e[2];a[0]=d*e-b*g;a[1]=b*c-f*e;a[2]=f*g-d*c;return a};
h.lerp=function(a,b,e,f){var d=b[0],c=b[1],b=b[2];a[0]=d+f*(e[0]-d);a[1]=c+f*(e[1]-c);a[2]=b+f*(e[2]-b);return a};h.random=function(a,b){var b=b||1,e=d()*2*Math.PI,f=d()*2-1,c=Math.sqrt(1-f*f)*b;a[0]=Math.cos(e)*c;a[1]=Math.sin(e)*c;a[2]=f*b;return a};h.transformMat4=function(a,b,e){var f=b[0],d=b[1],b=b[2];a[0]=e[0]*f+e[4]*d+e[8]*b+e[12];a[1]=e[1]*f+e[5]*d+e[9]*b+e[13];a[2]=e[2]*f+e[6]*d+e[10]*b+e[14];return a};h.transformMat3=function(a,b,e){var f=b[0],d=b[1],b=b[2];a[0]=f*e[0]+d*e[3]+b*e[6];a[1]=
f*e[1]+d*e[4]+b*e[7];a[2]=f*e[2]+d*e[5]+b*e[8];return a};h.transformQuat=function(a,b,e){var f=b[0],d=b[1],c=b[2],b=e[0],g=e[1],h=e[2],e=e[3],i=e*f+g*c-h*d,j=e*d+h*f-b*c,k=e*c+b*d-g*f,f=-b*f-g*d-h*c;a[0]=i*e+f*-b+j*-h-k*-g;a[1]=j*e+f*-g+k*-b-i*-h;a[2]=k*e+f*-h+i*-g-j*-b;return a};h.forEach=function(){var a=h.create();return function(b,e,f,d,c,g){e||(e=3);f||(f=0);for(d=d?Math.min(d*e+f,b.length):b.length;f<d;f=f+e){a[0]=b[f];a[1]=b[f+1];a[2]=b[f+2];c(a,a,g);b[f]=a[0];b[f+1]=a[1];b[f+2]=a[2]}return b}}();
h.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};"undefined"!==typeof b&&(b.vec3=h);var i={create:function(){var a=new f(4);a[0]=0;a[1]=0;a[2]=0;a[3]=0;return a},clone:function(a){var b=new f(4);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},fromValues:function(a,b,e,d){var c=new f(4);c[0]=a;c[1]=b;c[2]=e;c[3]=d;return c},copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},set:function(a,b,e,f,d){a[0]=b;a[1]=e;a[2]=f;a[3]=d;return a},add:function(a,b,e){a[0]=b[0]+
e[0];a[1]=b[1]+e[1];a[2]=b[2]+e[2];a[3]=b[3]+e[3];return a},subtract:function(a,b,e){a[0]=b[0]-e[0];a[1]=b[1]-e[1];a[2]=b[2]-e[2];a[3]=b[3]-e[3];return a}};i.sub=i.subtract;i.multiply=function(a,b,e){a[0]=b[0]*e[0];a[1]=b[1]*e[1];a[2]=b[2]*e[2];a[3]=b[3]*e[3];return a};i.mul=i.multiply;i.divide=function(a,b,e){a[0]=b[0]/e[0];a[1]=b[1]/e[1];a[2]=b[2]/e[2];a[3]=b[3]/e[3];return a};i.div=i.divide;i.min=function(a,b,e){a[0]=Math.min(b[0],e[0]);a[1]=Math.min(b[1],e[1]);a[2]=Math.min(b[2],e[2]);a[3]=Math.min(b[3],
e[3]);return a};i.max=function(a,b,e){a[0]=Math.max(b[0],e[0]);a[1]=Math.max(b[1],e[1]);a[2]=Math.max(b[2],e[2]);a[3]=Math.max(b[3],e[3]);return a};i.scale=function(a,b,e){a[0]=b[0]*e;a[1]=b[1]*e;a[2]=b[2]*e;a[3]=b[3]*e;return a};i.scaleAndAdd=function(a,b,e,f){a[0]=b[0]+e[0]*f;a[1]=b[1]+e[1]*f;a[2]=b[2]+e[2]*f;a[3]=b[3]+e[3]*f;return a};i.distance=function(a,b){var e=b[0]-a[0],f=b[1]-a[1],d=b[2]-a[2],c=b[3]-a[3];return Math.sqrt(e*e+f*f+d*d+c*c)};i.dist=i.distance;i.squaredDistance=function(a,b){var e=
b[0]-a[0],f=b[1]-a[1],d=b[2]-a[2],c=b[3]-a[3];return e*e+f*f+d*d+c*c};i.sqrDist=i.squaredDistance;i.length=function(a){var b=a[0],e=a[1],f=a[2],a=a[3];return Math.sqrt(b*b+e*e+f*f+a*a)};i.len=i.length;i.squaredLength=function(a){var b=a[0],e=a[1],f=a[2],a=a[3];return b*b+e*e+f*f+a*a};i.sqrLen=i.squaredLength;i.negate=function(a,b){a[0]=-b[0];a[1]=-b[1];a[2]=-b[2];a[3]=-b[3];return a};i.normalize=function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],e=e*e+f*f+d*d+c*c;if(e>0){e=1/Math.sqrt(e);a[0]=b[0]*e;a[1]=
b[1]*e;a[2]=b[2]*e;a[3]=b[3]*e}return a};i.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};i.lerp=function(a,b,e,f){var d=b[0],c=b[1],g=b[2],b=b[3];a[0]=d+f*(e[0]-d);a[1]=c+f*(e[1]-c);a[2]=g+f*(e[2]-g);a[3]=b+f*(e[3]-b);return a};i.random=function(a,b){b=b||1;a[0]=d();a[1]=d();a[2]=d();a[3]=d();i.normalize(a,a);i.scale(a,a,b);return a};i.transformMat4=function(a,b,e){var f=b[0],d=b[1],c=b[2],b=b[3];a[0]=e[0]*f+e[4]*d+e[8]*c+e[12]*b;a[1]=e[1]*f+e[5]*d+e[9]*c+e[13]*b;a[2]=e[2]*f+e[6]*
d+e[10]*c+e[14]*b;a[3]=e[3]*f+e[7]*d+e[11]*c+e[15]*b;return a};i.transformQuat=function(a,b,e){var f=b[0],d=b[1],c=b[2],b=e[0],g=e[1],h=e[2],e=e[3],i=e*f+g*c-h*d,j=e*d+h*f-b*c,k=e*c+b*d-g*f,f=-b*f-g*d-h*c;a[0]=i*e+f*-b+j*-h-k*-g;a[1]=j*e+f*-g+k*-b-i*-h;a[2]=k*e+f*-h+i*-g-j*-b;return a};i.forEach=function(){var a=i.create();return function(b,e,f,d,c,g){e||(e=4);f||(f=0);for(d=d?Math.min(d*e+f,b.length):b.length;f<d;f=f+e){a[0]=b[f];a[1]=b[f+1];a[2]=b[f+2];a[3]=b[f+3];c(a,a,g);b[f]=a[0];b[f+1]=a[1];
b[f+2]=a[2];b[f+3]=a[3]}return b}}();i.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!==typeof b&&(b.vec4=i);e={create:function(){var a=new f(4);a[0]=1;a[1]=0;a[2]=0;a[3]=1;return a},clone:function(a){var b=new f(4);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=1;return a},transpose:function(a,b){if(a===b){var e=b[1];a[1]=b[2];a[2]=e}else{a[0]=
b[0];a[1]=b[2];a[2]=b[1];a[3]=b[3]}return a},invert:function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=e*c-d*f;if(!g)return null;g=1/g;a[0]=c*g;a[1]=-f*g;a[2]=-d*g;a[3]=e*g;return a},adjoint:function(a,b){var e=b[0];a[0]=b[3];a[1]=-b[1];a[2]=-b[2];a[3]=e;return a},determinant:function(a){return a[0]*a[3]-a[2]*a[1]},multiply:function(a,b,e){var f=b[0],d=b[1],c=b[2],b=b[3],g=e[0],h=e[1],i=e[2],e=e[3];a[0]=f*g+d*i;a[1]=f*h+d*e;a[2]=c*g+b*i;a[3]=c*h+b*e;return a}};e.mul=e.multiply;e.rotate=function(a,b,
e){var f=b[0],d=b[1],c=b[2],b=b[3],g=Math.sin(e),e=Math.cos(e);a[0]=f*e+d*g;a[1]=f*-g+d*e;a[2]=c*e+b*g;a[3]=c*-g+b*e;return a};e.scale=function(a,b,e){var f=b[1],d=b[2],c=b[3],g=e[0],e=e[1];a[0]=b[0]*g;a[1]=f*e;a[2]=d*g;a[3]=c*e;return a};e.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!==typeof b&&(b.mat2=e);e={create:function(){var a=new f(6);a[0]=1;a[1]=0;a[2]=0;a[3]=1;a[4]=0;a[5]=0;return a},clone:function(a){var b=new f(6);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=
a[3];b[4]=a[4];b[5]=a[5];return b},copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];return a},identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=1;a[4]=0;a[5]=0;return a},invert:function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=b[4],h=b[5],i=e*c-f*d;if(!i)return null;i=1/i;a[0]=c*i;a[1]=-f*i;a[2]=-d*i;a[3]=e*i;a[4]=(d*h-c*g)*i;a[5]=(f*g-e*h)*i;return a},determinant:function(a){return a[0]*a[3]-a[1]*a[2]},multiply:function(a,b,e){var f=b[0],d=b[1],c=b[2],g=b[3],h=b[4],b=b[5],
i=e[0],j=e[1],k=e[2],l=e[3],t=e[4],e=e[5];a[0]=f*i+d*k;a[1]=f*j+d*l;a[2]=c*i+g*k;a[3]=c*j+g*l;a[4]=i*h+k*b+t;a[5]=j*h+l*b+e;return a}};e.mul=e.multiply;e.rotate=function(a,b,e){var f=b[0],d=b[1],c=b[2],g=b[3],h=b[4],b=b[5],i=Math.sin(e),e=Math.cos(e);a[0]=f*e+d*i;a[1]=-f*i+d*e;a[2]=c*e+g*i;a[3]=-c*i+e*g;a[4]=e*h+i*b;a[5]=e*b-i*h;return a};e.scale=function(a,b,e){var f=e[0],e=e[1];a[0]=b[0]*f;a[1]=b[1]*e;a[2]=b[2]*f;a[3]=b[3]*e;a[4]=b[4]*f;a[5]=b[5]*e;return a};e.translate=function(a,b,e){a[0]=b[0];
a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4]+e[0];a[5]=b[5]+e[1];return a};e.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};"undefined"!==typeof b&&(b.mat2d=e);var j={create:function(){var a=new f(9);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a},fromMat4:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[4];a[4]=b[5];a[5]=b[6];a[6]=b[8];a[7]=b[9];a[8]=b[10];return a},clone:function(a){var b=new f(9);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=
a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b},copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];return a},identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a},transpose:function(a,b){if(a===b){var e=b[1],f=b[2],d=b[5];a[1]=b[3];a[2]=b[6];a[3]=e;a[5]=b[7];a[6]=f;a[7]=d}else{a[0]=b[0];a[1]=b[3];a[2]=b[6];a[3]=b[1];a[4]=b[4];a[5]=b[7];a[6]=b[2];a[7]=b[5];a[8]=b[8]}return a},invert:function(a,
b){var e=b[0],f=b[1],d=b[2],c=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=k*g-h*j,t=-k*c+h*i,v=j*c-g*i,y=e*l+f*t+d*v;if(!y)return null;y=1/y;a[0]=l*y;a[1]=(-k*f+d*j)*y;a[2]=(h*f-d*g)*y;a[3]=t*y;a[4]=(k*e-d*i)*y;a[5]=(-h*e+d*c)*y;a[6]=v*y;a[7]=(-j*e+f*i)*y;a[8]=(g*e-f*c)*y;return a},adjoint:function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8];a[0]=g*k-h*j;a[1]=d*j-f*k;a[2]=f*h-d*g;a[3]=h*i-c*k;a[4]=e*k-d*i;a[5]=d*c-e*h;a[6]=c*j-g*i;a[7]=f*i-e*j;a[8]=e*g-f*c;return a},determinant:function(a){var b=
a[3],e=a[4],f=a[5],d=a[6],c=a[7],g=a[8];return a[0]*(g*e-f*c)+a[1]*(-g*b+f*d)+a[2]*(c*b-e*d)},multiply:function(a,b,e){var f=b[0],d=b[1],c=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],b=b[8],l=e[0],t=e[1],v=e[2],y=e[3],z=e[4],A=e[5],C=e[6],E=e[7],e=e[8];a[0]=l*f+t*g+v*j;a[1]=l*d+t*h+v*k;a[2]=l*c+t*i+v*b;a[3]=y*f+z*g+A*j;a[4]=y*d+z*h+A*k;a[5]=y*c+z*i+A*b;a[6]=C*f+E*g+e*j;a[7]=C*d+E*h+e*k;a[8]=C*c+E*i+e*b;return a}};j.mul=j.multiply;j.translate=function(a,b,e){var f=b[0],d=b[1],c=b[2],g=b[3],h=b[4],i=b[5],
j=b[6],k=b[7],b=b[8],l=e[0],e=e[1];a[0]=f;a[1]=d;a[2]=c;a[3]=g;a[4]=h;a[5]=i;a[6]=l*f+e*g+j;a[7]=l*d+e*h+k;a[8]=l*c+e*i+b;return a};j.rotate=function(a,b,e){var f=b[0],d=b[1],c=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],b=b[8],l=Math.sin(e),e=Math.cos(e);a[0]=e*f+l*g;a[1]=e*d+l*h;a[2]=e*c+l*i;a[3]=e*g-l*f;a[4]=e*h-l*d;a[5]=e*i-l*c;a[6]=j;a[7]=k;a[8]=b;return a};j.scale=function(a,b,e){var f=e[0],e=e[1];a[0]=f*b[0];a[1]=f*b[1];a[2]=f*b[2];a[3]=e*b[3];a[4]=e*b[4];a[5]=e*b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];
return a};j.fromMat2d=function(a,b){a[0]=b[0];a[1]=b[1];a[2]=0;a[3]=b[2];a[4]=b[3];a[5]=0;a[6]=b[4];a[7]=b[5];a[8]=1;return a};j.fromQuat=function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=e+e,h=f+f,i=d+d,j=e*g,k=e*h,e=e*i,l=f*h,f=f*i,d=d*i,g=c*g,h=c*h,c=c*i;a[0]=1-(l+d);a[3]=k+c;a[6]=e-h;a[1]=k-c;a[4]=1-(j+d);a[7]=f+g;a[2]=e+h;a[5]=f-g;a[8]=1-(j+l);return a};j.normalFromMat4=function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],t=b[10],v=b[11],y=b[12],z=b[13],A=b[14],
C=b[15],E=e*h-f*g,H=e*i-d*g,F=e*j-c*g,G=f*i-d*h,I=f*j-c*h,K=d*j-c*i,L=k*z-l*y,M=k*A-t*y,k=k*C-v*y,N=l*A-t*z,l=l*C-v*z,t=t*C-v*A,v=E*t-H*l+F*N+G*k-I*M+K*L;if(!v)return null;v=1/v;a[0]=(h*t-i*l+j*N)*v;a[1]=(i*k-g*t-j*M)*v;a[2]=(g*l-h*k+j*L)*v;a[3]=(d*l-f*t-c*N)*v;a[4]=(e*t-d*k+c*M)*v;a[5]=(f*k-e*l-c*L)*v;a[6]=(z*K-A*I+C*G)*v;a[7]=(A*F-y*K-C*H)*v;a[8]=(y*I-z*F+C*E)*v;return a};j.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};"undefined"!==
typeof b&&(b.mat3=j);var k={create:function(){var a=new f(16);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},clone:function(a){var b=new f(16);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b},copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];
a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return a},identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},transpose:function(a,b){if(a===b){var e=b[1],f=b[2],d=b[3],c=b[6],g=b[7],h=b[11];a[1]=b[4];a[2]=b[8];a[3]=b[12];a[4]=e;a[6]=b[9];a[7]=b[13];a[8]=f;a[9]=c;a[11]=b[14];a[12]=d;a[13]=g;a[14]=h}else{a[0]=b[0];a[1]=b[4];a[2]=b[8];a[3]=b[12];a[4]=b[1];a[5]=
b[5];a[6]=b[9];a[7]=b[13];a[8]=b[2];a[9]=b[6];a[10]=b[10];a[11]=b[14];a[12]=b[3];a[13]=b[7];a[14]=b[11];a[15]=b[15]}return a},invert:function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],t=b[10],v=b[11],y=b[12],z=b[13],A=b[14],C=b[15],E=e*h-f*g,H=e*i-d*g,F=e*j-c*g,G=f*i-d*h,I=f*j-c*h,K=d*j-c*i,L=k*z-l*y,M=k*A-t*y,N=k*C-v*y,O=l*A-t*z,P=l*C-v*z,Q=t*C-v*A,J=E*Q-H*P+F*O+G*N-I*M+K*L;if(!J)return null;J=1/J;a[0]=(h*Q-i*P+j*O)*J;a[1]=(d*P-f*Q-c*O)*J;a[2]=(z*K-A*I+C*G)*J;
a[3]=(t*I-l*K-v*G)*J;a[4]=(i*N-g*Q-j*M)*J;a[5]=(e*Q-d*N+c*M)*J;a[6]=(A*F-y*K-C*H)*J;a[7]=(k*K-t*F+v*H)*J;a[8]=(g*P-h*N+j*L)*J;a[9]=(f*N-e*P-c*L)*J;a[10]=(y*I-z*F+C*E)*J;a[11]=(l*F-k*I-v*E)*J;a[12]=(h*M-g*O-i*L)*J;a[13]=(e*O-f*M+d*L)*J;a[14]=(z*H-y*G-A*E)*J;a[15]=(k*G-l*H+t*E)*J;return a},adjoint:function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],t=b[10],v=b[11],y=b[12],z=b[13],A=b[14],C=b[15];a[0]=h*(t*C-v*A)-l*(i*C-j*A)+z*(i*v-j*t);a[1]=-(f*(t*C-v*A)-l*(d*C-c*
A)+z*(d*v-c*t));a[2]=f*(i*C-j*A)-h*(d*C-c*A)+z*(d*j-c*i);a[3]=-(f*(i*v-j*t)-h*(d*v-c*t)+l*(d*j-c*i));a[4]=-(g*(t*C-v*A)-k*(i*C-j*A)+y*(i*v-j*t));a[5]=e*(t*C-v*A)-k*(d*C-c*A)+y*(d*v-c*t);a[6]=-(e*(i*C-j*A)-g*(d*C-c*A)+y*(d*j-c*i));a[7]=e*(i*v-j*t)-g*(d*v-c*t)+k*(d*j-c*i);a[8]=g*(l*C-v*z)-k*(h*C-j*z)+y*(h*v-j*l);a[9]=-(e*(l*C-v*z)-k*(f*C-c*z)+y*(f*v-c*l));a[10]=e*(h*C-j*z)-g*(f*C-c*z)+y*(f*j-c*h);a[11]=-(e*(h*v-j*l)-g*(f*v-c*l)+k*(f*j-c*h));a[12]=-(g*(l*A-t*z)-k*(h*A-i*z)+y*(h*t-i*l));a[13]=e*(l*A-
t*z)-k*(f*A-d*z)+y*(f*t-d*l);a[14]=-(e*(h*A-i*z)-g*(f*A-d*z)+y*(f*i-d*h));a[15]=e*(h*t-i*l)-g*(f*t-d*l)+k*(f*i-d*h);return a},determinant:function(a){var b=a[0],e=a[1],f=a[2],d=a[3],c=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],t=a[11],v=a[12],y=a[13],z=a[14],a=a[15];return(b*g-e*c)*(l*a-t*z)-(b*h-f*c)*(k*a-t*y)+(b*i-d*c)*(k*z-l*y)+(e*h-f*g)*(j*a-t*v)-(e*i-d*g)*(j*z-l*v)+(f*i-d*h)*(j*y-k*v)},multiply:function(a,b,e){var f=b[0],d=b[1],c=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],t=b[9],v=b[10],
y=b[11],z=b[12],A=b[13],C=b[14],b=b[15],E=e[0],H=e[1],F=e[2],G=e[3];a[0]=E*f+H*h+F*l+G*z;a[1]=E*d+H*i+F*t+G*A;a[2]=E*c+H*j+F*v+G*C;a[3]=E*g+H*k+F*y+G*b;E=e[4];H=e[5];F=e[6];G=e[7];a[4]=E*f+H*h+F*l+G*z;a[5]=E*d+H*i+F*t+G*A;a[6]=E*c+H*j+F*v+G*C;a[7]=E*g+H*k+F*y+G*b;E=e[8];H=e[9];F=e[10];G=e[11];a[8]=E*f+H*h+F*l+G*z;a[9]=E*d+H*i+F*t+G*A;a[10]=E*c+H*j+F*v+G*C;a[11]=E*g+H*k+F*y+G*b;E=e[12];H=e[13];F=e[14];G=e[15];a[12]=E*f+H*h+F*l+G*z;a[13]=E*d+H*i+F*t+G*A;a[14]=E*c+H*j+F*v+G*C;a[15]=E*g+H*k+F*y+G*b;return a}};
k.mul=k.multiply;k.translate=function(a,b,e){var f=e[0],d=e[1],e=e[2],c,g,h,i,j,k,l,t,v,y,z,A;if(b===a){a[12]=b[0]*f+b[4]*d+b[8]*e+b[12];a[13]=b[1]*f+b[5]*d+b[9]*e+b[13];a[14]=b[2]*f+b[6]*d+b[10]*e+b[14];a[15]=b[3]*f+b[7]*d+b[11]*e+b[15]}else{c=b[0];g=b[1];h=b[2];i=b[3];j=b[4];k=b[5];l=b[6];t=b[7];v=b[8];y=b[9];z=b[10];A=b[11];a[0]=c;a[1]=g;a[2]=h;a[3]=i;a[4]=j;a[5]=k;a[6]=l;a[7]=t;a[8]=v;a[9]=y;a[10]=z;a[11]=A;a[12]=c*f+j*d+v*e+b[12];a[13]=g*f+k*d+y*e+b[13];a[14]=h*f+l*d+z*e+b[14];a[15]=i*f+t*d+
A*e+b[15]}return a};k.scale=function(a,b,e){var f=e[0],d=e[1],e=e[2];a[0]=b[0]*f;a[1]=b[1]*f;a[2]=b[2]*f;a[3]=b[3]*f;a[4]=b[4]*d;a[5]=b[5]*d;a[6]=b[6]*d;a[7]=b[7]*d;a[8]=b[8]*e;a[9]=b[9]*e;a[10]=b[10]*e;a[11]=b[11]*e;a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return a};k.rotate=function(b,e,f,d){var c=d[0],g=d[1],d=d[2],h=Math.sqrt(c*c+g*g+d*d),i,j,k,l,D,t,v,y,z,A,C,E,H,F,G,I,K,L,M,N;if(Math.abs(h)<a)return null;h=1/h;c=c*h;g=g*h;d=d*h;i=Math.sin(f);j=Math.cos(f);k=1-j;f=e[0];h=e[1];l=e[2];D=
e[3];t=e[4];v=e[5];y=e[6];z=e[7];A=e[8];C=e[9];E=e[10];H=e[11];F=c*c*k+j;G=g*c*k+d*i;I=d*c*k-g*i;K=c*g*k-d*i;L=g*g*k+j;M=d*g*k+c*i;N=c*d*k+g*i;c=g*d*k-c*i;g=d*d*k+j;b[0]=f*F+t*G+A*I;b[1]=h*F+v*G+C*I;b[2]=l*F+y*G+E*I;b[3]=D*F+z*G+H*I;b[4]=f*K+t*L+A*M;b[5]=h*K+v*L+C*M;b[6]=l*K+y*L+E*M;b[7]=D*K+z*L+H*M;b[8]=f*N+t*c+A*g;b[9]=h*N+v*c+C*g;b[10]=l*N+y*c+E*g;b[11]=D*N+z*c+H*g;if(e!==b){b[12]=e[12];b[13]=e[13];b[14]=e[14];b[15]=e[15]}return b};k.rotateX=function(a,b,e){var f=Math.sin(e),e=Math.cos(e),d=b[4],
c=b[5],g=b[6],h=b[7],i=b[8],j=b[9],k=b[10],l=b[11];if(b!==a){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15]}a[4]=d*e+i*f;a[5]=c*e+j*f;a[6]=g*e+k*f;a[7]=h*e+l*f;a[8]=i*e-d*f;a[9]=j*e-c*f;a[10]=k*e-g*f;a[11]=l*e-h*f;return a};k.rotateY=function(a,b,e){var f=Math.sin(e),e=Math.cos(e),d=b[0],c=b[1],g=b[2],h=b[3],i=b[8],j=b[9],k=b[10],l=b[11];if(b!==a){a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15]}a[0]=d*e-i*f;a[1]=c*e-
j*f;a[2]=g*e-k*f;a[3]=h*e-l*f;a[8]=d*f+i*e;a[9]=c*f+j*e;a[10]=g*f+k*e;a[11]=h*f+l*e;return a};k.rotateZ=function(a,b,e){var f=Math.sin(e),e=Math.cos(e),d=b[0],c=b[1],g=b[2],h=b[3],i=b[4],j=b[5],k=b[6],l=b[7];if(b!==a){a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15]}a[0]=d*e+i*f;a[1]=c*e+j*f;a[2]=g*e+k*f;a[3]=h*e+l*f;a[4]=i*e-d*f;a[5]=j*e-c*f;a[6]=k*e-g*f;a[7]=l*e-h*f;return a};k.fromRotationTranslation=function(a,b,e){var f=b[0],d=b[1],c=b[2],g=b[3],h=f+
f,i=d+d,j=c+c,b=f*h,k=f*i,f=f*j,l=d*i,d=d*j,c=c*j,h=g*h,i=g*i,g=g*j;a[0]=1-(l+c);a[1]=k+g;a[2]=f-i;a[3]=0;a[4]=k-g;a[5]=1-(b+c);a[6]=d+h;a[7]=0;a[8]=f+i;a[9]=d-h;a[10]=1-(b+l);a[11]=0;a[12]=e[0];a[13]=e[1];a[14]=e[2];a[15]=1;return a};k.fromQuat=function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=e+e,h=f+f,i=d+d,j=e*g,k=e*h,e=e*i,l=f*h,f=f*i,d=d*i,g=c*g,h=c*h,c=c*i;a[0]=1-(l+d);a[1]=k+c;a[2]=e-h;a[3]=0;a[4]=k-c;a[5]=1-(j+d);a[6]=f+g;a[7]=0;a[8]=e+h;a[9]=f-g;a[10]=1-(j+l);a[11]=0;a[12]=0;a[13]=0;a[14]=
0;a[15]=1;return a};k.frustum=function(a,b,e,f,d,c,g){var h=1/(e-b),i=1/(d-f),j=1/(c-g);a[0]=c*2*h;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=c*2*i;a[6]=0;a[7]=0;a[8]=(e+b)*h;a[9]=(d+f)*i;a[10]=(g+c)*j;a[11]=-1;a[12]=0;a[13]=0;a[14]=g*c*2*j;a[15]=0;return a};k.perspective=function(a,b,e,f,d){var b=1/Math.tan(b/2),c=1/(f-d);a[0]=b/e;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=b;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=(d+f)*c;a[11]=-1;a[12]=0;a[13]=0;a[14]=2*d*f*c;a[15]=0;return a};k.ortho=function(a,b,e,f,d,c,g){var h=1/(b-
e),i=1/(f-d),j=1/(c-g);a[0]=-2*h;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=-2*i;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=2*j;a[11]=0;a[12]=(b+e)*h;a[13]=(d+f)*i;a[14]=(g+c)*j;a[15]=1;return a};k.lookAt=function(b,e,f,d){var c,g,h,i,j,l,s,D,t=e[0],v=e[1],e=e[2];h=d[0];i=d[1];g=d[2];s=f[0];d=f[1];c=f[2];if(Math.abs(t-s)<a&&Math.abs(v-d)<a&&Math.abs(e-c)<a)return k.identity(b);f=t-s;d=v-d;s=e-c;D=1/Math.sqrt(f*f+d*d+s*s);f=f*D;d=d*D;s=s*D;c=i*s-g*d;g=g*f-h*s;h=h*d-i*f;if(D=Math.sqrt(c*c+g*g+h*h)){D=1/D;c=c*D;g=g*D;
h=h*D}else h=g=c=0;i=d*h-s*g;j=s*c-f*h;l=f*g-d*c;if(D=Math.sqrt(i*i+j*j+l*l)){D=1/D;i=i*D;j=j*D;l=l*D}else l=j=i=0;b[0]=c;b[1]=i;b[2]=f;b[3]=0;b[4]=g;b[5]=j;b[6]=d;b[7]=0;b[8]=h;b[9]=l;b[10]=s;b[11]=0;b[12]=-(c*t+g*v+h*e);b[13]=-(i*t+j*v+l*e);b[14]=-(f*t+d*v+s*e);b[15]=1;return b};k.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};"undefined"!==typeof b&&
(b.mat4=k);var l={create:function(){var a=new f(4);a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a}};l.rotationTo=function(){var a=h.create(),b=h.fromValues(1,0,0),e=h.fromValues(0,1,0);return function(f,d,c){var g=h.dot(d,c);if(g<-0.999999){h.cross(a,b,d);h.length(a)<1.0E-6&&h.cross(a,e,d);h.normalize(a,a);l.setAxisAngle(f,a,Math.PI);return f}if(g>0.999999){f[0]=0;f[1]=0;f[2]=0;f[3]=1;return f}h.cross(a,d,c);f[0]=a[0];f[1]=a[1];f[2]=a[2];f[3]=1+g;return l.normalize(f,f)}}();l.setAxes=function(){var a=j.create();
return function(b,e,f,d){a[0]=f[0];a[3]=f[1];a[6]=f[2];a[1]=d[0];a[4]=d[1];a[7]=d[2];a[2]=e[0];a[5]=e[1];a[8]=e[2];return l.normalize(b,l.fromMat3(b,a))}}();l.clone=i.clone;l.fromValues=i.fromValues;l.copy=i.copy;l.set=i.set;l.identity=function(a){a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};l.setAxisAngle=function(a,b,e){var e=e*0.5,f=Math.sin(e);a[0]=f*b[0];a[1]=f*b[1];a[2]=f*b[2];a[3]=Math.cos(e);return a};l.add=i.add;l.multiply=function(a,b,e){var f=b[0],d=b[1],c=b[2],b=b[3],g=e[0],h=e[1],i=e[2],e=e[3];
a[0]=f*e+b*g+d*i-c*h;a[1]=d*e+b*h+c*g-f*i;a[2]=c*e+b*i+f*h-d*g;a[3]=b*e-f*g-d*h-c*i;return a};l.mul=l.multiply;l.scale=i.scale;l.rotateX=function(a,b,e){var e=e*0.5,f=b[0],d=b[1],c=b[2],b=b[3],g=Math.sin(e),e=Math.cos(e);a[0]=f*e+b*g;a[1]=d*e+c*g;a[2]=c*e-d*g;a[3]=b*e-f*g;return a};l.rotateY=function(a,b,e){var e=e*0.5,f=b[0],d=b[1],c=b[2],b=b[3],g=Math.sin(e),e=Math.cos(e);a[0]=f*e-c*g;a[1]=d*e+b*g;a[2]=c*e+f*g;a[3]=b*e-d*g;return a};l.rotateZ=function(a,b,e){var e=e*0.5,f=b[0],d=b[1],c=b[2],b=b[3],
g=Math.sin(e),e=Math.cos(e);a[0]=f*e+d*g;a[1]=d*e-f*g;a[2]=c*e+b*g;a[3]=b*e-c*g;return a};l.calculateW=function(a,b){var e=b[0],f=b[1],d=b[2];a[0]=e;a[1]=f;a[2]=d;a[3]=-Math.sqrt(Math.abs(1-e*e-f*f-d*d));return a};l.dot=i.dot;l.lerp=i.lerp;l.slerp=function(a,b,e,f){var d=b[0],c=b[1],g=b[2],b=b[3],h=e[0],i=e[1],j=e[2],e=e[3],k,l,t;l=d*h+c*i+g*j+b*e;if(l<0){l=-l;h=-h;i=-i;j=-j;e=-e}if(1-l>1.0E-6){k=Math.acos(l);t=Math.sin(k);l=Math.sin((1-f)*k)/t;f=Math.sin(f*k)/t}else l=1-f;a[0]=l*d+f*h;a[1]=l*c+f*
i;a[2]=l*g+f*j;a[3]=l*b+f*e;return a};l.invert=function(a,b){var e=b[0],f=b[1],d=b[2],c=b[3],g=e*e+f*f+d*d+c*c,g=g?1/g:0;a[0]=-e*g;a[1]=-f*g;a[2]=-d*g;a[3]=c*g;return a};l.conjugate=function(a,b){a[0]=-b[0];a[1]=-b[1];a[2]=-b[2];a[3]=b[3];return a};l.length=i.length;l.len=l.length;l.squaredLength=i.squaredLength;l.sqrLen=l.squaredLength;l.normalize=i.normalize;l.fromMat3=function(){var a=typeof Int8Array!=="undefined"?new Int8Array([1,2,0]):[1,2,0];return function(b,e){var f=e[0]+e[4]+e[8];if(f>0){f=
Math.sqrt(f+1);b[3]=0.5*f;f=0.5/f;b[0]=(e[7]-e[5])*f;b[1]=(e[2]-e[6])*f;b[2]=(e[3]-e[1])*f}else{var d=0;e[4]>e[0]&&(d=1);e[8]>e[d*3+d]&&(d=2);var c=a[d],g=a[c],f=Math.sqrt(e[d*3+d]-e[c*3+c]-e[g*3+g]+1);b[d]=0.5*f;f=0.5/f;b[3]=(e[g*3+c]-e[c*3+g])*f;b[c]=(e[c*3+d]+e[d*3+c])*f;b[g]=(e[g*3+d]+e[d*3+g])*f}return b}}();l.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!==typeof b&&(b.quat=l)})(c)})(XML3D.math);
(function(){function c(b){var b=b||{guess:!0},a=b.e||null,b=!!b.guess,f=new c.implementation,a=f.run(a);return b?f.guessAnonymousFunctions(a):a}c.implementation=function(){};c.implementation.prototype={run:function(b,a){b=b||this.createException();a=a||this.mode(b);return"other"===a?this.other(arguments.callee):this[a](b)},createException:function(){try{this.undef()}catch(b){return b}},mode:function(b){return b.arguments&&b.stack?"chrome":b.stack&&b.sourceURL?"safari":"string"===typeof b.message&&
"undefined"!==typeof window&&window.opera?!b.stacktrace||-1<b.message.indexOf("\n")&&b.message.split("\n").length>b.stacktrace.split("\n").length?"opera9":!b.stack?"opera10a":0>b.stacktrace.indexOf("called from line")?"opera10b":"opera11":b.stack?"firefox":"other"},instrumentFunction:function(b,a,f){var b=b||window,d=b[a];b[a]=function(){f.call(this,c().slice(4));return b[a]._instrumented.apply(this,arguments)};b[a]._instrumented=d},deinstrumentFunction:function(b,a){b[a].constructor===Function&&
b[a]._instrumented&&b[a]._instrumented.constructor===Function&&(b[a]=b[a]._instrumented)},chrome:function(b){b=(b.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n");b.pop();return b},safari:function(b){return b.stack.replace(/\[native code\]\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},firefox:function(b){return b.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^[\(@]/gm,"{anonymous}()@").split("\n")},opera11:function(b){for(var a=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/,b=b.stacktrace.split("\n"),f=[],d=0,e=b.length;d<e;d+=2){var c=a.exec(b[d]);if(c){var h=c[4]+":"+c[1]+":"+c[2],c=c[3]||"global code",c=c.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");f.push(c+"@"+h+" -- "+b[d+1].replace(/^\s+/,""))}}return f},opera10b:function(b){for(var a=/^(.*)@(.+):(\d+)$/,b=b.stacktrace.split("\n"),
f=[],d=0,e=b.length;d<e;d++){var c=a.exec(b[d]);c&&f.push((c[1]?c[1]+"()":"global code")+"@"+c[2]+":"+c[3])}return f},opera10a:function(b){for(var a=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,b=b.stacktrace.split("\n"),f=[],d=0,e=b.length;d<e;d+=2){var c=a.exec(b[d]);c&&f.push((c[3]||"{anonymous}")+"()@"+c[2]+":"+c[1]+" -- "+b[d+1].replace(/^\s+/,""))}return f},opera9:function(b){for(var a=/Line (\d+).*script (?:in )?(\S+)/i,b=b.message.split("\n"),f=[],d=2,e=b.length;d<e;d+=2){var c=
a.exec(b[d]);c&&f.push("{anonymous}()@"+c[2]+":"+c[1]+" -- "+b[d+1].replace(/^\s+/,""))}return f},other:function(b){for(var a=/function\s*([\w\-$]+)?\s*\(/i,f=[],d,e;b&&b.arguments&&10>f.length;)d=a.test(b.toString())?RegExp.$1||"{anonymous}":"{anonymous}",e=Array.prototype.slice.call(b.arguments||[]),f[f.length]=d+"("+this.stringifyArguments(e)+")",b=b.caller;return f},stringifyArguments:function(b){for(var a=[],f=Array.prototype.slice,d=0;d<b.length;++d){var e=b[d];void 0===e?a[d]="undefined":null===
e?a[d]="null":e.constructor&&(e.constructor===Array?a[d]=3>e.length?"["+this.stringifyArguments(e)+"]":"["+this.stringifyArguments(f.call(e,0,1))+"..."+this.stringifyArguments(f.call(e,-1))+"]":e.constructor===Object?a[d]="#object":e.constructor===Function?a[d]="#function":e.constructor===String?a[d]='"'+e+'"':e.constructor===Number&&(a[d]=e))}return a.join(",")},sourceCache:{},ajax:function(b){var a=this.createXMLHTTPObject();if(a)try{return a.open("GET",b,!1),a.send(null),a.responseText}catch(f){}return""},
createXMLHTTPObject:function(){for(var b,a=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],f=0;f<a.length;f++)try{return b=a[f](),this.createXMLHTTPObject=a[f],b}catch(d){}},isSameDomain:function(b){return"undefined"!==typeof location&&-1!==b.indexOf(location.hostname)},getSource:function(b){b in this.sourceCache||(this.sourceCache[b]=this.ajax(b).split("\n"));
return this.sourceCache[b]},guessAnonymousFunctions:function(b){for(var a=0;a<b.length;++a){var f=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,d=b[a],e=/\{anonymous\}\(.*\)@(.*)/.exec(d);if(e){var c=f.exec(e[1]);c&&(f=c[1],e=c[2],c=c[3]||0,f&&this.isSameDomain(f)&&e&&(f=this.guessAnonymousFunction(f,e,c),b[a]=d.replace("{anonymous}",f)))}}return b},guessAnonymousFunction:function(b,a){var f;try{f=this.findFunctionName(this.getSource(b),a)}catch(d){f="getSource failed with url: "+b+", exception: "+d.toString()}return f},
findFunctionName:function(b,a){for(var f=/function\s+([^(]*?)\s*\(([^)]*)\)/,d=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*function\b/,e=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*(?:eval|new Function)\b/,c="",h,i=Math.min(a,20),j,k=0;k<i;++k)if(h=b[a-k-1],j=h.indexOf("//"),0<=j&&(h=h.substr(0,j)),h)if(c=h+c,(h=d.exec(c))&&h[1]||(h=f.exec(c))&&h[1]||(h=e.exec(c))&&h[1])return h[1];return"(?)"}};XML3D.debug.printStackTrace=c})();
(function(c){var b=function(){};b.prototype={constructor:b,addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var d=this._listeners;void 0===d[a]&&(d[a]=[]);-1===d[a].indexOf(b)&&d[a].push(b)},hasEventListener:function(a,b){if(void 0===this._listeners)return!1;var d=this._listeners;return void 0!==d[a]&&-1!==d[a].indexOf(b)?!0:!1},removeEventListener:function(a,b){if(void 0!==this._listeners){var d=this._listeners,e=d[a].indexOf(b);-1!==e&&d[a].splice(e,1)}},dispatchEvent:function(a){if(void 0!==
this._listeners){var b=this._listeners[a.type];if(void 0!==b){a.target=this;for(var d=0,e=b.length;d<e;d++)b[d].call(this,a)}}}};c.EventDispatcher=b})(XML3D.util);
(function(c){var b={VERSION:"2.2.0",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,ASYNC:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(a,f){var d="string"==typeof a.initial?{state:a.initial}:a.initial,e=f||a.target||{},c=a.events||[],h=a.callbacks||{},i={},j=function(a){var e=a.from instanceof Array?a.from:a.from?[a.from]:[b.WILDCARD];i[a.name]=i[a.name]||{};for(var f=0;f<e.length;f++)i[a.name][e[f]]=a.to||e[f]};d&&(d.event=
d.event||"startup",j({name:d.event,from:"none",to:d.state}));for(var k=0;k<c.length;k++)j(c[k]);for(var l in i)i.hasOwnProperty(l)&&(e[l]=b.buildEvent(l,i[l]));for(l in h)h.hasOwnProperty(l)&&(e[l]=h[l]);e.current="none";e.is=function(a){return this.current==a};e.can=function(a){return!this.transition&&(i[a].hasOwnProperty(this.current)||i[a].hasOwnProperty(b.WILDCARD))};e.cannot=function(a){return!this.can(a)};e.error=a.error||function(a,b,e,f,d,c,g){throw g||c;};if(d&&!d.defer)e[d.event]();return e},
doCallback:function(a,f,d,e,c,h){if(f)try{return f.apply(a,[d,e,c].concat(h))}catch(i){return a.error(d,e,c,h,b.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",i)}},beforeEvent:function(a,f,d,e,c){return b.doCallback(a,a["onbefore"+f],f,d,e,c)},afterEvent:function(a,f,d,e,c){return b.doCallback(a,a["onafter"+f]||a["on"+f],f,d,e,c)},leaveState:function(a,f,d,e,c){return b.doCallback(a,a["onleave"+d],f,d,e,c)},enterState:function(a,f,d,e,c){return b.doCallback(a,
a["onenter"+e]||a["on"+e],f,d,e,c)},changeState:function(a,f,d,e,c){return b.doCallback(a,a.onchangestate,f,d,e,c)},buildEvent:function(a,f){return function(){var d=this.current,e=f[d]||f[b.WILDCARD]||d,c=Array.prototype.slice.call(arguments);if(this.transition)return this.error(a,d,e,c,b.Error.PENDING_TRANSITION,"event "+a+" inappropriate because previous transition did not complete");if(this.cannot(a))return this.error(a,d,e,c,b.Error.INVALID_TRANSITION,"event "+a+" inappropriate in current state "+
this.current);if(!1===b.beforeEvent(this,a,d,e,c))return b.Result.CANCELLED;if(d===e)return b.afterEvent(this,a,d,e,c),b.Result.NOTRANSITION;var h=this;this.transition=function(){h.transition=null;h.current=e;b.enterState(h,a,d,e,c);b.changeState(h,a,d,e,c);b.afterEvent(h,a,d,e,c)};this.transition.cancel=function(){h.transition=null;b.afterEvent(h,a,d,e,c)};var i=b.leaveState(this,a,d,e,c);if(!1===i)return this.transition=null,b.Result.CANCELLED;if("async"===i)return b.Result.ASYNC;this.transition&&
this.transition();return b.Result.SUCCEEDED}}};c.StateMachine=b})(this);
var SimplexNoise=function(c){void 0==c&&(c=Math);this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];this.p=[];for(var b=0;256>b;b++)this.p[b]=Math.floor(256*c.random());this.perm=[];for(b=0;512>b;b++)this.perm[b]=this.p[b&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],
[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};
SimplexNoise.prototype.dot=function(c,b,a){return c[0]*b+c[1]*a};
SimplexNoise.prototype.noise=function(c,b){var a,f,d;d=0.5*(Math.sqrt(3)-1);d*=c+b;var e=Math.floor(c+d),g=Math.floor(b+d),h=(3-Math.sqrt(3))/6;d=(e+g)*h;a=c-(e-d);var i=b-(g-d),j,k;a>i?(j=1,k=0):(j=0,k=1);f=a-j+h;var l=i-k+h;d=a-1+2*h;var h=i-1+2*h,m=e&255,g=g&255,e=this.perm[m+this.perm[g]]%12;j=this.perm[m+j+this.perm[g+k]]%12;k=this.perm[m+1+this.perm[g+1]]%12;g=0.5-a*a-i*i;0>g?a=0:(g*=g,a=g*g*this.dot(this.grad3[e],a,i));i=0.5-f*f-l*l;0>i?f=0:(i*=i,f=i*i*this.dot(this.grad3[j],f,l));l=0.5-d*
d-h*h;0>l?d=0:(l*=l,d=l*l*this.dot(this.grad3[k],d,h));return 70*(a+f+d)};
SimplexNoise.prototype.noise3d=function(c,b,a){var f,d,e,g=(c+b+a)*(1/3),h=Math.floor(c+g),i=Math.floor(b+g),j=Math.floor(a+g),g=1/6;e=(h+i+j)*g;f=c-(h-e);d=b-(i-e);var k=a-(j-e),l,m,r,p,q,n;f>=d?d>=k?(l=1,r=m=0,q=p=1,n=0):(f>=k?(l=1,r=m=0):(m=l=0,r=1),p=1,q=0,n=1):d<k?(m=l=0,r=1,p=0,n=q=1):f<k?(l=0,m=1,p=r=0,n=q=1):(l=0,m=1,r=0,q=p=1,n=0);var o=f-l+g,u=d-m+g,x=k-r+g;e=f-p+2*g;var c=d-q+2*g,B=k-n+2*g,a=f-1+3*g,b=d-1+3*g,g=k-1+3*g,h=h&255,w=i&255,s=j&255,i=this.perm[h+this.perm[w+this.perm[s]]]%12,
j=this.perm[h+l+this.perm[w+m+this.perm[s+r]]]%12;p=this.perm[h+p+this.perm[w+q+this.perm[s+n]]]%12;h=this.perm[h+1+this.perm[w+1+this.perm[s+1]]]%12;q=0.6-f*f-d*d-k*k;0>q?f=0:(q*=q,f=q*q*this.dot(this.grad3[i],f,d,k));d=0.6-o*o-u*u-x*x;0>d?d=0:(d*=d,d=d*d*this.dot(this.grad3[j],o,u,x));o=0.6-e*e-c*c-B*B;0>o?e=0:(o*=o,e=o*o*this.dot(this.grad3[p],e,c,B));c=0.6-a*a-b*b-g*g;0>c?a=0:(c*=c,a=c*c*this.dot(this.grad3[h],a,b,g));return 32*(f+d+e+a)};(function(c){var b={create:function(){var a=new Float32Array(6);a[0]=Number.MAX_VALUE;a[1]=Number.MAX_VALUE;a[2]=Number.MAX_VALUE;a[3]=-Number.MAX_VALUE;a[4]=-Number.MAX_VALUE;a[5]=-Number.MAX_VALUE;return a},clone:function(a){var b=new Float32Array(6);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];return b},copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];return a},copyMin:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},copyMax:function(a,b){a[0]=
b[3];a[1]=b[4];a[2]=b[5];return a},extendWithBox:function(a,b){for(var d=0;3>d;d++)a[d]=Math.min(b[d],a[d]),a[d+3]=Math.max(b[d+3],a[d+3]);return a},empty:function(a){a[0]=Number.MAX_VALUE;a[1]=Number.MAX_VALUE;a[2]=Number.MAX_VALUE;a[3]=-Number.MAX_VALUE;a[4]=-Number.MAX_VALUE;a[5]=-Number.MAX_VALUE;return a},isEmpty:function(a){return a[0]>a[3]||a[1]>a[4]||a[2]>a[5]},center:function(a,b){a[0]=0.5*(b[0]+b[3]);a[1]=0.5*(b[1]+b[4]);a[2]=0.5*(b[2]+b[5]);return a},size:function(a,b){a[0]=b[3]-b[0];a[1]=
b[4]-b[1];a[2]=b[5]-b[2];return a},halfSize:function(a,b){a[0]=0.5*(b[3]-b[0]);a[1]=0.5*(b[4]-b[1]);a[2]=0.5*(b[5]-b[2]);return a},transform:function(a,f,d){if(d[0]>d[3]||d[1]>d[4]||d[2]>d[5])b.copy(a,d);else{d=b.clone(d);if(0==f[3]&&0==f[7]&&0==f[11]&&1==f[15]){for(var e=0;3>e;e++){a[e]=a[e+3]=f[12+e];for(var c=0;3>c;c++){var h,i;h=f[4*c+e]*d[c];i=f[4*c+e]*d[c+3];h<i?(a[e]+=h,a[e+3]+=i):(a[e]+=i,a[e+3]+=h)}}return a}throw Error("Matrix is not affine");}}};b.transform2=function(){var a=XML3D.math.mat4.create(),
f=XML3D.math.vec3.create(),d=XML3D.math.vec3.create();return function(e,c,h){b.center(f,h);b.halfSize(d,h);XML3D.math.mat4.copy(a,c);a.set([0,0,0,1],12);for(h=0;16>h;h++)a[h]=Math.abs(a[h]);XML3D.math.vec3.transformMat4(d,d,a);XML3D.math.vec3.transformMat4(f,f,c);e[0]=f[0]-d[0];e[1]=f[1]-d[1];e[2]=f[2]-d[2];e[3]=f[0]+d[0];e[4]=f[1]+d[1];e[5]=f[2]+d[2];return e}}();b.longestSide=function(a){var b=Math.abs(a[3]-a[0]),d=Math.abs(a[4]-a[1]),a=Math.abs(a[5]-a[2]);return Math.max(b,Math.max(d,a))};b.asXML3DBox=
function(a){var b=new window.XML3DBox;b.min._data[0]=a[0];b.min._data[1]=a[1];b.min._data[2]=a[2];b.max._data[0]=a[3];b.max._data[1]=a[4];b.max._data[2]=a[5];return b};b.str=function(a){return"bbox("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};c.bbox=b;c.EMPTY_BOX=b.create()})(XML3D.math);(function(c){function b(a){return{get:function(){return this._data[a]},set:function(b){this._data[a]=b;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!c){var a=function(a,b,e,c){this._data=new Float32Array(3);void 0!==a&&null!==a&&this.set(a,b,e);this._callback="function"==typeof c?c:0},c=a.prototype;c.set=function(a,b,e){a.length&&3<=a.length?(this._data[0]=a[0],this._data[1]=a[1],this._data[2]=a[2]):a._data&&a._data.length&&3===a._data.length?(this._data[0]=a._data[0],this._data[1]=
a._data[1],this._data[2]=a._data[2]):3==arguments.length&&(this._data[0]=a,this._data[1]=b,this._data[2]=e);this._callback&&this._callback(this)};Object.defineProperty(c,"x",b(0));Object.defineProperty(c,"y",b(1));Object.defineProperty(c,"z",b(2));c.toString=function(){return"[object XML3DVec3]"};c.add=function(b){return b._data?new a(this._data[0]+b._data[0],this._data[1]+b._data[1],this._data[2]+b._data[2]):new a(this._data[0]+b.x,this._data[1]+b.y,this._data[2]+b.z)};c.subtract=function(b){return b._data?
new a(this._data[0]-b._data[0],this._data[1]-b._data[1],this._data[2]-b._data[2]):new a(this._data[0]-b.x,this._data[1]-b.y,this._data[2]-b.z)};c.length=function(){return Math.sqrt(this._data[0]*this._data[0]+this._data[1]*this._data[1]+this._data[2]*this._data[2])};c.setVec3Value=function(a){a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!a)throw Error("Wrong format for XML3DVec3::setVec3Value");this._data[0]=+a[1];this._data[1]=+a[2];this._data[2]=+a[3];this._callback&&this._callback(this)};c.multiply=
function(b){return b._data?new a(this._data[0]*b._data[0],this._data[1]*b._data[1],this._data[2]*b._data[2]):new a(this._data[0]*b.x,this._data[1]*b.y,this._data[2]*b.z)};c.scale=function(b){return new a(this._data[0]*b,this._data[1]*b,this._data[2]*b)};c.cross=function(b){return b._data?new a(this._data[1]*b._data[2]-this._data[2]*b._data[1],this._data[2]*b._data[0]-this._data[0]*b._data[2],this._data[0]*b._data[1]-this._data[1]*b._data[0]):new a(this._data[1]*b.z-this._data[2]*b.y,this._data[2]*
b.x-this._data[0]*b.z,this._data[0]*b.y-this._data[1]*b.x)};c.negate=function(){return new a(-this._data[0],-this._data[1],-this._data[2])};c.dot=function(a){return this._data[0]*a.x+this._data[1]*a.y+this._data[2]*a.z};c.normalize=function(){var b=this.length();if(b)b=1/b;else throw Error();return new a(this._data[0]*b,this._data[1]*b,this._data[2]*b)};XML3D.XML3DVec3=a;window.XML3DVec3=a}})(XML3D._native);
(function(c){if(!c){var b=function(a,b,d){var e=this;this._data=new Float32Array(4);this._axis=new window.XML3DVec3(0,0,1,function(){e._updateQuaternion();e._callback&&e._callback(e)});this._angle=0;this._updateQuaternion();void 0!==a&&null!==a&&this.set(a,b);this._callback="function"==typeof d?d:0},c=b.prototype;c.set=function(a,b){a.axis&&void 0!==a.angle?this.setAxisAngle(a.axis,a.angle):a.length&&4<=a.length?this._setQuaternion(a):a._data&&a._data.length&&3===a._data.length?this.setAxisAngle(a,
b):XML3D.debug.logError("XML3DRotation.set(): invalid argument given. Expect XML3DRotation or Float32Array.")};Object.defineProperty(c,"axis",{get:function(){return this._axis},set:function(){throw Error("Can't set axis. XML3DRotation::axis is readonly.");},configurable:!1,enumerable:!1});Object.defineProperty(c,"angle",{get:function(){return this._angle},set:function(a){this._angle=a;this._updateQuaternion();this._callback&&this._callback(this)},configurable:!1,enumerable:!1});c.toString=function(){return"[object XML3DRotation]"};
c.setAxisAngle=function(a,b){if("object"!=typeof a||isNaN(b))throw Error("Illegal axis and/or angle values: ( axis="+a+" angle="+b+" )");this._axis._data[0]=a._data[0];this._axis._data[1]=a._data[1];this._axis._data[2]=a._data[2];this._angle=b;this._updateQuaternion();this._callback&&this._callback(this)};c.setRotation=function(a,b){var d=a.normalize(),e=b.normalize(),c=d.cross(e);c.length()||(c=Math.abs(d._data[1])>=0.9*Math.abs(d._data[0])&&Math.abs(d._data[2])>=0.9*Math.abs(d._data[0])?new window.XML3DVec3(0,
-d._data[2],d._data[1]):Math.abs(d._data[0])>=0.9*Math.abs(d._data[1])&&Math.abs(d._data[2])>=0.9*Math.abs(d._data[1])?new window.XML3DVec3(-d._data[2],0,d._data[0]):new window.XML3DVec3(-d._data[1],d._data[0],0));this.setAxisAngle(c,Math.acos(d.dot(e)))};c._updateQuaternion=function(){var a=this._axis.length();1.0E-5<a?(a=Math.sin(this._angle/2)/a,this._data[0]=this._axis.x*a,this._data[1]=this._axis.y*a,this._data[2]=this._axis.z*a,this._data[3]=Math.cos(this._angle/2)):XML3D.math.quat.set(this._data,
0,0,0,1)};c.setAxisAngleValue=function(a){var b=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!b)throw Error("Could not parse AxisAngle string: "+a);this.setAxisAngle(new window.XML3DVec3(+b[1],+b[2],+b[3]),+b[4])};c.interpolate=function(a,f){var d=XML3D.math.quat.create(),e=new b;XML3D.math.quat.slerp(d,this._data,a._data,f);e._setQuaternion(d);return e};c.setQuaternion=function(a,b){this._setQuaternion([a.x,a.y,a.z,b])};c.toMatrix=function(){var a=XML3D.math.quat.copy(XML3D.math.quat.create(),
this._data),b=new window.XML3DMatrix;XML3D.math.mat4.fromRotationTranslation(b._data,a,[0,0,0]);return b};c.rotateVec3=function(a){var b=new window.XML3DVec3;XML3D.math.vec3.transformQuat(b._data,a._data,this._data);return b};c._setQuaternion=function(a){var b=Math.sqrt(1-a[3]*a[3]);0.001>b||isNaN(b)?(this._axis._data[0]=0,this._axis._data[1]=0,this._axis._data[2]=1,this._angle=0):(b=1/b,this._axis._data[0]=a[0]*b,this._axis._data[1]=a[1]*b,this._axis._data[2]=a[2]*b,this._angle=2*Math.acos(a[3]));
this._data=XML3D.math.quat.copy(XML3D.math.quat.create(),a);this._callback&&this._callback(this)};c.multiply=function(a){var f=new b,d=XML3D.math.quat.create();XML3D.math.quat.multiply(d,this._data,a._data);f._setQuaternion(d);return f};c.normalize=function(){var a=this._axis.normalize();return new b(a,this._angle)};c.getQuaternion=function(){return XML3D.math.quat.copy(XML3D.math.quat.create(),this._data)};c.setFromBasis=function(a,b,d){var e=XML3D.math.quat.create();XML3D.math.quat.setFromBasis(a._data,
b._data,d._data,e);this._setQuaternion(e)};XML3D.XML3DRotation=b;window.XML3DRotation=b}})(XML3D._native);
(function(c){c||(c=function(b,a,f){var d=this,e=function(){d._callback&&d._callback(d)};this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,e);this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,e);b&&b.min?(this._min.set(b.min),this._max.set(b.max)):(b&&this._min.set(b),a&&this._max.set(a));this._callback="function"==typeof f?f:0},Object.defineProperty(c.prototype,"min",{get:function(){return this._min},set:function(){throw Error("XML3DBox::min is readonly.");
},configurable:!1,enumerable:!1}),Object.defineProperty(c.prototype,"max",{get:function(){return this._max},set:function(){throw Error("XML3DBox::max is readonly.");},configurable:!1,enumerable:!1}),c.prototype.size=function(){var b=this._max.subtract(this._min);0>b.x&&(b.x=0);0>b.y&&(b.y=0);0>b.z&&(b.z=0);return b},c.prototype.center=function(){return this._min.add(this._max).scale(0.5)},c.prototype.makeEmpty=function(){this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);
this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);this._callback&&this._callback(this)},c.prototype.isEmpty=function(){return this._min.x>this._max.x||this._min.y>this._max.y||this._min.z>this._max.z},c.prototype.toString=function(){return"[object XML3DBox]"},c.prototype.set=function(b){this._min.set(b.min);this._max.set(b.max);this._callback&&this._callback(this)},c.prototype.extend=function(b){if(b){var a;if(b.constructor===window.XML3DBox)a=b.min,b=b.max;else if(b.constructor===
window.XML3DVec3)a=b;else return;a.x<this._min.x&&(this._min.x=a.x);a.y<this._min.y&&(this._min.y=a.y);a.z<this._min.z&&(this._min.z=a.z);b.x>this._max.x&&(this._max.x=b.x);b.y>this._max.y&&(this._max.y=b.y);b.z>this._max.z&&(this._max.z=b.z)}},XML3D.XML3DBox=c,window.XML3DBox=c)})(XML3D._native);
(function(c){function b(a){return{get:function(){return this._data[a]},set:function(b){this._data[a]=b;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!c){var a=function(a,b,e,c,h,i,j,k,l,m,r,p,q,n,o,u,x){"number"==typeof a&&16<=arguments.length?(this.set(a,b,e,c,h,i,j,k,l,m,r,p,q,n,o,u),this._callback="function"==typeof x?x:0):"object"==typeof a&&1==arguments.length?this.set(a):(this._data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._callback="function"==typeof a?
a:0)},c=a.prototype;Object.defineProperty(c,"m11",b(0));Object.defineProperty(c,"m12",b(1));Object.defineProperty(c,"m13",b(2));Object.defineProperty(c,"m14",b(3));Object.defineProperty(c,"m21",b(4));Object.defineProperty(c,"m22",b(5));Object.defineProperty(c,"m23",b(6));Object.defineProperty(c,"m24",b(7));Object.defineProperty(c,"m31",b(8));Object.defineProperty(c,"m32",b(9));Object.defineProperty(c,"m33",b(10));Object.defineProperty(c,"m34",b(11));Object.defineProperty(c,"m41",b(12));Object.defineProperty(c,
"m42",b(13));Object.defineProperty(c,"m43",b(14));Object.defineProperty(c,"m44",b(15));c.set=function(a,b,e,c,h,i,j,k,l,m,r,p,q,n,o,u){"number"==typeof a&&16<=arguments.length?this._data=new Float32Array(arguments):a._data&&a._data.length&&16===a._data.length?this._data=new Float32Array(a._data):a.length&&16<=a.length?this._data=new Float32Array(a):XML3D.debug.logError("XML3DMatrix.set(): invalid parameter(s). Expect XML3DMatrix, Float32Array or 16 numbers.")};c.toString=function(){return"[object XML3DMatrix]"};
c.setMatrixValue=function(a){a=/^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)$/.exec(a);if(!a)throw{code:DOMException.SYNTAX_ERR,message:"SYNTAX_ERR: DOM Exception 12"};if(17!=a.length)throw{code:DOMException.SYNTAX_ERR,message:"Illegal number of elements: "+(a.length-1)+"expected: 16"};this._data=new Float32Array(a.slice(1));this._callback&&this._callback(this)};c.multiply=function(b){var d=new a;XML3D.math.mat4.multiply(d._data,
this._data,b._data);return d};c.inverse=function(){var b=new a;b._data=XML3D.math.mat4.invert(b._data,this._data);if(null==b._data||isNaN(b._data[0]))throw Error("Trying to invert matrix that is not invertable.");return b};c.rotate=function(b,d,e){var c=new a;if(void 0===d&&void 0===e)return XML3D.math.mat4.rotateZ(c._data,this._data,b),c;XML3D.math.mat4.rotateZ(c._data,this._data,e);XML3D.math.mat4.rotateY(c._data,c._data,d);XML3D.math.mat4.rotateX(c._data,c._data,b);return c};c.rotateAxisAngle=
function(b,d,e,c){var h=new a;XML3D.math.mat4.rotate(h._data,this._data,c,[b,d,e]);return h};c.scale=function(b,d,e){var c=new a;e||(e=1);d||(d=b);XML3D.math.mat4.scale(c._data,this._data,[b,d,e]);return c};c.translate=function(b,d,e){var c=new a;XML3D.math.mat4.translate(c._data,this._data,[b,d,e]);return c};XML3D.XML3DMatrix=a;window.XML3DMatrix||(window.XML3DMatrix=a)}})(XML3D._native);
(function(c){if(!c){var c=function(a,b,d){var e=this,c=function(){e._callback&&e._callback(e)};this._origin=new window.XML3DVec3(0,0,0,c);this._direction=new window.XML3DVec3(0,0,-1,c);a&&a.origin?this.set(a,b):(a&&this._origin.set(a),b&&this._direction.set(b));this._callback="function"==typeof d?d:0},b=c.prototype;Object.defineProperty(b,"origin",{get:function(){return this._origin},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});Object.defineProperty(b,
"direction",{get:function(){return this._direction},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});b.set=function(a){this._origin.set(a.origin);this._direction.set(a.direction);this._callback&&this._callback(this)};b.toString=function(){return"[object XML3DRay]"};XML3D.XML3DRay=c;window.XML3DRay=c}})(XML3D._native);
(function(c){function b(a){switch(a){case Xflow.DATA_TYPE.FLOAT:return d.FLOAT;case Xflow.DATA_TYPE.FLOAT2:return d.FLOAT2;case Xflow.DATA_TYPE.FLOAT3:return d.FLOAT3;case Xflow.DATA_TYPE.FLOAT4:return d.FLOAT4;case Xflow.DATA_TYPE.FLOAT4X4:return d.FLOAT4X4;case Xflow.DATA_TYPE.INT:return d.INT;case Xflow.DATA_TYPE.INT4:return d.INT4;case Xflow.DATA_TYPE.BOOL:return d.BOOL;case Xflow.DATA_TYPE.TEXTURE:return d.TEXTURE;case Xflow.DATA_TYPE.BYTE:return d.BYTE;case Xflow.DATA_TYPE.UBYTE:return d.UBYTE;
default:throw Error("WHAT IS THIS I DON'T EVEN...");}}if(!c){var a=[],c=function(a){this.callback=a;this.observed=[]};window.XML3DDataObserver=c;c.prototype.observe=function(b,d){if(!b)throw Error("The node to observe is null.");if(!b._configured)throw Error("Note to observe is not configured (yet). Make sure to pass an XML3D node and to execute this function after XML3D has been configured e.g. inside a DOMContentLoaded listener.");var f=XML3D.base.resourceManager.getAdapter(b,XML3D.data);if(!f)throw Error("Can't observe node. XML3DataObserver can only observe data containers such as <data>, <mesh> or <shader>");
0==this.observed.length&&a.push(this);var c={node:b,changed:!1,request:null},j=d&&d.names;"String"===Object.prototype.toString.call(j).slice(8,-1)&&(j=[j]);c.request=f.getComputeRequest(j,function(){c.changed=!0});c.request.getResult();this.observed.push(c)};c.prototype.disconnect=function(){for(var b=0;b<this.observed.length;++b)this.observed[b].request.clear();this.observed=[];for(b=a.length;b--;)a[b]==this&&a.splice(b,1)};XML3D.updateXflowObserver=function(){for(var b=0;b<a.length;++b){for(var c=
a[b],h=[],i=0;i<c.observed.length;++i){var j=c.observed[i];if(j.changed){j.changed=!1;var k=j.request.getResult(),k=new d(k);h.push(new f(j.node,k))}}0<h.length&&c.callback&&c.callback(h,c)}};var f=function(a,b){this.target=a;this.result=b};window.XML3DDataRecord=f;var d=function(a){this._entries={};for(var d=0;d<a.outputNames.length;++d){var f=a.outputNames[d],c=a.getOutputData(f),j=c&&c.getValue();null!==j&&(c=b(c.type),this._entries[f]={type:c,value:j})}};window.XML3DDataResult=d;d.prototype.getValue=
function(a){return this._entries[a]?this._entries[a].value:null};d.prototype.getType=function(a){return this._entries[a]?this._entries[a].type:null};d.prototype.getNames=function(){var a=[],b;for(b in this._entries)a.push(b);return a};d.FLOAT=0;d.FLOAT2=1;d.FLOAT3=2;d.FLOAT4=3;d.FLOAT4X4=4;d.INT=10;d.INT4=11;d.BOOL=20;d.TEXTURE=30;d.BYTE=40;d.UBYTE=50;c=function(a,d,f,c,j,k){this.type=b(a);this.origin=d;this.originalName=f;this.seqLength=c;this.seqMinKey=j;this.seqMaxKey=k};window.XML3DDataChannelInfo=
c;c.ORIGIN_CHILD=1;c.ORIGIN_COMPUTE=2;c.ORIGIN_PROTO=3}})(XML3D._native);(function(c){function b(a){for(var b in this.connectedAdapterHandles)this.connectedAdapterHandles[b]==a.adapterHandle&&this.notifyChanged(new c.events.ConnectedAdapterNotification(a,b))}c.base={toString:function(){return"base"}};c.base.Adapter=function(a){this.factory=a};c.base.Adapter.prototype.connectAdapterHandle=function(a,f){this.connectedAdapterHandles||(this.connectedAdapterHandles={},this._bindedAdapterHandleCallback=b.bind(this));this.disconnectAdapterHandle(a);f?(this.connectedAdapterHandles[a]=
f,this.connectedAdapterHandles[a].addListener(this._bindedAdapterHandleCallback)):delete this.connectedAdapterHandles[a]};c.base.Adapter.prototype.disconnectAdapterHandle=function(a){this.connectedAdapterHandles&&this.connectedAdapterHandles[a]&&(this.connectedAdapterHandles[a].removeListener(this._bindedAdapterHandleCallback),delete this.connectedAdapterHandles[a])};c.base.Adapter.prototype.clearAdapterHandles=function(){for(var a in this.connectedAdapterHandles)this.connectedAdapterHandles[a].removeListener(this._bindedAdapterHandleCallback);
this.connectedAdapterHandles={}};c.base.Adapter.prototype.getConnectedAdapterHandle=function(a){return this.connectedAdapterHandles&&this.connectedAdapterHandles[a]};c.base.Adapter.prototype.getConnectedAdapter=function(a){return(a=this.getConnectedAdapterHandle(a))&&a.getAdapter()};c.base.Adapter.prototype.onDispose=function(){};c.base.NodeAdapter=function(a,b){c.base.Adapter.call(this,a);this.node=b};c.createClass(c.base.NodeAdapter,c.base.Adapter);c.base.NodeAdapter.prototype.init=function(){};
c.base.NodeAdapter.prototype.notifyChanged=function(){};c.base.NodeAdapter.prototype.getAdapterHandle=function(a,b,d){d=void 0===d?this.factory.canvasId:0;return c.base.resourceManager.getAdapterHandle(this.node.ownerDocument,a,b||this.factory.aspect,d)};c.base.NodeAdapter.prototype.notifyOppositeAdapters=function(a){a=a||c.events.ADAPTER_HANDLE_CHANGED;return c.base.resourceManager.notifyNodeAdapterChange(this.node,this.factory.aspect,this.factory.canvasId,a)};c.base.NodeAdapter.prototype.traverse=
function(a){a(this);for(var b=this.node.firstElementChild;b;){var d=this.factory.getAdapter(b);d&&d.traverse(a);b=b.nextElementSibling}};c.base.IFactory=function(){};c.base.AdapterFactory=function(a,b,d){this.aspect=a;this.canvasId=d||0;this.mimetypes="string"==typeof b?[b]:b;c.base.registerFactory(this)};c.base.AdapterFactory.prototype.createAdapter=function(){return null};c.base.AdapterFactory.prototype.supportsMimetype=function(a){return-1!=this.mimetypes.indexOf(a)};c.base.NodeAdapterFactory=
function(a,b){c.base.AdapterFactory.call(this,a,["text/xml","application/xml"],b)};c.createClass(c.base.NodeAdapterFactory,c.base.AdapterFactory);c.base.NodeAdapterFactory.prototype.getAdapter=function(a){a&&void 0===a._configured&&c.config.element(a,!0);if(!a||void 0===a._configured)return null;var b=a._configured,d=this.aspect+"_"+this.canvasId,e=b.adapters[d];if(void 0!==e)return e;if(e=this.createAdapter(a))b.adapters[d]=e,e.init();return e};c.base.callAdapterFunc=function(a,b){var d=[];if(!a||
void 0===a._configured)return d;var e=a._configured.adapters,c;for(c in e)for(var h in b){var i=e[c],j=i[h];j&&d.push(j.apply(i,b[h]))}return d};c.base.sendAdapterEvent=function(a,b){if(!a||void 0===a._configured)return!1;var d=a._configured.adapters,e;for(e in d)for(var c in b){var h=d[e][c];h&&h.apply(d[e],b[c])}return!0}})(window.XML3D);
(function(c){var b=function(a){this.url=a;this.adapter=null;this.listeners=[];this.status=0};b.STATUS={LOADING:0,NOT_FOUND:1,READY:2};b.prototype.hasAdapter=function(){return null!=this.adapter};b.prototype.getAdapter=function(){return this.adapter};b.prototype.setAdapter=function(a,b){this.adapter=a;this.status=b;this.notifyListeners(c.events.ADAPTER_HANDLE_CHANGED)};b.prototype.notifyListeners=function(a){for(var a=new c.events.AdapterHandleNotification(this,a),b=this.listeners.length;b--;)this.listeners[b](a)};
b.prototype.addListener=function(a){-1==this.listeners.indexOf(a)&&this.listeners.push(a)};b.prototype.removeListener=function(a){a=this.listeners.indexOf(a);-1!=a&&this.listeners.splice(a,1)};c.base.AdapterHandle=b})(window.XML3D);
(function(){function c(a){var b=r[a];b||(b={counter:0,listeners:[]},r[a]=b);return b}function b(a){var b=a.listeners;a.listeners=[];for(a=b.length;a--;)b[a](this)}function a(a){if(a=r[a])XML3D.debug.assert(0<a.counter,"counter must be > 0"),a.counter--,0==a.counter&&b(a)}function f(a){for(var b in q)if(a==q[b])return!0;return!1}function d(a){for(var b in n)if(-1!==a.indexOf(n[b],a.length-n[b].length))return!0;return!1}function e(a){var b=null;try{b=new XMLHttpRequest}catch(e){b=null}b&&(b._url=a,
b._contentChecked=!1,b.open("GET",a,!0),d(a)&&(b.responseType="arraybuffer"),b.onreadystatechange=function(){if(!b._aborted){if(!b._contentChecked&&(b.readyState==2||b.readyState==3||b.readyState==4)&&b.status==200){b._contentChecked=true;var a=b.getResponseHeader("content-type");if(a){a=f(a);if(a!=(b.responseType=="arraybuffer")){b._aborted=true;var e=b.onreadystatechange;b.onreadystatechange=null;var d=b._url;b.abort();b=new XMLHttpRequest;b._url=d;b._contentChecked=true;b.open("GET",d,true);if(a)b.responseType=
"arraybuffer";b.onreadystatechange=e;b.send(null);return}}}if(b.readyState==4)if(b.status==200){XML3D.debug.logDebug("Loaded: "+b._url);XML3D.xmlHttpCallback&&XML3D.xmlHttpCallback(b);var a=b,c=a.getResponseHeader("content-type");a:{var h=a._url,e=k[h],d=e.mimetype=c;c.indexOf(";")>0&&(d=c.substr(0,c.indexOf(";")));var j=null;if(a.responseType=="arraybuffer")j=a.response;else if(d=="application/json")j=JSON.parse(a.responseText);else if(d=="application/xml"||d=="text/xml"){j=a.responseXML;if(!j){XML3D.debug.logError("Invalid external XML document '"+
a._url+"': XML Syntax error");break a}}else{d=="application/octet-stream"||c=="text/plain; charset=x-user-defined"?XML3D.debug.logError("Possibly wrong loading of resource "+h+". Mimetype is "+c+" but response is not an ArrayBuffer"):XML3D.debug.logError("Unidentified response type (response = '"+a.response+"', responseType = '"+a.responseType+"')");j=a.response}if(c=XML3D.base.findFormat(j,a.responseType,d)){e.format=c;e.response=c.getFormatData(j,a.responseType,d)}else XML3D.debug.logError("No format handler for resource (response = '"+
j+"', responseType = '"+a.responseType+"')")}a=a._url;d=k[a];e=d.fragments;d.fragments=[];for(d=0;d<e.length;++d)g(a,e[d])}else{XML3D.debug.logError("Could not load external document '"+b._url+"': "+b.status+" - "+b.statusText);a=b._url;d=k[a];e=d.fragments;d.fragments=[];for(d=0;d<e.length;++d)i(a+(e[d]?"#"+e[d]:""))}}},b.send(null))}function g(a,b){var e=k[a].response,d=k[a].format,f=a+(b?"#"+b:"");e?(e=d.getFragmentData(e,b))?h(f,d,e):i(f):i(f)}function h(b,e,d){for(var f in m[b])for(var c in m[b][f]){var g=
m[b][f][c];g.hasAdapter()||(j(g,f,c,e,d),a(c,b))}}function i(b){for(var e in m[b])for(var d in m[b][e])m[b][e][d].setAdapter(null,XML3D.base.AdapterHandle.STATUS.NOT_FOUND),a(d,b)}function j(a,b,e,d,f){(e=d.getFactory(b,e))?(b=e.getAdapter?e.getAdapter(f):e.createAdapter(f))&&a.setAdapter(b,XML3D.base.AdapterHandle.STATUS.READY):XML3D.debug.logError("Format does not support adapterType "+b)}var k={},l={},m={},r={},p=[],q=["application/octet-stream","text/plain; charset=x-user-defined"],n=[".bin",
".bson"];XML3D.base.registerFactory=function(a){var b=a.canvasId;l[b]||(l[b]=[]);l[b].push(a)};XML3D.base.registerFormat=function(a){a&&p.push(a)};XML3D.base.findFormat=function(a,b,e){for(var d=0;d<p.length;++d){var f=p[d];if(p[d].isFormatSupported(a,b,e))return f}return null};var o=function(){};o.prototype.addLoadCompleteListener=function(a,b){var e=r[a];void 0===e||0==e.counter?b(a):-1==e.listeners.indexOf(b)&&e.listeners.push(b)};o.prototype.removeLoadCompleteListener=function(a,b){var e=r[a];
if(e){var d=e.listeners.indexOf(b);-1!=d&&e.listeners.splice(d,1)}};o.prototype.addBinaryContentType=function(a){-1==q.indexOf(a)&&q.push(a)};o.prototype.removeBinaryContentType=function(a){a=q.indexOf(a);-1!=a&&q.splice(a,1)};o.prototype.addBinaryExtension=function(a){-1==n.indexOf(a)&&n.push(a)};o.prototype.removeBinaryExtension=function(a){a=n.indexOf(a);-1!=a&&n.splice(a,1)};o.prototype.getAdapterHandle=function(a,b,d,f){if(!b)return null;"string"==typeof b&&(b=new XML3D.URI(b));f=f||0;if(a!=
document||!b.isLocal())b=b.getAbsoluteURI(a.documentURI);m[b]||(m[b]={});m[b][d]||(m[b][d]={});if(a=m[b][d][f])return a;a=new XML3D.base.AdapterHandle(b);m[b][d][f]=a;b.isLocal()?(b=XML3D.URIResolver.resolveLocal(b))?j(a,d,f,XML3D.base.xml3dFormatHandler,b):a.setAdapter(null,XML3D.base.AdapterHandle.STATUS.NOT_FOUND):(c(f).counter++,d=b.toStringWithoutFragment(),(f=k[d])&&f.response?g(d,b.fragment):(f||(e(d),k[d]=f={fragments:[]}),f.fragments.push(b.fragment)));return a};o.prototype.getAdapter=function(a,
b,e){return(b=XML3D.base.xml3dFormatHandler.getFactory(b,e))?b.getAdapter(a):null};o.prototype.notifyNodeIdChange=function(a,b,e){for(var d=a;d.parentNode;)d=d.parentNode;if(d==window.document){if(b){var b="#"+b,f;for(f in m[b])for(var c in m[b][f])d=m[b][f][c],d.hasAdapter()&&d.setAdapter(null,XML3D.base.AdapterHandle.STATUS.NOT_FOUND)}e&&h("#"+e,XML3D.base.xml3dFormatHandler,a)}};o.prototype.notifyNodeAdapterChange=function(a,b,e,d){e=e||0;a="#"+a.id;m[a]&&m[a][b]&&m[a][b][e]&&m[a][b][e].notifyListeners(d)};
o.prototype.loadData=function(a,b,e){var c=null;try{c=new XMLHttpRequest}catch(g){c=null}c&&(c._url=a,c._contentChecked=!1,c.open("GET",a,!0),d(a)&&(c.responseType="arraybuffer"),c.onreadystatechange=function(){if(!c._aborted){if(!c._contentChecked&&(c.readyState==2||c.readyState==3||c.readyState==4)&&c.status==200){c._contentChecked=true;var a=c.getResponseHeader("content-type");if(a){a=f(a);if(a!=(c.responseType=="arraybuffer")){c._aborted=true;var d=c.onreadystatechange;c.onreadystatechange=null;
var g=c._url;c.abort();c=new XMLHttpRequest;c._url=g;c._contentChecked=true;c.open("GET",g,true);if(a)c.responseType="arraybuffer";c.onreadystatechange=d;c.send(null);return}}}if(c.readyState==4)if(c.status==200){XML3D.debug.logDebug("Loaded: "+c._url);a=c.getResponseHeader("content-type");d=null;if(c.responseType=="arraybuffer")d=c.response;else if(a=="application/json")d=JSON.parse(c.responseText);else if(a=="application/xml"||a=="text/xml")d=c.responseXML;else if(a=="application/octet-stream"||
a=="text/plain; charset=x-user-defined"){XML3D.debug.logError("Possibly wrong loading of resource "+g+". Mimetype is "+a+" but response is not an ArrayBuffer");d=c.responseText}b&&b(d)}else{XML3D.debug.logError("Could not load external document '"+c._url+"': "+c.status+" - "+c.statusText);e&&e(c)}}},c.send(null))};o.prototype.getImage=function(b,e,d){c(0).counter++;var f=new Image;f.onload=function(d){a(0,b);e(d,f)};f.onerror=function(e){a(0,b);d(e,f)};f.crossOrigin="anonymous";f.src=b;return f};
o.prototype.getVideo=function(b,e,d){function f(){a(0,b)}function g(a){return function(b){a(b,h)}}c(0).counter++;var h=document.createElement("video");h.addEventListener("canplay",f,!0);h.addEventListener("error",f,!0);h.crossorigin="anonymous";h.autoplay=e;for(var i in d)h.addEventListener(i,g(d[i]),!0);h.src=b;return h};XML3D.base.resourceManager=new o})();
(function(){var c=function(){this.factoryClasses={};this.factoryCache={}};c.prototype.registerFactoryClass=function(a){if(!a.prototype.aspect||!XML3D.isSuperclassOf(XML3D.base.AdapterFactory,a))throw Error("factoryClass must be a subclass of XML3D.base.AdapterFactory");this.factoryClasses[a.prototype.aspect]=a};c.prototype.getFactoryClassByAspect=function(a){return this.factoryClasses[a]};c.prototype.getFactory=function(a,b){var b=b||0,d=a+"_"+b,f=this.factoryCache[d];if(!f){f=this.getFactoryClassByAspect(a);
if(!f)return null;f=new f(b);this.factoryCache[d]=f}return f};c.prototype.isFormatSupported=function(){return!1};c.prototype.getFormatData=function(a){return a};c.prototype.getFragmentData=function(a,b){return!b?a:null};var b=function(){c.call(this)};XML3D.createClass(b,c);b.prototype.isFormatSupported=function(a,b,d){return a&&9===a.nodeType&&("application/xml"===d||"text/xml"===d)};b.prototype.getFormatData=function(a){return a};b.prototype.getFragmentData=function(a,b){return a.querySelectorAll("*[id="+
b+"]")[0]};var a=function(){c.call(this)};XML3D.createClass(a,b);a.prototype.isFormatSupported=function(a,d,f){return b.prototype.isFormatSupported.call(this,a,d,f)};a.prototype.getFormatData=function(a){for(var b=a.querySelectorAll("xml3d"),d=0;d<b.length;++d)XML3D.config.element(b[d]);return a};var f=function(){c.call(this)};XML3D.createClass(f,c);f.prototype.isFormatSupported=function(a,b,d){return"application/json"===d};f.prototype.getFormatData=function(a){return a};var d=function(){c.call(this)};
XML3D.createClass(d,c);XML3D.base.JSONFormatHandler=f;XML3D.base.BinaryFormatHandler=d;XML3D.base.XMLFormatHandler=b;XML3D.base.XML3DFormatHandler=a;XML3D.base.xml3dFormatHandler=new a;XML3D.base.FormatHandler=c;XML3D.base.registerFormat(XML3D.base.xml3dFormatHandler)})();(function(){var c={NODE_INSERTED:0,VALUE_MODIFIED:1,NODE_REMOVED:2,THIS_REMOVED:3,ADAPTER_HANDLE_CHANGED:4,ADAPTER_VALUE_CHANGED:5,Notification:function(b){this.type=b}};c.Notification.prototype.toString=function(){return"Notification (type:"+this.type+")"};c.NotificationWrapper=function(b,a){this.wrapped=b;this.type=a};XML3D.createClass(c.NotificationWrapper,c.Notification);c.NotificationWrapper.prototype.toString=function(){return"NotificationWrapper (type:"+this.type+", wrapped: "+this.wrapped+
")"};c.AdapterHandleNotification=function(b,a){this.adapterHandle=b;this.type=a};XML3D.createClass(c.AdapterHandleNotification,c.Notification);c.AdapterHandleNotification.prototype.toString=function(){return"AdapterHandleNotification (type:"+this.type+")"};c.ConnectedAdapterNotification=function(b,a){this.adapter=b.adapterHandle.getAdapter();this.key=a;this.url=b.adapterHandle.url;this.type=b.type;this.handleStatus=b.adapterHandle.status};XML3D.createClass(c.ConnectedAdapterNotification,c.Notification);
c.ConnectedAdapterNotification.prototype.toString=function(){return"ConnectedAdapterNotification (type:"+this.type+", key: "+this.key+")"};XML3D.events=XML3D.events||{};XML3D.extend(XML3D.events,c)})();XML3D.config=XML3D.config||{};XML3D.config.isXML3DElement=function(c){return c.nodeType===Node.ELEMENT_NODE&&c.namespaceURI==XML3D.xml3dNS};
XML3D.config.element=function(c,b){if(void 0===c._configured){var a=XML3D.classInfo[c.localName];if(void 0===a)XML3D.debug.logInfo("Unrecognised element "+c.localName);else{c._configured="xml3d"==c.localName?new XML3D.XML3DHandler(c):new XML3D.ElementHandler(c,b);c._configured.registerAttributes(a);void 0==c.style&&(c.style=null);a=c.firstElementChild;for(XML3D.base.resourceManager.notifyNodeIdChange(c,null,c.getAttribute("id"));a;)XML3D.config.element(a,b),a=a.nextElementSibling}}};
XML3D.config.configure=function(c,b){Array.isArray(c)?Array.forEach(c,function(a){XML3D.config.element(a,b)}):XML3D.config.element(c,b)};
(function(c){if(!c){var c={},b=document.getElementById;c.getElementById=function(a){var e=b.call(this,a);if(e)return e;for(var e=this.getElementsByTagName("*"),f=0;f<e.length;f++){var c=e[f];if(c.getAttribute("id")===a)return c}return null};var a=document.createElementNS;c.createElementNS=function(b,e){var f=a.call(this,b,e);(b==XML3D.xml3dNS||XML3D.classInfo[e.toLowerCase()])&&XML3D.config.element(f,!0);return f};var f=document.createElement;c.createElement=function(a){var b=f.call(this,a);XML3D.classInfo[a.toLowerCase()]&&
XML3D.config.element(b,!0);return b};XML3D.extend(window.document,c)}})(XML3D._native);
if(-1!=navigator.userAgent.indexOf("WebKit")){var attrModifiedWorks=!1,listener=function(){attrModifiedWorks=!0};document.documentElement.addEventListener("DOMAttrModified",listener,!1);document.documentElement.setAttribute("___TEST___",!0);document.documentElement.removeAttribute("___TEST___");document.documentElement.removeEventListener("DOMAttrModified",listener,!1);attrModifiedWorks||(Element.prototype.__setAttribute=HTMLElement.prototype.setAttribute,Element.prototype.setAttribute=function(c,
b){var a=this.getAttribute(c);this.__setAttribute(c,b);var b=this.getAttribute(c),f=document.createEvent("MutationEvent");f.initMutationEvent("DOMAttrModified",!0,!1,this,a||"",b||"",c,null==a?MutationEvent.ADDITION:MutationEvent.MODIFICATION);this.dispatchEvent(f)},Element.prototype.__removeAttribute=HTMLElement.prototype.removeAttribute,Element.prototype.removeAttribute=function(c){var b=this.getAttribute(c);this.__removeAttribute(c);var a=document.createEvent("MutationEvent");a.initMutationEvent("DOMAttrModified",
!0,!1,this,b,"",c,MutationEvent.REMOVAL);this.dispatchEvent(a)})}
(function(){function c(a){var b=a.target._configured,e=b&&b.handlers[a.attrName];if(e){var d=!1;e.setFromAttribute&&(d=e.setFromAttribute(a.newValue,a.prevValue));d||(a=new k.NotificationWrapper(a),a.type=k.VALUE_MODIFIED,b.notify(a))}}function b(b){var e=b.target,d=b.relatedNode._configured;if(d){var c=new k.NotificationWrapper(b);e.nodeType==Node.TEXT_NODE&&d.handlers.value?(c.type=k.VALUE_MODIFIED,d.handlers.value.resetValue()):(c.type=k.NODE_REMOVED,d.notify(c),e._configured&&(c.type=k.THIS_REMOVED,
a(e,c),f(e)));b.stopPropagation()}}function a(b,e){b._configured&&(b._configured.notify(e),b._configured.remove(e));for(var d=b.firstElementChild;d;)a(d,e),d=d.nextElementSibling}function f(a){XML3D.base.resourceManager.notifyNodeIdChange(a,a.id,null);for(a=a.firstElementChild;a;)f(a),a=a.nextElementSibling}function d(a){var b=a.target,d=a.relatedNode._configured;if(d&&a.currentTarget!==b){var f=new k.NotificationWrapper(a);b.nodeType==Node.TEXT_NODE&&d.handlers.value?(f.type=k.VALUE_MODIFIED,d.handlers.value.resetValue()):
(XML3D.config.element(b),f.type=k.NODE_INSERTED,e(b));d.notify(f);a.stopPropagation()}}function e(a){for(var b=a.firstElementChild;b;)e(b),b=b.nextElementSibling;XML3D.base.resourceManager.notifyNodeIdChange(a,null,a.id)}function g(a){a=a.target;XML3D.base.resourceManager.notifyNodeIdChange(a,null,a.id)}function h(a){a=a.target;XML3D.base.resourceManager.notifyNodeIdChange(a,a.id,null)}function i(a,b,e){var d={get:function(){return e[a]}};try{Object.defineProperty(b,a,d)}catch(f){XML3D.debug.logWarning("Can't configure "+
b.nodeName+"::"+a)}}var j={},k=XML3D.events;j.ElementHandler=function(a,e){a&&(this.element=a,this.handlers={},this.adapters={},e&&(a.addEventListener("DOMNodeRemoved",b,!0),a.addEventListener("DOMNodeInserted",d,!0),a.addEventListener("DOMNodeInsertedIntoDocument",g,!0),a.addEventListener("DOMNodeRemovedFromDocument",h,!0),a.addEventListener("DOMAttrModified",c,!0),this.monitoring=!0))};j.ElementHandler.prototype.registerAttributes=function(a){var b=this.element,e;for(e in a)if(void 0===a[e])delete b[e];
else if(void 0!==a[e].a){var d=a[e].id||e,f=new a[e].a(b,d,a[e].params);this.handlers[d]=f;try{Object.defineProperty(b,e,f.desc)}catch(c){XML3D.debug.logWarning("Can't configure "+b.nodeName+"::"+e)}}else void 0!==a[e].m?b[e]=a[e].m:XML3D.debug.logError("Can't configure "+b.nodeName+"::"+e);return b};j.ElementHandler.prototype.registerMixed=function(){this.element.addEventListener("DOMCharacterDataModified",this,!1)};j.ElementHandler.prototype.handleEvent=function(a){XML3D.debug.logDebug(a.type+" at "+
a.currentTarget.localName+"/"+a.target);var b=new k.NotificationWrapper(a);switch(a.type){case "DOMCharacterDataModified":b.type=k.VALUE_MODIFIED,this.handlers.value.resetValue(),this.notify(b)}};j.ElementHandler.prototype.notify=function(a){var b=this.adapters,e;for(e in b)try{b[e].notifyChanged(a)}catch(d){XML3D.debug.logException(d)}};j.ElementHandler.prototype.remove=function(){for(var a in this.adapters){var b=this.adapters[a];if(b.onDispose)b.onDispose();b.clearAdapterHandles&&b.clearAdapterHandles()}this.adapters=
{};for(a in this.handlers)b=this.handlers[a],b.remove&&b.remove()};j.ElementHandler.prototype.toString=function(){return"ElementHandler ("+this.element.nodeName+", id: "+this.element.id+")"};var l="clientHeight,clientLeft,clientTop,clientWidth,offsetHeight,offsetLeft,offsetTop,offsetWidth".split(",");j.XML3DHandler=function(a){j.ElementHandler.call(this,a,!0);var b=document.createElement("canvas");b.width=800;b.height=600;this.canvas=b;for(var e in l)i(l[e],a,b);a.getBoundingClientRect=function(){return b.getBoundingClientRect()}};
XML3D.createClass(j.XML3DHandler,j.ElementHandler);XML3D.extend(XML3D,j)})();
(function(){var c=function(a){switch(a.toLowerCase()){case "true":case "1":return!0;case "false":case "0":return!1;default:return Boolean(a)}},b={},a=function(){this.setter=function(){}};b.IDHandler=function(a,b){this.setFromAttribute=function(b,d){XML3D.base.resourceManager.notifyNodeIdChange(a,d,b)};this.desc={get:function(){return this.getAttribute(b)||""},set:function(a){this.setAttribute(b,a)}}};b.StringAttributeHandler=function(a,b){this.desc={get:function(){return this.getAttribute(b)||""},
set:function(a){this.setAttribute(b,a)}}};b.ReferenceHandler=b.StringAttributeHandler;b.EnumAttributeHandler=function(b,d,f){a.call(this,b);var c=f.d;this.setFromAttribute=function(a){c=(a=a.toLowerCase())&&void 0!==f.e[a]?f.e[a]:f.d;return!1};b.hasAttribute(d)&&this.setFromAttribute(b.getAttribute(d));this.desc={get:function(){return f.e[c]},set:function(a){this.setAttribute(d,a);c=(a="string"==typeof a?a.toLowerCase():void 0)&&void 0!==f.e[a]?f.e[a]:f.d}}};b.EnumAttributeHandler.prototype=new a;
b.EnumAttributeHandler.prototype.constructor=b.EnumAttributeHandler;b.EventAttributeHandler=function(b,d){a.call(this,b);var f=null;this.setFromAttribute=function(){f=null;return!1};this.desc={get:function(){return f?f:!this.hasAttribute(d)||void 0===f?null:eval("crx = function onclick(event){\n  "+this.getAttribute(d)+"\n}")},set:function(a){f="function"==typeof a?a:void 0;this._configured.notify({attrName:d,relatedNode:b})}}};b.EventAttributeHandler.prototype=new a;b.EventAttributeHandler.prototype.constructor=
b.EventAttributeHandler;b.IntAttributeHandler=function(a,b,d){var f=d;this.setFromAttribute=function(c){f=(c=c.match(/^\d+/))?+c[0]:d;a._configured.canvas&&(a._configured.canvas[b]=f);return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));this.desc={get:function(){return f},set:function(a){a=+a;f=isNaN(a)?d:Math.floor(a);this.setAttribute(b,f+"")}}};b.IntAttributeHandler.prototype=new a;b.IntAttributeHandler.prototype.constructor=b.IntAttributeHandler;b.FloatAttributeHandler=function(a,
b,d){var f=d;this.setFromAttribute=function(a){a=+a;f=isNaN(a)?d:a;return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));this.desc={get:function(){return f},set:function(a){a=+a;f=isNaN(a)?d:a;this.setAttribute(b,f+"")}}};b.BoolAttributeHandler=function(a,b,d){var f=d;this.setFromAttribute=function(a){f=c(a+"");return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));this.desc={get:function(){return f},set:function(a){f=Boolean(a);this.setAttribute(b,f+"")}}};b.XML3DVec3AttributeHandler=
function(a,b,d){var f=null,c=this,k=function(d){a.setAttribute(b,d.x+" "+d.y+" "+d.z)};this.setFromAttribute=function(a){f||(f=new window.XML3DVec3(0,0,0,k));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?(f._data[0]=a[1],f._data[1]=a[2],f._data[2]=a[3]):f._data.set(d);return!1};this.desc={get:function(){f||(this.hasAttribute(b)?c.setFromAttribute(this.getAttribute(b)):f=new window.XML3DVec3(d[0],d[1],d[2],k));return f},set:function(){throw Error("Can't set "+a.nodeName+"::"+b+": it's readonly");}}};
b.XML3DRotationAttributeHandler=function(a,b,d){var f=null,c=this,k=function(d){a.setAttribute(b,d.axis.x+" "+d.axis.y+" "+d.axis.z+" "+d.angle)};this.setFromAttribute=function(a){f||(f=new window.XML3DRotation(null,null,k));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?(f._axis._data[0]=+a[1],f._axis._data[1]=+a[2],f._axis._data[2]=+a[3],f._angle=+a[4]):(f._axis._data[0]=d[0],f._axis._data[1]=d[1],f._axis._data[2]=d[2],f._angle=d[3]);f._updateQuaternion();return!1};this.desc={get:function(){f||
(this.hasAttribute(b)?c.setFromAttribute(this.getAttribute(b)):f=new window.XML3DRotation(new window.XML3DVec3(d[0],d[1],d[2]),d[3],k));return f},set:function(){throw Error("Can't set "+a.nodeName+"::"+b+": it's readonly");}}};var f=function(a,b,d){a._configured.registerMixed();return{get:function(){b.value||(b.value=d.parse(a));return b.value},set:function(){throw Error("Can't set "+a.nodeName+"::value: it's readonly");}}},d=function(a){for(var b="",a=a.firstChild;a;)b+=3==a.nodeType?a.textContent:
" ",a=a.nextSibling;return b};b.FloatArrayValueHandler=function(a){var b={};this.desc=f(a,b,this);this.resetValue=function(){b.value=null}};b.FloatArrayValueHandler.prototype.parse=function(a){return(a=d(a).match(/([+\-0-9eE\.]+)/g))?new Float32Array(a):new Float32Array};b.Float2ArrayValueHandler=b.FloatArrayValueHandler;b.Float3ArrayValueHandler=b.FloatArrayValueHandler;b.Float4ArrayValueHandler=b.FloatArrayValueHandler;b.Float4x4ArrayValueHandler=b.FloatArrayValueHandler;b.IntArrayValueHandler=
function(a){var b={};this.desc=f(a,b,this);this.resetValue=function(){b.value=null}};b.IntArrayValueHandler.prototype.parse=function(a){return(a=d(a).match(/([+\-0-9]+)/g))?new Int32Array(a):new Int32Array};b.BoolArrayValueHandler=function(a){var b={};this.desc=f(a,b,this);this.resetValue=function(){b.value=null}};b.BoolArrayValueHandler.prototype.parse=function(a){a=d(a).match(/(true|false|0|1)/ig);return!a?new Uint8Array:(a=Array.map(a,c))?new Uint8Array(a):new Uint8Array};b.StringValueHandler=
function(a){var b={};this.desc=f(a,b,this);this.resetValue=function(){b.value=null}};b.StringValueHandler.prototype.parse=function(a){return d(a)};b.CanvasStyleHandler=function(a,b){var d=a._configured.canvas;this.desc={};this.desc.get=function(){return d.style};this.desc.set=function(){};this.setFromAttribute=function(a){d.setAttribute(b,a)};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b))};b.CanvasClassHandler=function(a,b){var d=a._configured.canvas;d.className="_xml3d";this.desc={};
this.desc.get=function(){return d.className};this.desc.set=function(a){d.className=a};this.setFromAttribute=function(a){d.setAttribute(b,a+" _xml3d")};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b))};XML3D.extend(XML3D,b)})();XML3D.methods=XML3D.methods||{};
new function(){function c(a,b){var d={},f;for(f in b){var c=b[f],k=a.getOutputData(c)&&a.getOutputData(c).getValue();k&&(d[c]=k)}return d}var b={xml3dCreateXML3DVec3:function(){return new window.XML3DVec3},xml3dCreateXML3DRay:function(){return new window.XML3DRay},xml3dGetElementByRay:function(){XML3D.debug.logError(this.nodeName+"::getElementByRay is not implemeted yet.");return null},xml3dCreateXML3DMatrix:function(){return new window.XML3DMatrix},xml3dCreateXML3DRotation:function(){return new window.XML3DRotation},
viewGetDirection:function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,0,-1))},viewSetPosition:function(a){this.position=a}},a=XML3D.math.vec3.create(),f=XML3D.math.vec3.create(),d=XML3D.math.vec3.create();XML3D.math.quat.setFromMat3=function(a,b){var d=a[0]+a[4]+a[8];0<d?(d=2*Math.sqrt(d+1),b[0]=(a[7]-a[5])/d,b[1]=(a[2]-a[6])/d,b[2]=(a[3]-a[1])/d,b[3]=0.25*d):a[0]>a[4]&a[0]>a[8]?(d=2*Math.sqrt(1+a[0]-a[4]-a[8]),b[3]=(a[7]-a[5])/d,b[0]=0.25*d,b[1]=(a[1]+a[3])/d,b[2]=(a[2]+a[6])/d):
a[4]>a[8]?(d=2*Math.sqrt(1+a[4]-a[0]-a[8]),b[3]=(a[2]-a[6])/d,b[0]=(a[1]+a[3])/d,b[1]=0.25*d,b[2]=(a[5]+a[7])/d):(d=2*Math.sqrt(1+a[8]-a[0]-a[4]),b[3]=(a[3]-a[1])/d,b[0]=(a[2]+a[6])/d,b[1]=(a[5]+a[7])/d,b[2]=0.25*d)};XML3D.math.quat.setFromBasis=function(a,b,d,f){var c=1/XML3D.math.vec3.length(a),k=1/XML3D.math.vec3.length(b),l=1/XML3D.math.vec3.length(d),m=XML3D.math.mat3.create();m[0]=a[0]*c;m[1]=b[0]*k;m[2]=d[0]*l;m[3]=a[1]*c;m[4]=b[1]*k;m[5]=d[1]*l;m[6]=a[2]*c;m[7]=b[2]*k;m[8]=d[2]*l;XML3D.math.quat.setFromMat3(m,
f)};b.viewSetDirection=function(b){var b=b||new window.XML3DVec3(0,0,-1),b=b.normalize(),c=this.orientation.rotateVec3(new window.XML3DVec3(0,1,0)),c=c.normalize();XML3D.math.vec3.cross(a,b._data,c._data);XML3D.math.vec3.length(a)||(a=this.orientation.rotateVec3(new window.XML3DVec3(1,0,0))._data);XML3D.math.vec3.cross(f,a,b._data);XML3D.math.vec3.negate(d,b._data);b=XML3D.math.quat.create();XML3D.math.quat.setFromBasis(a,f,d,b);this.orientation._setQuaternion(b)};b.viewSetUpVector=function(a){var a=
a||new window.XML3DVec3(0,1,0),a=a.normalize(),b=new window.XML3DRotation;b.setRotation(new window.XML3DVec3(0,1,0),a);b=this.orientation.multiply(b);b=b.normalize();this.orientation.set(b)};b.viewGetUpVector=function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,1,0))};b.viewLookAt=function(a){this.setDirection(a.subtract(this.position))};b.viewGetViewMatrix=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getViewMatrix)return a[b].getViewMatrix();a=this.position;
b=this.orientation;var d=b.axis;return(new window.XML3DMatrix).translate(a.x,a.y,a.z).rotateAxisAngle(d.x,d.y,d.z,b.angle).inverse()};b.xml3dGetElementByPoint=function(a,b,d,f){var c=this._configured.adapters||{},k;for(k in c)if(c[k].getElementByPoint)return c[k].getElementByPoint(a,b,d,f);return null};b.xml3dGenerateRay=function(a,b){var d=this._configured.adapters||{},f;for(f in d)if(d[f].generateRay)return d[f].generateRay(a,b);return new window.XML3DRay};b.groupGetLocalMatrix=function(){var a=
this._configured.adapters||{},b;for(b in a)if(a[b].getLocalMatrix)return a[b].getLocalMatrix();return new window.XML3DMatrix};b.groupGetBoundingBox=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getBoundingBox)return a[b].getBoundingBox();return new window.XML3DBox};b.xml3dGetBoundingBox=b.groupGetBoundingBox;b.meshGetBoundingBox=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getBoundingBox)return a[b].getBoundingBox();return new window.XML3DBox};b.XML3DGraphTypeGetWorldMatrix=
function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getWorldMatrix)return a[b].getWorldMatrix();return new window.XML3DMatrix};b.videoPlay=function(){XML3D.base.sendAdapterEvent(this,{play:[]})};b.videoPause=function(){XML3D.base.sendAdapterEvent(this,{pause:[]})};b.XML3DNestedDataContainerTypeGetOutputNames=b.XML3DShaderProviderTypeGetOutputNames=b.meshGetOutputNames=function(){var a=XML3D.base.resourceManager.getAdapter(this,XML3D.data);return a?a.getOutputNames():null};b.XML3DNestedDataContainerTypeGetResult=
b.XML3DShaderProviderTypeGetResult=b.meshGetResult=function(a){var b=XML3D.base.resourceManager.getAdapter(this,XML3D.data);return b?(a=b.getComputeResult(a),!a?null:new window.XML3DDataResult(a)):null};b.XML3DNestedDataContainerTypeGetOutputChannelInfo=b.XML3DShaderProviderTypeGetOutputChannelInfo=b.meshGetOutputChannelInfo=function(a){var b=XML3D.base.resourceManager.getAdapter(this,XML3D.data);return b?(a=b.getOutputChannelInfo(a),!a?null:new window.XML3DDataChannelInfo(a.type,a.origin,a.originalName,
a.seqLength,a.seqMinKey,a.seqMaxKey)):null};b.XML3DNestedDataContainerTypeGetComputeInfo=b.XML3DShaderProviderTypeGetComputeInfo=b.meshGetComputeInfo=function(){XML3D.debug.logError(this.nodeName+"::getComputeInfo is not implemeted yet.");return null};b.XML3DNestedDataContainerTypeGetProtoInfo=b.XML3DShaderProviderTypeGetProtoInfo=b.meshGetProtoInfo=function(){XML3D.debug.logError(this.nodeName+"::getProtoInfo is not implemeted yet.");return null};b.XML3DNestedDataContainerTypeIsOutputConnected=b.XML3DShaderProviderTypeIsOutputConnected=
b.meshIsOutputConnected=function(){XML3D.debug.logError(this.nodeName+"::isOutputConnected is not implemeted yet.");return!1};b.dataAddOutputFieldListener=function(a,b){if(!a)return!1;"String"===Object.prototype.toString.call(a).slice(8,-1)&&(a=[a]);if(0==a.length)return!1;var d=XML3D.base.callAdapterFunc(this,{getComputeRequest:[a,function(d){b(c(d.getResult(),a))}]});if(0==d.length)return!1;d=d[0].getResult();d=c(d,a);Object.keys(d).length&&b(d);return!0};XML3D.scriptValueLabel="[value set by script]";
b.XML3DDataSourceTypeSetScriptValue=function(a){var b=this._configured;b&&(this.textContent!=XML3D.scriptValueLabel&&(this.textContent=XML3D.scriptValueLabel),b.scriptValue=a,(b=XML3D.base.resourceManager.getAdapter(this,XML3D.data))&&b.setScriptValue(a))};XML3D.extend(XML3D.methods,b)};XML3D.MeshTypes={};XML3D.MeshTypes.triangles=0;XML3D.MeshTypes[0]="triangles";XML3D.MeshTypes.trianglestrips=1;XML3D.MeshTypes[1]="trianglestrips";XML3D.MeshTypes.lines=2;XML3D.MeshTypes[2]="lines";
XML3D.MeshTypes.linestrips=3;XML3D.MeshTypes[3]="linestrips";XML3D.MeshTypes.points=4;XML3D.MeshTypes[4]="points";XML3D.TextureTypes={};XML3D.TextureTypes["2d"]=0;XML3D.TextureTypes[0]="2d";XML3D.TextureTypes["1d"]=1;XML3D.TextureTypes[1]="1d";XML3D.TextureTypes["3d"]=2;XML3D.TextureTypes[2]="3d";XML3D.FilterTypes={};XML3D.FilterTypes.none=0;XML3D.FilterTypes[0]="none";XML3D.FilterTypes.nearest=1;XML3D.FilterTypes[1]="nearest";XML3D.FilterTypes.linear=2;XML3D.FilterTypes[2]="linear";
XML3D.WrapTypes={};XML3D.WrapTypes.clamp=0;XML3D.WrapTypes[0]="clamp";XML3D.WrapTypes.repeat=1;XML3D.WrapTypes[1]="repeat";XML3D.WrapTypes.border=2;XML3D.WrapTypes[2]="border";XML3D.DataFieldType={};XML3D.DataFieldType["float "]=0;XML3D.DataFieldType[0]="float ";XML3D.DataFieldType["float2 "]=1;XML3D.DataFieldType[1]="float2 ";XML3D.DataFieldType.float3=2;XML3D.DataFieldType[2]="float3";XML3D.DataFieldType.float4=3;XML3D.DataFieldType[3]="float4";XML3D.DataFieldType.float4x4=4;
XML3D.DataFieldType[4]="float4x4";XML3D.DataFieldType["int"]=10;XML3D.DataFieldType[10]="int";XML3D.DataFieldType.int4=11;XML3D.DataFieldType[11]="int4";XML3D.DataFieldType.bool=20;XML3D.DataFieldType[20]="bool";XML3D.DataFieldType.texture=30;XML3D.DataFieldType[30]="texture";XML3D.DataChannelOrigin={};XML3D.DataChannelOrigin["origin_value "]=0;XML3D.DataChannelOrigin[0]="origin_value ";XML3D.DataChannelOrigin.origin_child=1;XML3D.DataChannelOrigin[1]="origin_child";
XML3D.DataChannelOrigin.origin_source=2;XML3D.DataChannelOrigin[2]="origin_source";XML3D.DataChannelOrigin.origin_compute=3;XML3D.DataChannelOrigin[3]="origin_compute";XML3D.DataChannelOrigin.origin_proto=4;XML3D.DataChannelOrigin[4]="origin_proto";XML3D.classInfo={};
XML3D.classInfo.xml3d={id:{a:XML3D.IDHandler},className:{a:XML3D.CanvasClassHandler,id:"class"},style:{a:XML3D.CanvasStyleHandler},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},
onkeyup:{a:XML3D.EventAttributeHandler},height:{a:XML3D.IntAttributeHandler,params:600},width:{a:XML3D.IntAttributeHandler,params:800},createXML3DVec3:{m:XML3D.methods.xml3dCreateXML3DVec3},createXML3DRotation:{m:XML3D.methods.xml3dCreateXML3DRotation},createXML3DMatrix:{m:XML3D.methods.xml3dCreateXML3DMatrix},createXML3DRay:{m:XML3D.methods.xml3dCreateXML3DRay},getElementByPoint:{m:XML3D.methods.xml3dGetElementByPoint},generateRay:{m:XML3D.methods.xml3dGenerateRay},getElementByRay:{m:XML3D.methods.xml3dGetElementByRay},
getBoundingBox:{m:XML3D.methods.xml3dGetBoundingBox},activeView:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.compute={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},value:{a:XML3D.StringValueHandler},_term:void 0};
XML3D.classInfo.data={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},filter:{a:XML3D.StringAttributeHandler},getOutputNames:{m:XML3D.methods.XML3DNestedDataContainerTypeGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetComputeInfo},getProtoInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetProtoInfo},isOutputConnected:{m:XML3D.methods.XML3DNestedDataContainerTypeIsOutputConnected},
getResult:{m:XML3D.methods.XML3DNestedDataContainerTypeGetResult},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.dataflow={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},out:{a:XML3D.StringAttributeHandler},getOutputNames:{m:XML3D.methods.XML3DNestedDataContainerTypeGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetComputeInfo},getProtoInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetProtoInfo},isOutputConnected:{m:XML3D.methods.XML3DNestedDataContainerTypeIsOutputConnected},
getResult:{m:XML3D.methods.XML3DNestedDataContainerTypeGetResult},_term:void 0};XML3D.classInfo.defs={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},_term:void 0};
XML3D.classInfo.group={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getLocalMatrix:{m:XML3D.methods.groupGetLocalMatrix},getBoundingBox:{m:XML3D.methods.groupGetBoundingBox},transform:{a:XML3D.ReferenceHandler},shader:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.mesh={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.MeshTypes,d:0}},compute:{a:XML3D.StringAttributeHandler},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getBoundingBox:{m:XML3D.methods.meshGetBoundingBox},getOutputNames:{m:XML3D.methods.meshGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.meshGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.meshGetComputeInfo},getProtoInfo:{m:XML3D.methods.meshGetProtoInfo},isOutputConnected:{m:XML3D.methods.meshIsOutputConnected},
getResult:{m:XML3D.methods.meshGetResult},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.transform={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},translation:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scale:{a:XML3D.XML3DVec3AttributeHandler,params:[1,1,1]},rotation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},center:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scaleOrientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},_term:void 0};
XML3D.classInfo.shader={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},getOutputNames:{m:XML3D.methods.XML3DShaderProviderTypeGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.XML3DShaderProviderTypeGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.XML3DShaderProviderTypeGetComputeInfo},getProtoInfo:{m:XML3D.methods.XML3DShaderProviderTypeGetProtoInfo},isOutputConnected:{m:XML3D.methods.XML3DShaderProviderTypeIsOutputConnected},
getResult:{m:XML3D.methods.XML3DShaderProviderTypeGetResult},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.light={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},global:{a:XML3D.BoolAttributeHandler,params:!1},intensity:{a:XML3D.FloatAttributeHandler,params:1},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},shader:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.lightshader={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},getOutputNames:{m:XML3D.methods.XML3DShaderProviderTypeGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.XML3DShaderProviderTypeGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.XML3DShaderProviderTypeGetComputeInfo},getProtoInfo:{m:XML3D.methods.XML3DShaderProviderTypeGetProtoInfo},isOutputConnected:{m:XML3D.methods.XML3DShaderProviderTypeIsOutputConnected},
getResult:{m:XML3D.methods.XML3DShaderProviderTypeGetResult},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.script={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},value:{a:XML3D.StringValueHandler},src:{a:XML3D.StringAttributeHandler},type:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.proto={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},compute:{a:XML3D.StringAttributeHandler},filter:{a:XML3D.StringAttributeHandler},getOutputNames:{m:XML3D.methods.XML3DNestedDataContainerTypeGetOutputNames},getOutputChannelInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetOutputChannelInfo},getComputeInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetComputeInfo},getProtoInfo:{m:XML3D.methods.XML3DNestedDataContainerTypeGetProtoInfo},isOutputConnected:{m:XML3D.methods.XML3DNestedDataContainerTypeIsOutputConnected},
getResult:{m:XML3D.methods.XML3DNestedDataContainerTypeGetResult},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo["float"]={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.FloatArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo.float2={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float2ArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo.float3={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float3ArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo.float4={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float4ArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo.float4x4={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float4x4ArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo["int"]={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.IntArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo.int4={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.IntArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo.bool={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.BoolArrayValueHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};
XML3D.classInfo.texture={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},param:{a:XML3D.BoolAttributeHandler,params:!1},key:{a:XML3D.FloatAttributeHandler,params:0},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.TextureTypes,d:0}},filterMin:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMag:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMip:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,
d:1}},wrapS:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},wrapT:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},wrapU:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},borderColor:{a:XML3D.StringAttributeHandler},setScriptValue:{m:XML3D.methods.XML3DDataSourceTypeSetScriptValue},_term:void 0};XML3D.classInfo.img={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.video={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},autoplay:{a:XML3D.BoolAttributeHandler,params:!1},play:{m:XML3D.methods.videoPlay},pause:{m:XML3D.methods.videoPause},_term:void 0};
XML3D.classInfo.view={id:{a:XML3D.IDHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},position:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},orientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},fieldOfView:{a:XML3D.FloatAttributeHandler,params:0.785398},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},setDirection:{m:XML3D.methods.viewSetDirection},setUpVector:{m:XML3D.methods.viewSetUpVector},lookAt:{m:XML3D.methods.viewLookAt},getDirection:{m:XML3D.methods.viewGetDirection},getUpVector:{m:XML3D.methods.viewGetUpVector},
getViewMatrix:{m:XML3D.methods.viewGetViewMatrix},perspective:{a:XML3D.ReferenceHandler},_term:void 0};window=this;var Xflow={};
(function(){Xflow.EPSILON=1.0E-6;Xflow.DATA_TYPE={UNKNOWN:0,FLOAT:1,FLOAT2:2,FLOAT3:3,FLOAT4:4,FLOAT4X4:10,INT:20,INT4:21,BOOL:30,TEXTURE:40,BYTE:50,UBYTE:60};Xflow.DATA_TYPE_MAP={"float":Xflow.DATA_TYPE.FLOAT,float2:Xflow.DATA_TYPE.FLOAT2,float3:Xflow.DATA_TYPE.FLOAT3,float4:Xflow.DATA_TYPE.FLOAT4,float4x4:Xflow.DATA_TYPE.FLOAT4X4,"int":Xflow.DATA_TYPE.INT,int4:Xflow.DATA_TYPE.INT4,bool:Xflow.DATA_TYPE.BOOL,texture:Xflow.DATA_TYPE.TEXTURE,"byte":Xflow.DATA_TYPE.BYTE,ubyte:Xflow.DATA_TYPE.UBYTE};Xflow.DATA_TYPE_TUPLE_SIZE=
{};Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT2]=2;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT3]=3;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT4]=4;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.FLOAT4X4]=16;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.INT]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.INT4]=4;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.BOOL]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.TEXTURE]=1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.BYTE]=
1;Xflow.DATA_TYPE_TUPLE_SIZE[Xflow.DATA_TYPE.UBYTE]=1;Xflow.TYPED_ARRAY_MAP={};Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.FLOAT]=Float32Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.FLOAT2]=Float32Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.FLOAT3]=Float32Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.FLOAT4]=Float32Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.FLOAT4X4]=Float32Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.INT]=Int32Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.INT4]=Int32Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.BOOL]=
Int8Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.BYTE]=Int8Array;Xflow.TYPED_ARRAY_MAP[Xflow.DATA_TYPE.UBYTE]=Uint8Array;Xflow.getTypeName=function(a){for(var b in Xflow.DATA_TYPE_MAP)if(Xflow.DATA_TYPE_MAP[b]==a)return b};Xflow.TEX_FILTER_TYPE={NEAREST:9728,LINEAR:9729,MIPMAP_NEAREST:9984,MIPMAP_LINEAR:9985};Xflow.TEX_WRAP_TYPE={CLAMP:33071,REPEAT:10497};Xflow.TEX_TYPE={TEXTURE_2D:3553};Xflow.SHADER_CONSTANT_KEY={WORLD_TRANSFORM:1,VIEW_TRANSFORM:2,SCREEN_TRANSFORM:3,WORLD_TRANSFORM_NORMAL:4,VIEW_TRANSFORM_NORMAL:5,
SCREEN_TRANSFORM_NORMAL:6,OBJECT_ID:7};Xflow.VS_ATTRIB_TRANSFORM={NONE:0,VIEW_POINT:1,WORLD_POINT:2,VIEW_NORMAL:3,WORLD_NORMAL:4};Xflow.DATA_FILTER_TYPE={RENAME:0,KEEP:1,REMOVE:2};Xflow.DATA_ENTRY_STATE={CHANGED_VALUE:1,CHANGED_NEW:2,LOAD_START:3,LOAD_END:4,CHANGED_SIZE:5,CHANGED_REMOVED:6};Xflow.RESULT_TYPE={COMPUTE:0,VS:1};Xflow.RESULT_STATE={NONE:0,CHANGED_DATA_VALUE:1,CHANGED_DATA_SIZE:2,CHANGED_STRUCTURE:3,LOAD_START:4,LOAD_END:5,IMAGE_LOAD_START:6,IMAGE_LOAD_END:7};Xflow.SEQUENCE={NO_ACCESS:0,
PREV_BUFFER:1,NEXT_BUFFER:2,LINEAR_WEIGHT:3};Xflow.ITERATION_TYPE={NULL:0,ONE:1,MANY:2};Xflow.EXTRACT={NO_EXTRAC:0,TEX_WIDTH:1,TEX_HEIGHT:2};Xflow.ORIGIN={CHILD:1,COMPUTE:2,PROTO:3};Xflow.PLATFORM={JAVASCRIPT:0,GLSL:1};Xflow.PROCESS_STATE={MODIFIED:0,LOADING:1,NEEDS_VALIDATION:2,INVALID:3,UNPROCESSED:4,PROCESSED:5};var c=[];Xflow.registerErrorCallback=function(a){c.push(a)};Xflow.notifyError=function(a,b){if(0<c.length)for(var e=0;e<c.length;++e)c[e](a,b)};Xflow.createClass=function(a,b,e){e=e||{};
if(b){var c=function(){};c.prototype=b.prototype;a.prototype=new c;a.prototype.constructor=a;a.superclass=b.prototype}for(var h in e)a.prototype[h]=e[h];return a};var b=[],a=[];Xflow._listCallback=function(f,d){var e;if(-1==(e=b.indexOf(f)))e=b.length,b.push(f);var c=a[e];if(!c||c<d)a[e]=d};Xflow._callListedCallback=function(){if(b.length){for(var f=0;f<b.length;++f)b[f]._onListedCallback(a[f]);b=[];a=[]}}})();
(function(){function c(a,b){for(var d=0;d<e._listeners.length;++d)e._listeners[d](a,b);for(d=0;d<a._listeners.length;++d)a._listeners[d](a,b)}Xflow.SamplerConfig=function(){this.generateMipMap=this.colorB=this.colorG=this.colorR=this.textureType=this.wrapU=this.wrapT=this.wrapS=this.mipFilter=this.magFilter=this.minFilter=0};Xflow.SamplerConfig.prototype.setDefaults=function(){this.magFilter=this.minFilter=Xflow.TEX_FILTER_TYPE.LINEAR;this.mipFilter=Xflow.TEX_FILTER_TYPE.NEAREST;this.wrapU=this.wrapT=
this.wrapS=Xflow.TEX_WRAP_TYPE.CLAMP;this.textureType=Xflow.TEX_TYPE.TEXTURE_2D;this.generateMipMap=this.colorB=this.colorG=this.colorR=0};Xflow.SamplerConfig.prototype.set=function(a){this.minFilter=a.minFilter;this.magFilter=a.magFilter;this.mipFilter=a.mipFilter;this.wrapS=a.wrapS;this.wrapT=a.wrapT;this.wrapU=a.wrapU;this.textureType=a.textureType;this.colorR=a.colorR;this.colorG=a.colorG;this.colorB=a.colorB;this.generateMipMap=a.generateMipMap};var b=Xflow.SamplerConfig;Xflow.DataEntry=function(a){this._type=
a;this._listeners=[];this.userData={}};var a=Xflow.DataEntry;Object.defineProperty(a.prototype,"type",{set:function(){throw Error("type is read-only");},get:function(){return this._type}});a.prototype.addListener=function(a){this._listeners.push(a)};a.prototype.removeListener=function(a){Array.erase(this._listeners,a)};a.prototype._notifyChanged=function(){c(this,Xflow.DATA_ENTRY_STATE.CHANGED_VALUE)};Xflow.BufferEntry=function(a,b){Xflow.DataEntry.call(this,a);this._value=b;c(this,Xflow.DATA_ENTRY_STATE.CHANGED_NEW)};
Xflow.createClass(Xflow.BufferEntry,Xflow.DataEntry);a=Xflow.BufferEntry;a.prototype.setValue=function(a){this._setValue(a);Xflow._callListedCallback()};a.prototype._setValue=function(a){var b=(this._value?this._value.length:0)!=(a?a.length:0);this._value=a;c(this,b?Xflow.DATA_ENTRY_STATE.CHANGED_SIZE:Xflow.DATA_ENTRY_STATE.CHANGED_VALUE)};a.prototype.getValue=function(){return this._value};a.prototype.getLength=function(){return this._value?this._value.length:0};a.prototype.getTupleSize=function(){this._tupleSize||
(this._tupleSize=Xflow.DATA_TYPE_TUPLE_SIZE[this._type]);return this._tupleSize};a.prototype.getIterateCount=function(){return this.getLength()/this.getTupleSize()};a.prototype.isEmpty=function(){return!this._value||!this.getLength()};var f=null,d=null;Xflow.toImageData=function(a){if(a instanceof ImageData)return a;if(!a.data)throw Error("no data property");if(!a.width)throw Error("no width property");if(!a.height)throw Error("no height property");d||(f=document.createElement("canvas"),d=f.getContext("2d"));
for(var b=d.createImageData(a.width,a.height),e=0;e<a.data.length;++e){var c=a.data[e];255<c&&(c=255);0>c&&(c=0);b.data[e]=c}return b};Xflow.TextureEntry=function(a){Xflow.DataEntry.call(this,Xflow.DATA_TYPE.TEXTURE);this._samplerConfig=new b;this._formatType=null;this._loading=!1;this._updateImage(a);c(this,Xflow.DATA_ENTRY_STATE.CHANGED_NEW)};Xflow.createClass(Xflow.TextureEntry,Xflow.DataEntry);a=Xflow.TextureEntry;a.prototype.isLoading=function(){var a=this._image;if(!a)return!1;var b=a.nodeName.toLowerCase();
return"img"==b?!a.complete:"canvas"==b?0>=this._image.width||0>=this._image.height:"video"==b?0==a.readyState||0>=this._image.videoWidth||0>=this._image.videoHeight:!1};a.prototype._updateImage=function(a){this._image=a;this._imageData=this._context=null;this._image?(a=this._image.nodeName.toLowerCase(),"video"==a?(this.width=this._image.videoWidth,this.height=this._image.videoHeight):(this.width=this._image.width,this.height=this._image.height),"canvas"==a)?(this._canvas=this._image,this._copyImageToCtx=
!1):(this._canvas=null,this._copyImageToCtx=!0):(this.height=this.width=0,this._canvas=null)};a.prototype._createImage=function(a,b,e,d){if(!this._image||this.getWidth()!=a||this.getHeight()!=b||this._formatType!=e){if(!a||!b)throw Error("Width or height is not specified");var f=document.createElement("canvas");f.width=a;f.height=b;f.complete=!0;this._formatType=e;d||(d=new Xflow.SamplerConfig,d.setDefaults());this._samplerConfig.set(d);this._setImage(f)}else this._notifyChanged();return this._image};
a.prototype.setImage=function(a){this._setImage(a);Xflow._callListedCallback()};a.prototype._setImage=function(a){this._updateImage(a);this.isLoading()?(this._loading=!0,c(this,Xflow.DATA_ENTRY_STATE.LOAD_START)):this._loading?(this._loading=!1,c(this,Xflow.DATA_ENTRY_STATE.LOAD_END)):c(this,Xflow.DATA_ENTRY_STATE.CHANGED_VALUE)};a.prototype.getFormatType=function(){return this._formatType};a.prototype.getWidth=function(){return!this._image?0:this._image.videoWidth||this._image.width||0};a.prototype.getHeight=
function(){return!this._image?0:this._image.videoHeight||this._image.height||0};a.prototype._flush=function(){this._imageData&&(this._imageData instanceof ImageData?this._context.putImageData(this._imageData,0,0):this._context.putImageData(Xflow.toImageData(this._imageData),0,0),this._imageData=null);this._canvas&&(this._canvas.complete=!0,this._image=this._canvas)};a.prototype.getImage=function(){this._flush();return this._image};a.prototype.getCanvas=function(){this._canvas?this._flush():(this._canvas=
document.createElement("canvas"),this._canvas.width=this.getWidth(),this._canvas.height=this.getHeight(),this._canvas.complete=!1);return this._canvas};a.prototype.getFilledCanvas=function(){var a=this.getCanvas();this._context=a.getContext("2d");if(!this._context)throw Error("Could not create 2D context.");this._copyImageToCtx&&(this._context.drawImage(this._image,0,0),this._copyImageToCtx=!1);return a};a.prototype.getContext2D=function(){this._context?this._flush():this.getFilledCanvas();return this._context};
a.prototype.getValue=function(){if(!this._image)return null;!this._imageData&&!this.isLoading()&&(this._imageData=this.getContext2D().getImageData(0,0,this.getWidth(),this.getHeight()),"float32"==this._formatType?this._imageData={data:new Float32Array(this._imageData.data),width:this._imageData.width,height:this._imageData.height}:"float64"==this._formatType&&(this._imageData={data:new Float64Array(this._imageData.data),width:this._imageData.width,height:this._imageData.height}));return this._imageData};
a.prototype.getSamplerConfig=function(){return this._samplerConfig};a.prototype.getLength=function(){return 1};a.prototype.isEmpty=function(){return!this._image};a.prototype.getIterateCount=function(){return 1};Xflow.ImageDataTextureEntry=function(a){Xflow.DataEntry.call(this,Xflow.DATA_TYPE.TEXTURE);this._samplerConfig=new b;this._formatType=this._imageData=null;this._updateImageData(a);c(this,Xflow.DATA_ENTRY_STATE.CHANGED_NEW)};Xflow.createClass(Xflow.ImageDataTextureEntry,Xflow.DataEntry);a=Xflow.ImageDataTextureEntry;
a.prototype.isLoading=function(){return!this._imageData};a.prototype._updateImageData=function(a){this._formatType=null;this._imageData=a};a.prototype._createImage=function(a,b,e,d){if(!this._image||this.getWidth()!=a||this.getHeight()!=b||this._formatType!=e){if(!a||!b)throw Error("Width or height is not specified");this._formatType=e;d||(d=new Xflow.SamplerConfig,d.setDefaults());this._samplerConfig.set(d);d={width:a,height:b,data:null};d.data="float64"==e?new Float64Array(4*a*b):"float32"==e?new Float32Array(4*
a*b):Uint8Array==Uint8ClampedArray?new Int16Array(4*a*b):new Uint8ClampedArray(4*a*b);this._imageData=d}this._notifyChanged()};a.prototype.setImageData=function(a){this._updateImageData(a);c(this,Xflow.DATA_ENTRY_STATE.CHANGED_VALUE);Xflow._callListedCallback()};a.prototype.getWidth=function(){return this._imageData&&this._imageData.width||0};a.prototype.getHeight=function(){return this._imageData&&this._imageData.height||0};a.prototype.getValue=function(){return this._imageData};a.prototype.getSamplerConfig=
function(){return this._samplerConfig};a.prototype.getLength=function(){return 1};a.prototype.isEmpty=function(){return!this._imageData};a.prototype.getFormatType=function(){return this._formatType};a.prototype.getIterateCount=function(){return 1};Xflow.DataChangeNotifier={_listeners:[]};var e=Xflow.DataChangeNotifier;e.addListener=function(a){this._listeners.push(a)};e.removeListener=function(a){Array.erase(this._listeners,a)}})();
(function(){function c(a,b){if(!a._filterMapping||a._filterMapping.isEmpty()){if(!a._computeOperator){if(a._sourceNode&&0==a._children.length)return c(a._sourceNode);if(1==a._children.length&&a._children[0]instanceof i)return c(a._children[0])}var e=a._channelNode.getChildDataIndex(b);if(-1!=e&&void 0!=e)return a._sourceNode?c(a._sourceNode):c(a._children[e])}return a}function b(b){a(b);return f(b)}function a(a){for(var b=!1,e=0;!b&&e<a._children.length;++e)b=a._children[e],b=b instanceof Xflow.DataNode?
b._imageLoading:b._data&&b._data.isLoading&&b._data.isLoading();!b&&a._sourceNode&&(b=a._sourceNode._imageLoading);!b&&a._dataflowNode&&(b=a._dataflowNode._imageLoading);b=b||!1;if(b!=a._imageLoading){a._imageLoading=b;for(e=0;e<a._parents.length;++e)a._parents[e].notify(b?Xflow.RESULT_STATE.IMAGE_LOAD_START:Xflow.RESULT_STATE.IMAGE_LOAD_END)}}function f(a){for(var b=a._loading,e=0;!b&&e<a._children.length;++e)b=a._children[e],b=b instanceof Xflow.DataNode?b._subTreeLoading:!1;!b&&a._sourceNode&&
(b=a._sourceNode._subTreeLoading);!b&&a._dataflowNode&&(b=a._dataflowNode._subTreeLoading);if(b!=a._subTreeLoading){a._subTreeLoading=b;for(e=0;e<a._parents.length;++e)a._parents[e].notify(b?Xflow.RESULT_STATE.LOAD_START:Xflow.RESULT_STATE.LOAD_END);return!0}return!1}function d(a,b){for(var e=0;e<a._parents.length;++e)a._parents[e].notify(b,a)}function e(a,b,e){a[b]&&a[b]._removeOwner(a);a[b]=e;a[b]&&a[b]._addOwner(a)}Xflow.Graph=function(){this._nodes=[]};var g=Xflow.Graph;g.prototype.createInputNode=
function(){var a=new Xflow.InputNode(this);this._nodes.push(a);return a};g.prototype.createDataNode=function(a){a=new Xflow.DataNode(this,a);this._nodes.push(a);return a};Xflow.GraphNode=function(a){this._graph=a;this._parents=[]};Xflow.InputNode=function(a){Xflow.GraphNode.call(this,a);this._name="";this._key=0;this._paramName=this._data=null;this._paramGlobal=!1;this._dataListener=this.onDataChange.bind(this)};Xflow.createClass(Xflow.InputNode,Xflow.GraphNode);g=Xflow.InputNode;g.prototype.onDataChange=
function(a,b){var e;switch(b){case Xflow.DATA_ENTRY_STATE.CHANGED_VALUE:e=Xflow.RESULT_STATE.CHANGED_DATA_VALUE;break;case Xflow.DATA_ENTRY_STATE.LOAD_START:e=Xflow.RESULT_STATE.IMAGE_LOAD_START;break;case Xflow.DATA_ENTRY_STATE.LOAD_END:e=Xflow.RESULT_STATE.IMAGE_LOAD_START;break;default:e=Xflow.RESULT_STATE.CHANGED_DATA_SIZE}d(this,e)};Object.defineProperty(g.prototype,"name",{set:function(a){this._name=a;d(this,Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._name}});
Object.defineProperty(g.prototype,"key",{set:function(a){this._key=a;d(this,Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._key}});Object.defineProperty(g.prototype,"paramName",{set:function(a){this._paramName=a;d(this,Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._paramName}});Object.defineProperty(g.prototype,"paramGlobal",{set:function(a){this._paramGlobal=a;d(this,Xflow.RESULT_STATE.CHANGED_STRUCTURE);
Xflow._callListedCallback()},get:function(){return this._paramGlobal}});Object.defineProperty(g.prototype,"data",{set:function(a){var b=!1;this._data&&(b=this._data._loading,this._data.removeListener(this._dataListener));(this._data=a)&&this._data.addListener(this._dataListener);b!=this._data._loading&&d(this,this._data._loading?Xflow.RESULT_STATE.IMAGE_LOAD_START:Xflow.RESULT_STATE.IMAGE_LOAD_END);Xflow._callListedCallback()},get:function(){return this._data}});g.prototype._getParamNames=function(){return this._paramGlobal?
null:this._paramName};g.prototype._getGlobalParamNames=function(){return this._paramGlobal?this._paramName:null};Xflow.createBufferInputNode=function(a,b,e){if(0==e)return null;a=Xflow.DATA_TYPE_MAP[a];e=new Xflow.TYPED_ARRAY_MAP[a](e*Xflow.DATA_TYPE_TUPLE_SIZE[a]);e=new Xflow.BufferEntry(a,e);a=XML3D.data.xflowGraph.createInputNode();a.data=e;a.name=b;return a};var h=0;Xflow.DataNode=function(a,b){Xflow.GraphNode.call(this,a);this._imageLoading=this._subTreeLoading=this._loading=!1;this.id=++h;this._isProtoNode=
b;this._children=[];this._userData=this._sourceNode=null;this._filterType=0;this._filterMapping=null;this._computeOperator="";this._computeUsesDataflow=!1;this._dataflowNode=this._computeOutputMapping=this._computeInputMapping=null;this._channelNode=new Xflow.ChannelNode(this);this._substitutionNodes={};this._globalParamNames=this._paramNames=null;this._listeners=[]};Xflow.createClass(Xflow.DataNode,Xflow.GraphNode);var i=Xflow.DataNode;Xflow.Mapping=function(){this._owners=[]};Xflow.OrderMapping=
function(){Xflow.Mapping.call(this);this._names=[]};Xflow.createClass(Xflow.OrderMapping,Xflow.Mapping);Xflow.NameMapping=function(){Xflow.Mapping.call(this);this._destNames=[];this._srcNames=[]};Xflow.createClass(Xflow.NameMapping,Xflow.Mapping);Object.defineProperty(i.prototype,"sourceNode",{set:function(a){this._sourceNode&&Array.erase(this._sourceNode._parents,this);(this._sourceNode=a)&&this._sourceNode._parents.push(this);b(this)||this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},
get:function(){return this._sourceNode}});Object.defineProperty(i.prototype,"protoNode",{set:function(a){this._computeUsesDataflow=!!a;this._computeOutputMapping=this._computeInputMapping=null;this.dataflowNode=a},get:function(){return this._dataflowNode}});Object.defineProperty(i.prototype,"dataflowNode",{set:function(a){if(a&&!this._computeUsesDataflow)throw Error("Cannot set dataflowNode when compute doesn't use dataflow.");this._dataflowNode&&Array.erase(this._dataflowNode._parents,this);(this._dataflowNode=
a)&&this._dataflowNode._parents.push(this);b(this)||this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._dataflowNode}});Object.defineProperty(i.prototype,"userData",{set:function(a){this._userData=a},get:function(){return this._userData}});i.prototype.setLoading=function(a){this._loading!=a&&(this._loading=a,f(this),Xflow._callListedCallback())};i.prototype.isSubtreeLoading=function(){return this._subTreeLoading};i.prototype.isImageLoading=function(){return this._imageLoading};
Object.defineProperty(i.prototype,"filterType",{set:function(a){this._filterType=a;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._filterType}});Object.defineProperty(i.prototype,"filterMapping",{set:function(a){e(this,"_filterMapping",a);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._filterMapping}});Object.defineProperty(i.prototype,"computeOperator",{set:function(a){this._computeOperator=
a;this._computeUsesDataflow=!1;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._computeUsesDataflow?null:this._computeOperator}});Object.defineProperty(i.prototype,"computeDataflowUrl",{set:function(a){this._computeOperator=a;this._computeUsesDataflow=!0;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._computeUsesDataflow?this._computeOperator:null}});Object.defineProperty(i.prototype,
"computeInputMapping",{set:function(a){e(this,"_computeInputMapping",a);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._computeInputMapping}});Object.defineProperty(i.prototype,"computeOutputMapping",{set:function(a){e(this,"_computeOutputMapping",a);this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()},get:function(){return this._computeOutputMapping}});i.prototype.isProtoNode=function(){return this._isProtoNode};
i.prototype.appendChild=function(a){this._children.push(a);a._parents.push(this);b(this)||this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()};i.prototype.removeChild=function(a){Array.erase(this._children,a);Array.erase(a._parents,this);b(this)||this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()};i.prototype.insertBefore=function(a,e){var d=this._children.indexOf(e);-1==d?this._children.push(a):this._children.splice(d,0,a);a._parents.push(this);
b(this)||this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()};i.prototype.clearChildren=function(){for(var a=0;a<this._children.length;++a)Array.erase(this._children[a]._parents,this);this._children=[];b(this)||this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()};i.prototype.detachFromParents=function(){for(var a=0;a<this._parents.length;++a){var b=this._parents[a];b._sourceNode==this?b.sourceNode=null:b._dataflowNode==this?b.dataflowNode=null:b.removeChild(this)}this._children=
[]};var j=/^([A-Za-z\s]*)\(([^()]+)\)$/;i.prototype.setFilter=function(a){var a=a||"",b=Xflow.DATA_FILTER_TYPE.RENAME,d=null;if(a){var f=a.trim().match(j);if(f){a=f[1].trim();switch(a){case "keep":b=Xflow.DATA_FILTER_TYPE.KEEP;break;case "remove":b=Xflow.DATA_FILTER_TYPE.REMOVE;break;case "rename":b=Xflow.DATA_FILTER_TYPE.RENAME;break;default:Xflow.notifyError("Unknown filter type:"+a,this)}d=Xflow.Mapping.parse(f[2],this)}else Xflow.notifyError("Could not parse filter '"+a+"'",this)}d||(d=new Xflow.OrderMapping);
e(this,"_filterMapping",d);this._filterType=b;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()};var k=/^(([^=]+)\=)?([^'(]+('[^']+')?[^'(]+)(\(([^()]*)?\))?$/,l=/^\(([^()]*)\)$/,m=/^dataflow\['([^']+)'\]$/;i.prototype.setCompute=function(a){var a=a||"",b="",d=null,f=null,c=a.trim().match(k);if(c){var a=c[2]?c[2].trim():"",b=c[3].trim(),g=c[6]?c[6].trim():"";if(c=a.match(l))a=c[1];g&&(d=Xflow.Mapping.parse(g,this));a&&(f=Xflow.Mapping.parse(a,this));(c=b.match(m))?(this._computeUsesDataflow=
!0,b=c[1]):this._computeUsesDataflow=!1;this._dataflowNode=null}else a&&Xflow.notifyError("Error parsing Compute value '"+a+"'",this);e(this,"_computeInputMapping",d);e(this,"_computeOutputMapping",f);this._computeOperator=b;this.notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()};i.prototype.notify=function(b,e){if(b==Xflow.RESULT_STATE.CHANGED_STRUCTURE||b==Xflow.RESULT_STATE.LOAD_START||b==Xflow.RESULT_STATE.LOAD_END){this._globalParamNames=this._paramNames=null;this._channelNode.setStructureOutOfSync();
for(var c in this._substitutionNodes)this._substitutionNodes[c].clear();this._substitutionNodes={};b==Xflow.RESULT_STATE.CHANGED_STRUCTURE?d(this,b):f(this)}else if(b==Xflow.RESULT_STATE.CHANGED_DATA_VALUE||b==Xflow.RESULT_STATE.CHANGED_DATA_SIZE||b==Xflow.RESULT_STATE.IMAGE_LOAD_START||b==Xflow.RESULT_STATE.IMAGE_LOAD_END)(b==Xflow.RESULT_STATE.IMAGE_LOAD_START||b==Xflow.RESULT_STATE.IMAGE_LOAD_END)&&a(this),e&&this._channelNode.notifyDataChange(e,b);for(c=0;c<this._listeners.length;++c)this._listeners[c](b)};
i.prototype.addListener=function(a){this._listeners.push(a)};i.prototype.removeListener=function(a){Array.erase(this._listeners,a)};i.prototype.getOutputNames=function(){return c(this)._channelNode.getOutputNames()};i.prototype.getOutputChannelInfo=function(a){return c(this)._channelNode.getOutputChannelInfo(a)};i.prototype.getParamNames=function(){return this._getParamNames()};i.prototype._getResult=function(a,b){return c(this,b)._channelNode.getResult(a,b)};i.prototype._getForwardNode=function(a){return c(this,
a)};i.prototype._getParamNames=function(){if(!this._paramNames)if(this._paramNames=[],this._sourceNode)Xflow.nameset.add(this._paramNames,this._sourceNode._getParamNames());else for(var a=0;a<this._children.length;++a)Xflow.nameset.add(this._paramNames,this._children[a]._getParamNames());return this._paramNames};i.prototype._getGlobalParamNames=function(){if(!this._globalParamNames)if(this._globalParamNames=[],this._dataflowNode&&Xflow.nameset.add(this._globalParamNames,this._dataflowNode._getGlobalParamNames()),
this._sourceNode)Xflow.nameset.add(this._globalParamNames,this._sourceNode._getGlobalParamNames());else for(var a=0;a<this._children.length;++a)Xflow.nameset.add(this._globalParamNames,this._children[a]._getGlobalParamNames());return this._globalParamNames};i.prototype._getChannelNode=function(a){if(a){var b=a.getKey(this);this._substitutionNodes[b]?this._substitutionNodes[b].increaseRef():this._substitutionNodes[b]=new Xflow.ChannelNode(this,a);return this._substitutionNodes[b]}return this._channelNode};
i.prototype._removeSubstitutionNode=function(a){a=a.substitution.getKey(this);this._substitutionNodes[a]&&this._substitutionNodes[a].decreaseRef()&&delete this._substitutionNodes[a]}})();
(function(){function c(a){for(var b=0;b<a._owners.length;++b)a._owners[b].notify(Xflow.RESULT_STATE.CHANGED_STRUCTURE);Xflow._callListedCallback()}Xflow.Mapping.parse=function(e,c){var e=e.trim(),h=e.trim().match(a);if(h)return b.parse(e,c);if(h=e.trim().match(d))return f.parse(h[1],c);Xflow.notifyError("Cannot parse name mapping '"+e+"'",c);return null};Xflow.Mapping.prototype._addOwner=function(a){-1==this._owners.indexOf(a)&&this._owners.push(a)};Xflow.Mapping.prototype._removeOwner=function(a){a=
this._owners.indexOf(a);-1!=a&&this._owners.splice(a,-1)};var b=Xflow.OrderMapping;b.parse=function(a,b){for(var d=new Xflow.OrderMapping(b),f=a.split(","),c=0;c<f.length;c++)d._names.push(f[c].trim());return d};Object.defineProperty(b.prototype,"length",{set:function(){throw Error("length is read-only");},get:function(){return this._name.length}});b.prototype.getName=function(a){return this._names[a]};b.prototype.clear=function(){this._names=[];c(this)};b.prototype.setName=function(a,b){this._names[a]=
b;c(this)};b.prototype.removeName=function(a){this._names.splice(a);c(this)};b.prototype.isEmpty=function(){return 0==this._names.length};var a=/^([^:,{}]+)(,[^:{},]+)*$/;b.prototype.applyFilterOnChannelMap=function(a,b,d,f){if(d==Xflow.DATA_FILTER_TYPE.KEEP)for(var c=0;c<this._names.length;++c)d=this._names[c],b.map[d]&&f(a,d,b,d);else for(c in b.map){var k=this._names.indexOf(c);(d==Xflow.DATA_FILTER_TYPE.RENAME||d==Xflow.DATA_FILTER_TYPE.REMOVE&&-1==k)&&f(a,c,b,c)}};b.prototype.getScriptInputName=
function(a){return this._names[a]?this._names[a]:null};b.prototype.getScriptOutputName=function(a){return this._names[a]?this._names[a]:null};b.prototype.getScriptOutputNameInv=function(a,b){var d=this._names.indexOf(a);return-1==d?null:b[d].name};b.prototype.applyScriptOutputOnMap=function(a,b){var d=0,f;for(f in b)if(d<this._names.length)a[this._names[d]]=b[f],++d;else break};b.prototype.getRenameSrcName=function(a){return a};b.prototype.filterNameset=function(a,b){if(b==Xflow.DATA_FILTER_TYPE.RENAME)return a.splice();
var d=b==Xflow.DATA_FILTER_TYPE.KEEP,f=[],c;for(c in a){var k=this._names.indexOf(a[c]);(d&&-1!=k||!d&&-1==k)&&f.push(a[c])}return f};var f=Xflow.NameMapping;f.parse=function(a,b){for(var d=new Xflow.NameMapping(b),f=a.split(","),c=0;c<f.length;c++){var k=f[c].split(":"),l=k[0].trim(),k=k[1].trim();d.setNamePair(l,k)}return d};Object.defineProperty(f.prototype,"length",{set:function(){throw Error("length is read-only");},get:function(){return this._srcNames.length}});f.prototype.getDestName=function(a){return this._destNames[a]};
f.prototype.getSrcName=function(a){return this._srcNames[a]};f.prototype.getSrcNameFromDestName=function(a){a=this._destNames.indexOf(a);return-1==a?null:this._srcNames[a]};f.prototype.getDestNameFromSrcName=function(a){a=this._srcNames.indexOf(a);return-1==a?null:this._destNames[a]};f.prototype.clear=function(){this._srcNames=[];this._destNames=[];c(this)};f.prototype.setNamePair=function(a,b){var d=this._destNames.indexOf(a);-1!=d&&(this._destNames.splice(d,1),this._srcNames.splice(d,1));this._destNames.push(a);
this._srcNames.push(b);c(this)};f.prototype.removeNamePair=function(a){a=this._destNames.indexOf(a);-1!=a&&(this._destNames.splice(a,1),this._srcNames.splice(a,1));c(this)};f.prototype.isEmpty=function(){return 0==this._destNames.length};var d=/^\{(([^:,{}]+:[^:{},]+)(,[^:{},]+:[^:},]+)*)\}$/;f.prototype.filterNameset=function(){};f.prototype.applyFilterOnChannelMap=function(a,b,d,f){if(d==Xflow.DATA_FILTER_TYPE.REMOVE)for(var c in b.map)-1==this._srcNames.indexOf(c)&&f(a,c,b,c);else{if(d==Xflow.DATA_FILTER_TYPE.RENAME)for(c in b.map)-1==
this._srcNames.indexOf(c)&&f(a,c,b,c);for(c in this._destNames)f(a,this._destNames[c],b,this._srcNames[c])}};f.prototype.getRenameSrcName=function(a){return this.getSrcNameFromDestName(a)||a};f.prototype.getScriptInputName=function(a,b){return this.getSrcNameFromDestName(b)};f.prototype.getScriptOutputName=function(a,b){return this.getDestNameFromSrcName(b)};f.prototype.getScriptOutputNameInv=function(a){a=this._destNames.indexOf(a);return-1==a?null:this._srcNames[a]};f.prototype.applyScriptOutputOnMap=
function(a,b){for(var d in this._destNames)a[this._destNames[d]]=b[this._srcNames[d]]}})();
(function(){function c(a,b){a._result&&a._result._removeRequest(a);(a._result=b)&&b._addRequest(a);return b}function b(a,b,f){var c=a._getForwardNode(f),a=c.id+"|"+b.getKey();(f=e[a])?d[f.id]++:(f=c._graph.createDataNode(!1),f.appendChild(c),c=b.getOperator(),f.computeOperator=c,f.computeInputMapping=new Xflow.OrderMapping,f.computeOutputMapping=new Xflow.OrderMapping,b.setInputMapping(f._computeInputMapping),b.setOutputMapping(f._computeOutputMapping),e[a]=f,d[f.id]=1);return f}var a=function(a,
b,d){this._dataNode=a;this._filter=b?b.slice().sort():null;this._listener=d;this._result=null;this._dataNodeListener=this._onDataNodeChange.bind(this);this._dataNode.addListener(this._dataNodeListener)};Xflow.Request=a;Object.defineProperty(a.prototype,"dataNode",{set:function(){throw Error("dataNode is readonly");},get:function(){return this._dataNode}});Object.defineProperty(a.prototype,"filter",{set:function(){throw Error("filter is read-only");},get:function(){return this._filter}});a.prototype.clear=
function(){this._listener=null;this._result&&this._result._removeRequest(this);this._dataNode.removeListener(this._dataNodeListener)};a.prototype._onListedCallback=function(a){this._listener&&this._listener(this,a)};a.prototype._onDataNodeChange=function(a){Xflow._listCallback(this,a)};var f=function(a,b,d){Xflow.Request.call(this,a,b,d)};Xflow.createClass(f,Xflow.Request);Xflow.ComputeRequest=f;f.prototype.getResult=function(){return c(this,this._dataNode._getResult(Xflow.RESULT_TYPE.COMPUTE,this._filter))};
f.prototype._onResultChanged=function(a){this._onDataNodeChange(a)};var d={},e={},f=function(a,d,e){var f=d.getFilter();if(0==f.length)throw Error("vsConfig requires at least one attribute entry.");Xflow.Request.call(this,a,f,e);this._vsConfig=d;this._vsConnectNode=b(a,d)};Xflow.createClass(f,Xflow.Request);Xflow.VertexShaderRequest=f;f.prototype.getResult=function(){return c(this,this._vsConnectNode._getResult(Xflow.RESULT_TYPE.VS,this._filter))};f.prototype._onDataNodeChange=function(f){if(f==Xflow.RESULT_STATE.CHANGED_STRUCTURE){var c=
b(this._dataNode,this._vsConfig,this._filter);if(c!=this._vsConnectNode){var i=this._vsConnectNode,j=this._dataNode,k=this._vsConfig;d[i.id]--;d[i.id]||(j=j.id+"|"+k.getKey(),e[j]=null,i.clearChildren());this._vsConnectNode=c}}a.prototype._onDataNodeChange.call(this,f)};f.prototype._onResultChanged=function(a,b){this._onDataNodeChange(b)}})();
(function(){Xflow.Result=function(){this.valid=this.loading=!1;this._listeners=[];this._requests=[]};var c=Xflow.Result;c.prototype.addListener=function(b){this._listeners.push(b)};c.prototype.removeListener=function(b){Array.erase(this._listeners,b)};c.prototype._addRequest=function(b){this._requests.push(b)};c.prototype._removeRequest=function(b){Array.erase(this._requests,b)};c.prototype._notifyChanged=function(b){this.valid=!1;for(var a=0;a<this._requests.length;++a)this._requests[a]._onResultChanged(b);
Xflow._listCallback(this,b)};c.prototype._onListedCallback=function(b){for(var a=0;a<this._listeners.length;++a)this._listeners[a](this,b)};Xflow.ComputeResult=function(){Xflow.Result.call(this);this._outputNames=[];this._dataEntries={}};Xflow.createClass(Xflow.ComputeResult,Xflow.Result);c=Xflow.ComputeResult;Object.defineProperty(c.prototype,"outputNames",{set:function(){throw Error("outputNames is readonly");},get:function(){return this._outputNames}});c.prototype.getOutputData=function(b){return this._dataEntries[b]};
c.prototype.getOutputMap=function(){return this._dataEntries};Xflow.VertexShaderResult=function(){Xflow.Result.call(this);this._programData=this._program=this._shaderInputNames=null};Xflow.createClass(Xflow.VertexShaderResult,Xflow.Result);c=Xflow.VertexShaderResult;Object.defineProperty(c.prototype,"shaderInputNames",{set:function(){throw Error("shaderInputNames is readonly");},get:function(){return this._program._shaderInputNames}});Object.defineProperty(c.prototype,"shaderOutputNames",{set:function(){throw Error("shaderOutputNames is readonly");
},get:function(){return this._program._shaderOutputNames}});c.prototype.getShaderInputData=function(b){return this._program.getInputData(b,this._programData)};c.prototype.isShaderInputUniform=function(b){return this._program.isInputUniform(b)};c.prototype.isShaderOutputUniform=function(b){return this._program.isOutputUniform(b)};c.prototype.getShaderOutputType=function(b){return this._program.getShaderOutputType(b)};c.prototype.getShaderOutputSourceName=function(b){return this._program.getShaderOutputSourceName(b)};
c.prototype.getUniformOutputData=function(b){return this._program.getUniformOutputData(b,this._programData)};c.prototype.isShaderOutputNull=function(b){return this._program.isOutputNull(b)};c.prototype.getGLSLCode=function(){return this._program._glslCode}})();
(function(){Xflow.shaderConstant={};Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.OBJECT_ID]="objectID";Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.SCREEN_TRANSFORM]="screenTransform";Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.SCREEN_TRANSFORM_NORMAL]="screenTransformNormal";Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM]="viewTransform";Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM_NORMAL]="viewTransformNormal";Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.WORLD_TRANSFORM]=
"worldTransform";Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.WORLD_TRANSFORM_NORMAL]="worldTransformNormal";Xflow.setShaderConstant=function(b,a){Xflow.shaderConstant[b]=a};Xflow.VSConfig=function(){this._blockedNames=[];this._attributes=[]};Xflow.VSConfig.prototype.addAttribute=function(b,a,f,d,e){this._attributes.push({type:b,inputName:a,outputName:f,optional:d||!1,transform:e||Xflow.VS_ATTRIB_TRANSFORM.NONE})};Xflow.VSConfig.prototype.getAttributeCount=function(){return this._attributes.length};
Xflow.VSConfig.prototype.getAttribute=function(b){return this._attributes[b]};Xflow.VSConfig.prototype.isAttributeTransformed=function(b){return!!this._attributes[b].transform};Xflow.VSConfig.prototype.addBlockedName=function(b){this._blockedNames.push(b)};Xflow.VSConfig.prototype.getBlockedNames=function(){return this._blockedNames};Xflow.VSConfig.prototype.getFilter=function(){for(var b=[],a=0;a<this._attributes.length;++a)b.push(this._attributes[a].outputName);return b};Xflow.VSConfig.prototype.getKey=
function(){for(var b=this._blockedNames.join(";"),a=0;a<this._attributes.length;++a)b+=";"+this._attributes.type+","+this._attributes.inputName+","+this._attributes.outputName+","+this._attributes.optional;return b};var c={};Xflow.VSConfig.prototype.getOperator=function(){var b=this.getKey();if(c[b])return c[b];for(var a=[],f=[],d="\t// VS Connector\n",e={},g=[],h={},i=0;i<this._attributes.length;++i){var j=this._attributes[i],k=Xflow.getTypeName(j.type);a.push({type:k,name:j.outputName});if(void 0===
e[j.inputName]){var l=f.length;g[i]=l;f.push({type:k,source:j.inputName,optional:j.optional});e[j.inputName]=l}else g[i]=e[j.inputName];k="\t#O{"+j.outputName+"} = ";if(j.transform&&j.type!=Xflow.DATA_TYPE.FLOAT3)throw Error("Xflow VS Shader only supports transformation of float3 values at this point");switch(j.transform){case Xflow.VS_ATTRIB_TRANSFORM.VIEW_NORMAL:k+="normalize( #G{"+Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM_NORMAL]+"} * #I{"+j.inputName+"} );";break;case Xflow.VS_ATTRIB_TRANSFORM.VIEW_POINT:k+=
"( #G{"+Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM]+"} * vec4( #I{"+j.inputName+"} , 1.0)).xyz;";break;case Xflow.VS_ATTRIB_TRANSFORM.WORLD_NORMAL:k+="normalize( #G{"+Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.WORLD_TRANSFORM_NORMAL]+"} * #I{"+j.inputName+"} );";break;case Xflow.VS_ATTRIB_TRANSFORM.WORLD_POINT:k+="( #G{"+Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.WORLD_TRANSFORM]+"} * vec4( #I{"+j.inputName+"} , 1.0)).xyz;";break;default:k+="#I{"+j.inputName+"};"}h[j.outputName]=
k}d+="\tgl_Position = #G{"+Xflow.shaderConstant[Xflow.SHADER_CONSTANT_KEY.SCREEN_TRANSFORM]+"} * vec4(#I{position}, 1.0);\n";a=Xflow.initAnonymousOperator({outputs:a,params:f,evaluate_glsl:d,glsl_fragments:h,blockedNames:this._blockedNames,vsConfig:this,outputInputMap:g});return c[b]=a};Xflow.VSConfig.prototype.setInputMapping=function(b){for(var a={},f=0;f<this._attributes.length;++f){var d=this._attributes[f].inputName;a[d]||(b.setName(f,d),a[d]=!0)}};Xflow.VSConfig.prototype.setOutputMapping=function(b){for(var a=
0;a<this._attributes.length;++a)b.setName(a,this._attributes[a].outputName)}})();
(function(){function c(a,b){a.map[b]||(a.map[b]={channel:null,childDataIndex:void 0})}function b(b,d,f,i){c(b,d);var j=b.map[d].channel;if(!j||!j.willMergeWithDataSlot(f))return f=new Xflow.Channel(b,f),b.map[d].channel=f,b.map[d].childDataIndex=i,f;j=a(b,j);j.addDataSlot(f);b.map[d].channel=j;b.map[d].childDataIndex=-1;return j}function a(a,b){if(b.map!=a){var d=new Xflow.Channel(a);d.addChannelEntries(b);d.creatorProcessNode=b.creatorProcessNode;return d}return b}Xflow.DataSlot=function(a,b){this.key=
b||0;this.dataEntry=a;this.parentChannels=[]};Xflow.DataSlot.prototype.addChannel=function(a){this.parentChannels.push(a)};Xflow.DataSlot.prototype.removeChannel=function(a){a=this.parentChannels.indexOf(a);-1!=a&&this.parentChannels.splice(a,1)};Xflow.DataSlot.prototype.setDataEntry=function(a,b){this.dataEntry=a;this.notifyOnChange(b==Xflow.RESULT_STATE.CHANGED_DATA_VALUE?Xflow.DATA_ENTRY_STATE.CHANGED_VALUE:Xflow.DATA_ENTRY_STATE.CHANGED_SIZE)};Xflow.DataSlot.prototype.notifyOnChange=function(a){for(var b=
0;b<this.parentChannels.length;++b)this.parentChannels[b].notifyOnChange(a)};Xflow.ChannelMap=function(){this.map={}};var f=Xflow.ChannelMap;f.prototype.getNames=function(){var a=[],b;for(b in this.map)a.push(b);return a};f.prototype.getChannel=function(a){return!this.map[a]?null:this.map[a].channel};f.prototype.getChildDataIndex=function(a){return!this.map[a]?void 0:this.map[a].childDataIndex};f.prototype.getChildDataIndexForFilter=function(a){for(var b,a=a||this.getNames(),d=0;d<a.length;++d){var f=
this.getChildDataIndex(a[d]);void 0!=f&&(b=void 0!=b&&b!=f?-1:f)}return b};f.prototype.merge=function(a,b){for(var d in a.map){var f=void 0==b?a.getChildDataIndex(d):b;this.addChannel(d,a.getChannel(d),f)}};f.prototype.addChannel=function(b,d,f){if(d){void 0==f&&(f=-1);c(this,b);var i=this.map[b].channel;!i||!i.willMergeWithChannel(d)?(this.map[b].channel=d,this.map[b].childDataIndex=f):(i=a(this,i),i.addChannelEntries(d),this.map[b].channel=i,this.map[b].childDataIndex=-1)}};f.prototype.addDataEntry=
function(a,d){b(this,a,d,-1)};f.prototype.addOutputDataSlot=function(a,d,f){b(this,a,d,-1).creatorProcessNode=f};f.prototype.clear=function(){for(var a in this.map){var b=this.map[a];b&&b.map==this&&b.clear()}this.map={}};Xflow.Channel=function(a,b){this.entries=[];this.map=a;this.id=++d;this.listeners=[];this.creatorProcessNode=null;b&&this.addDataSlot(b)};f=Xflow.Channel;f.prototype.addDataSlot=function(a){a.addChannel(this);for(var b=0;b<this.entries.length;++b){var d=this.entries[b];if(d.key>=
a.key-Xflow.EPSILON){Math.abs(d.key-a.key)<=Xflow.EPSILON?(d.removeChannel(this),this.entries.splice(b,1,a)):this.entries.splice(b,0,a);break}}this.entries.push(a)};f.prototype.getSequenceLength=function(){return this.entries.length};f.prototype.getSequenceMinKey=function(){return this.entries[0].key};f.prototype.getSequenceMaxKey=function(){return this.entries[this.entries.length-1].key};f.prototype.getType=function(){return 0==this.entries.length?Xflow.DATA_TYPE.UNKNOWN:this.entries[0].dataEntry._type};
f.prototype.addChannelEntries=function(a){for(var b=0;b<a.entries.length;++b)this.addDataSlot(a.entries[b])};f.prototype.getDataEntry=function(a,b){if(0==this.entries.length)return null;if(!a)return this.entries[0].dataEntry;for(var d=0,f=this.entries.length;d<f&&this.entries[d].key<b;)++d;if(a==Xflow.SEQUENCE.PREV_BUFFER)return this.entries[d?d-1:0].dataEntry;if(a==Xflow.SEQUENCE.NEXT_BUFFER)return this.entries[d<f?d:f-1].dataEntry;if(a==Xflow.SEQUENCE.LINEAR_WEIGHT){var c=this.entries[d?d-1:0].key,
d=this.entries[d<f?d:f-1].key,f=new Float32Array(1);f[0]=d==c?0:(b-c)/(d-c);return new Xflow.BufferEntry(Xflow.DATA_TYPE.FLOAT,f)}return null};f.prototype.willMergeWithChannel=function(a){if(this.entries.length!=a.entries.length)return!0;if(this.getType()!=a.getType())return!1;for(var b=0;b<this.entries.length;b++)if(Math.abs(this.entries[b].key-a.entries[b].key)>Xflow.EPSILON)return!0;return!1};f.prototype.willMergeWithDataSlot=function(a){return 1<this.entries.length?!0:this.getType()!=a.dataEntry._type?
!1:Math.abs(this.entries[0].key-a.key)>Xflow.EPSILON?!0:!1};f.prototype.notifyOnChange=function(a){for(var b=0;b<this.listeners.length;b++)this.listeners[b].onXflowChannelChange(this,a)};f.prototype.addListener=function(a){this.listeners.push(a)};f.prototype.removeListener=function(a){a=this.listeners.indexOf(a);-1!=a&&this.listeners.splice(a,1)};f.prototype.clear=function(){for(var a=0;a<this.entries.length;++a)this.entries[a].removeChannel(this)};var d=0;Xflow.Substitution=function(a,b,d){this.map=
{};if(b&&d)for(var f=0;f<d.length;++f){var c=d[f];this.map[c]=b.map[c]}for(c in a.map)this.map[c]=a.getChannel(c,b)};Xflow.Substitution.prototype.getKey=function(a){var b=[];if(a)for(var d=0;d<a.length;++d){var f=this.map[a[d]];b[d]=a[d]+">"+(f&&f.id||"X")}else{var d=0,c;for(c in this.map)f=this.map[c],b[d++]=c+">"+(f&&f.id||"X")}return 0<b.length?b.join(";"):0}})();
(function(){function c(b,a,f,d){var e=f.getChannel(d);b.addChannel(a,e,f.getChildDataIndex(d))}Xflow.ChannelNode=function(b,a){this.owner=b;this.substitution=a;this.loading=!1;this.inputSlots={};this.inputChannels=new Xflow.ChannelMap;this.computedChannels=new Xflow.ChannelMap;this.outputChannels=new Xflow.ChannelMap;this.processNode=this.dataflowChannelNode=this.operator=null;this.requestNodes={};this.useCount=1;this.outOfSync=!0};Xflow.ChannelNode.prototype.synchronize=function(){if(this.outOfSync){var b=
this.owner;this.loading=b._subTreeLoading;this.substitution&&b._channelNode.synchronize();if(b._sourceNode)b._sourceNode._getChannelNode(this.substitution).synchronize();else for(var a=0;a<b._children.length;++a)b._children[a]._getChannelNode&&b._children[a]._getChannelNode(this.substitution).synchronize();b=this.owner;if(b._sourceNode)this.inputChannels.merge(b._sourceNode._getChannelNode(this.substitution).outputChannels,0);else{for(var a=b._children,f=0;f<a.length;++f)a[f]._getChannelNode&&this.inputChannels.merge(a[f]._getChannelNode(this.substitution).outputChannels,
f);for(f=0;f<a.length;++f)if(!a[f]._getChannelNode){var d=a[f],e=d._name+";"+d._key;if(this.substitution)d._paramName&&this.substitution.hasChannel(d._paramName)?this.inputChannels.addChannel(d._name,this.substitution.getChannel(d._paramName)):this.inputChannels.addDataEntry(d._name,b._channelNode.inputSlots[e]);else{var g=new Xflow.DataSlot(d._data,d._key);this.inputSlots[e]=g;this.inputChannels.addDataEntry(d._name,g)}}}a=this.owner;this.computedChannels.merge(this.inputChannels);b=this.dataflowChannelNode;
if(a._computeUsesDataflow&&a._dataflowNode){this.operator=null;var h=this.owner,a=new Xflow.Substitution(h._dataflowNode,this);this.dataflowChannelNode=h._dataflowNode._getChannelNode(a);h=this.owner;if(this.dataflowChannelNode){a=this.dataflowChannelNode;a.synchronize();f=a.outputChannels.getNames();for(d=0;d<f.length;++d)g=e=f[d],h._computeOutputMapping&&(g=h._computeOutputMapping.getScriptOutputName(d,e)),g&&this.computedChannels.addChannel(g,a.outputChannels.getChannel(e))}}else if(!a._computeUsesDataflow&&
a._computeOperator&&(this.dataflowChannelNode=null,a=this.owner,"string"==typeof a._computeOperator?(a=a._computeOperator,f=null,a&&((f=Xflow.getOperator(a))||Xflow.notifyError("Unknown operator: '"+a+"'",this.owner)),this.operator=f):this.operator=a._computeOperator,a=this.owner,this.operator))for(h in f=this.processNode=new Xflow.ProcessNode(this),d=0,f.outputDataSlots)(e=a._computeOutputMapping.getScriptOutputName(d,h))&&this.computedChannels.addOutputDataSlot(e,f.outputDataSlots[h],f),d++;b&&
b!=this.dataflowChannelNode&&b.owner._removeSubstitutionNode(b);b=this.owner;b._filterMapping?b._filterMapping.applyFilterOnChannelMap(this.outputChannels,this.computedChannels,b._filterType,c):this.outputChannels.merge(this.computedChannels);this.outOfSync=!1}};Xflow.ChannelNode.prototype.clear=function(){this.useCount=0;this.inputChannels.clear();this.outputChannels.clear();return!0};Xflow.ChannelNode.prototype.increaseRef=function(){this.useCount++};Xflow.ChannelNode.prototype.decreaseRef=function(){this.useCount--;
0==this.useCount&&this.clear();return!1};Xflow.ChannelNode.prototype.getOutputNames=function(){this.synchronize();return this.outputChannels.getNames()};Xflow.ChannelNode.prototype.getChildDataIndex=function(b){this.synchronize();return this.outputChannels.getChildDataIndexForFilter(b)};Xflow.ChannelNode.prototype.setStructureOutOfSync=function(){if(!this.outOfSync){this.outOfSync=!0;this.inputChannels.clear();this.computedChannels.clear();this.outputChannels.clear();this.processNode&&this.processNode.clear();
for(var b in this.requestNodes)this.requestNodes[b].setStructureOutOfSync()}};Xflow.ChannelNode.prototype.notifyDataChange=function(b,a){var f=b._name+";"+b._key;this.inputSlots[f]&&this.inputSlots[f].setDataEntry(b._data,a)};Xflow.ChannelNode.prototype.getResult=function(b,a){this.synchronize();var f=a?a.join(";"):"[null]";this.requestNodes[f]||(this.requestNodes[f]=new Xflow.RequestNode(this,a));return this.requestNodes[f].getResult(b)};Xflow.ChannelNode.prototype.getOutputChannelInfo=function(b){this.synchronize();
var a=this.outputChannels.getChannel(b);if(!a)return null;var f={type:a.getType(),seqLength:a.getSequenceLength(),seqMinKey:a.getSequenceMinKey(),seqMaxKey:a.getSequenceMaxKey(),origin:0,originalName:""},b=this.owner._filterMapping?this.owner._filterMapping.getRenameSrcName(b):b,a=a.getDataEntry();if(this.dataflowChannelNode){var d=this.inputChannels.getChannel(b);if(!d||a!=d.getDataEntry())return f.origin=Xflow.ORIGIN.PROTO,f.originalName=b,f}if(this.operator&&(d=this.inputChannels.getChannel(b),
!d||a!=d.getDataEntry()))return f.origin=Xflow.ORIGIN.COMPUTE,f.originalName=this.owner._computeOutputMapping.getScriptOutputNameInv(b,this.operator.outputs),f;f.origin=Xflow.ORIGIN.CHILD;f.originalName=b;return f};Xflow.Substitution=function(b,a){this.map={};for(var f=a.owner,d=b._getGlobalParamNames(),e=0;e<d.length;++e)this.map[d[e]]=a.inputChannels.getChannel(d[e]);d=b._getParamNames();for(e=0;e<d.length;++e){var c=d[e],h=c;f._computeInputMapping&&(h=f._computeInputMapping.getScriptInputName(e,
c));this.map[c]=a.inputChannels.getChannel(h)}};Xflow.Substitution.prototype.hasChannel=function(b){return!!this.map[b]};Xflow.Substitution.prototype.getChannel=function(b){return this.map[b]};Xflow.Substitution.prototype.getKey=function(b){for(var a="",f=b._getGlobalParamNames(),d=0;d<f.length;++d)var e=this.map[f[d]],a=a+((e&&e.id||"-")+"!");b=b._getParamNames();for(d=0;d<b.length;++d)e=this.map[b[d]],a+=(e&&e.id||"-")+".";return a}})();
(function(){function c(a,b,e){var c,h;for(h in e)if((c=e[h])&&c.creatorProcessNode)Xflow.utils.setAdd(a,c.creatorProcessNode),Xflow.utils.setAdd(b,c.creatorProcessNode.descendants);Xflow.utils.setRemove(a,b);Xflow.utils.setAdd(b,a)}function b(a,b){a.executers[b]||(a.executers[b]=new Xflow.Executer(a,b));return a.executers[b]}Xflow.ProcessNode=function(a){this.owner=a;this.operator=a.operator;this.inputChannels={};this.outputDataSlots={};this.status=Xflow.PROCESS_STATE.MODIFIED;this.children=[];this.descendants=
[];this.executers=[];for(var b=this.operator,e=a.owner._computeInputMapping,g=0;g<b.params.length;++g){var h=b.params[g].source,i=e?e.getScriptInputName(g,h):h;i&&((i=a.inputChannels.getChannel(i))&&i.addListener(this),this.inputChannels[h]=i)}c(this.children,this.descendants,this.inputChannels);var a=this.operator,b=this.outputDataSlots,j;for(j in a.outputs)e=a.outputs[j],g=e.type,g=g!=Xflow.DATA_TYPE.TEXTURE?new Xflow.BufferEntry(g,null):window.document?new Xflow.TextureEntry(null):new Xflow.ImageDataTextureEntry(null),
b[e.name]=new Xflow.DataSlot(g,0)};var a=Xflow.ProcessNode;a.prototype.onXflowChannelChange=function(a,b){this.status=b==Xflow.DATA_ENTRY_STATE.CHANGED_VALUE&&this.status>Xflow.PROCESS_STATE.UNPROCESSED?Xflow.PROCESS_STATE.UNPROCESSED:Xflow.PROCESS_STATE.MODIFIED;for(var e in this.outputDataSlots)this.outputDataSlots[e].notifyOnChange(b)};a.prototype.clear=function(){for(var a in this.inputChannels)this.inputChannels[a]&&this.inputChannels[a].removeListener(this)};a.prototype.updateState=function(){if(this.status==
Xflow.PROCESS_STATE.MODIFIED)if(this.status=Xflow.PROCESS_STATE.UNPROCESSED,this.owner.loading)this.status=Xflow.PROCESS_STATE.LOADING;else{for(var a=0;a<this.children.length;++a)this.status=Math.min(this.status,this.children[a].updateState());if(a=this.status>Xflow.PROCESS_STATE.LOADING)a:{var a=this.operator,b=this.inputChannels,e;for(e in a.params){var c=b[a.params[e].source];if(c&&(c=c.getDataEntry())&&c.isLoading&&c.isLoading()){a=!0;break a}}a=!1}a&&(this.status=Xflow.PROCESS_STATE.LOADING);
if(e=this.status>Xflow.PROCESS_STATE.INVALID){var h;a:{e=this.operator;a=this.owner.owner._computeInputMapping;b=this.inputChannels;c=this.owner.owner;for(h in e.params){var i=e.params[h],j=a?a.getScriptInputName(h,i.source):i.source;if(!i.optional&&!j){Xflow.notifyError("Xflow: operator "+e.name+": Missing input argument for "+i.source,c);h=!1;break a}if(j){var k=b[i.source];if(!k){Xflow.notifyError("Xflow: operator "+e.name+": Input of name '"+j+"' not found. Used for parameter "+i.source,c);h=
!1;break a}j=k.getDataEntry();if(!k.creatorProcessNode&&!i.optional&&(!j||j.isEmpty())){Xflow.notifyError("Xflow: operator "+e.name+": Input for "+i.source+" contains no data.",c);h=!1;break a}if(j&&j.type!=i.type){Xflow.notifyError("Xflow: operator "+e.name+": Input for "+i.source+" has wrong type. Expected: "+Xflow.getTypeName(i.type)+", but got: "+Xflow.getTypeName(j.type),c);h=!1;break a}}}h=!0}e=!h}e&&(this.status=Xflow.PROCESS_STATE.INVALID)}return this.status};a.prototype.process=function(){this.status==
Xflow.PROCESS_STATE.UNPROCESSED&&(b(this,Xflow.PLATFORM.JAVASCRIPT).run(),this.status=Xflow.PROCESS_STATE.PROCESSED)};Xflow.RequestNode=function(a,b){this.owner=a;this.filter=b;this.results={};this.status=Xflow.PROCESS_STATE.MODIFIED;this.channels={};this.children=[];this.executers=[];this.outOfSync=!0};a=Xflow.RequestNode;a.prototype.synchronize=function(){if(this.outOfSync){this.outOfSync=!1;var a=this.owner,b=this.filter;b||(b=a.outputChannels.getNames());for(var e=0;e<b.length;++e){var g=b[e],
h=a.outputChannels.getChannel(g);h&&(this.channels[g]=h,h.addListener(this))}c(this.children,[],this.channels)}};a.prototype.updateState=function(){this.synchronize();if(this.status==Xflow.PROCESS_STATE.MODIFIED)if(this.status=Xflow.PROCESS_STATE.UNPROCESSED,this.owner.loading)this.status=Xflow.PROCESS_STATE.LOADING;else for(var a=0;a<this.children.length;++a)this.status=Math.min(this.status,this.children[a].updateState());return this.status};a.prototype.isReady=function(){this.updateState();return this.status>=
Xflow.PROCESS_STATE.UNPROCESSED};a.prototype.getResult=function(a){this.updateState();this.status==Xflow.PROCESS_STATE.UNPROCESSED&&(a==Xflow.RESULT_TYPE.COMPUTE&&b(this,Xflow.PLATFORM.JAVASCRIPT).run(),this.status=Xflow.PROCESS_STATE.PROCESSED);var d=null;if(a==Xflow.RESULT_TYPE.COMPUTE){this.results[Xflow.RESULT_TYPE.COMPUTE]||(this.results[Xflow.RESULT_TYPE.COMPUTE]=new Xflow.ComputeResult);var e=this.results[Xflow.RESULT_TYPE.COMPUTE];e._dataEntries={};e._outputNames=[];for(var c in this.channels)a=
this.channels[c].getDataEntry(),e._dataEntries[c]=a&&!a.isEmpty()?a:null,e._outputNames.push(c);d=e}else if(a==Xflow.RESULT_TYPE.VS){a=b(this,Xflow.PLATFORM.GLSL);this.results[Xflow.RESULT_TYPE.VS]||(this.results[Xflow.RESULT_TYPE.VS]=new Xflow.VertexShaderResult);c=this.results[Xflow.RESULT_TYPE.VS];d=a.getVertexShader();c._program=d;c._programData=a.programData;c._dataEntries={};c._outputNames=[];for(e in this.channels)a=this.channels[e].getDataEntry(),c._dataEntries[e]=a&&!a.isEmpty()?a:null,c._outputNames.push(e);
d=c}d.loading=this.status==Xflow.PROCESS_STATE.LOADING;return d};a.prototype.setStructureOutOfSync=function(){this.outOfSync=!0;this.status=Xflow.PROCESS_STATE.MODIFIED;for(var a in this.results)this.results[a]._notifyChanged(Xflow.RESULT_STATE.CHANGED_STRUCTURE);for(var b in this.channels)this.channels[b].removeListener(this);this.channels=[];this.children=[];this.executers=[]};a.prototype.onXflowChannelChange=function(a,b){a.creatorProcessNode&&(this.status=Xflow.PROCESS_STATE.MODIFIED);var e=b==
Xflow.DATA_ENTRY_STATE.CHANGED_VALUE?Xflow.RESULT_STATE.CHANGED_DATA_VALUE:Xflow.RESULT_STATE.CHANGED_DATA_SIZE,c;for(c in this.results)this.results[c]._notifyChanged(e)}})();
(function(){function c(d,e,f){if(-1==d.blockedNodes.indexOf(e)){if(e.operator)if(!d.firstOperator||f==Xflow.PLATFORM.GLSL&&d.firstOperator.evaluate_glsl&&e.operator.evaluate_glsl){d.firstOperator||(d.firstOperator=e.operator);for(var j=e.operator.mapping,k=0;k<j.length;++k)j[k].sequence?(a(d,e,j[k].source),a(d,e,j[k].keySource)):j[k].array&&a(d,e,j[k].source)}else{b(d,e);return}for(k=0;k<e.children.length;++k)c(d,e.children[k],f)}}function b(a,d){if(-1==a.blockedNodes.indexOf(d)){a.blockedNodes.push(d);
for(var e=0;e<d.children.length;++e)b(a,d.children[e])}}function a(a,d,e){(d=d.inputChannels[e])&&d.creatorProcessNode&&b(a,d.creatorProcessNode)}function f(a,b,d){if(-1==a.doneNodes.indexOf(d))if(a.doneNodes.push(d),-1!=a.blockedNodes.indexOf(d))b.subNodes.push(d);else{for(var e=0;e<d.children.length;++e)f(a,b,d.children[e]);d.operator&&a.constructionOrder.push(d)}}function d(a){for(var b=a.programData.inputs,d=0;d<a.programData.inputs.length;++d){var e=a.programData.getDataEntry(d);(e=e?e.getIterateCount?
e.getIterateCount():1:0)?!b[d].arrayAccess&&1<e?a.operatorList.setInputIterateType(d,Xflow.ITERATION_TYPE.MANY):a.operatorList.setInputIterateType(d,Xflow.ITERATION_TYPE.ONE):a.operatorList.setInputIterateType(d,Xflow.ITERATION_TYPE.NULL);b[d].arrayAccess&&a.platform==Xflow.PLATFORM.GLSL&&a.operatorList.setInputSize(d,e)}}function e(a){for(var b=0;b<a.subNodes.length;++b)a.subNodes[b].process()}Xflow.Executer=function(a,b){this.platform=b;this.mergedNodes=[];this.subNodes=[];this.unprocessedDataNames=
[];this.operatorList=new Xflow.OperatorList(b);this.programData=new Xflow.ProgramData;this.program=null;var d={blockedNodes:[],doneNodes:[],constructionOrder:[],inputSlots:{},finalOutput:null,firstOperator:null};if(a instanceof Xflow.RequestNode){d.finalOutput={};for(var e=a.filter||a.owner.outputChannels.getNames(),k=0;k<e.length;++k){var l=e[k],m=a.owner.outputChannels.getChannel(l);m&&m.creatorProcessNode&&(d.finalOutput[l]=m.getDataEntry())}Xflow.nameset.add(this.unprocessedDataNames,e)}c(d,a,
this.platform);f(d,this,a);for(e=0;e<d.constructionOrder.length;++e){for(var k=d.constructionOrder[e],m=l=new Xflow.OperatorEntry(k.operator),r=d,p=k,q=p.operator.mapping,n=0;n<q.length;++n){var o=p.inputChannels[q[n].source],u;if(o&&o.creatorProcessNode&&-1!=(u=this.mergedNodes.indexOf(o.creatorProcessNode))){a:{for(var x=o.creatorProcessNode,B=x.operator.outputs,w=0;w<B.length;++w)if(o.getDataEntry()==x.outputDataSlots[B[w].name].dataEntry){o=w;break a}o=null}m.setTransferInput(n,u,o);this.operatorList.entries[u].isFinalOutput(o)||
this.operatorList.entries[u].setTransferOutput(o)}else{x=p.owner.owner._computeInputMapping.getScriptInputName(q[n].paramIdx,q[n].source);B=new Xflow.ProgramInputConnection;B.channel=o;B.arrayAccess=q[n].array||!1;B.sequenceAccessType=q[n].sequence||0;B.sequenceAccessType&&(B.sequenceKeySourceChannel=p.inputChannels[q[n].keySource]);var w=B.getKey(),s=r.inputSlots[w];o&&void 0!=s||(s=this.programData.inputs.length,r.inputSlots[w]=s,this.programData.inputs.push(B));m.setDirectInput(n,s,x)}}m=l;r=d;
p=k;q=p.operator.outputs;for(n=0;n<q.length;++n){o=p.outputDataSlots[q[n].name];a:if(r.finalOutput){x=void 0;for(x in r.finalOutput)if(r.finalOutput[x]==o.dataEntry)break a;x=!1}else x=!0;x&&(B=this.programData.outputs.length,this.programData.outputs.push(o),m.setFinalOutput(n,B),!0!==x&&Xflow.nameset.remove(this.unprocessedDataNames,x))}this.programData.operatorData.push({});this.operatorList.addEntry(l);this.mergedNodes.push(k)}for(u=0;u<d.constructionOrder.length;++u){e=d.constructionOrder[u];
k=this.operatorList.entries[u];l=e.operator.outputs;for(m=0;m<l.length;++m)!k.isFinalOutput(m)&&!k.isTransferOutput(m)&&(r=this.programData.outputs.length,this.programData.outputs.push(e.outputDataSlots[l[m].name]),k.setLostOutput(m,r))}};Xflow.Executer.prototype.run=function(){e(this);d(this);if(this.program=Xflow.createProgram(this.operatorList))this.operatorList.allocateOutput(this.programData),this.program.run(this.programData)};Xflow.Executer.prototype.getVertexShader=function(){e(this);d(this);
return this.program=Xflow.createProgram(this.operatorList)}})();
(function(){Xflow.utils={};Xflow.utils.setAdd=function(c,b){if(void 0!==b.length)for(var a=0;a<b.length;++a)-1==c.indexOf(b[a])&&c.push(b[a]);else-1==c.indexOf(b)&&c.push(b)};Xflow.utils.setRemove=function(c,b){var a;if(void 0!==b.length)for(var f=0;f<b.length;++f)-1!=(a=c.indexOf(b[f]))&&c.splice(a,1);else-1!=(a=c.indexOf(b))&&c.splice(a,1)};Xflow.nameset={};Xflow.nameset.add=function(c,b){if(b)if("string"==typeof b)-1==c.indexOf(b)&&c.push(b);else for(var a=0;a<b.length;++a)-1==c.indexOf(b[a])&&
c.push(b[a])};Xflow.nameset.remove=function(c,b){if(b)if("string"==typeof b){var a=c.indexOf(b);-1!=a&&c.splice(a,1)}else for(var f=0;f<b.length;++f)a=c.indexOf(b[f]),-1!=a&&c.splice(a,1)};Xflow.nameset.intersection=function(c,b){for(var a=c.length;a--;)-1==b.indexOf(c[a])&&c.splice(a,1)};Xflow.utils.binarySearch=function(c,b,a){for(var f=0,a=a-1;f<=a;){var d=Math.floor((f+a)/2);if(c[d]==b)return d;c[d]<b?f=d+1:a=d-1}return a}})();
(function(){function c(a){for(var b={},d=0;d<a.outputs.length;++d)a.outputs[d].type=Xflow.DATA_TYPE_MAP[a.outputs[d].type];for(d=0;d<a.params.length;++d)a.params[d].type=Xflow.DATA_TYPE_MAP[a.params[d].type],b[a.params[d].source]=d;a.mapping||(a.mapping=a.params);for(d=0;d<a.mapping.length;++d){var e=a.mapping[d],c=b[e.source];e.paramIdx=c;c=a.params[c].type;e.sequence&&(e.keyParamIdx=b[e.keySource]);e.sequence==Xflow.SEQUENCE.LINEAR_WEIGHT&&(c=Xflow.DATA_TYPE.FLOAT);e.internalType=c;e.name=e.name||
e.source}}var b={};Xflow.registerOperator=function(a,f){c(f);b[a]=f;f.name=a};Xflow.initAnonymousOperator=function(a){c(a);a.name="Anonymous Operator";return a};Xflow.getOperator=function(a){return a&&!b[a]?null:b[a]}})();
(function(){function c(d,e){var f="function (",c=b(d.evaluate_core),f=f+(c.args.join(",")+",__xflowMax) {\n"),f=f+"    var __xflowI = __xflowMax\n    while(__xflowI--){\n",g=c.body,g=a(g,c.args,d,e);return eval("("+(f+(g+"\n  }\n}"))+")")}function b(a){var b={},d=a.toString().match(h);if(!d)return Xflow.notifyError("Xflow Internal: Could not parse function: "+a),null;b.args=d[2].split(",");for(var e in b.args)b.args[e]=b.args[e].trim();b.body=d[3];return b}function a(a,b,d,e){for(var f="",c=0,g=a.indexOf("[",
c);-1!=g;){var h=a.substr(c).match(i)[1],o=b.indexOf(h),h=!1,u=0;-1!=o&&(o<d.outputs.length?(h=!0,u=Xflow.DATA_TYPE_TUPLE_SIZE[[d.outputs[o].type]]):(o-=d.outputs.length,h=e.iterFlag[o],u=Xflow.DATA_TYPE_TUPLE_SIZE[d.mapping[o].internalType]));f+=a.substring(c,g)+"[";h&&(f+=u+"*__xflowI + ");c=g+1;g=a.indexOf("[",c)}return f+=a.substring(c)}function f(a,b){for(var e=[],f=a.operator.outputs,c=0;c<f.length;++c){var g=b.outputs[a.getOutputIndex(c)].dataEntry;e.push(g?g.getValue():null)}d(e,a,b);return e}
function d(a,b,d){for(var e=b.operator.mapping,f=0;f<e.length;++f){var c=d.getDataEntry(b.getDirectInputIndex(f));a.push(c?c.getValue():null)}}Xflow.OperatorEntry=function(a){this.index=0;this.operator=a;this.inputInfo=[];this.outputInfo=[]};Xflow.OperatorEntry.prototype.isTransferInput=function(a){return void 0!==this.inputInfo[a].operatorIndex};Xflow.OperatorEntry.prototype.getTransferInputOperatorIndex=function(a){return this.inputInfo[a].operatorIndex};Xflow.OperatorEntry.prototype.getTransferInputOutputIndex=
function(a){return this.inputInfo[a].outputIndex};Xflow.OperatorEntry.prototype.getTransferInputId=function(a){a=this.inputInfo[a];return a.operatorIndex+"_"+a.outputIndex};Xflow.OperatorEntry.prototype.getTransferOutputId=function(a){return this.index+"_"+a};Xflow.OperatorEntry.prototype.getInputMappingName=function(a){return this.inputInfo[a].mappedName};Xflow.OperatorEntry.prototype.getDirectInputIndex=function(a){return this.inputInfo[a].inputIndex};Xflow.OperatorEntry.prototype.getOutputIndex=
function(a){return this.outputInfo[a].finalOut||this.outputInfo[a].lost||0};Xflow.OperatorEntry.prototype.isFinalOutput=function(a){return this.outputInfo[a]&&void 0!==this.outputInfo[a].finalOut};Xflow.OperatorEntry.prototype.isTransferOutput=function(a){return this.outputInfo[a]&&this.outputInfo[a].transfer};Xflow.OperatorEntry.prototype.isLostOutput=function(a){return this.outputInfo[a]&&void 0!==this.outputInfo[a].lost};Xflow.OperatorEntry.prototype.setTransferInput=function(a,b,d){this.inputInfo[a]=
{operatorIndex:b,outputIndex:d}};Xflow.OperatorEntry.prototype.setDirectInput=function(a,b,d){this.inputInfo[a]={inputIndex:b,mappedName:d}};Xflow.OperatorEntry.prototype.setFinalOutput=function(a,b){this.outputInfo[a]={finalOut:b}};Xflow.OperatorEntry.prototype.setTransferOutput=function(a){this.outputInfo[a]={transfer:!0}};Xflow.OperatorEntry.prototype.setLostOutput=function(a,b){this.outputInfo[a]={lost:b}};Xflow.OperatorEntry.prototype.getKey=function(){for(var a=this.operator.name+"*O",b=0;b<
this.outputInfo.length;++b)var d=this.outputInfo[b],a=a+("*"+(d.transfer?"_":d.finalOut||d.lost+"?"));a+=NaN;for(b=0;b<this.inputInfo.length;++b)d=this.inputInfo[b],a+="*"+(d.inputIndex?d.inputInfo:d.operatorIndex+">"+d.outputIndex);return a};Xflow.OperatorList=function(a){this.platform=a;this.entries=[];this.inputInfo={}};Xflow.OperatorList.prototype.addEntry=function(a){a.index=this.entries.length;this.entries.push(a)};Xflow.OperatorList.prototype.getKey=function(){for(var a=[],b=0;b<this.entries.length;++b)a.push(this.entries[b].getKey());
a=this.platform+">"+a.join("!")+"|";for(b in this.inputInfo)a+=b+">"+(this.inputInfo[b].iterate||0)+"x"+(this.inputInfo[b].size||0);return a};Xflow.OperatorList.prototype.setInputIterateType=function(a,b){this.inputInfo[a]||(this.inputInfo[a]={});this.inputInfo[a].iterate=b};Xflow.OperatorList.prototype.setInputSize=function(a,b){this.inputInfo[a]||(this.inputInfo[a]={});this.inputInfo[a].size=b};Xflow.OperatorList.prototype.isInputIterate=function(a){return this.inputInfo[a]&&this.inputInfo[a].iterate==
Xflow.ITERATION_TYPE.MANY};Xflow.OperatorList.prototype.isInputUniform=function(a){return this.inputInfo[a]&&this.inputInfo[a].iterate==Xflow.ITERATION_TYPE.ONE};Xflow.OperatorList.prototype.isInputNull=function(a){return this.inputInfo[a]&&this.inputInfo[a].iterate==Xflow.ITERATION_TYPE.NULL};Xflow.OperatorList.prototype.getInputIterateType=function(a){return this.inputInfo[a]&&this.inputInfo[a].iterate};Xflow.OperatorList.prototype.getInputSize=function(a){return this.inputInfo[a]&&this.inputInfo[a].size||
0};Xflow.OperatorList.prototype.getIterateCount=function(a){for(var b=-1,d=0;d<a.inputs.length;++d)if(this.isInputIterate(d)){var e=a.getDataEntry(d);e&&e.getIterateCount&&(e=e.getIterateCount(),b=0>b?e:Math.min(e,b))}return 0>b?1:b};var e={};Xflow.OperatorList.prototype.allocateOutput=function(a){for(var b=0;b<this.entries.length;++b){var f=this.entries[b],c=f.operator,g=a.operatorData[b],h=this.getIterateCount(a);if(c.alloc){var i=[e];d(i,f,a);i.push(h);c.alloc.apply(g,i)}for(g=0;g<c.outputs.length;++g){var n=
c.outputs[g],i=a.outputs[f.getOutputIndex(g)].dataEntry;if(i.type==Xflow.DATA_TYPE.TEXTURE)if(n.customAlloc){var n=e[n.name],o=n.imageFormat.width,u=n.imageFormat.height,x=n.imageFormat.type,n=n.samplerConfig;i._createImage(o,u,x,n)}else if(n.sizeof){for(var B=null,o=0;o<c.mapping.length;++o)if(c.mapping[o].source==n.sizeof){B=a.getDataEntry(f.getDirectInputIndex(o));break}if(B)o=Math.max(B.getWidth(),1),u=Math.max(B.getHeight(),1),x=n.formatType||B.getFormatType(),n=n.samplerConfig||B.getSamplerConfig(),
i._createImage(o,u,x,n);else throw Error("Unknown texture input parameter '"+n.sizeof+"' in operator '"+c.name+"'");}else throw Error("Cannot create texture. Use customAlloc or sizeof parameter attribute");else if(o=(n.customAlloc?e[n.name]:h)*i.getTupleSize(),!i._value||i._value.length!=o)switch(i.type){case Xflow.DATA_TYPE.FLOAT:case Xflow.DATA_TYPE.FLOAT2:case Xflow.DATA_TYPE.FLOAT3:case Xflow.DATA_TYPE.FLOAT4:case Xflow.DATA_TYPE.FLOAT4X4:i._setValue(new Float32Array(o));break;case Xflow.DATA_TYPE.INT:case Xflow.DATA_TYPE.INT4:case Xflow.DATA_TYPE.BOOL:i._setValue(new Int32Array(o));
break;default:XML3D.debug.logWarning("Could not allocate output buffer of TYPE: "+i.type)}else i._notifyChanged()}}};Xflow.ProgramData=function(){this.inputs=[];this.outputs=[];this.operatorData=[]};Xflow.ProgramData.prototype.getChannel=function(a){return this.inputs[a].channel};Xflow.ProgramData.prototype.getDataEntry=function(a){var a=this.inputs[a],b=a.channel;if(!b)return null;var d=0;a.sequenceKeySourceChannel&&(d=(d=a.sequenceKeySourceChannel.getDataEntry())&&d._value?d._value[0]:0);return b.getDataEntry(a.sequenceAccessType,
d)};Xflow.ProgramInputConnection=function(){this.channel=null;this.arrayAccess=!1;this.sequenceAccessType=Xflow.SEQUENCE.NO_ACCESS;this.sequenceKeySourceChannel=null};Xflow.ProgramInputConnection.prototype.getKey=function(){return(this.channel?this.channel.id:"NULL")+";"+this.arrayAccess+";"+this.sequenceAccessType+";"+(this.sequenceKeySourceChannel?this.sequenceKeySourceChannel.id:"")};var g={};Xflow.createProgram=function(a){if(0==a.entries.length)return null;var b=a.getKey();g[b]||(a.platform==
Xflow.PLATFORM.GLSL?g[b]=new Xflow.VSProgram(a):1==a.entries.length?g[b]=new Xflow.SingleProgram(a):Xflow.notifyError("Could not create program from operatorList"));return g[b]};Xflow.SingleProgram=function(a){this.list=a;this.entry=a.entries[0];this.operator=this.entry.operator;this._inlineLoop=null};Xflow.SingleProgram.prototype.run=function(a){var b=this.list,d=a.operatorData[0],e=b.entries[0],g=e.operator.mapping;d.iterFlag={};for(var h=0;h<g.length;++h){var i=e.isTransferInput(h)||b.isInputIterate(e.getDirectInputIndex(h));
d.iterFlag[h]=i}d.iterateCount=b.getIterateCount(a);this.operator.evaluate_core?(a=f(this.entry,a),a.push(d.iterateCount),this._inlineLoop||(this._inlineLoop=c(this.operator,d)),this._inlineLoop.apply(d,a)):(b=this.entry,a=f(b,a),a.push(d),b.operator.evaluate.apply(d,a))};var h=/function\s+([^(]*)\(([^)]*)\)\s*\{([\s\S]*)\}/,i=/([a-zA-Z_$][\w$]*)(\[)/})();
(function(){function c(a,b){for(var e=a,c=1;-1!=b.indexOf(e);)e=a+"_"+ ++c;Xflow.nameset.add(b,e);return e}function b(a){switch(a){case Xflow.DATA_TYPE.BOOL:return"bool";case Xflow.DATA_TYPE.BYTE:return"uint";case Xflow.DATA_TYPE.FLOAT:return"float";case Xflow.DATA_TYPE.FLOAT2:return"vec2";case Xflow.DATA_TYPE.FLOAT3:return"vec3";case Xflow.DATA_TYPE.FLOAT4:return"vec4";case Xflow.DATA_TYPE.FLOAT4X4:return"mat4";case Xflow.DATA_TYPE.INT:return"int";case Xflow.DATA_TYPE.INT4:return"ivec4"}throw Error("Type not supported for GLSL "+
Xflow.getTypeName(a));}var a={};a[Xflow.SHADER_CONSTANT_KEY.OBJECT_ID]="int";a[Xflow.SHADER_CONSTANT_KEY.SCREEN_TRANSFORM]="mat4";a[Xflow.SHADER_CONSTANT_KEY.SCREEN_TRANSFORM_NORMAL]="mat3";a[Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM]="mat4";a[Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM_NORMAL]="mat3";a[Xflow.SHADER_CONSTANT_KEY.WORLD_TRANSFORM]="mat4";a[Xflow.SHADER_CONSTANT_KEY.WORLD_TRANSFORM_NORMAL]="mat3";Xflow.VSProgram=function(f){this.list=f;this._glslCode=null;this._shaderInputNames=[];this._shaderOutputNames=
[];this._inputInfo={};this._outputInfo={};var d=this.list,f=d.entries,e=[],g={},h={},i=f[f.length-1],j=[],k=i.operator,l=k.vsConfig,m=k.outputInputMap;if(!l)throw Error("Could not find vsConfig! Attempt to create vertex shader programm without VS operator?");for(var r=0;r<f.length;++r)f[r].blockedNames&&Xflow.nameset.add(e,f[r].blockedNames);var p;p="// GLOBALS\n";for(var q in Xflow.shaderConstant){var n=Xflow.shaderConstant[q];p+="uniform "+a[q]+" "+n+";\n";Xflow.nameset.add(e,n)}p+="\n// OUTPUT\n";
for(r=0;r<l._attributes.length;++r){var o=l._attributes[r];q=m[r];var n=i.getDirectInputIndex(q),u={type:o.type,iteration:0,index:0,sourceName:o.inputName},o=o.outputName;l.isAttributeTransformed(r)||i.isTransferInput(q)||d.isInputIterate(n)?(j[q]=!0,u.iteration=Xflow.ITERATION_TYPE.MANY,p+="varying "+b(k.outputs[r].type)+" "+o+";\n",Xflow.nameset.add(e,o),h[i.getTransferOutputId(r)]=o):d.isInputUniform(n)?(u.iteration=Xflow.ITERATION_TYPE.ONE,u.index=n):u.iteration=Xflow.ITERATION_TYPE.NULL;Xflow.nameset.add(this._shaderOutputNames,
o);this._outputInfo[o]=u}p+="\n// INPUT\n";for(r=0;r<f.length;++r){i=f[r];k=i.operator;for(l=0;l<k.mapping.length;++l)if((r<f.length-1||j[l])&&!i.isTransferInput(l)&&!g[i.getDirectInputIndex(l)])m=k.mapping[l],n=c(m.name,e),q=i.getDirectInputIndex(l),u=!d.isInputIterate(q),this._inputInfo[n]={index:q,uniform:u},Xflow.nameset.add(this._shaderInputNames,n),g[q]=n,p+=(u?"uniform ":"attribute ")+b(m.internalType)+" "+n,m.array&&(p+="["+d.getInputSize(q)+"]"),p+=";\n"}p+="\n// CODE\nvoid main(void){\n";
for(r=0;r<f.length;++r){i=f[r];k=i.operator;for(l=0;l<k.outputs.length;++l)i.isFinalOutput(l)||(n=c(k.outputs[l].name,e),h[i.getTransferOutputId(l)]=n,p+="\t"+b(k.outputs[l].type)+" "+n+";\n");d=k.evaluate_glsl;if(k.glsl_fragments)for(o in this._outputInfo)this._outputInfo[o].iteration==Xflow.ITERATION_TYPE.MANY&&(d+="\n"+k.glsl_fragments[o]);for(;-1!=(j=d.indexOf("#I{"));){q=d.indexOf("}",j);a:{n=d.substring(j+3,q);for(l=0;l<k.mapping.length;++l)if(k.mapping[l].name==n){n=l;break a}throw Error("Invalid input name '"+
n+"' inside of code fragment");}n=i.isTransferInput(n)?h[i.getTransferInputId(n)]:g[i.getDirectInputIndex(n)];d=d.substring(0,j)+n+d.substring(q+1)}for(;-1!=(j=d.indexOf("#O{"));){q=d.indexOf("}",j);a:{n=d.substring(j+3,q);for(l=0;l<k.outputs.length;++l)if(k.outputs[l].name==n){n=l;break a}n=void 0}n=h[i.getTransferOutputId(n)];d=d.substring(0,j)+n+d.substring(q+1)}for(i=[];-1!=(j=d.indexOf("#L{"));)q=d.indexOf("}",j),k=d.substring(j+3,q),i[k]||(i[k]=c(k,e)),n=i[k],d=d.substring(0,j)+n+d.substring(q+
1);for(;-1!=(j=d.indexOf("#G{"));)q=d.indexOf("}",j),n=d.substring(j+3,q),d=d.substring(0,j)+n+d.substring(q+1);p+=d+"\n"}this._glslCode=p+"}\n"};Xflow.VSProgram.prototype.isInputUniform=function(a){return this._inputInfo[a].uniform};Xflow.VSProgram.prototype.getInputData=function(a,b){return b.getDataEntry(this._inputInfo[a].index)};Xflow.VSProgram.prototype.getShaderOutputType=function(a){return this._outputInfo[a].type};Xflow.VSProgram.prototype.getShaderOutputSourceName=function(a){return this._outputInfo[a].sourceName};
Xflow.VSProgram.prototype.isOutputUniform=function(a){return this._outputInfo[a].iteration==Xflow.ITERATION_TYPE.ONE};Xflow.VSProgram.prototype.isOutputNull=function(a){return this._outputInfo[a].iteration==Xflow.ITERATION_TYPE.NULL};Xflow.VSProgram.prototype.getUniformOutputData=function(a,b){return b.getDataEntry(this._outputInfo[a].index)}})();
Xflow.registerOperator("xflow.morph",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value"},{type:"float3",source:"valueAdd"},{type:"float",source:"weight"}],evaluate:function(c,b,a,f,d){for(var e=0;e<d.iterateCount;e++){var g=f[d.iterFlag[2]?e:0];c[3*e]=b[d.iterFlag[0]?3*e:0]+g*a[d.iterFlag[1]?3*e:0];c[3*e+1]=b[d.iterFlag[0]?3*e+1:1]+g*a[d.iterFlag[1]?3*e+1:1];c[3*e+2]=b[d.iterFlag[0]?3*e+2:2]+g*a[d.iterFlag[1]?3*e+2:2]}return!0},evaluate_core:function(c,b,a,f){c[0]=b[0]+
f[0]*a[0];c[1]=b[1]+f[0]*a[1];c[2]=b[2]+f[0]*a[2]},evaluate_glsl:"\t// xflow.morph \n\t#O{result} = #I{value} + vec3(#I{weight}) * #I{valueAdd};\n"});Xflow.registerOperator("xflow.sub",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value1"},{type:"float3",source:"value2"}],evaluate:function(){throw"Not used!";},evaluate_core:function(c,b,a){c[0]=b[0]-a[0];c[1]=b[1]-a[1];c[2]=b[2]-a[2]}});
Xflow.registerOperator("xflow.normalize",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value"}],evaluate:function(c,b,a){for(var f=0;f<a.iterateCount;f++){var d=3*f,e=b[d],g=b[d+1],h=b[d+2],i=1/Math.sqrt(e*e+g*g+h*h);c[d]=e*i;c[d+1]=g*i;c[d+2]=h*i}}});
Xflow.registerOperator("xflow.lerpSeq",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"sequence"},{type:"float",source:"key"}],mapping:[{name:"value1",source:"sequence",sequence:Xflow.SEQUENCE.PREV_BUFFER,keySource:"key"},{name:"value2",source:"sequence",sequence:Xflow.SEQUENCE.NEXT_BUFFER,keySource:"key"},{name:"weight",source:"sequence",sequence:Xflow.SEQUENCE.LINEAR_WEIGHT,keySource:"key"}],evaluate_core:function(c,b,a,f){var d=1-f[0];c[0]=d*b[0]+f[0]*a[0];c[1]=d*b[1]+f[0]*
a[1];c[2]=d*b[2]+f[0]*a[2]},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.lerpKeys",{outputs:[{type:"float3",name:"result"}],params:[{type:"float",source:"keys",array:!0},{type:"float3",source:"values",array:!0},{type:"float",source:"key"}],alloc:function(c){c.result=3},evaluate:function(c,b,a,f){var d=Math.min(b.length,Math.floor(a.length/3)),e=Xflow.utils.binarySearch(b,f[0],d);0>e||e==d-1?(e=Math.max(0,e),c[0]=a[3*e],c[1]=a[3*e+1],c[2]=a[3*e+2]):(b=(f[0]-b[e])/(b[e+1]-b[e]),f=1-b,c[0]=f*a[3*e]+b*a[3*e+3],c[1]=f*a[3*e+1]+b*a[3*e+4],c[2]=
f*a[3*e+2]+b*a[3*e+5])}});
Xflow.registerOperator("xflow.slerpSeq",{outputs:[{type:"float4",name:"result"}],params:[{type:"float4",source:"sequence"},{type:"float",source:"key"}],mapping:[{name:"value1",source:"sequence",sequence:Xflow.SEQUENCE.PREV_BUFFER,keySource:"key"},{name:"value2",source:"sequence",sequence:Xflow.SEQUENCE.NEXT_BUFFER,keySource:"key"},{name:"weight",source:"sequence",sequence:Xflow.SEQUENCE.LINEAR_WEIGHT,keySource:"key"}],evaluate:function(c,b,a,f,d){for(var e=0;e<d.iterateCount;++e)XML3D.math.quat.slerpOffset(b,d.iterFlag[0]?
4*e:0,a,d.iterFlag[1]?4*e:0,f[0],c,4*e,!0)},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.slerpKeys",{outputs:[{type:"float4",name:"result"}],params:[{type:"float",source:"keys",array:!0},{type:"float4",source:"values",array:!0},{type:"float",source:"key"}],alloc:function(c){c.result=4},evaluate:function(c,b,a,f){var d=Math.min(b.length,Math.floor(a.length/4)),e=Xflow.utils.binarySearch(b,f[0],d);0>e||e==d-1?(e=Math.max(0,e),c[0]=a[4*e],c[1]=a[4*e+1],c[2]=a[4*e+2],c[3]=a[4*e+3]):XML3D.math.quat.slerpOffset(a,4*e,a,4*(e+1),(f[0]-b[e])/(b[e+1]-b[e]),c,0,!0)}});
Xflow.registerOperator("xflow.createTransform",{outputs:[{type:"float4x4",name:"result"}],params:[{type:"float3",source:"translation",optional:!0},{type:"float4",source:"rotation",optional:!0},{type:"float3",source:"scale",optional:!0},{type:"float3",source:"center",optional:!0},{type:"float4",source:"scaleOrientation",optional:!0}],evaluate:function(c,b,a,f,d,e,g){for(var h=0;h<g.iterateCount;h++)XML3D.math.mat4.makeTransformXflow(b?b.subarray(g.iterFlag[0]?3*h:0):null,a?a.subarray(g.iterFlag[1]?
4*h:0):null,f?f.subarray(g.iterFlag[2]?3*h:0):null,d?d.subarray(g.iterFlag[3]?3*h:0):null,e?e.subarray(g.iterFlag[4]?4*h:0):null,c.subarray(16*h));return!0}});
Xflow.registerOperator("xflow.createTransformInv",{outputs:[{type:"float4x4",name:"result"}],params:[{type:"float3",source:"translation",optional:!0},{type:"float4",source:"rotation",optional:!0},{type:"float3",source:"scale",optional:!0},{type:"float3",source:"center",optional:!0},{type:"float4",source:"scaleOrientation",optional:!0}],evaluate:function(c,b,a,f,d,e,g){for(var h=0;h<g.iterateCount;h++)XML3D.math.mat4.makeTransformInvXflow(b?b.subarray(g.iterFlag[0]?3*h:0):null,a?a.subarray(g.iterFlag[1]?
4*h:0):null,f?f.subarray(g.iterFlag[2]?3*h:0):null,d?d.subarray(g.iterFlag[3]?3*h:0):null,e?e.subarray(g.iterFlag[4]?4*h:0):null,c.subarray(16*h))},evaluate_parallel:function(){return!0}});Xflow.registerOperator("xflow.mul",{outputs:[{type:"float4x4",name:"result"}],params:[{type:"float4x4",source:"value1"},{type:"float4x4",source:"value2"}],evaluate:function(c,b,a,f){for(var d=0;d<f.iterateCount;d++)XML3D.math.mat4.multiplyOffset(c,16*d,b,f.iterFlag[0]?16*d:0,a,f.iterFlag[0]?16*d:0)},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.skinDirection",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"dir"},{type:"int4",source:"boneIdx"},{type:"float4",source:"boneWeight"},{type:"float4x4",source:"boneXform",array:!0}],evaluate:function(c,b,a,f,d,e){for(var g=XML3D.math.vec3.create(),h=XML3D.math.vec3.create(),i=0;i<e.iterateCount;++i){for(var j=3*i,k=g[0]=g[1]=g[2]=0;4>k;k++){var l=f[e.iterFlag[2]?4*i+k:k];l&&(XML3D.math.mat4.multiplyOffsetDirection(d,16*a[e.iterFlag[1]?4*i+k:k],
b,j,h),XML3D.math.vec3.scale(h,h,l),XML3D.math.vec3.add(g,g,h))}XML3D.math.vec3.normalize(g,g);c[j]=g[0];c[j+1]=g[1];c[j+2]=g[2]}},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.skinPosition",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"pos"},{type:"int4",source:"boneIdx"},{type:"float4",source:"boneWeight"},{type:"float4x4",source:"boneXform",array:!0}],evaluate:function(c,b,a,f,d,e){for(var g=XML3D.math.vec3.create(),h=XML3D.math.vec3.create(),i=0;i<e.iterateCount;++i){for(var j=3*i,k=g[0]=g[1]=g[2]=0;4>k;k++){var l=f[e.iterFlag[2]?4*i+k:k];l&&(XML3D.math.mat4.multiplyOffsetVec3(d,16*a[e.iterFlag[1]?4*i+k:k],b,j,
h),XML3D.math.vec3.scale(h,h,l),XML3D.math.vec3.add(g,g,h))}c[j]=g[0];c[j+1]=g[1];c[j+2]=g[2]}},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.forwardKinematics",{outputs:[{type:"float4x4",name:"result",customAlloc:!0}],params:[{type:"int",source:"parent",array:!0},{type:"float4x4",source:"xform",array:!0}],alloc:function(c,b,a){b=Math.min(b.length,a.length/16);c.result=b},evaluate:function(c,b,a){for(var f=c.length/16,d=[],e=0;e<f;){if(!d[e]){var g=b[e];if(0<=g)if(d[g])XML3D.math.mat4.multiplyOffset(c,16*e,a,16*e,c,16*g);else{for(;0<=b[g]&&!d[b[g]];)g=b[g];if(0<=b[g])XML3D.math.mat4.multiplyOffset(c,16*g,a,
16*g,c,16*b[g]);else for(var h=0;16>h;h++)c[16*g+h]=a[16*g+h];d[g]=!0;continue}else for(h=0;16>h;h++)c[16*e+h]=a[16*e+h];d[e]=!0}e++}},evaluate_parallel:function(){return!0}});
Xflow.registerOperator("xflow.forwardKinematicsInv",{outputs:[{type:"float4x4",name:"result",customAlloc:!0}],params:[{type:"int",source:"parent",array:!0},{type:"float4x4",source:"xform",array:!0}],alloc:function(c,b,a){b=Math.min(b.length,a.length/16);c.result=b},evaluate:function(c,b,a){for(var f=a.length/16,d=[],e=0;e<f;){if(!d[e]){var g=b[e];if(0<=g)if(d[g])XML3D.math.mat4.multiplyOffset(c,16*e,c,16*g,a,16*e);else{for(;0<=b[g]&&!d[b[g]];)g=b[g];if(0<=b[g])XML3D.math.mat4.multiplyOffset(c,16*
g,c,16*b[g],a,16*g);else for(var h=0;16>h;h++)c[16*g+h]=a[16*g+h];d[g]=!0;continue}else for(h=0;16>h;h++)c[16*e+h]=a[16*e+h];d[e]=!0}e++}}});Xflow.registerOperator("xflow.flipNormal",{outputs:[{type:"float3",name:"result"}],params:[{type:"float3",source:"value"}],evaluate:function(c,b,a){for(var f=0;f<3*a.iterateCount;f++)c[f]=-b[f]}});
Xflow.registerOperator("xflow.createIGIndex",{outputs:[{type:"float2",name:"texcoord",customAlloc:!0}],params:[{type:"int",source:"vertexCount",optional:!1},{type:"texture",source:"positionTex",optional:!1}],alloc:function(c,b,a){c.texcoord=a.width*a.height},evaluate:function(c,b,a){for(var b=0.5/a.width,f=0.5/a.height,d=0,e=0,g=a.height;e<g;e++)for(var h=0,i=a.width;h<i;h++)c[d++]=h/i+b,c[d++]=1-(e/g+f);return!0}});
XML3D.math.vec3.reciprocal=function(c,b){b||(b=c);b[0]=1/c[0];b[1]=1/c[1];b[2]=1/c[2];return b};XML3D.math.mat4.multiplyOffsetVec3=function(c,b,a,f,d){d||(d=a);f||(f=0);var e=a[f+0],g=a[f+1],a=a[f+2];d[0]=c[b+0]*e+c[b+4]*g+c[b+8]*a+c[b+12];d[1]=c[b+1]*e+c[b+5]*g+c[b+9]*a+c[b+13];d[2]=c[b+2]*e+c[b+6]*g+c[b+10]*a+c[b+14];return d};
XML3D.math.mat4.multiplyOffsetDirection=function(c,b,a,f,d){d||(d=a);f||(f=0);var e=a[f+0],g=a[f+1],a=a[f+2];d[0]=c[b+0]*e+c[b+4]*g+c[b+8]*a;d[1]=c[b+1]*e+c[b+5]*g+c[b+9]*a;d[2]=c[b+2]*e+c[b+6]*g+c[b+10]*a;return d};var IDENT_MAT=XML3D.math.mat4.identity(XML3D.math.mat4.create()),TMP_MATRIX=XML3D.math.mat4.create(),TMP_VEC=XML3D.math.vec3.create();
XML3D.math.mat4.makeTransformXflow=function(c,b,a,f,d,e){XML3D.math.mat4.identity(e);c&&XML3D.math.mat4.translate(e,e,c);f&&XML3D.math.mat4.translate(e,e,f);b&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[b[0],b[1],b[2],b[3]],[0,0,0]),XML3D.math.mat4.multiply(e,e,TMP_MATRIX));d&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[d[0],d[1],d[2],d[3]],[0,0,0]),XML3D.math.mat4.multiply(e,e,TMP_MATRIX));a&&XML3D.math.mat4.scale(e,e,a);d&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[d[0],
d[1],d[2],-d[3]],[0,0,0]),XML3D.math.mat4.multiply(e,e,TMP_MATRIX));f&&XML3D.math.mat4.translate(e,e,XML3D.math.vec3.negate(TMP_VEC,f))};
XML3D.math.mat4.makeTransformInvXflow=function(c,b,a,f,d,e){XML3D.math.mat4.identity(e);f&&XML3D.math.mat4.translate(e,e,f);d&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[d[0],d[1],d[2],d[3]],[0,0,0]),XML3D.math.mat4.multiply(e,e,TMP_MATRIX));a&&XML3D.math.mat4.scale(e,e,XML3D.math.vec3.reciprocal(a,TMP_VEC));d&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,[d[0],d[1],d[2],-d[3]],[0,0,0]),XML3D.math.mat4.multiply(e,e,TMP_MATRIX));b&&(XML3D.math.mat4.fromRotationTranslation(TMP_MATRIX,
[b[0],b[1],b[2],-b[3]],[0,0,0]),XML3D.math.mat4.multiply(e,e,TMP_MATRIX));f&&XML3D.math.mat4.translate(e,e,XML3D.math.vec3.negate(TMP_VEC,f));c&&XML3D.math.mat4.translate(e,e,XML3D.math.vec3.negate(TMP_VEC,c))};
XML3D.math.mat4.multiplyOffset=function(c,b,a,f,d,e){var g=d[e+0],h=d[e+1],i=d[e+2],j=d[e+3],k=d[e+4],l=d[e+5],m=d[e+6],r=d[e+7],p=d[e+8],q=d[e+9],n=d[e+10],o=d[e+11],u=d[e+12],x=d[e+13],B=d[e+14],d=d[e+15],e=a[f+0],w=a[f+1],s=a[f+2],D=a[f+3],t=a[f+4],v=a[f+5],y=a[f+6],z=a[f+7],A=a[f+8],C=a[f+9],E=a[f+10],H=a[f+11],F=a[f+12],G=a[f+13],I=a[f+14],a=a[f+15];c[b+0]=e*g+w*k+s*p+D*u;c[b+1]=e*h+w*l+s*q+D*x;c[b+2]=e*i+w*m+s*n+D*B;c[b+3]=e*j+w*r+s*o+D*d;c[b+4]=t*g+v*k+y*p+z*u;c[b+5]=t*h+v*l+y*q+z*x;c[b+6]=
t*i+v*m+y*n+z*B;c[b+7]=t*j+v*r+y*o+z*d;c[b+8]=A*g+C*k+E*p+H*u;c[b+9]=A*h+C*l+E*q+H*x;c[b+10]=A*i+C*m+E*n+H*B;c[b+11]=A*j+C*r+E*o+H*d;c[b+12]=F*g+G*k+I*p+a*u;c[b+13]=F*h+G*l+I*q+a*x;c[b+14]=F*i+G*m+I*n+a*B;c[b+15]=F*j+G*r+I*o+a*d};
XML3D.math.quat.slerpOffset=function(c,b,a,f,d,e,g,h){e||(e=c);var i=b+1,j=b+2,k=b+3,l=f+1,m=f+2,r=f+3,p=g+1,q=g+2,n=g+3,o=c[b]*a[f]+c[i]*a[l]+c[j]*a[m]+c[k]*a[r],u;if(0.01>1-Math.abs(o))u=1-d;else{var x=Math.acos(Math.abs(o)),B=Math.sin(x);u=Math.sin(x*(1-d))/B;d=Math.sin(x*d)/B}h&&0>o&&(u=-u);e[g]=u*c[b]+d*a[f];e[p]=u*c[i]+d*a[l];e[q]=u*c[j]+d*a[m];e[n]=u*c[k]+d*a[r]};
Xflow.registerOperator("xflow.noiseImage",{outputs:[{type:"texture",name:"image",customAlloc:!0}],params:[{type:"int",source:"width"},{type:"int",source:"height"},{type:"float2",source:"scale"},{type:"float",source:"minFreq"},{type:"float",source:"maxFreq"}],alloc:function(c,b,a){var f=new Xflow.SamplerConfig;f.setDefaults();c.image={imageFormat:{width:b[0],height:a[0]},samplerConfig:f}},evaluate:function(c,b,a,f,d,e){for(var b=b[0],a=a[0],d=d[0],e=e[0],c=c.data,g=this.noise=this.noise||new SimplexNoise,
h=0!=d&&0!=e&&d<e,i=0;i<a;++i)for(var j=i/a*f[1],k=1/b,l=0;l<b;++l){var m=l*k*f[0],r;if(h){r=e;for(var p=j,q=0,n=d;n<r;n*=2)q+=Math.abs(g.noise(m*n,p*n))/n;r=q}else r=g.noise(m,j);m=4*(l*b+i);c[m]=Math.floor(255*r);c[m+1]=Math.floor(255*r);c[m+2]=Math.floor(255*r);c[m+3]=255}return!0}});
(function(){Xflow.Filters={};var c=null,b=null;Xflow.Filters.createImageData=function(a,f){c||(c=document.createElement("canvas"));b||(b=c.getContext("2d"));return b.createImageData(a,f)};Xflow.Filters.createImageDataFloat32=function(a,b){return{width:a,height:b,data:new Float32Array(4*a*b)}};Xflow.Filters.grayscale=function(a,b){for(var d=a.data,e=b.data,c=0;c<d.length;c+=4){var h=d[c+3];e[c]=e[c+1]=e[c+2]=0.2126*d[c]+0.7152*d[c+1]+0.0722*d[c+2];e[c+3]=h}return a};Xflow.Filters.convolute=function(a,
b,d,e){for(var c=Math.round(Math.sqrt(d.length)),h=Math.floor(c/2),i=a.data,j=a.width,a=a.height,k=b.data,e=e?1:0,l=0;l<a;l++)for(var m=0;m<j;m++){for(var r=l,p=m,q=4*(l*j+m),n=0,o=0,u=0,x=0,B=0;B<c;B++)for(var w=0;w<c;w++){var s=r+B-h,D=p+w-h;0<=s&&s<a&&0<=D&&D<j&&(s=4*(s*j+D),D=d[B*c+w],n+=i[s]*D,o+=i[s+1]*D,u+=i[s+2]*D,x+=i[s+3]*D)}k[q]=n;k[q+1]=o;k[q+2]=u;k[q+3]=x+e*(255-x)}return b}})();
function float4(c,b,a,f){var d=new Float32Array(4);switch(arguments.length){case 0:d[0]=0;d[1]=0;d[2]=0;d[3]=0;break;case 1:d[0]=c;d[1]=c;d[2]=c;d[3]=c;break;case 2:d[0]=c;d[1]=b;d[2]=0;d[3]=0;break;case 3:d[0]=c;d[1]=b;d[2]=a;d[3]=0;break;default:d[0]=c,d[1]=b,d[2]=a,d[3]=f}return d}function hypot(c,b){return Math.sqrt(c*c+b*b)}function hypot4(c,b){return float4(hypot(c[0],b[0]),hypot(c[1],b[1]),hypot(c[2],b[2]),hypot(c[3],b[3]))}
function hypot4To(c,b,a){c[0]=hypot(b[0],a[0]);c[1]=hypot(b[1],a[1]);c[2]=hypot(b[2],a[2]);c[3]=hypot(b[3],a[3])}function getTexel2D(c,b,a){b=4*(a*c.width+b);c=c.data;a=new Float32Array(4);a[0]=c[b]/255;a[1]=c[b+1]/255;a[2]=c[b+2]/255;a[3]=c[b+3]/255;return a}function getTexel2DTo(c,b,a,f){a=4*(f*b.width+a);b=b.data;c[0]=b[a]/255;c[1]=b[a+1]/255;c[2]=b[a+2]/255;c[3]=b[a+3]/255;return c}
function setTexel2D(c,b,a,f){b=4*(a*c.width+b);c=c.data;c[b]=255*f[0];c[b+1]=255*f[1];c[b+2]=255*f[2];c[b+3]=255*f[3]}
Xflow.registerOperator("xflow.sobelImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(c,b){for(var a=b.width,f=b.height,d=float4(0),e=float4(0),g=float4(),g=float4(),h=float4(),i=float4(),j=float4(),k=float4(),l=float4(),m=float4(),r=float4(),p=float4(),q=float4(),n=0;n<f;++n)for(var o=0;o<a;++o)1<=o&&o<a-1&&1<=n&&n<f-1&&(getTexel2DTo(g,b,o-1,n-1),getTexel2DTo(h,b,o,n-1),getTexel2DTo(i,b,o+1,n-1),getTexel2DTo(j,b,o-1,n),getTexel2DTo(k,
b,o,n),getTexel2DTo(l,b,o+1,n),getTexel2DTo(m,b,o-1,n+1),getTexel2DTo(r,b,o,n+1),getTexel2DTo(p,b,o+1,n+1),d[0]=g[0]+2*h[0]+i[0]-m[0]-2*r[0]-p[0],d[1]=g[1]+2*h[1]+i[1]-m[1]-2*r[1]-p[1],d[2]=g[2]+2*h[2]+i[2]-m[2]-2*r[2]-p[2],e[0]=g[0]-i[0]+2*j[0]-2*l[0]+m[0]-p[0],e[1]=g[1]-i[1]+2*j[1]-2*l[1]+m[1]-p[1],e[2]=g[2]-i[2]+2*j[2]-2*l[2]+m[2]-p[2],hypot4To(q,d,e),q[0]/=2,q[1]/=2,q[2]/=2,q[3]=1,setTexel2D(c,o,n,q));return!0}});
Xflow.registerOperator("xflow.grayscaleImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(c,b){for(var a=b.data,f=c.data,d=0;d<a.length;d+=4){var e=a[d+3];f[d]=f[d+1]=f[d+2]=0.2126*a[d]+0.7152*a[d+1]+0.0722*a[d+2];f[d+3]=e}return!0}});
Xflow.registerOperator("xflow.sepiaImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(c,b){for(var a=b.data,f=c.data,d=0,e=0,g=0,h=0;h<a.length;h+=4)d=0.393*a[h]+0.769*a[h+1]+0.189*a[h+2],e=0.349*a[h]+0.686*a[h+1]+0.168*a[h+2],g=0.272*a[h]+0.534*a[h+1]+0.131*a[h+2],255<d&&(d=255),255<e&&(e=255),255<g&&(g=255),0>d&&(d=0),0>e&&(e=0),0>g&&(g=0),f[h]=d,f[h+1]=e,f[h+2]=g,f[h+3]=255;return!0},evaluate_parallel:function(c,b){var a=c[0],
f=c[1],d=0.393*b[a][f][0]+0.769*b[a][f][1]+0.189*b[a][f][2],e=0.349*b[a][f][0]+0.686*b[a][f][1]+0.168*b[a][f][2],a=0.272*b[a][f][0]+0.534*b[a][f][1]+0.131*b[a][f][2];255<d&&(d=255);255<e&&(e=255);255<a&&(a=255);0>d&&(d=0);0>e&&(e=0);0>a&&(a=0);return[d,e,a,255]}});
Xflow.registerOperator("xflow.clampImage",{outputs:[{type:"texture",name:"result",sizeof:"image",formatType:"ImageData"}],params:[{type:"texture",source:"image"},{type:"float",source:"min"},{type:"float",source:"max"}],evaluate:function(c,b,a,f){for(var d=b.data,c=c.data,a=a[0],f=f[0],b=b.data.length,e=0;e<b;e++){var g=d[e];g<a&&(g=a);g>f&&(g=f);c[e]=g}return!0}});
(function(){function c(b,a,f,d){for(var e=Math.round(Math.sqrt(f.length)),c=Math.floor(e/2),h=b.data,i=b.width,b=b.height,j=a.data,d=d?1:0,k=0;k<b;k++)for(var l=0;l<i;l++){for(var m=k,r=l,p=4*(k*i+l),q=0,n=0,o=0,u=0,x=0;x<e;x++)for(var B=0;B<e;B++){var w=m+x-c,s=r+B-c;0<=w&&w<b&&0<=s&&s<i&&(w=4*(w*i+s),s=f[x*e+B],q+=h[w]*s,n+=h[w+1]*s,o+=h[w+2]*s,u+=h[w+3]*s)}j[p]=q;j[p+1]=n;j[p+2]=o;j[p+3]=u+d*(255-u)}return a}Xflow.registerOperator("xflow.convoluteImage",{outputs:[{type:"texture",name:"result",
sizeof:"image"}],params:[{type:"texture",source:"image"},{type:"float",source:"kernel"}],evaluate:function(b,a,f){c(a,b,f,!0);return!0}});Xflow.registerOperator("xflow.convoluteImageToFloat",{outputs:[{type:"texture",name:"result",sizeof:"image",formatType:"float32"}],params:[{type:"texture",source:"image"},{type:"float",source:"kernel"}],evaluate:function(b,a,f){c(a,b,f,!0);return!0}})})();
Xflow.registerOperator("xflow.funMirrorImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"},{type:"float",source:"time"}],evaluate:function(c,b,a){for(var f=c.width,d=c.height,a=a[0],b=b.data,c=c.data,e=0;e<d;++e)for(var g=0;g<f;++g){var h=g/f,i=e/d,h=2*h-1,j=2*i-1,i=Math.sqrt(h*h+j*j),j=Math.atan2(j,h),i=Math.pow(i,1/1.8)*a,h=i*Math.cos(j),j=i*Math.sin(j),h=h/2+0.5,i=j/2+0.5,h=Math.round(h*f),h=4*(Math.round(i*d)*f+h),i=b[h],j=b[h+1],k=b[h+2],l=
b[h+3],h=4*(e*f+g);c[h]=i;c[h+1]=j;c[h+2]=k;c[h+3]=l}return!0}});Xflow.registerOperator("xflow.popartImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"},{type:"float",source:"time"}],evaluate:function(c,b){for(var a=b.data,f=c.data,d=0;d<a.length;d+=4){var e=0.3*(a[d]/255)+0.59*(a[d+1]/255)+0.11*(a[d+2]/255),e=0.3>e?0:0.6>e?0.5:1;0.5==e?(f[d]=204,f[d+1]=0):1==e?(f[d]=229.5,f[d+1]=229.5):(f[d]=0,f[d+1]=0);f[d+2]=0;f[d+3]=a[d+3]}return!0}});
Xflow.registerOperator("xflow.magnitudeImage",{outputs:[{type:"texture",name:"result",sizeof:"image1"}],params:[{type:"texture",source:"image1"},{type:"texture",source:"image2"}],evaluate:function(c,b,a){for(var b=b.data,a=a.data,c=c.data,f=b.length,d=0;d<f;d+=1){var e=b[d],g=a[d];c[d]=Math.sqrt(e*e+g*g)}return!0}});
Xflow.registerOperator("xflow.flipVerticalImage",{outputs:[{type:"texture",name:"result",sizeof:"image"}],params:[{type:"texture",source:"image"}],evaluate:function(c,b){for(var a=b.width,f=b.height,d=c.data,e=b.data,g=0;g<f;++g)for(var h=0;h<a;++h){var i=g*a,j=4*(i+h),i=4*(i+(a-1-h));d[i]=e[j];d[i+1]=e[j+1];d[i+2]=e[j+2];d[i+3]=e[j+3]}return!0}});
Xflow.registerOperator("xflow.selectTransform",{outputs:[{type:"float4x4",name:"result",customAlloc:!0}],params:[{type:"int",source:"index"},{type:"float4x4",source:"transform"}],alloc:function(c){c.result=1},evaluate:function(c,b,a){b=16*b[0];b<a.length&&b+15<a.length?(c[0]=a[b+0],c[1]=a[b+1],c[2]=a[b+2],c[3]=a[b+3],c[4]=a[b+4],c[5]=a[b+5],c[6]=a[b+6],c[7]=a[b+7],c[8]=a[b+8],c[9]=a[b+9],c[10]=a[b+10],c[11]=a[b+11],c[12]=a[b+12],c[13]=a[b+13],c[14]=a[b+14],c[15]=a[b+15]):(c[0]=1,c[1]=0,c[2]=0,c[3]=
0,c[4]=0,c[5]=1,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1)}});Xflow.registerOperator("xflow.selectBool",{outputs:[{type:"bool",name:"result",customAlloc:!0}],params:[{type:"int",source:"index"},{type:"bool",source:"value"}],alloc:function(c){c.result=1},evaluate:function(c,b,a){b=b[0];c[0]=b<a.length?a[b]:!1}});
(function(){var c=[[-1,-1,-1],[1,-1,-1],[-1,1,-1],[1,1,-1],[-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[-1,-1,-1],[1,-1,-1],[-1,-1,1],[1,-1,1],[1,-1,-1],[1,1,-1],[1,-1,1],[1,1,1],[-1,1,-1],[1,1,-1],[-1,1,1],[1,1,1],[-1,-1,1],[1,-1,1],[-1,1,1],[1,1,1]],b=[[0,0,-1],[0,0,-1],[0,0,-1],[0,0,-1],[-1,0,0],[-1,0,0],[-1,0,0],[-1,0,0],[0,-1,0],[0,-1,0],[0,-1,0],[0,-1,0],[1,0,0],[1,0,0],[1,0,0],[1,0,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,0,1],[0,0,1],[0,0,1],[0,0,1]],a=[[0,1,2,1,2,3],[4,5,6,5,6,7],[8,9,10,9,10,11],
[12,13,14,13,14,15],[16,17,18,17,18,19],[20,21,22,21,22,23]];Xflow.registerOperator("xflow.debug.createSkinCubes",{outputs:[{type:"int",name:"index",customAlloc:!0},{type:"float3",name:"position",customAlloc:!0},{type:"float3",name:"normal",customAlloc:!0},{type:"int4",name:"boneIndices",customAlloc:!0},{type:"float4",name:"boneWeights",customAlloc:!0}],params:[{type:"float4x4",source:"bindTransforms",array:!0},{type:"float",source:"size",array:!0,optional:!0}],alloc:function(a,b){var e=b.length/
16;a.position=24*e;a.normal=24*e;a.boneIndices=24*e;a.boneWeights=24*e;a.index=36*e},evaluate:function(f,d,e,g,h,i,j){for(var k=i.length/16,j=(j&&j[0]||1)/2,l=XML3D.math.vec3.create(),m=XML3D.math.vec3.create(),r=0;r<k;++r)for(var p=0;6>p;++p){for(var q=0;4>q;q++){var n=4*p+q,o=24*r+n;XML3D.math.vec3.copy(l,c[n]);XML3D.math.vec3.scale(l,l,j);XML3D.math.mat4.multiplyOffsetVec3(i,16*r,l,0);XML3D.math.vec3.copy(m,b[n]);XML3D.math.mat4.multiplyOffsetDirection(i,16*r,m,0);d[3*o+0]=l[0];d[3*o+1]=l[1];d[3*
o+2]=l[2];e[3*o+0]=m[0];e[3*o+1]=m[1];e[3*o+2]=m[2];g[4*o+0]=r;g[4*o+1]=g[4*o+2]=g[4*o+3]=0;h[4*o+0]=1;h[4*o+1]=h[4*o+2]=h[4*o+3]=0}n=36*r+6*p;for(q=0;6>q;++q)f[n+q]=24*r+a[p][q]}}})})();XML3D.data={toString:function(){return"data"}};XML3D.data=XML3D.data||{};
(function(){function c(d){var f=d.xflowDataNode;f.setCompute(d.node.getAttribute("compute"));f.computeDataflowUrl?a(d,"dataflow",f.computeDataflowUrl):(d.disconnectAdapterHandle("dataflow"),b(d))}function b(a){var b=!1,d=a.getConnectedAdapterHandle("src");d&&d.status==XML3D.base.AdapterHandle.STATUS.LOADING&&(b=!0);(d=a.getConnectedAdapterHandle("dataflow"))&&d.status==XML3D.base.AdapterHandle.STATUS.LOADING&&(b=!0);a.xflowDataNode.setLoading(b)}function a(a,b,d){var f=(d=a.getAdapterHandle(d))&&
d.status;f==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logError("Could not find element of url '"+d.url+"' for "+b,a.node);a.connectAdapterHandle(b,d);a.connectedAdapterChanged(b,d?d.getAdapter():null,f)}function f(a){var b=a.node.getAttribute("out");b?a.xflowDataNode.setFilter("keep("+b+")"):a.xflowDataNode.setFilter("")}function d(b,d){b.xflowDataNode.clearChildren();b.xflowDataNode.setCompute("");b.clearAdapterHandles();b.dataflowRefs=[];f(b);var c=d.lastElementChild,i=!0,j=null,k=
b.xflowDataNode;do{var l=b.factory.getAdapter(c);if(l)if(l.getXflowNode){var m=l.getXflowNode();j?k.insertBefore(m,j):k.appendChild(m);j=m}else if(l.getComputeCode)for(var l=l.getComputeCode().split(";"),r=l.length;r--;)if(l[r].trim()&&(i?i=!1:(m=XML3D.data.xflowGraph.createDataNode(),j?k.insertBefore(m,j):k.appendChild(m),k=m,j=null),k.userData=c,k.setCompute(l[r].trim()),k.computeDataflowUrl))m=b.dataflowRefs.length,b.dataflowRefs.push(k),a(b,m,k.computeDataflowUrl)}while(c=c.previousElementSibling)}
XML3D.data.xflowGraph=new Xflow.Graph;Xflow.setShaderConstant(Xflow.SHADER_CONSTANT_KEY.OBJECT_ID,"objectID");Xflow.setShaderConstant(Xflow.SHADER_CONSTANT_KEY.SCREEN_TRANSFORM,"modelViewProjectionMatrix");Xflow.setShaderConstant(Xflow.SHADER_CONSTANT_KEY.SCREEN_TRANSFORM_NORMAL,"modelViewProjectionNormalMatrix");Xflow.setShaderConstant(Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM,"modelViewMatrix");Xflow.setShaderConstant(Xflow.SHADER_CONSTANT_KEY.VIEW_TRANSFORM_NORMAL,"normalMatrix");Xflow.setShaderConstant(Xflow.SHADER_CONSTANT_KEY.WORLD_TRANSFORM,
"modelMatrix");Xflow.registerErrorCallback(function(a,b){var a="Xflow: "+a,d=b.userData;if(d&&d.ownerDocument)if(d.ownerDocument==document)XML3D.debug.logError(a,d);else if(d.id){var f=new XML3D.URI("#"+d.id),f=f.getAbsoluteURI(d.ownerDocument.documentURI);XML3D.debug.logError(a,"External Node: "+f)}else XML3D.debug.logError(a,"External Document: "+d.ownerDocument.documentURI);else"string"==typeof d?XML3D.debug.logError(a,d):XML3D.debug.logError(a)});XML3D.data.BaseDataAdapter=function(a,b){XML3D.base.NodeAdapter.call(this,
a,b);this.xflowDataNode=null};XML3D.createClass(XML3D.data.BaseDataAdapter,XML3D.base.NodeAdapter);XML3D.data.BaseDataAdapter.prototype.getXflowNode=function(){return this.xflowDataNode};XML3D.data.BaseDataAdapter.prototype.getComputeRequest=function(a,b){return new Xflow.ComputeRequest(this.xflowDataNode,a,b)};XML3D.data.BaseDataAdapter.prototype.getComputeResult=function(a){return this.xflowDataNode._getResult(Xflow.RESULT_TYPE.COMPUTE,a)};XML3D.data.BaseDataAdapter.prototype.getOutputNames=function(){return this.xflowDataNode.getOutputNames()};
XML3D.data.BaseDataAdapter.prototype.getOutputChannelInfo=function(a){return this.xflowDataNode.getOutputChannelInfo(a)};XML3D.data.DataAdapter=function(a,b){XML3D.data.BaseDataAdapter.call(this,a,b);this.xflowDataNode=null};XML3D.createClass(XML3D.data.DataAdapter,XML3D.data.BaseDataAdapter);XML3D.data.DataAdapter.prototype.init=function(){this.xflowDataNode=XML3D.data.xflowGraph.createDataNode("proto"==this.node.localName);this.xflowDataNode.userData=this.node;a(this,"src",this.node.getAttribute("src"));
this.xflowDataNode.setFilter(this.node.getAttribute("filter"));c(this);for(var b=this.node.firstElementChild;null!==b;b=b.nextElementSibling){var d=this.factory.getAdapter(b);d&&this.xflowDataNode.appendChild(d.getXflowNode())}};XML3D.data.DataAdapter.prototype.notifyChanged=function(b){if(b.type==XML3D.events.ADAPTER_HANDLE_CHANGED)this.connectedAdapterChanged(b.key,b.adapter,b.handleStatus),b.handleStatus==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logError("Could not find <data> element of url '"+
b.url+"' for "+b.key,this.node);else if(b.type==XML3D.events.NODE_INSERTED){var d=b.wrapped.target;if(b=this.factory.getAdapter(d)){var b=b.getXflowNode(),f=null;do d=d.nextSibling;while(d&&!(f=this.factory.getAdapter(d)));f?this.xflowDataNode.insertBefore(b,f.getXflowNode()):this.xflowDataNode.appendChild(b)}}else b.type==XML3D.events.NODE_REMOVED?(b=this.factory.getAdapter(b.wrapped.target))&&this.xflowDataNode.removeChild(b.getXflowNode()):b.type==XML3D.events.VALUE_MODIFIED?(b=b.wrapped.attrName,
"filter"==b?this.xflowDataNode.setFilter(this.node.getAttribute(b)):"compute"==b?c(this):"src"==b&&a(this,b,this.node.getAttribute(b))):b.type==XML3D.events.THIS_REMOVED&&this.clearAdapterHandles()};XML3D.data.DataAdapter.prototype.connectedAdapterChanged=function(a,d){"src"==a&&(this.xflowDataNode.sourceNode=d?d.getXflowNode():null);"dataflow"==a&&(this.xflowDataNode.dataflowNode=d?d.getXflowNode():null);b(this)};XML3D.data.DataAdapter.prototype.toString=function(){return"XML3D.data.DataAdapter"};
XML3D.data.DataflowDataAdapter=function(a,b){XML3D.data.BaseDataAdapter.call(this,a,b);this.xflowDataNode=null};XML3D.createClass(XML3D.data.DataflowDataAdapter,XML3D.data.BaseDataAdapter);XML3D.data.DataflowDataAdapter.prototype.init=function(){this.xflowDataNode=XML3D.data.xflowGraph.createDataNode();this.dataflowRefs=[];d(this,this.node)};XML3D.data.DataflowDataAdapter.prototype.notifyChanged=function(a){switch(a.type){case XML3D.events.ADAPTER_HANDLE_CHANGED:this.connectedAdapterChanged(a.key,
a.adapter,a.handleStatus);a.handleStatus==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logError("Could not find dataflow of url '"+a.url,this.node);break;case XML3D.events.NODE_INSERTED:case XML3D.events.NODE_REMOVED:d(this);break;case XML3D.events.VALUE_MODIFIED:"out"==a.wrapped.attrName&&f(this)}};XML3D.data.DataflowDataAdapter.prototype.updateXflowNode=function(){d(this,this.node)};XML3D.data.DataflowDataAdapter.prototype.connectedAdapterChanged=function(a,b,d){if(a=this.dataflowRefs[a])a.dataflowNode=
b?b.getXflowNode():null,a.setLoading(d==XML3D.base.AdapterHandle.STATUS.LOADING)};XML3D.data.ComputeDataAdapter=function(a,b){XML3D.base.NodeAdapter.call(this,a,b)};XML3D.createClass(XML3D.data.ComputeDataAdapter,XML3D.base.NodeAdapter);XML3D.data.ComputeDataAdapter.prototype.getComputeCode=function(){return this.node.value};XML3D.data.ComputeDataAdapter.prototype.notifyChanged=function(a){switch(a.type){case XML3D.events.VALUE_MODIFIED:case XML3D.events.NODE_INSERTED:case XML3D.events.NODE_REMOVED:if(a=
this.node.parentNode)(a=this.factory.getAdapter(a))&&a.updateXflowNode()}}})();
(function(){var c={};c["float"]=Xflow.DATA_TYPE.FLOAT;c["int"]=Xflow.DATA_TYPE.INT;c["byte"]=Xflow.DATA_TYPE.BYTE;c.ubyte=Xflow.DATA_TYPE.UBYTE;c.bool=Xflow.DATA_TYPE.BOOL;c.float2=Xflow.DATA_TYPE.FLOAT2;c.float3=Xflow.DATA_TYPE.FLOAT3;c.float4=Xflow.DATA_TYPE.FLOAT4;c.int4=Xflow.DATA_TYPE.INT4;c.float4x4=Xflow.DATA_TYPE.FLOAT4X4;XML3D.data.BUFFER_TYPE_TABLE=c;var b=function(a,b){XML3D.data.DataAdapter.call(this,a,b);this.xflowInputNode=null};XML3D.createClass(b,XML3D.base.NodeAdapter);b.prototype.init=
function(){var a=this.node._configured;this.node.textContent==XML3D.scriptValueLabel?a=a.scriptValue:(delete a.scriptValue,a=this.node.value);a=new Xflow.BufferEntry(c[this.node.localName],a);this.xflowInputNode=XML3D.data.xflowGraph.createInputNode();this.xflowInputNode.name=this.node.name;this.xflowInputNode.data=a;this.xflowInputNode.key=this.node.key;this.xflowInputNode.paramName=this.node.param?this.node.name:null};b.prototype.getXflowNode=function(){return this.xflowInputNode};b.prototype.notifyChanged=
function(a){a.type==XML3D.events.VALUE_MODIFIED&&((a=a.wrapped.attrName)?"name"==a?this.xflowInputNode.name=this.node.name:"key"==a?this.xflowInputNode.key=this.node.key:"param"==a&&(this.xflowInputNode.paramName=this.node.param?this.node.name:null):(delete this.node._configured.scriptValue,this.xflowInputNode.data.setValue(this.node.value)))};b.prototype.setScriptValue=function(a){this.xflowInputNode.data.setValue(a)};b.prototype.toString=function(){return"XML3D.data.ValueDataAdapter"};XML3D.data.ValueDataAdapter=
b})();
(function(){var c=function(a){return"clamp"==a?WebGLRenderingContext.CLAMP_TO_EDGE:"repeat"==a?WebGLRenderingContext.REPEAT:WebGLRenderingContext.CLAMP_TO_EDGE},b=function(a){return"nearest"==a?WebGLRenderingContext.NEAREST:"linear"==a?WebGLRenderingContext.LINEAR:"mipmap_linear"==a?WebGLRenderingContext.LINEAR_MIPMAP_NEAREST:"mipmap_nearest"==a?WebGLRenderingContext.NEAREST_MIPMAP_NEAREST:WebGLRenderingContext.LINEAR},a=function(a,b){XML3D.data.DataAdapter.call(this,a,b)};XML3D.createClass(a,XML3D.base.NodeAdapter);
a.prototype.init=function(){this.xflowInputNode=this.createXflowNode();this.xflowInputNode.data=this.createTextureEntry()};a.prototype.createTextureEntry=function(){var a=this.node,d=new Xflow.TextureEntry(null),e=d.getSamplerConfig();e.wrapS=c(a.wrapS);e.wrapT=c(a.wrapT);e.minFilter=b(a.filterMin);e.magFilter=b(a.filterMin);e.textureType=Xflow.TEX_TYPE.TEXTURE_2D;(a=this.factory.getAdapter(this.node.firstElementChild,XML3D.data.XML3DDataAdapterFactory.prototype))&&a.setTextureEntry(d);return d};
a.prototype.createXflowNode=function(){var a=XML3D.data.xflowGraph.createInputNode();a.name=this.node.name;a.paramName=this.node.param?this.node.name:null;a.key=this.node.key;return a};a.prototype.setScriptValue=function(){XML3D.debug.logError("Texture currently does not support setScriptValue()")};a.prototype.getOutputs=function(){var a={};a[this.node.name]=this;return a};a.prototype.getValue=function(){return this.value};a.prototype.notifyChanged=function(a){a.type==XML3D.events.VALUE_MODIFIED&&
(a=a.wrapped.attrName,"name"==a?this.xflowInputNode.name=this.node.name:"key"==a?this.xflowInputNode.key=this.node.key:"param"==a&&(this.xflowInputNode.paramName=this.node.param?this.node.name:null))};a.prototype.getXflowNode=function(){return this.xflowInputNode};a.prototype.toString=function(){return"XML3D.data.TextureDataAdapter"};XML3D.data.TextureDataAdapter=a})();
(function(){var c=function(a,b){XML3D.data.DataAdapter.call(this,a,b)};XML3D.createClass(c,XML3D.data.DataAdapter);c.prototype.isSinkAdapter=function(){return!0};c.prototype.toString=function(){return"XML3D.data.SinkDataAdapter"};XML3D.data.SinkDataAdapter=c;c=function(a,b){XML3D.base.NodeAdapter.call(this,a,b)};XML3D.createClass(c,XML3D.base.NodeAdapter);XML3D.data.ScriptDataAdapter=c;c.prototype.getScriptType=function(){return this.node.type};c.prototype.getScriptCode=function(){return this.node.value};
c.prototype.notifyChanged=function(a){switch(a.type){case XML3D.events.VALUE_MODIFIED:case XML3D.events.NODE_INSERTED:case XML3D.events.NODE_REMOVED:this.notifyOppositeAdapters()}};c=function(a,b){XML3D.base.NodeAdapter.call(this,a,b);this.image=this.textureEntry=null;b.src&&this.createImageFromURL(b.src)};XML3D.createClass(c,XML3D.base.NodeAdapter);c.prototype.createImageFromURL=function(a){var b=this,a=(new XML3D.URI(a)).getAbsoluteURI(this.node.ownerDocument.documentURI);this.image=XML3D.base.resourceManager.getImage(a,
function(a,c){b.textureEntry&&b.textureEntry.setImage(c)},function(a,b){XML3D.debug.logError("Could not load image URI="+b.src)})};c.prototype.setTextureEntry=function(a){this.textureEntry=a;this.image&&this.textureEntry.setImage(this.image)};c.prototype.notifyChanged=function(a){a.type==XML3D.events.VALUE_MODIFIED&&"src"==a.wrapped.attrName&&this.createImageFromURL(this.node.src)};c.prototype.getValue=function(){return this.image};c.prototype.getOutputs=function(){return{image:this}};c.prototype.resolveScript=
function(){return null};var b=function(a,b){XML3D.data.DataAdapter.call(this,a,b);this.video=this.textureEntry=null;this._ticking=!1;this._boundTick=this._tick.bind(this);b.src&&this.createVideoFromURL(b.src)};XML3D.createClass(b,XML3D.base.NodeAdapter);b.prototype.createVideoFromURL=function(a){var b=this,a=(new XML3D.URI(a)).getAbsoluteURI(this.node.ownerDocument.documentURI);this.video=XML3D.base.resourceManager.getVideo(a,this.node.autoplay,{canplay:function(){XML3D.util.dispatchCustomEvent(b.node,
"canplay",!0,!0,null);b._startVideoRefresh()},ended:function(){XML3D.util.dispatchCustomEvent(b.node,"ended",!0,!0,null)},load:function(){XML3D.util.dispatchEvent(b.node,"load")},error:function(a,c){XML3D.util.dispatchCustomEvent(b.node,"error",!0,!0,null);XML3D.debug.logError("Could not load video URI="+c.src)}});this.textureEntry&&this.textureEntry.setImage(this.video)};b.prototype.play=function(){this.video&&this.video.play()};b.prototype.pause=function(){this.video&&this.video.pause()};b.prototype._startVideoRefresh=
function(){this._ticking||this._tick()};b.prototype._tick=function(){this._ticking=!0;window.requestAnimFrame(this._boundTick,XML3D.webgl.MAXFPS);this.textureEntry&&this.textureEntry.setImage(this.video)};b.prototype.setTextureEntry=function(a){this.textureEntry=a;this.video&&this.textureEntry.setImage(this.video)};b.prototype.notifyChanged=function(a){a.type==XML3D.events.VALUE_MODIFIED&&"src"==a.wrapped.attrName&&this.createVideoFromURL(this.node.src)};b.prototype.getValue=function(){return this.video};
b.prototype.getOutputs=function(){return{video:this}};var a=function(a,b){XML3D.base.NodeAdapter.call(this,a,b);this.image=this.textureEntry=null;this.createImageFromIFrame(b)};XML3D.createClass(a,XML3D.base.NodeAdapter);a.prototype.createImageFromIFrame=function(a){var b=document.createElement("canvas");b.width=a.getAttribute("width");b.height=a.getAttribute("height");b.complete=!1;document.body.appendChild(b);var e=document.createElement("iframe");e.id="newIFrame";e.setAttribute("scrolling","no");
e.width=a.getAttribute("width");e.height=a.getAttribute("height");e.style.position="absolute";e.style.left=-e.width-8+"px";document.body.appendChild(e);e.addEventListener("load",function(){var a={_iframe:e,_canvas:b},f=document.createEvent("CustomEvent");f.initCustomEvent("XML3D_XML3DINIT",!0,!1,a);document.dispatchEvent(f);a._canvas.complete=!0;c.textureEntry&&c.textureEntry.setImage(b)},!0);e.src=a.src;var c=this;this.image=b};a.prototype.setTextureEntry=function(a){this.textureEntry=a;this.image&&
this.textureEntry.setImage(this.image)};XML3D.data.IFrameDataAdapter=a;XML3D.data.ImgDataAdapter=c;XML3D.data.VideoDataAdapter=b})();
(function(){var c=function(){XML3D.base.NodeAdapterFactory.call(this,XML3D.data)};XML3D.createClass(c,XML3D.base.NodeAdapterFactory);var b=c.prototype.aspect=XML3D.data,a={};a.mesh=b.SinkDataAdapter;a.shader=b.SinkDataAdapter;a.lightshader=b.SinkDataAdapter;a["float"]=b.ValueDataAdapter;a.float2=b.ValueDataAdapter;a.float3=b.ValueDataAdapter;a.float4=b.ValueDataAdapter;a.float4x4=b.ValueDataAdapter;a["int"]=b.ValueDataAdapter;a.int4=b.ValueDataAdapter;a.bool=b.ValueDataAdapter;a["byte"]=b.ValueDataAdapter;
a.ubyte=b.ValueDataAdapter;a.img=b.ImgDataAdapter;a.texture=b.TextureDataAdapter;a.data=b.DataAdapter;a.proto=b.DataAdapter;a.dataflow=b.DataflowDataAdapter;a.compute=b.ComputeDataAdapter;a.iframe=b.IFrameDataAdapter;a.video=b.VideoDataAdapter;a.script=b.ScriptDataAdapter;c.prototype.createAdapter=function(b){var d=a[b.localName];if(void 0!==d)return new d(this,b);XML3D.debug.logWarning("Not supported as data element: "+b.localName);return null};XML3D.data.XML3DDataAdapterFactory=c;XML3D.base.xml3dFormatHandler.registerFactoryClass(c)})();
(function(){function c(a,b,d,e,c){c=new f[b](c);b=new Xflow.BufferEntry(XML3D.data.BUFFER_TYPE_TABLE[b],c);c=XML3D.data.xflowGraph.createInputNode();c.data=b;c.name=d;c.key=e;a.appendChild(c)}function b(a,b,e){if(f[e.type])for(var g=0;g<e.seq.length;++g){var l=e.seq[g],m=l.value,r=l.key;if("Object"===Object.prototype.toString.call(m).slice(8,-1)&&m.url){if(!d())throw Error("Big-endian binary data are not supported yet");XML3D.base.resourceManager.loadData(m.url,function(d){var c=e.type,g=r,k=f[c],
d=new k(d,m.byteOffset,m.byteLength/k.BYTES_PER_ELEMENT),c=new Xflow.BufferEntry(XML3D.data.BUFFER_TYPE_TABLE[c],d),d=XML3D.data.xflowGraph.createInputNode();d.data=c;d.name=b;d.key=g;a.appendChild(d)},null)}else c(a,e.type,b,r,m)}}var a=function(){XML3D.base.JSONFormatHandler.call(this)};XML3D.createClass(a,XML3D.base.JSONFormatHandler);a.prototype.isFormatSupported=function(a,b,d){return"application/json"===d&&"xml3d-json"==a.format&&"0.4.0"==a.version};a=new a;XML3D.base.registerFormat(a);var f=
{"int":Int32Array,int4:Int32Array,"float":Float32Array,float2:Float32Array,float3:Float32Array,float4:Float32Array,float4x4:Float32Array,bool:Uint8Array,"byte":Int8Array,ubyte:Uint8Array},d=function(){var a=new ArrayBuffer(4),b=new DataView(a);(new Int32Array(a))[0]=16909060;var d=16909060===b.getInt32(0,!0);return function(){return d}}(),e=function(a){this.json=a;try{if("xml3d-json"!=a.format)throw Error("Unknown JSON format: "+a.format);if("0.4.0"!=a.version)throw Error("Unknown JSON version: "+
a.version);var d=XML3D.data.xflowGraph.createDataNode();d.userData="External Json";var e=a.data,c;for(c in e)b(d,c,e[c]);this.xflowDataNode=d}catch(f){XML3D.debug.logException(f,"Failed to process XML3D json file")}};e.prototype.getXflowNode=function(){return this.xflowDataNode};var g=function(){XML3D.base.AdapterFactory.call(this,XML3D.data)};XML3D.createClass(g,XML3D.base.AdapterFactory);g.prototype.aspect=XML3D.data;g.prototype.createAdapter=function(a){return new e(a)};a.registerFactoryClass(g)})();
(function(){var c={"int":Int32Array,int4:Int32Array,"float":Float32Array,float2:Float32Array,float3:Float32Array,float4:Float32Array,float4x4:Float32Array,bool:Uint8Array,"byte":Int8Array,ubyte:Uint8Array},b=function(a){this.data=a;try{if(!a instanceof ArrayBuffer&&!a instanceof ArrayBufferView)throw Error("Unknown binary type: "+typeof a);var b=XML3D.data.xflowGraph.createDataNode(),e="ubyte",g=null;if(c[e]){var g=new c[e](a),e=XML3D.data.BUFFER_TYPE_TABLE[e],h=new Xflow.BufferEntry(e,g),i=XML3D.data.xflowGraph.createInputNode();
i.data=h;i.name="data";b.appendChild(i)}this.xflowDataNode=b}catch(j){XML3D.debug.logException(j,"Failed to process binary file")}};b.prototype.getXflowNode=function(){return this.xflowDataNode};var a=function(){XML3D.base.AdapterFactory.call(this,XML3D.data,["application/octet-stream","text/plain; charset=x-user-defined"])};XML3D.createClass(a,XML3D.base.AdapterFactory);a.prototype.createAdapter=function(a){return new b(a)};new a})();XML3D.webgl={toString:function(){return"webgl"},supported:function(){var c=document.createElement("canvas");return function(){try{return!(!window.WebGLRenderingContext||!c.getContext("experimental-webgl"))}catch(b){return!1}}}(),MAX_PICK_BUFFER_DIMENSION:512};XML3D.webgl.DataChangeListener=function(c){this.requestRedraw=c.requestRedraw;Xflow.DataChangeNotifier.addListener(this.dataEntryChanged)};
XML3D.webgl.DataChangeListener.prototype.dataEntryChanged=function(c,b){if(c.userData.webglData)for(var a in c.userData.webglData)c.userData.webglData[a].changed=Math.max(c.userData.webglData[a].changed,b)};XML3D.webgl.getXflowEntryWebGlData=function(c,b){if(!c)return null;c.userData.webglData||(c.userData.webglData={});c.userData.webglData[b]||(c.userData.webglData[b]={changed:Xflow.DATA_ENTRY_STATE.CHANGED_NEW});return c.userData.webglData[b]};XML3D.webgl.MAXFPS=30;
(function(){function c(b,d){this.canvas=b;this.xml3dElem=d;this.id=++a;XML3D.webgl.handlers[this.id]=this;this._pickingDisabled=!1;this.lastPickObj=null;this.timeNow=Date.now()/1E3;this.lastKnownDimensions={width:b.width,height:b.height};var e=this.getContextForCanvas(b);e&&this.initialize(e)}var b={alpha:!0,premultipliedAlpha:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!0};XML3D.webgl.configure=function(a){a instanceof Array||(a=[a]);for(var b in a){var e=XML3D.webgl.createCanvas(a[b],b),e=
new XML3D.webgl.CanvasHandler(e,a[b]);window.requestAnimFrame(e.tick,XML3D.webgl.MAXFPS)}};var a=0;XML3D.webgl.handlers=[];XML3D.webgl.events={available:[]};c.prototype.getContextForCanvas=function(a){try{return a.getContext("experimental-webgl",b)}catch(d){return null}};c.prototype.initialize=function(a){this.registerCanvasListeners();var b=this;this.tick=function(){XML3D.updateXflowObserver();if(b.canvasSizeChanged()||b.renderer.needsRedraw())b.dispatchUpdateEvent(),b.draw();window.requestAnimFrame(b.tick,
XML3D.webgl.MAXFPS)};var a=new XML3D.webgl.GLContext(a,this.id,this.canvas.clientWidth,this.canvas.clientHeight),e=new XML3D.webgl.GLScene(a),c=XML3D.base.xml3dFormatHandler.getFactory(XML3D.webgl,this.id);c.setScene(e);this.renderer=XML3D.webgl.rendererFactory.createRenderer(a,e,this.canvas);c.setRenderer(this.renderer);c.getAdapter(this.xml3dElem).traverse(function(){});e.rootNode.setVisible(!0)};c.prototype.getPickObjectByPoint=function(a,b){return this._pickingDisabled?null:this.renderer.getRenderObjectFromPickingBuffer(a,
b)};c.prototype.getWorldSpaceNormalByPoint=function(a,b){return this.renderer.getWorldSpaceNormalByPoint(a,b)};c.prototype.getWorldSpacePositionByPoint=function(a,b){return this.renderer.getWorldSpacePositionByPoint(a,b)};c.prototype.canvasSizeChanged=function(){var a=this.canvas;return a.clientWidth!==this.lastKnownDimensions.width||a.clientHeight!==this.lastKnownDimensions.height?(this.lastKnownDimensions.width=a.width=a.clientWidth,this.lastKnownDimensions.height=a.height=a.clientHeight,this.renderer.handleResizeEvent(a.width,
a.height),!0):!1};c.prototype.dispatchUpdateEvent=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("update",!0,!0,null);this.xml3dElem.dispatchEvent(a)};c.prototype.draw=function(){try{var a=Date.now(),b=this.renderer.renderToCanvas(),e=Date.now();this.dispatchFrameDrawnEvent(a,e,b)}catch(c){XML3D.debug.logException(c)}};c.prototype.registerCanvasListeners=function(){var a=this;XML3D.webgl.events.available.forEach(function(b){a.canvas.addEventListener(b,function(d){a[b]&&a[b].call(a,
d);d.stopPropagation()})});var b=this.xml3dElem.getAttribute("contextmenu");(!b||"false"==b)&&this.canvas.addEventListener("contextmenu",function(a){XML3D.webgl.stopEvent(a)},!1)};c.prototype.dispatchFrameDrawnEvent=function(a,b,e){var e=e||{count:{primitives:0,objects:0}},c=document.createEvent("CustomEvent");c.initCustomEvent("framedrawn",!0,!0,{timeStart:a,timeEnd:b,renderTimeInMilliseconds:b-a,count:e.count});this.xml3dElem.dispatchEvent(c)};c.prototype.shutdown=function(){this.renderer&&this.renderer.dispose()};
XML3D.webgl.CanvasHandler=c})();XML3D.webgl.createCanvas=function(c){var b=c.parentNode,a=b.ownerDocument.createElement("div");a.style.display="none";b.insertBefore(a,c);a.appendChild(c);var f=c._configured.canvas;b.insertBefore(f,a);c=f.ownerDocument.defaultView.getComputedStyle(c);if(!f.style.backgroundColor&&(c=c.getPropertyValue("background-color"))&&"transparent"!=c)f.style.backgroundColor=c;f.width=f.clientWidth;f.height=f.clientHeight;return f};
XML3D.webgl.stopEvent=function(c){c.preventDefault&&c.preventDefault();c.stopPropagation&&c.stopPropagation();c.returnValue=!1};
(function(){var c=XML3D.webgl;"ontouchstart"in window?(c.events.available.push("touchstart","touchmove","touchend","touchcancel"),XML3D.extend(c.CanvasHandler.prototype,{hasTouchEvents:function(){return!0},copyTouchEvent:function(b,a){return this.createTouchEvent(this.copyTouchEventData(b,a))},copyTouchEventData:function(b,a){return{type:a.type||b.type,timeStamp:Date.now(),bubbles:b.bubbles,cancelable:b.cancelable,detail:b.detail,screenX:b.screenX,screenY:b.screenY,pageX:b.pageX,pageY:b.pageY,clientX:b.clientX,
clientY:b.clientY,ctrlKey:b.ctrlKey,altKey:b.altKey,shiftKey:b.shiftKey,metaKey:b.metaKey,scale:b.scale,rotation:b.rotation,view:b.view,touches:b.touches,changedTouches:b.changedTouches,targetTouches:b.targetTouches}},createTouchEvent:function(b){var a;try{a=document.createEvent("TouchEvent")}catch(c){XML3D.debug.logWarning("Create Touch Event failed, creating UI instead"),a=document.createEvent("UIEvent")}a&&a.initTouchEvent&&(0==a.initTouchEvent.length?a.initTouchEvent(b.touches,b.targetTouches,
b.changedTouches,b.type,b.view,b.screenX,b.screenY,b.clientX,b.clientY):12==a.initTouchEvent.length?a.initTouchEvent(b.type,b.bubbles,b.cancelable,b.view,b.detail,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.touches,b.targetTouches,b.changedTouches):a.initTouchEvent(b.type,b.bubbles,b.cancelable,b.view,b.detail,b.screenX,b.screenY,b.pageX,b.pageY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.touches,b.targetTouches,b.changedTouches,b.scale,b.rotation));return a},dispatchTouchEventOnPickedObject:function(b,
a){var a=a||{},c=this.copyTouchEvent(b,a);c.preventDefault=function(){b.preventDefault()};this.xml3dElem.dispatchEvent(c)},touchstart:function(b){this.dispatchTouchEventOnPickedObject(b)},touchend:function(b){this.dispatchTouchEventOnPickedObject(b)},touchmove:function(b){this.dispatchTouchEventOnPickedObject(b)},touchcancel:function(b){this.dispatchTouchEventOnPickedObject(b)}})):XML3D.extend(c.CanvasHandler.prototype,{hasTouchEvents:function(){return!1}})})();
(function(){var c=XML3D.webgl;c.events.available.push("click","dblclick","mousedown","mouseup","mouseover","mousemove","mouseout","mousewheel");XML3D.extend(c.CanvasHandler.prototype,{dispatchMouseEvent:function(b,a,c){var c=c||{},a=a||this.xml3dElem,d=void 0!==c.x?c.x:b.clientX,e=void 0!==c.y?c.y:b.clientY,b=c.noCopy?b:this.copyMouseEvent(b);this.initExtendedMouseEvent(b,d,e);a.dispatchEvent(b)},copyMouseEvent:function(b){var a=document.createEvent("MouseEvents");a.initMouseEvent(b.type,b.bubbles,
b.cancelable,b.view,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);b.dataTransfer&&(a.data={url:b.dataTransfer.getData("URL"),text:b.dataTransfer.getData("Text")});a.preventDefault=function(){b.preventDefault()};return a},createMouseEvent:function(b,a){var a=a||{},c=document.createEvent("MouseEvents");c.initMouseEvent(b,void 0!==a.canBubble?a.canBubble:!0,void 0!==a.cancelable?a.cancelable:!0,a.view||window,void 0!=a.detail?a.detail:
0,void 0!=a.screenX?a.screenX:0,void 0!=a.screenY?a.screenY:0,void 0!=a.clientX?a.clientX:0,void 0!=a.clientY?a.clientY:0,void 0!=a.ctrl?a.ctrl:!1,void 0!=a.alt?a.alt:!1,void 0!=a.shift?a.shift:!1,void 0!=a.meta?a.meta:!1,void 0!=a.button?a.button:0,a.relatedTarget);return c},initExtendedMouseEvent:function(b,a,c){var d=this;(function(){var e=void 0,g=void 0;b.__defineGetter__("normal",function(){if(void 0!==g)return g;var b=d.getWorldSpaceNormalByPoint(a,c);return g=b?new window.XML3DVec3(b[0],b[1],
b[2]):null});b.__defineGetter__("position",function(){if(!e){var b=d.getWorldSpacePositionByPoint(a,c);e=b?new window.XML3DVec3(b[0],b[1],b[2]):null}return e})})()},setMouseMovePicking:function(){},dispatchMouseEventOnPickedObject:function(b,a){var a=a||{},c=this.getMousePosition(b),d=null;a.omitUpdate||(d=this.getPickObjectByPoint(c.x,c.y));this.dispatchMouseEvent(b,d&&d.node,c)},getMousePosition:function(b){var a=this.canvas.getBoundingClientRect();return{x:b.clientX-a.left,y:b.clientY-a.top}},
mouseup:function(b){this.dispatchMouseEventOnPickedObject(b)},mousedown:function(b){this.dispatchMouseEventOnPickedObject(b)},click:function(b){this.dispatchMouseEventOnPickedObject(b)},dblclick:function(b){this.dispatchMouseEventOnPickedObject(b)},mousemove:function(b){var a=this.getMousePosition(b);this.dispatchMouseEventOnPickedObject(b);var c=this.renderer.pickedObject?this.renderer.pickedObject.node:null;c!==this.lastPickObj&&(this.lastPickObj&&(this.dispatchMouseEvent(this.createMouseEvent("mouseout",
{clientX:a.x,clientY:a.y,button:b.button}),this.lastPickObj),c||this.dispatchMouseEvent(this.createMouseEvent("mouseover",{clientX:a.x,clientY:a.y,button:b.button}),this.xml3dElem)),c&&(this.dispatchMouseEvent(this.createMouseEvent("mouseover",{clientX:a.x,clientY:a.y,button:b.button}),c),this.lastPickObj||this.dispatchMouseEvent(this.createMouseEvent("mouseout",{clientX:a.x,clientY:a.y,button:b.button}),this.xml3dElem)),this.lastPickObj=c)},mouseout:function(b){var a=this.getMousePosition(b);this.dispatchMouseEvent(b,
this.lastPickObj,a)},mouseover:function(b){this.getMousePosition(b);this.dispatchMouseEventOnPickedObject(b)},mousewheel:function(b){this.getMousePosition(b);this.dispatchMouseEventOnPickedObject(b)}})})();
(function(c){function b(a,b,d){var e=XML3D.math.vec3.create();e[0]=d(a[0],b[0]);e[1]=d(a[1],b[1]);e[2]=d(a[2],b[2]);return e}c.calculateBoundingBox=function(a,b){var d=new XML3D.math.bbox.create;if(!a||3>a.length)return d;if(b){var e=3*b[0];d[0]=a[e];d[1]=a[e+1];d[2]=a[e+2];d[3]=a[e];d[4]=a[e+1];d[5]=a[e+2];for(e=1;e<b.length;e++){var c=3*b[e],h=a[c],i=a[c+1],c=a[c+2];h<d[0]&&(d[0]=h);i<d[1]&&(d[1]=i);c<d[2]&&(d[2]=c);h>d[3]&&(d[3]=h);i>d[4]&&(d[4]=i);c>d[5]&&(d[5]=c)}}else{d[0]=a[0];d[1]=a[1];d[2]=
a[2];d[3]=a[0];d[4]=a[1];d[5]=a[2];for(e=3;e<a.length;e+=3)a[e]<d[0]&&(d[0]=a[e]),a[e+1]<d[1]&&(d[1]=a[e+1]),a[e+2]<d[2]&&(d[2]=a[e+2]),a[e]>d[3]&&(d[3]=a[e]),a[e+1]>d[4]&&(d[4]=a[e+1]),a[e+2]>d[5]&&(d[5]=a[e+2])}return d};XML3D.math.mat4.create();XML3D.webgl.splitMesh=function(a,b){var b=3*Math.floor(b/3),d=a.position.data,e=a.index?a.index.data:void 0,c=a.normal?a.normal.data:void 0,h=a.texcoord?a.texcoord.data:void 0,i=a.color?a.color.data:void 0,j=a.position.tupleSize,k=a.texcoord?a.texcoord.tupleSize:
void 0,l=e.length;if(e){for(var m=[],r=Math.ceil(l/b),l=[],p=0;p<r;p++)if(l[p]={},l[p].index=new Uint16Array(b),l[p].index.nextFreeSlot=0,l[p].position=new Float32Array(b*j),c&&(l[p].normal=new Float32Array(b*j)),h&&(l[p].texcoord=new Float32Array(b*k)),i)l[p].color=new Float32Array(3*b);for(p=0;p<e.length;p+=3){var q=!0,r=Math.floor(e[p]/b);l[r].index.nextFreeSlot+3>b&&(q=!1);for(n=1;3>n;n++)if(Math.floor(e[p+n]/b)!=r){q=!1;break}if(q)for(var q=b*r,n=0;3>n;n++){var o=e[p+n],u=o-q,x=l[r];x.index[x.index.nextFreeSlot]=
u;x.index.nextFreeSlot++;for(var B=o*j,w=[],s=0;s<j;s++)w[s]=d[B+s];x.position.set(w,u*j);if(c){w=[];for(s=0;s<j;s++)w[s]=c[B+s];x.normal.set(w,u*j)}o*=k;if(h){w=[];for(s=0;s<k;s++)w[s]=h[o+s];x.texcoord.set(w,u*k)}if(i){w=[];for(s=0;3>s;s++)w[s]=i[B+s];x.color.set(w,3*u)}}else m.push(p)}for(p=r=0;p<m.length;p++){for(;l[r].index.nextFreeSlot+3>b;)if(r++,r>=l.length){l[r]={};l[r].index=new Uint16Array(b);l[r].index.nextFreeSlot=0;l[r].position=new Float32Array(b*j);c&&(l[r].normal=new Float32Array(b*
j));h&&(l[r].texcoord=new Float32Array(b*k));i&&(l[r].color=new Float32Array(3*b));break}for(n=0;3>n;n++){x=l[r];o=e[m[p]+n];u=x.index.nextFreeSlot;x.index[u]=u;x.index.nextFreeSlot++;w=[];for(s=0;s<j;s++)w[s]=d[o*j+s];x.position.set(w,u*j);if(c){w=[];for(s=0;s<j;s++)w[s]=c[o*j+s];x.normal.set(w,u*j)}if(h){w=[];for(s=0;s<k;s++)w[s]=h[o*k+s];x.texcoord.set(w,u*k)}if(i){w=[];for(s=0;s<j;s++)w[s]=i[3*o+s];x.color.set(w,3*u)}}}a.index=[];a.position=[];c&&(a.normal=[]);h&&(a.texcoord=[]);i&&(a.color=[]);
for(p=0;p<l.length;p++)0<l[p].index.nextFreeSlot&&(a.index[p]={data:l[p].index,tupleSize:j},a.position[p]={data:l[p].position,tupleSize:j},c&&(a.normal[p]={data:l[p].normal,tupleSize:j}),h&&(a.texcoord[p]={data:l[p].texcoord,tupleSize:k}),i&&(a.color[p]={data:l[p].color,tupleSize:3}))}};XML3D.webgl.adjustMinMax=function(a,c,d,e){var g=XML3D.math.vec3.create(),h=XML3D.math.vec3.create();XML3D.math.vec3.transformMat4(g,a.min,e);XML3D.math.vec3.transformMat4(h,a.max,e);a=b(g,h,Math.min);g=b(g,h,Math.max);
a[0]<c[0]&&(c[0]=a[0]);a[1]<c[1]&&(c[1]=a[1]);a[2]<c[2]&&(c[2]=a[2]);g[0]>d[0]&&(d[0]=g[0]);g[1]>d[1]&&(d[1]=g[1]);g[2]>d[2]&&(d[2]=g[2])};c.convertPageCoords=function(a,b,d){var e;e=a.getBoundingClientRect();var c=document.body,h=document.documentElement,a=e.left+(window.pageXOffset||h.scrollLeft||c.scrollLeft)-(h.clientLeft||c.clientLeft||0);e=Math.round(e.top+(window.pageYOffset||h.scrollTop||c.scrollTop)-(h.clientTop||c.clientTop||0));a=Math.round(a);return{x:b-a,y:d-e}}})(XML3D.webgl);
(function(c){var b=function(){this.pages=[];this.nextOffset=0;this.freeEntries=[];this.addPage()};XML3D.createClass(b,XML3D.util.EventDispatcher,{addPage:function(){this.pages.push(new Float32Array(b.PAGE_SIZE));this.nextOffset=0;XML3D.debug.logInfo("adding page",this.pages.length)},getPageEntry:function(a){if(!a)throw Error("No size given for page entry");return this.reusePageEntry(a)||this.createPageEntry(a)},reusePageEntry:function(a){return(a=this.freeEntries[a])&&a.length?a.pop():null},createPageEntry:function(a){if(this.nextOffset+
a>b.PAGE_SIZE)return this.addPage(),this.getPageEntry(a);var c=this.pages[this.pages.length-1],d=this.nextOffset;this.nextOffset+=a;return{page:c,offset:d,size:a}},freePageEntry:function(a){var b=this.freeEntries[a.size];b||(b=this.freeEntries[a.size]=[]);b.push(a)}});b.PAGE_SIZE=4096;c.Pager=b})(XML3D.webgl);
(function(){var c=function(b,a,c,d){d=d||{};this.scene=a;this.type=b;this.name=d.name||"";this.page=c.page;this.offset=c.offset;this.entrySize=c.size;this.localVisible=d.visible;this.visible=void 0!==this.localVisible?this.localVisible:d.parent?d.parent.isVisible():!0;this.transformDirty=!0;this.children=[];this.setParent(d.parent||a.rootNode)};XML3D.extend(c.prototype,{getChildren:function(){return this.children},getParent:function(){return this.parent},setParent:function(b){(this.parent=b)&&b.addChild&&
b.addChild(this)},traverse:function(b){b(this);this.children.forEach(function(a){a.traverse(b)})},getWorldMatrix:function(b){this.transformDirty&&(this.parent.getWorldMatrix(b),this.updateWorldMatrix(b));for(var a=this.offset+0,c=0;16>c;c++,a++)b[c]=this.page[a]},setWorldMatrix:function(b){for(var a=this.offset+0,c=0;16>c;c++,a++)this.page[a]=b[c];this.transformDirty=!1;this.setBoundingBoxDirty&&this.setBoundingBoxDirty()},isVisible:function(){return this.visible},setTransformDirty:function(){this.transformDirty=
!0},setLocalVisible:function(b){this.localVisible=b;this.parent.isVisible()&&this.setVisible(b)},setVisible:function(b){var a=b;!1===this.localVisible&&(a=!1);this.visible=a;this.children.forEach(function(b){b.setVisible(a)})},remove:function(){this.parent.removeChild(this);this.scene.freePageEntry({page:this.page,offset:this.offset,size:this.entrySize})}});XML3D.webgl.RenderNode=c})();
(function(c){var b=function(a,b,d){XML3D.webgl.RenderNode.call(this,c.Scene.NODE_TYPE.OBJECT,a,b,d);d=d||{};this.node=d.node;this.object=d.object||{data:null,type:"triangles"};this.boundingBoxDirty=this.transformDirty=!0;this.drawable=this.createDrawable();this.shaderHandle=d.shaderHandle||null;this.initialize()};b.ENTRY_SIZE=76;b.IDENTITY_MATRIX=XML3D.math.mat4.create();XML3D.createClass(b,XML3D.webgl.RenderNode,{createDrawable:function(){var a=this.scene.createDrawable(this);if(a){var b=this;a.addEventListener(c.Scene.EVENT_TYPE.DRAWABLE_STATE_CHANGED,
function(a){a.newState===c.DrawableClosure.READY_STATE.COMPLETE?b.scene.moveFromQueueToReady(b):a.newState===c.DrawableClosure.READY_STATE.INCOMPLETE&&a.oldState===c.DrawableClosure.READY_STATE.COMPLETE&&b.scene.moveFromReadyToQueue(b)})}return a},initialize:function(){this.setObjectSpaceBoundingBox(XML3D.math.EMPTY_BOX);this.override=null},setType:function(a){this.object.type=a},getType:function(){return this.object.type},getDataNode:function(){return this.object?this.object.data:null},dispose:function(){this.scene.remove(this)},
getModelViewMatrix:function(a){for(var b=this.offset+28,d=0;16>d;d++,b++)a[d]=this.page[b]},getNormalMatrix:function(a){var b=this.offset+60;a[0]=this.page[b];a[1]=this.page[b+1];a[2]=this.page[b+2];a[3]=this.page[b+4];a[4]=this.page[b+5];a[5]=this.page[b+6];a[6]=this.page[b+8];a[7]=this.page[b+9];a[8]=this.page[b+10]},getModelViewProjectionMatrix:function(a){for(var b=this.offset+44,d=0;16>d;d++,b++)a[d]=this.page[b]},updateWorldSpaceMatrices:function(a,b){this.transformDirty&&this.updateWorldMatrix();
this.updateModelViewMatrix(a);this.updateNormalMatrix();this.updateModelViewProjectionMatrix(b)},updateWorldMatrix:function(){var a=XML3D.math.mat4.create();return function(){this.parent.getWorldMatrix(a);this.setWorldMatrix(a);this.updateWorldSpaceBoundingBox();this.transformDirty=!1}}(),updateModelViewMatrix:function(a){this.transformDirty&&this.updateWorldMatrix();var b=this.page,d=this.offset;XML3D.math.mat4.multiplyOffset(b,d+28,b,d+0,a,0)},updateNormalMatrix:function(){var a=XML3D.math.mat4.create();
return function(){this.getModelViewMatrix(a);for(var c=XML3D.math.mat4.invert(a,a),c=c?XML3D.math.mat4.transpose(c,c):b.IDENTITY_MATRIX,d=this.offset+60,e=0;16>e;e++,d++)this.page[d]=c[e]}}(),updateModelViewProjectionMatrix:function(a){var b=this.page,d=this.offset;XML3D.math.mat4.multiplyOffset(b,d+44,b,d+28,a,0)},setTransformDirty:function(){this.transformDirty=!0;this.setBoundingBoxDirty();this.scene.requestRedraw("Transformation changed")},shaderHandleCallback:function(a){XML3D.debug.assert(a.type==
XML3D.events.ADAPTER_HANDLE_CHANGED);this.updateShaderFromHandle(a.adapterHandle)},setShader:function(a){if(this.drawable){var b=this.shaderHandle;b!=a&&(this.bindedShaderHandleCallback||(this.bindedShaderHandleCallback=this.shaderHandleCallback.bind(this)),b&&b.removeListener(this.bindedShaderHandleCallback),a&&a.addListener(this.bindedShaderHandleCallback),this.shaderHandle=a,this.updateShaderFromHandle(a))}},updateShaderFromHandle:function(a){var b=null;if(a)switch(a.status){case XML3D.base.AdapterHandle.STATUS.NOT_FOUND:XML3D.debug.logWarning("Shader not found.",
a.url,this.name);break;case XML3D.base.AdapterHandle.STATUS.READY:b=a.getAdapter().getShaderInfo()}this.drawable.setShaderComposer(this.scene.shaderFactory.createComposerForShaderInfo(b))},setObjectSpaceBoundingBox:function(a){var b=this.offset+16;this.page[b]=a[0];this.page[b+1]=a[1];this.page[b+2]=a[2];this.page[b+3]=a[3];this.page[b+4]=a[4];this.page[b+5]=a[5];this.setBoundingBoxDirty()},getObjectSpaceBoundingBox:function(a){var b=this.offset+16;a[0]=this.page[b];a[1]=this.page[b+1];a[2]=this.page[b+
2];a[3]=this.page[b+3];a[4]=this.page[b+4];a[5]=this.page[b+5]},setBoundingBoxDirty:function(){this.boundingBoxDirty=!0;this.parent.setBoundingBoxDirty()},setWorldSpaceBoundingBox:function(a){var b=this.offset+22;this.page[b]=a[0];this.page[b+1]=a[1];this.page[b+2]=a[2];this.page[b+3]=a[3];this.page[b+4]=a[4];this.page[b+5]=a[5]},getWorldSpaceBoundingBox:function(a){this.boundingBoxDirty&&this.updateWorldSpaceBoundingBox();var b=this.offset+22;a[0]=this.page[b];a[1]=this.page[b+1];a[2]=this.page[b+
2];a[3]=this.page[b+3];a[4]=this.page[b+4];a[5]=this.page[b+5]},updateWorldSpaceBoundingBox:function(){var a=new XML3D.math.bbox.create,b=new XML3D.math.mat4.create;return function(){this.getObjectSpaceBoundingBox(a);this.parent.getWorldMatrix(b);XML3D.math.bbox.transform(a,b,a);this.setWorldSpaceBoundingBox(a);this.boundingBoxDirty=!1}}(),setLocalVisible:function(a){this.localVisible=a;this.parent.isVisible()&&(this.setVisible(a),this.setBoundingBoxDirty())},getProgram:function(){return this.drawable.getProgram()},
hasTransparency:function(){var a=this.getProgram();return a?a.hasTransparency():!1},updateForRendering:function(){c.SystemNotifier.setNode(this.node);this.setShader(this.parent.getShaderHandle());try{this.drawable.update(this.scene)}catch(a){XML3D.debug.logError("Mesh Error: "+a.message,this.node)}c.SystemNotifier.setNode(null)}});c.RenderObject=b})(XML3D.webgl);
(function(c){var b=function(a,b,d){c.RenderNode.call(this,c.Scene.NODE_TYPE.GROUP,a,b,d);d=d||{};this.shaderHandle=d.shaderHandle||null;this.boundingBoxDirty=!1;this.setWorldSpaceBoundingBox(XML3D.math.EMPTY_BOX)};b.ENTRY_SIZE=38;XML3D.createClass(b,c.RenderNode);XML3D.extend(b.prototype,{getLocalMatrix:function(a){for(var b=this.offset+16,d=0;16>d;d++,b++)a[d]=this.page[b]},setLocalMatrix:function(a){for(var b=this.offset+16,d=0;16>d;d++,b++)this.page[b]=a[d];this.setTransformDirty();this.setBoundingBoxDirty()},
getWorldSpaceBoundingBox:function(a){this.boundingBoxDirty&&this.updateWorldSpaceBoundingBox();var b=this.offset+32;a[0]=this.page[b];a[1]=this.page[b+1];a[2]=this.page[b+2];a[3]=this.page[b+3];a[4]=this.page[b+4];a[5]=this.page[b+5]},setWorldSpaceBoundingBox:function(a){var b=this.offset+32;this.page[b]=a[0];this.page[b+1]=a[1];this.page[b+2]=a[2];this.page[b+3]=a[3];this.page[b+4]=a[4];this.page[b+5]=a[5]},updateWorldSpaceBoundingBox:function(){var a=XML3D.math.bbox.create();return function(){for(var b=
XML3D.math.bbox.create(),d=0,c=this.children.length;d<c;d++){var g=this.children[d];g.isVisible()&&(g.getWorldSpaceBoundingBox(a),XML3D.math.bbox.extendWithBox(b,a))}this.setWorldSpaceBoundingBox(b);this.boundingBoxDirty=!1}}(),addChild:function(a){this.children.push(a);this.setBoundingBoxDirty();this.scene.dispatchEvent({type:c.Scene.EVENT_TYPE.SCENE_STRUCTURE_CHANGED,newChild:a})},removeChild:function(a){this.children.splice(this.children.indexOf(a),1);this.scene.dispatchEvent({type:c.Scene.EVENT_TYPE.SCENE_STRUCTURE_CHANGED,
removedChild:a})},getChildren:function(){return this.children},updateWorldMatrix:function(a){var b=this.page,d=this.offset;XML3D.math.mat4.multiplyOffset(b,d+0,b,d+16,a,0);this.transformDirty=!1},setTransformDirty:function(){this.transformDirty=!0;this.children.forEach(function(a){a.setTransformDirty()})},setLocalShaderHandle:function(a){this.shaderHandle=void 0;void 0===a?this.setShader(this.parent.getShaderHandle()):this.setShader(a);this.shaderHandle=a},setShader:function(a){void 0===this.shaderHandle&&
this.children.forEach(function(b){b.setShader(a)})},getShaderHandle:function(){return!this.shaderHandle?this.parent.getShaderHandle():this.shaderHandle},setBoundingBoxDirty:function(){this.boundingBoxDirty=!0;this.parent&&this.parent.setBoundingBoxDirty()},setLocalVisible:function(a){this.localVisible=a;this.parent.isVisible()&&(this.setVisible(a),this.setBoundingBoxDirty())}});c.RenderGroup=b})(XML3D.webgl);
(function(c){var b=XML3D.math.vec3.fromValues(0,0,-1);XML3D.math.vec3.fromValues(0,0,1);var a=XML3D.math.vec3.fromValues(1,1,1),f=XML3D.math.vec3.fromValues(0,0,1),d=Math.PI/4,e="intensity,attenuation,softness,falloffAngle,direction,position".split(","),g=function(d,g,j){XML3D.webgl.RenderNode.call(this,c.Scene.NODE_TYPE.LIGHT,d,g,j);j=j||{};d=j.light||{};this.light={type:d.type||"directional",data:d.data};this.intensity=XML3D.math.vec3.clone(a);this.srcPosition=XML3D.math.vec3.fromValues(0,0,0);
this.srcDirection=XML3D.math.vec3.clone(b);this.position=XML3D.math.vec3.fromValues(0,0,0);this.direction=XML3D.math.vec3.clone(b);this.attenuation=XML3D.math.vec3.clone(f);this.light.data?(this.lightParameterRequest=new Xflow.ComputeRequest(this.light.data,e,this.lightParametersChanged.bind(this)),this.lightParametersChanged(this.lightParameterRequest,null)):XML3D.debug.logWarning("External light shaders not supported yet");this.localIntensity=void 0!==j.localIntensity?j.localIntensity:1;this.addLightToScene()};
g.ENTRY_SIZE=16;XML3D.createClass(g,c.RenderNode);XML3D.extend(g.prototype,{addLightToScene:function(){var a=this.scene.lights[this.light.type];Array.isArray(a)?(a.push(this),this.updateWorldMatrix(),this.lightStructureChanged()):XML3D.debug.logError("Unsupported light shader script: urn:xml3d:lightshader:"+this.light.type)},removeLightFromScene:function(){var a=this.scene.lights[this.light.type];Array.isArray(a)&&(a.splice(this),this.lightStructureChanged())},lightParametersChanged:function(a,b){var d=
a.getResult();if(d){var c=d.getOutputData("intensity");c&&XML3D.math.vec3.copy(this.intensity,c.getValue());(c=d.getOutputData("attenuation"))&&XML3D.math.vec3.copy(this.attenuation,c.getValue());(c=d.getOutputData("position"))&&XML3D.math.vec3.copy(this.srcPosition,c.getValue());(c=d.getOutputData("direction"))&&XML3D.math.vec3.copy(this.srcDirection,c.getValue());this.updateWorldMatrix();b&&this.lightValueChanged()}},lightValueChanged:function(){this.scene.dispatchEvent({type:c.Scene.EVENT_TYPE.LIGHT_VALUE_CHANGED,
light:this})},lightStructureChanged:function(){this.scene.dispatchEvent({type:c.Scene.EVENT_TYPE.LIGHT_STRUCTURE_CHANGED,light:this})},getLightData:function(a,b){var c=3*b;["position","direction","attenuation"].forEach(function(b){a[b]&&(a[b][c+0]=this[b][0],a[b][c+1]=this[b][1],a[b][c+2]=this[b][2])},this);a.intensity&&(a.intensity[c+0]=this.intensity[0]*this.localIntensity,a.intensity[c+1]=this.intensity[1]*this.localIntensity,a.intensity[c+2]=this.intensity[2]*this.localIntensity);a.on&&(a.on[b]=
this.visible);var e;a.softness&&(a.softness[b]=0,this.light.data&&(e=this.lightParameterRequest.getResult(),e=e.getOutputData("softness"),a.softness[b]=e?e.getValue()[0]:0));a.falloffAngle&&(a.falloffAngle[b]=d,this.light.data&&(e=this.lightParameterRequest.getResult(),e=e.getOutputData("falloffAngle"),a.falloffAngle[b]=e?e.getValue()[0]:d))},setTransformDirty:function(){this.updateWorldMatrix()},updateWorldMatrix:function(){var a=XML3D.math.mat4.create();return function(){this.parent&&(this.parent.getWorldMatrix(a),
this.setWorldMatrix(a),this.updateLightTransformData(a))}}(),updateLightTransformData:function(a){switch(this.light.type){case "directional":XML3D.math.vec3.copy(this.direction,this.applyTransformDir(this.srcDirection,a));break;case "spot":XML3D.math.vec3.copy(this.direction,this.applyTransformDir(this.srcDirection,a));XML3D.math.vec3.copy(this.position,this.applyTransform(this.srcPosition,a));break;case "point":XML3D.math.vec3.copy(this.position,this.applyTransform(this.srcPosition,a))}this.lightValueChanged()},
applyTransform:function(a,b){var d=XML3D.math.vec4.transformMat4(XML3D.math.vec4.create(),[a[0],a[1],a[2],1],b);return[d[0]/d[3],d[1]/d[3],d[2]/d[3]]},applyTransformDir:function(a,b){var d=XML3D.math.vec4.transformMat4(XML3D.math.vec4.create(),[a[0],a[1],a[2],0],b);return[d[0],d[1],d[2]]},setLocalVisible:function(a){this.localVisible=a;!1===a?(this.visible=!1,this.lightValueChanged()):this.setVisible(this.parent.isVisible())},setVisible:function(a){!1!==this.localVisible&&(this.visible=a,this.lightValueChanged())},
setLocalIntensity:function(a){this.localIntensity=a;this.lightValueChanged()},setLightType:function(a){a=a||"directional";a!=this.light.type&&(this.removeLightFromScene(),this.light.type=a,this.addLightToScene())},remove:function(){this.parent.removeChild(this);this.removeLightFromScene()},getWorldSpaceBoundingBox:function(a){XML3D.math.bbox.empty(a)}});c.RenderLight=g})(XML3D.webgl);
(function(c){var b=function(a,b,d){XML3D.webgl.RenderNode.call(this,c.Scene.NODE_TYPE.VIEW,a,b,d);d=d||{};this.position=d.position||XML3D.math.vec3.create();this.orientation=d.orientation||XML3D.math.mat4.create();this.fieldOfView=void 0!==d.fieldOfView?d.fieldOfView:0.78;this.worldSpacePosition=XML3D.math.vec3.create();this.projectionAdapter=d.projectionAdapter;this.projectionDirty=this.viewDirty=!0;this.frustum=new XML3D.webgl.Frustum(1,1E5,0,this.fieldOfView,1)};b.ENTRY_SIZE=48;XML3D.createClass(b,
XML3D.webgl.RenderNode);XML3D.extend(b.prototype,{getFrustum:function(){return this.frustum},updateViewMatrix:function(){var a=XML3D.math.mat4.create(),b=XML3D.math.mat4.create();return function(){XML3D.math.mat4.identity(a);a[12]=this.position[0];a[13]=this.position[1];a[14]=this.position[2];XML3D.math.mat4.multiply(a,a,this.orientation);this.parent.getWorldMatrix(b);XML3D.math.mat4.multiply(a,b,a);XML3D.math.vec3.set(this.worldSpacePosition,a[12],a[13],a[14]);this.setViewToWorldMatrix(a);XML3D.math.mat4.invert(a,
a);this.setWorldToViewMatrix(a);this.viewDirty=!1}}(),updateProjectionMatrix:function(){var a=XML3D.math.mat4.create();return function(b){if(this.projectionAdapter)this.setProjectionMatrix(this.projectionAdapter.getMatrix("perspective"));else{var d=this.getClippingPlanes(),c=d.near,d=d.far,g=this.fieldOfView;XML3D.math.mat4.perspective(a,g,b,c,d);this.setProjectionMatrix(a);this.frustum.setFrustum(c,d,0,g,b)}}}(),getClippingPlanes:function(){var a=XML3D.math.mat4.create(),b=new XML3D.math.bbox.create;
return function(){this.scene.getBoundingBox(b);if(XML3D.math.bbox.isEmpty(b))return{near:1,far:10};this.getWorldToViewMatrix(a);XML3D.math.bbox.transform(b,a,b);var d=b[2],c=b[5],g=XML3D.math.bbox.longestSide(b),d=d-0.005*g;return{near:Math.max(-(c+0.005*g),0.01*g),far:-d}}}(),setMatrix:function(a,b){for(var d=this.offset+b,c=0;16>c;c++,d++)this.page[d]=a[c]},setWorldToViewMatrix:function(a){this.setMatrix(a,16)},setViewToWorldMatrix:function(a){this.setMatrix(a,0)},setProjectionMatrix:function(a){for(var b=
this.offset+32,d=0;16>d;d++,b++)this.page[b]=a[d];this.projectionDirty=!1},setProjectionAdapter:function(a){this.projectionAdapter=a;this.setProjectionDirty()},setTransformDirty:function(){this.viewDirty=!0;this.setProjectionDirty();this.scene.requestRedraw("Transformation changed")},setProjectionDirty:function(){this.projectionDirty=!0},updatePosition:function(a){this.setTransformDirty();this.position=a},updateOrientation:function(a){this.setTransformDirty();this.orientation=a},updateFieldOfView:function(a){this.setTransformDirty();
this.fieldOfView=a},getViewToWorldMatrix:function(a){this.viewDirty&&this.updateViewMatrix();for(var b=this.offset+0,d=0;16>d;d++,b++)a[d]=this.page[b]},getWorldToViewMatrix:function(a){this.viewDirty&&this.updateViewMatrix();for(var b=this.offset+16,d=0;16>d;d++,b++)a[d]=this.page[b]},getProjectionMatrix:function(a,b){this.projectionDirty&&this.updateProjectionMatrix(b);for(var d=this.offset+32,c=0;16>c;c++,d++)a[c]=this.page[d]},getWorldSpacePosition:function(){return this.worldSpacePosition},getWorldSpaceBoundingBox:function(a){XML3D.math.bbox.empty(a)}});
c.RenderView=b})(XML3D.webgl);
(function(c){var b=function(){c.Pager.call(this);this.boundingBox=new XML3D.math.bbox.create;this.lights={queue:[],point:[],directional:[],spot:[],length:function(){return this.point.length+this.directional.length+this.spot.length}};this.shaderInfos=[];this.activeView=null;this.rootNode=this.createRootNode();this.systemDomNode=null};XML3D.createClass(b,c.Pager);b.NODE_TYPE={GROUP:"group",OBJECT:"object",LIGHT:"light",VIEW:"view"};b.EVENT_TYPE={VIEW_CHANGED:"view_changed",LIGHT_STRUCTURE_CHANGED:"light_structure_changed",
LIGHT_VALUE_CHANGED:"light_value_changed",SCENE_STRUCTURE_CHANGED:"scene_structure_changed",DRAWABLE_STATE_CHANGED:"drawable_state_changed"};XML3D.extend(b.prototype,{getActiveView:function(){return this.activeView},setActiveView:function(a){if(a!=this.activeView){if(!a)throw Error("Active view must not be null");this.activeView=a;this.dispatchEvent({type:b.EVENT_TYPE.VIEW_CHANGED,newView:this.activeView})}},createRenderObject:function(a){var b=this.getPageEntry(c.RenderObject.ENTRY_SIZE);return new c.RenderObject(this,
b,a)},createRenderGroup:function(a){var b=this.getPageEntry(c.RenderGroup.ENTRY_SIZE);return new c.RenderGroup(this,b,a)},createRenderView:function(a){var b=this.getPageEntry(c.RenderView.ENTRY_SIZE);return new c.RenderView(this,b,a)},createRenderLight:function(a){var b=this.getPageEntry(c.RenderLight.ENTRY_SIZE);return new c.RenderLight(this,b,a)},createShaderInfo:function(a){return new c.ShaderInfo(this,a)},createRootNode:function(){var a=this.getPageEntry(c.RenderGroup.ENTRY_SIZE),a=new c.RenderGroup(this,
a,{});a.setWorldMatrix(XML3D.math.mat4.create());a.setLocalMatrix(XML3D.math.mat4.create());a.transformDirty=!1;a.shaderDirty=!1;a.visible=!0;a.shaderHandle=new XML3D.base.AdapterHandle("not_found");a.shaderHandle.status=XML3D.base.AdapterHandle.STATUS.NOT_FOUND;return a},updateBoundingBox:function(){this.rootNode.boundingBoxDirty&&this.activeView&&this.activeView.setProjectionDirty();this.rootNode.getWorldSpaceBoundingBox(this.boundingBox)},getBoundingBox:function(a){this.updateBoundingBox();XML3D.math.bbox.copy(a,
this.boundingBox)},createDrawable:function(){throw Error("Scene::createDrawable not implemented");},requestRedraw:function(){throw Error("Scene::requestRedraw not implemented");},traverse:function(a){this.rootNode.traverse(a)}});c.Scene=b;c.SystemNotifier={node:null,setNode:function(a){this.node=a},sendEvent:function(a,b){if(this.node){var d=document.createEvent("CustomEvent");b.systemtype=a;d.initCustomEvent("xml3dsystem",!0,!0,b);this.node.dispatchEvent(d)}}}})(XML3D.webgl);
(function(c){var b=function(){var a=0;return function(){return a++}}(),a=function(a,d){d=d||{};this.id=b();this.scene=a;this.data=d.data;this.scriptCode=this.scriptType=this.scriptUri=null;this.scene.shaderInfos.push(this);this.changeListener=[]};XML3D.extend(a.prototype,{setScript:function(a,b,c){this.scriptUri=a;this.scriptType=b;this.scriptCode=c;this.scriptChangedEvent()},getScriptUri:function(){return this.scriptUri},getScriptType:function(){return this.scriptType},getScriptCode:function(){return this.scriptCode},
getData:function(){return this.data},addChangeListener:function(a){this.changeListener.push(a)},scriptChangedEvent:function(){for(var a=0;a<this.changeListener.length;++a)this.changeListener[a](this)}});c.ShaderInfo=a})(XML3D.webgl);
(function(c){var b=function(b,d,c,g){this.gl=b;this.id=d;this.canvasTarget=new XML3D.webgl.GLCanvasTarget(this,c,g);this.programFactory=new XML3D.webgl.ProgramFactory(this);this.stats={materials:0,meshes:0};var d={},h;for(h in a)c=a[h],(g=b.getExtension(c))?d[c]=g:XML3D.debug.logInfo(c,"is not supported on your graphics card");this.extensions=d},a=b.EXTENSIONS={};a.STANDARD_DERIVATES="OES_standard_derivatives";XML3D.extend(b.prototype,{getXflowEntryWebGlData:function(a){return XML3D.webgl.getXflowEntryWebGlData(a,
this.id)},requestRedraw:function(){},handleResizeEvent:function(a,b){this.canvasTarget=new XML3D.webgl.GLCanvasTarget(this,a,b)},getStatistics:function(){return this.stats},getExtensionByName:function(a){return this.extensions[a]}});c.GLContext=b})(XML3D.webgl);
(function(c){var b=function(a){Xflow.SamplerConfig.call(this);this.setDefaults();this.gl=a;this.handle=null};XML3D.createClass(b,Xflow.SamplerConfig);b.State={NONE:"none",LOADING:"loading",READY:"ready",ERROR:"error"};var a=function(){var a=null;return function(c){if(!a){a=new b(c);for(var f=new Uint8Array(768),h=0;h<f.length;h++)f[h]=128;a.createTex2DFromData(c.RGB,16,16,c.RGB,c.UNSIGNED_BYTE,{texels:f,wrapS:c.REPEAT,wrapT:c.REPEAT,minFilter:c.LINEAR,magFilter:c.LINEAR})}return a}}(),f=function(a){--a;
for(var b=1;32>b;b<<=1)a|=a>>b;return a+1};XML3D.extend(b.prototype,{updateFromTextureEntry:function(a){var b=a.getImage();b?(this.handle||(this.handle=this.gl.createTexture()),this.set(a.getSamplerConfig()),a.isLoading()?this.loads():this.updateTex2DFromImage(b)):this.failed()},needsScale:function(a,b){return(this.wrapS!=this.gl.CLAMP_TO_EDGE||this.wrapT!=this.gl.CLAMP_TO_EDGE)&&(0!=(a&a-1)||0!=(b&b-1))},updateTex2DFromImage:function(a){var b=this.gl;b.bindTexture(b.TEXTURE_2D,this.handle);var c=
a.videoWidth||a.width,h=a.videoHeight||a.height;if(this.needsScale(c,h)){var i=document.createElement("canvas");i.width=f(c);i.height=f(h);i.getContext("2d").drawImage(a,0,0,i.width,i.height);a=i}b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,this.wrapS);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,this.wrapT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,this.minFilter);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,this.magFilter);
this.generateMipMap&&b.generateMipmap(b.TEXTURE_2D);b.bindTexture(b.TEXTURE_2D,null);this.created()},bind:function(b){this.canBind()?(this.gl.activeTexture(this.gl.TEXTURE0+b),this.gl.bindTexture(this.textureType,this.handle)):a(this.gl).bind(b)},unbind:function(a){this.gl.activeTexture(this.gl.TEXTURE0+a);this.gl.bindTexture(this.textureType,null)},destroy:function(){this.gl.deleteTexture(this.handle)},canBind:function(){return this.current==b.State.READY},createTex2DFromData:function(a,b,c,f,i,
j){var k=this.gl,j=j||{},l=j.texels;l||(l=i==k.FLOAT?new Float32Array(4*b*c):new Uint8Array(4*b*c));this.handle=k.createTexture();this.textureType=k.TEXTURE_2D;k.bindTexture(k.TEXTURE_2D,this.handle);k.texParameteri(k.TEXTURE_2D,k.TEXTURE_WRAP_S,j.wrapS);k.texParameteri(k.TEXTURE_2D,k.TEXTURE_WRAP_T,j.wrapT);k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MIN_FILTER,j.minFilter);k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MAG_FILTER,j.magFilter);k.texImage2D(k.TEXTURE_2D,0,a,b,c,0,f,i,l);j.isDepth&&(k.texParameteri(k.TEXTURE_2D,
k.DEPTH_TEXTURE_MODE,j.depthMode),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_COMPARE_MODE,j.depthCompareMode),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_COMPARE_FUNC,j.depthCompareFunc));j.generateMipmap&&k.generateMipmap(k.TEXTURE_2D);k.bindTexture(k.TEXTURE_2D,null);this.created()}});window.StateMachine.create({target:b.prototype,initial:b.State.NONE,events:[{name:"created",from:"*",to:b.State.READY},{name:"failed",from:"*",to:b.State.ERROR},{name:"loads",from:"*",to:b.State.LOADING}]});c.GLTexture=b})(XML3D.webgl);
(function(c){var b=function(a,b,f){var h=a.createShader(b);a.shaderSource(h,f);a.compileShader(h);if(0==a.getShaderParameter(h,a.COMPILE_STATUS)){var h=a.getShaderInfoLog(h),i="",i=b==a.VERTEX_SHADER?"Vertex shader failed to compile: \n":"Fragment shader failed to compile: \n",i=i+(h+"\n--------\n")+"Shader Source:\n--------\n"+XML3D.debug.formatSourceCode(f);a.getError();c.SystemNotifier.sendEvent("glsl",{glslType:"compile_error",shaderType:b==a.VERTEX_SHADER?"vertex":"fragment",code:f,message:h});
throw Error(i);}return h},a=function(){var a=0;return function(){return a++}}(),f=function(b,c){this.gl=b;this.sources=c;this.id=a();this.attributes={};this.uniforms={};this.samplers={};this.needsLights=!0;this.handle=null;this.texturesBinded=!1;var f=0;this.nextTextureUnit=function(){return f++};this.create()};XML3D.extend(f.prototype,{create:function(){XML3D.debug.logDebug("Create shader program: ",this.id);var a=this.gl,e=[this.sources.vertex],f=[this.sources.fragment],h=null,i=[],j;for(j in e)h=
e[j],h=b(a,a.VERTEX_SHADER,h),i.push(h);for(j in f)h=f[j],h=b(a,a.FRAGMENT_SHADER,h),i.push(h);var e=a.createProgram(),k;for(k in i)a.attachShader(e,i[k]);a.linkProgram(e);if(0==a.getProgramParameter(e,a.LINK_STATUS))throw i=a.getProgramInfoLog(e),k="Shader linking failed: \n"+i+"\n--------\n",a.getError(),c.SystemNotifier.sendEvent("glsl",{glslType:"link_error",message:i}),Error(k);if(this.handle=e){c.SystemNotifier.sendEvent("glsl",{glslType:"success"});this.bind();a=this.gl;i=this.handle;e=a.getProgramParameter(i,
a.ACTIVE_ATTRIBUTES);for(k=0;k<e;k++)if(f=a.getActiveAttrib(i,k))j={},j.name=f.name,j.size=f.size,j.glType=f.type,j.location=a.getAttribLocation(i,f.name),this.attributes[f.name]=j;e=a.getProgramParameter(i,a.ACTIVE_UNIFORMS);for(k=0;k<e;k++)if(h=a.getActiveUniform(i,k))if(f={},f.name=h.name,f.size=h.size,f.glType=h.type,f.location=a.getUniformLocation(i,h.name),j=f.name,"[0]"==j.substring(j.length-3)&&(j=j.substring(0,j.length-3)),h.type==a.SAMPLER_2D||h.type==a.SAMPLER_CUBE){f.unit=[];f.texture=
[];for(h=0;h<f.size;h++)f.unit[h]=this.nextTextureUnit(),f.texture[h]=new XML3D.webgl.GLTexture(a);c.setUniform(a,f,f.unit);this.samplers[j]=f}else this.uniforms[j]=f}},bind:function(){this.handle||XML3D.debug.logError("Trying to bind invalid GLProgram.");this.gl.useProgram(this.handle);for(var a in this.samplers){var b=this.samplers[a];if(b.texture)for(var c=0;c<b.texture.length;c++)b.texture[c]&&b.texture[c].bind(b.unit[c])}this.texturesBinded=!0},unbind:function(){this.texturesBinded=!1},isValid:function(){return!!this.handle},
setUniformVariables:function(a,b,c){var f,i,j;if(a&&c.envBase){f=a.length;i=c.envBase;for(j=c.envOverride;f--;){var k=a[f];this.setUniformVariable(k,j&&void 0!==j[k]?j[k]:i[k])}}if(b&&c.sysBase){f=b.length;for(i=c.sysBase;f--;)k=b[f],this.setUniformVariable(k,i[k])}},setUniformVariable:function(a,b){if(void 0!==b)if(this.uniforms[a])c.setUniform(this.gl,this.uniforms[a],b);else if(this.samplers[a]){var f=this.samplers[a];if(b&&f.texture!==b){f.texture=b;for(var h=0;h<f.texture.length;h++)f.texture[h]&&
f.texture[h].bind(f.unit[h])}}}});c.GLProgramObject=f})(XML3D.webgl);
(function(c){var b=function(a,b,c){this.context=a;this.width=b;this.height=c},a=function(){};XML3D.extend(b.prototype,{getWidth:function(){return this.width},getHeight:function(){return this.height},getScale:function(){return 1},bind:a,unbind:a,resize:a});var f=function(a,b){this.context=a;this.width=b.width||800;this.height=b.height||600;this.scale=b.scale||1;this.opt=this.fillOptions(b);this.handle=null;this.colorTarget={handle:null,isTexture:!1};this.depthTarget={handle:null,isTexture:!1};this.stencilTarget=
{handle:null,isTexture:!1};this.valid=!1};XML3D.extend(f.prototype,{getWidth:function(){return this.width},getHeight:function(){return this.height},getScale:function(){return this.scale},bind:function(){var a=!1;this.handle||(this.createFrameBuffer(this.opt.colorFormat,this.opt.depthFormat,this.opt.stencilFormat),a=!0);if(this.valid){var b=this.context.gl;b.bindFramebuffer(b.FRAMEBUFFER,this.handle);a&&b.viewport(0,0,this.width,this.height)}},unbind:function(){var a=this.context.gl;a.bindFramebuffer(a.FRAMEBUFFER,
null)},resize:function(a,b){this.dispose();this.width=a;this.height=b;this.bind()},createFrameBuffer:function(a,b,c){var f=this.context.gl;this.handle=f.createFramebuffer();f.bindFramebuffer(f.FRAMEBUFFER,this.handle);a&&this.createColorTarget(a);b&&this.createDepthTarget(b);c&&this.createStencilTarget(c);this.checkStatus()},createColorTarget:function(a){var b=this.context.gl;if(this.opt.colorAsRenderbuffer){var c=b.createRenderbuffer();b.bindRenderbuffer(b.RENDERBUFFER,c);b.renderbufferStorage(b.RENDERBUFFER,
a,this.width,this.height);b.bindRenderbuffer(b.RENDERBUFFER,null);b.framebufferRenderbuffer(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.RENDERBUFFER,c);this.colorTarget={handle:c,isTexture:!1}}else c=new XML3D.webgl.GLTexture(b),c.createTex2DFromData(a,this.width,this.height,b.RGBA,b.UNSIGNED_BYTE,this.opt),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,c.handle,0),this.colorTarget={handle:c,isTexture:!0}},createDepthTarget:function(a){var b=this.context.gl;this.opt.isDepth=!0;if(this.opt.depthAsRenderbuffer){var c=
b.createRenderbuffer();b.bindRenderbuffer(b.RENDERBUFFER,c);b.renderbufferStorage(b.RENDERBUFFER,a,this.width,this.height);b.bindRenderbuffer(b.RENDERBUFFER,null);b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,c);this.depthTarget={handle:c,isTexture:!1}}else c=new XML3D.webgl.GLTexture(b),c.createTex2DFromData(a,this.width,this.height,b.DEPTH_COMPONENT,b.FLOAT,this.opt),b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.TEXTURE_2D,c.handle,0),this.depthTarget={handle:c,
isTexture:!0}},createStencilTarget:function(a){var b=this.context.gl;if(this.opt.stencilAsRenderbuffer){var c=b.createRenderbuffer();b.bindRenderbuffer(b.RENDERBUFFER,c);b.renderbufferStorage(b.RENDERBUFFER,a,this.width,this.height);b.bindRenderbuffer(b.RENDERBUFFER,null);b.framebufferRenderbuffer(b.FRAMEBUFFER,b.STENCIL_ATTACHMENT,b.RENDERBUFFER,c);this.stencilTarget={handle:c,isTexture:!1}}else c=new XML3D.webgl.GLTexture(b),c.createTex2DFromData(a,this.width,this.height,b.STENCIL_COMPONENT,b.UNSIGNED_BYTE,
this.opt),b.framebufferTexture2D(b.FRAMEBUFFER,b.STENCIL_ATTACHMENT,b.TEXTURE_2D,c.handle,0),this.stencilTarget={handle:c,isTexture:!0}},checkStatus:function(){var a=this.context.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.handle);var b=a.checkFramebufferStatus(a.FRAMEBUFFER);switch(b){case a.FRAMEBUFFER_COMPLETE:break;case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");break;default:XML3D.debug.logError("Incomplete framebuffer: "+b)}a.bindFramebuffer(a.FRAMEBUFFER,null);return this.valid=b==a.FRAMEBUFFER_COMPLETE},fillOptions:function(a){var b=this.context.gl,b={wrapS:b.CLAMP_TO_EDGE,wrapT:b.CLAMP_TO_EDGE,minFilter:b.NEAREST,magFilter:b.NEAREST,
depthMode:b.LUMINANCE,depthCompareMode:b.COMPARE_R_TO_TEXTURE,depthCompareFunc:b.LEQUAL,colorsAsRenderbuffer:!1,depthAsRenderbuffer:!1,stencilAsRenderbuffer:!1,isDepth:!1},c;for(c in a)b[c]=a[c];return b},dispose:function(){if(this.handle){var a=this.context.gl;a.deleteFramebuffer(this.handle);null!==this.colorTarget&&(this.colorTarget.isTexture?this.colorTarget.handle.dispose():a.deleteRenderBuffer(this.colorTarget.handle));null!==this.depthTarget&&(this.depthTarget.isTexture?this.depthTarget.handle.dispose():
a.deleteRenderBuffer(this.depthTarget.handle));null!==this.stencilTarget&&(this.stencilTarget.isTexture?this.stencilTarget.handle.dispose():a.deleteRenderBuffer(this.stencilTarget.handle))}}});a=function(a,b,c){f.call(this,a,c);this.scaleToMaxDimension(b)};XML3D.createClass(a,f);XML3D.extend(a.prototype,{scaleToMaxDimension:function(a){var b=this.height-a,c=this.width-a;if(0<b||0<c)a=b>c?a/this.height:a/this.width,this.width=Math.floor(this.width*a),this.height=Math.floor(this.height*a),this.scale=
a}});c.GLCanvasTarget=b;c.GLRenderTarget=f;c.GLScaledRenderTarget=a})(XML3D.webgl);
(function(c){var b=XML3D.math.vec3,a=b.create(),f=b.create(),d=function(a,b,d,c,e){this.orthographic=!1;this.setFrustum(a,b,d,c,e)};XML3D.extend(d.prototype,{setFrustum:function(a,b,d,c,e){if(d&&c)throw Error("fovx and fovy cannot both be non-zero.");d?(this.right=a*Math.tan(d/2),this.left=-this.right,this.top=(this.right-this.left)/e/2,this.bottom=-this.top):(this.top=a*Math.tan(0.5*c),this.bottom=-this.top,this.right=(this.top-this.bottom)*e/2,this.left=-this.right);this.nearPlane=a;this.farPlane=
b;this.orthographic=!1},getProjectionMatrix:function(a){var b=Number.MAX_VALUE,d=this.right+this.left,c=this.right-this.left,e=this.top+this.bottom,f=this.top-this.bottom,g=this.farPlane+this.nearPlane,p=this.farPlane-this.nearPlane;if(1>Math.abs(c)&&Math.abs(d)>b*Math.abs(c)||1>Math.abs(f)&&Math.abs(e)>b*Math.abs(f)||1>Math.abs(p)&&Math.abs(g)>b*Math.abs(p))throw Error("Bad viewing frustum: projection matrix cannot be computed.");if(this.orthographic){var q=-d/c,n=-e/f,o=-g/p;if(1>Math.abs(c)&&2>
b*Math.abs(c)||1>Math.abs(f)&&2>b*Math.abs(f)||1>Math.abs(p)&&2>b*Math.abs(p))throw Error("Bad viewing frustum:  projection matrix cannot be computed.");d=2/c;e=2/f;g=-2/p;XML3D.math.mat4.identity(a);a[0]=d;a[5]=e;a[10]=g;a[12]=q;a[13]=n;a[14]=o;a[15]=1}else{d/=c;e/=f;g=-g/p;q=-2*this.farPlane*this.nearPlane;if(1>Math.abs(p)&&Math.abs(q)>b*Math.abs(p))throw Error("Bad viewing frustum: projection matrix cannot be computed.");p=q/p;q=2*this.nearPlane;if(1>Math.abs(c)&&Math.abs(q)>b*Math.abs(c)||1>Math.abs(f)&&
Math.abs(q)>b*Math.abs(f))throw Error("Bad viewing frustum: projection matrix cannot be computed.");b=q/c;f=q/f;XML3D.math.mat4.identity(a);a[0]=b;a[5]=f;a[8]=d;a[9]=e;a[10]=g;a[11]=-1;a[14]=p;a[15]=0}},getPlanes:function(){var a=b.create(),d=b.create(),c=b.create(),e=b.create(),f=b.create(),g=b.create(),r=b.create(),p=b.create();return function(q,n){var o=b.transformMat4(a,[this.left,this.bottom,-this.nearPlane],n),u=b.transformMat4(d,[this.left,this.top,-this.nearPlane],n),x=b.transformMat4(c,[this.right,
this.top,-this.nearPlane],n),B=b.transformMat4(e,[this.right,this.bottom,-this.nearPlane],n),w,s,D,t;this.orthographic?(w=b.transformMat4(f,[this.left,this.bottom,-this.farPlane],n),s=b.transformMat4(g,[this.left,this.top,-this.farPlane],n),D=b.transformMat4(r,[this.right,this.top,-this.farPlane],n),t=b.transformMat4(p,[this.right,this.bottom,-this.farPlane],n),q[0].setFromPoints(x,D,s),q[1].setFromPoints(B,t,D),q[2].setFromPoints(o,w,t),q[3].setFromPoints(u,s,w)):(w=this.farPlane/this.nearPlane,
s=w*this.left,D=w*this.right,t=w*this.top,w=b.transformMat4(f,[s,w*this.bottom,-this.farPlane],n),s=b.transformMat4(g,[s,t,-this.farPlane],n),D=b.transformMat4(r,[D,t,-this.farPlane],n),t=b.transformMat4(p,[0,0,0],n),q[0].setFromPoints(t,x,u),q[1].setFromPoints(t,B,x),q[2].setFromPoints(t,o,B),q[3].setFromPoints(t,u,o));q[4].setFromPoints(o,B,x);q[5].setFromPoints(w,s,D)}}()});var e=function(){this.distance=0;this.normal=b.create()};XML3D.extend(e.prototype,{setFromPoints:function(d,c,e){b.cross(this.normal,
b.sub(f,e,d),b.sub(a,c,d));b.normalize(this.normal,this.normal);this.distance=-b.dot(this.normal,d)},set:function(a,d,c,e){b.set(this.normal,a,d,c);b.normalize(this.normal,this.normal);this.distance=e}});var g=function(a,b){this.frustumPlanes=[new e,new e,new e,new e,new e,new e];a&&b&&this.set(a,b)};XML3D.extend(g.prototype,{set:function(a,b){a.getPlanes(this.frustumPlanes,b)},isBoxVisible:function(){return function(a){if(XML3D.math.bbox.isEmpty(a))return!1;for(var b=0;b<this.frustumPlanes.length;b++){var d=
this.frustumPlanes[b],c=d.normal;if(0>(0<=c[0]?a[3]:a[0])*c[0]+(0<=c[1]?a[4]:a[1])*c[1]+(0<=c[2]?a[5]:a[2])*c[2]+d.distance)return!1}return!0}}()});c.Plane=e;c.Frustum=d;c.FrustumTest=g})(XML3D.webgl);
(function(c){var b=function(a){var b=window.WebGLRenderingContext;a&&a.toLoweGLase&&(a=a.toLowerCase());switch(a){case "triangles":return b.TRIANGLES;case "tristrips":return b.TRIANGLE_STRIP;case "points":return b.POINTS;case "lines":return b.LINES;case "linestrips":return b.LINE_STRIP;default:throw Error("Unknown primitive type: "+a);}},a=function(a,d){this.context=a;this.glType=b(d);this.buffers={};this.uniformOverride={};this.maxIndex=this.minIndex=0;this.isIndexed=!1;this.vertexCount=null;this.minAttributeCount=
-1;this.context.getStatistics().meshes++};XML3D.extend(a.prototype,{setIndexRange:function(a,b){this.minIndex=a;this.maxIndex=b},checkBufferCompatible:function(a,b){var c=b.getIterateCount();this.minAttributeCount=-1==this.minAttributeCount?c:Math.min(this.minAttributeCount,c);if(this.isIndexed){if(c<=this.maxIndex)throw Error("Index range of ["+this.minIndex+", "+this.maxIndex+"]  goes beyond element count "+c+" of attribute '"+a+"'");}else if(null!==this.vertexCount&&c<this.vertexCount)throw Error("VertexCount "+
this.vertexCount+" is larger than element count "+c+" of attribute '"+a+"'");},removeBuffer:function(a){delete this.buffers[a]},setBuffer:function(a,b){this.buffers[a]=b;this.isIndexed=this.isIndexed||"index"==a},clear:function(){this.buffers={};this.uniformOverride={};this.minIndex=this.maxIndex=0;this.isIndexed=!1;this.minAttributeCount=-1},setUniformOverride:function(a,b){void 0===b&&delete this.uniformOverride[a];this.uniformOverride[a]=b},setVertexCount:function(a){this.vertexCount=a},isReadyToRender:function(){return 0<
this.minAttributeCount},getElementCount:function(){try{return this.buffers.index.length}catch(a){return 0}},getVertexCount:function(){try{return null!=this.vertexCount?this.vertexCount:this.minAttributeCount}catch(a){return 0}},draw:function(a){var b=this.context.gl,c=a.attributes,g=this.buffers,h=0,i;for(i in c){var j=c[i];if(h=g[i])b.enableVertexAttribArray(j.location),b.bindBuffer(b.ARRAY_BUFFER,h),b.vertexAttribPointer(j.location,h.tupleSize,h.glType,!1,0,0)}if(this.isIndexed){b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
g.index);if(this.segments){g=0;j=this.segments.value;for(h=0;h<j.length;h++)b.drawElements(this.glType,j[h],b.UNSIGNED_SHORT,g),g+=2*j[h]}else b.drawElements(this.glType,this.getElementCount(),b.UNSIGNED_SHORT,0);h=this.getElementCount()/3}else{if(this.size){g=0;j=this.size.data;for(h=0;h<j.length;h++)b.drawArrays(this.glType,g,j[h]),g+=2*j[h]}else b.drawArrays(this.glType,0,this.getVertexCount());h=this.getVertexCount()}for(i in c)j=c[i],b.disableVertexAttribArray(j.location);b.bindBuffer(b.ARRAY_BUFFER,
null);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);a.undoUniformVariableOverride&&a.undoUniformVariableOverride(this.uniformOverride);return h}});c.GLMesh=a})(XML3D.webgl);
(function(c){c.checkError=function(a,b){var c=a.getError();if(c!==a.NO_ERROR){var e=""+c;switch(c){case 1280:e="1280 ( GL_INVALID_ENUM )";break;case 1281:e="1281 ( GL_INVALID_VALUE )";break;case 1282:e="1282 ( GL_INVALID_OPERATION )";break;case 1283:e="1283 ( GL_STACK_OVERFLOW )";break;case 1284:e="1284 ( GL_STACK_UNDERFLOW )";break;case 1285:e="1285 ( GL_OUT_OF_MEMORY )"}c="GL error "+e+" occured.";void 0!==b&&(c+=" "+b);XML3D.debug.trace(c)}};var b=function(a,b,c){var e=a.createBuffer();a.bindBuffer(b,
e);a.bufferData(b,c,a.STATIC_DRAW);e.length=c.length;a=window.WebGLRenderingContext;e.glType=c instanceof Int8Array?a.BYTE:c instanceof Uint8Array?a.UNSIGNED_BYTE:c instanceof Int16Array?a.SHORT:c instanceof Uint16Array?a.UNSIGNED_SHORT:c instanceof Int32Array?a.INT:c instanceof Uint32Array?a.UNSIGNED_INT:a.FLOAT;return e};c.getGLBufferFromXflowDataEntry=function(a,c,d){var e=c.getXflowEntryWebGlData(a),g=e.buffer,c=c.gl;switch(e.changed){case Xflow.DATA_ENTRY_STATE.CHANGED_VALUE:var h=d?c.ELEMENT_ARRAY_BUFFER:
c.ARRAY_BUFFER;c.bindBuffer(h,g);c.bufferSubData(h,0,a.getValue());break;case Xflow.DATA_ENTRY_STATE.CHANGED_NEW:case Xflow.DATA_ENTRY_STATE.CHANGED_SIZE:g=d?b(c,c.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.getValue())):b(c,c.ARRAY_BUFFER,a.getValue()),g.tupleSize=a.getTupleSize(),e.buffer=g}if(e.changed&&d){a=a.getValue();d=1E8;c=0;for(h=a.length;h--;)d=Math.min(d,a[h]),c=Math.max(c,a[h]);e.maxIndex=c;e.minIndex=d}e.changed=0;return g};c.getGLUniformValueFromXflowDataEntry=function(a,b){var c;if(!a)return null;
if(a.type==Xflow.DATA_TYPE.TEXTURE){var e=b.gl;c=b.getXflowEntryWebGlData(a);e=c.texture||new XML3D.webgl.GLTexture(e);c.changed&&e.updateFromTextureEntry(a);c.texture=e;c.changed=0;c=[e]}else if(a.type==Xflow.DATA_TYPE.BOOL){c=a.getValue();for(var e=[c.length],g=0;g<c.length;g++)e[g]=c[g];c=e}else c=a.getValue();return c};c.canvasToGlY=function(a,b){return a.height-b-1};c.FRAGMENT_HEADER="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif // GL_FRAGMENT_PRECISION_HIGH\n\n";
c.addFragmentShaderHeader=function(a){return c.FRAGMENT_HEADER+a};c.setUniform=function(a,b,c,e){switch(b.glType){case 35670:case 5124:case 35678:c&&void 0!==c.length?a.uniform1iv(b.location,c):a.uniform1i(b.location,c||0);break;case 35671:case 35667:a.uniform2iv(b.location,c);break;case 35672:case 35668:a.uniform3iv(b.location,c);break;case 35673:case 35669:a.uniform4iv(b.location,c);break;case 5126:null!=c.length?a.uniform1fv(b.location,c):a.uniform1f(b.location,c);break;case 35664:a.uniform2fv(b.location,
c);break;case 35665:a.uniform3fv(b.location,c);break;case 35666:a.uniform4fv(b.location,c);break;case 35674:a.uniformMatrix2fv(b.location,e||!1,c);break;case 35675:a.uniformMatrix3fv(b.location,e||!1,c);break;case 35676:a.uniformMatrix4fv(b.location,e||!1,c);break;default:XML3D.debug.logError("Unknown uniform type "+b.glType)}}})(XML3D.webgl);
(function(c){var b=function(a,b,c){this.context=a;this.scene=b;this.canvas=c;this.width=c.clientWidth;this.height=c.clientHeight;this.pickedObject=null;this.needsPickingDraw=this.needsDraw=!0;this.context.requestRedraw=this.requestRedraw.bind(this);this.initGL();this.changeListener=new XML3D.webgl.DataChangeListener(this);this.createRenderPasses(a)};b.prototype.generateRay=function(){};XML3D.extend(b.prototype,{initGL:function(){var a=this.context.gl;a.clearColor(0,0,0,0);a.clearDepth(1);a.clearStencil(0);
a.enable(a.DEPTH_TEST);a.depthFunc(a.LEQUAL);a.frontFace(a.CCW);a.cullFace(a.BACK);a.disable(a.CULL_FACE);a.blendEquation(a.FUNC_ADD);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.disable(a.BLEND);a.viewport(0,0,this.width,this.height);a.pixelStorei(a.PACK_ALIGNMENT,1);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL)},handleResizeEvent:function(a,
b){this.width=a;this.height=b;this.context.handleResizeEvent(a,b);this.createRenderPasses(this.context);this.scene.handleResizeEvent(a,b);this.needsDraw=this.needsPickingDraw=!0},createRenderPasses:function(a){this.mainPass=new c.ForwardRenderPass(a);var b=this.createPickingTarget();this.pickObjectPass=new c.PickObjectRenderPass(a,{target:b});this.pickPositionPass=new c.PickPositionRenderPass(a,{target:b});this.pickNormalPass=new c.PickNormalRenderPass(a,{target:b})},requestRedraw:function(a){XML3D.debug.logDebug("Request redraw because:",
a);this.needsPickingDraw=this.needsDraw=!0},getWorldSpaceNormalByPoint:function(a,b,d){d=d||this.pickedObject;if(!d)return null;b=c.canvasToGlY(this.canvas,b);this.pickNormalPass.renderObject(d);return this.pickNormalPass.readNormalFromPickingBuffer(a,b)},getWorldSpacePositionByPoint:function(a,b,d){d=d||this.pickedObject;if(!d)return null;b=c.canvasToGlY(this.canvas,b);this.pickPositionPass.renderObject(d);return this.pickPositionPass.readPositionFromPickingBuffer(a,b)},needsRedraw:function(){return this.needsDraw},
renderToCanvas:function(){this.prepareRendering();var a=this.mainPass.renderScene(this.scene);XML3D.debug.logDebug("Rendered to Canvas");this.needsDraw=!1;return a},getRenderObjectFromPickingBuffer:function(a,b){b=c.canvasToGlY(this.canvas,b);this.needsPickingDraw&&(this.prepareRendering(),this.pickObjectPass.renderScene(this.scene),this.needsPickingDraw=!1);return this.pickedObject=this.pickObjectPass.getRenderObjectFromPickingBuffer(a,b,this.scene)},prepareRendering:function(){this.scene.update()},
createPickingTarget:function(){var a=this.context.gl;return new c.GLScaledRenderTarget(this.context,c.MAX_PICK_BUFFER_DIMENSION,{width:this.width,height:this.height,colorFormat:a.RGBA,depthFormat:a.DEPTH_COMPONENT16,stencilFormat:null,depthAsRenderbuffer:!0})},generateRay:function(){var a=XML3D.math.mat4.create(),b=XML3D.math.mat4.create();return function(c,e){var g=XML3D.webgl.canvasToGlY(this.canvas,e),h=[0,0];h[2]=this.width;h[3]=this.height;var i=this.scene.getActiveView();i.getWorldToViewMatrix(a);
i.getProjectionMatrix(b,h[2]/h[3]);var i=new window.XML3DRay,j=[],k=[];if(!1===GLU.unProject(c,g,0,a,b,h,j)||!1===GLU.unProject(c,g,1,a,b,h,k))return i;XML3D.math.mat4.invert(a,a);g=new window.XML3DVec3(a[12],a[13],a[14]);i.origin.set(g);i.direction.set(k[0]-j[0],k[1]-j[1],k[2]-j[2]);i.direction.set(i.direction.normalize());return i}}(),dispose:function(){this.scene.clear()}});c.GLRenderer=b})(XML3D.webgl);
(function(c){var b=function(){var a={};window.location.search.substr(1).split("&").forEach(function(b){b=b.split("=");a[b[0].toLowerCase()]=decodeURIComponent(b[1])});return a.hasOwnProperty("xml3d_noculling")}(),a=function(a){c.Scene.call(this);this.context=a;this.shaderFactory=new c.ShaderComposerFactory(a);this.drawableFactory=new c.DrawableFactory(a);this.firstOpaqueIndex=0;this.ready=[];this.queue=[];this.lightsNeedUpdate=!0;this.systemUniforms={};this.addListeners()},f=c.Scene.EVENT_TYPE;XML3D.createClass(a,
c.Scene);a.LIGHT_PARAMETERS="pointLightPosition,pointLightAttenuation,pointLightIntensity,pointLightOn,directionalLightDirection,directionalLightIntensity,directionalLightOn,spotLightAttenuation,spotLightPosition,spotLightIntensity,spotLightDirection,spotLightOn,spotLightSoftness,spotLightCosFalloffAngle,spotLightCosSoftFalloffAngle".split(",");XML3D.extend(a.prototype,{remove:function(a){var b=this.queue.indexOf(a);-1!=b&&this.queue.splice(b,1);b=this.ready.indexOf(a);-1!=b&&(this.ready.splice(b,
1),b<this.firstOpaqueIndex&&this.firstOpaqueIndex--)},clear:function(){this.ready=[];this.queue=[]},moveFromQueueToReady:function(a){var b=this.queue.indexOf(a);-1!=b&&(this.queue.splice(b,1),a.hasTransparency()?(this.ready.unshift(a),this.firstOpaqueIndex++):this.ready.push(a))},moveFromReadyToQueue:function(a){var b=this.ready.indexOf(a);-1!=b&&(this.ready.splice(b,1),b<this.firstOpaqueIndex&&this.firstOpaqueIndex--,this.queue.push(a))},update:function(){this.lightsNeedUpdate&&(this.lightsNeedUpdate=
!1,this.updateLightParameters());this.updateObjectsForRendering();this.updateShaders()},updateLightParameters:function(){var a=this.systemUniforms,b=this.lights,c={position:[],attenuation:[],intensity:[],on:[]};b.point.forEach(function(a,b){a.getLightData(c,b)});a.pointLightPosition=c.position;a.pointLightAttenuation=c.attenuation;a.pointLightIntensity=c.intensity;a.pointLightOn=c.on;var f={direction:[],intensity:[],on:[]};b.directional.forEach(function(a,b){a.getLightData(f,b)});a.directionalLightDirection=
f.direction;a.directionalLightIntensity=f.intensity;a.directionalLightOn=f.on;var i={position:[],attenuation:[],direction:[],intensity:[],on:[],softness:[],falloffAngle:[]};b.spot.forEach(function(a,b){a.getLightData(i,b)});a.spotLightAttenuation=i.attenuation;a.spotLightPosition=i.position;a.spotLightIntensity=i.intensity;a.spotLightDirection=i.direction;a.spotLightOn=i.on;a.spotLightSoftness=i.softness;a.spotLightCosFalloffAngle=i.falloffAngle.map(Math.cos);for(var b=i.softness.slice(),j=0;j<b.length;j++)b[j]*=
1-i.softness[j];a.spotLightCosSoftFalloffAngle=b.map(Math.cos)},updateShaders:function(){this.shaderFactory.update(this)},updateObjectsForRendering:function(){this.forEach(function(a){a.updateForRendering()})},forEach:function(a,b){this.queue.slice().forEach(a,b);this.ready.slice().forEach(a,b)},updateReadyObjectsFromActiveView:function(){var a=XML3D.math.mat4.create(),c=XML3D.math.mat4.create(),f=XML3D.math.mat4.create(),h=XML3D.math.bbox.create(),i=new XML3D.webgl.FrustumTest;return function(j){var k=
this.getActiveView(),l=this.ready;k.getWorldToViewMatrix(a);l.forEach(function(b){b.updateModelViewMatrix(a);b.updateNormalMatrix()});this.updateBoundingBox();k.getProjectionMatrix(f,j);k.getViewToWorldMatrix(c);j=k.getFrustum();i.set(j,c);j=0;for(k=l.length;j<k;j++){var m=l[j];m.updateModelViewProjectionMatrix(f);m.getWorldSpaceBoundingBox(h);m.inFrustum=b?!0:i.isBoxVisible(h)}}}(),addListeners:function(){this.addEventListener(f.SCENE_STRUCTURE_CHANGED,function(a){void 0!==a.newChild?this.addChildEvent(a.newChild):
void 0!==a.removedChild&&this.removeChildEvent(a.removedChild)});this.addEventListener(f.VIEW_CHANGED,function(){this.context.requestRedraw("Active view changed.")});this.addEventListener(f.LIGHT_STRUCTURE_CHANGED,function(){this.lightsNeedUpdate=!0;this.shaderFactory.setLightStructureDirty()});this.addEventListener(f.LIGHT_VALUE_CHANGED,function(){this.lightsNeedUpdate=!0;this.shaderFactory.setLightValueChanged();this.context.requestRedraw("Light value changed.")})},addChildEvent:function(a){a.type==
c.Scene.NODE_TYPE.OBJECT&&(this.queue.push(a),this.context.requestRedraw("Object was added to scene."))},removeChildEvent:function(a){a.type==c.Scene.NODE_TYPE.OBJECT&&(this.remove(a),a.dispose(),this.context.requestRedraw("Object was removed from scene."))},handleResizeEvent:function(){this.getActiveView().setProjectionDirty()},createDrawable:function(a){return this.drawableFactory.createDrawable(a)},requestRedraw:function(a){return this.context.requestRedraw(a)}});c.GLScene=a})(XML3D.webgl);
(function(c){var b=function(){},a=XML3D.math.bbox.create(),f=XML3D.math.vec3.create();XML3D.extend(b.prototype,{sortScene:function(b,c){for(var g=b.ready,h=b.firstOpaqueIndex,i=[],j=[],k=[],l,m=0,r=g.length;m<r;m++)if(l=g[m],!1!==l.inFrustum)if(m<h)k.push(l);else{var p=l.getProgram();i[p.id]=i[p.id]||[];i[p.id].push(l)}g=k.length;if(1<g){for(m=0;m<g;m++)l=k[m],l.getWorldSpaceBoundingBox(a),XML3D.math.bbox.center(f,a),c&&XML3D.math.vec3.transformMat4(f,f,c),k[m]=[l,f[2]];k.sort(function(a,b){return a[1]-
b[1]});for(m=0;m<g;m++)j[m]=k[m][0]}else 1==g&&(j[0]=k[0]);return{opaque:i,transparent:j}}});c.ObjectSorter=b})(XML3D.webgl);
(function(c){var b=function(a,b){b=b||{};this.context=a;this.target=b.target||a.canvasTarget};XML3D.extend(b.prototype,{readPixelDataFromBuffer:function(){var a=new Uint8Array(8);return function(b,c){var e=this.context.gl,g=this.target.getScale(),h=b*g,g=c*g;this.target.bind();try{return e.readPixels(h,g,1,1,e.RGBA,e.UNSIGNED_BYTE,a),this.target.unbind(),a}catch(i){return XML3D.debug.logException(i),this.target.unbind(),null}}}()});c.BaseRenderPass=b})(XML3D.webgl);
(function(c){var b=function(a,b){c.BaseRenderPass.call(this,a,b);this.sorter=new c.ObjectSorter};XML3D.createClass(b,c.BaseRenderPass);XML3D.extend(b.prototype,{renderScene:function(){var a=XML3D.math.mat4.create();return function(b){var c=this.context.gl,e=this.target,g={objects:0,primitives:0};e.bind();c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT);c.viewport(0,0,e.getWidth(),e.getHeight());c.enable(c.DEPTH_TEST);b.updateReadyObjectsFromActiveView(e.getWidth()/e.getHeight());
b.getActiveView().getWorldToViewMatrix(a);var c=this.sorter.sortScene(b,a),h;for(h in c.opaque)this.renderObjectsToActiveBuffer(c.opaque[h],b,{transparent:!1,stats:g});for(h=0;h<c.transparent.length;h++)this.renderObjectsToActiveBuffer([c.transparent[h]],b,{transparent:!0,stats:g});b.lights.changed=!1;return{count:g}}}(),renderObjectsToActiveBuffer:function(){var a=XML3D.math.mat4.create(),b=XML3D.math.mat4.create(),c=XML3D.math.mat4.create(),e=XML3D.math.mat4.create(),g=XML3D.math.mat4.create(),
h=XML3D.math.mat3.create(),i=["viewMatrix","projectionMatrix","screenWidth","cameraPosition"],j=["modelMatrix","modelViewMatrix","modelViewProjectionMatrix","normalMatrix"];return function(k,l,m){var r=0,p=0,q=l.systemUniforms,n=m.stats||{},m=!0===m.transparent||!1,o=this.context.gl;if(0!=k.length){m&&(o.enable(o.BLEND),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA));var u=k[0].getProgram();u.bind();l.getActiveView().getWorldToViewMatrix(a);l.getActiveView().getProjectionMatrix(b,
this.width/this.height);q.viewMatrix=a;q.projectionMatrix=b;q.cameraPosition=l.getActiveView().getWorldSpacePosition();q.screenWidth=this.target.width;u.setSystemUniformVariables(i,q);for(var l=null,x=0,B=k.length;x<B;x++){var w=k[x];if(w.isVisible()){var s=w.mesh;XML3D.debug.assert(s,"We need a mesh at his point.");w.getWorldMatrix(c);q.modelMatrix=c;w.getModelViewMatrix(e);q.modelViewMatrix=e;w.getModelViewProjectionMatrix(g);q.modelViewProjectionMatrix=g;w.getNormalMatrix(h);q.normalMatrix=h;u.setSystemUniformVariables(j,
q);u.changeUniformVariableOverride(l,s.uniformOverride);l=s.uniformOverride;p+=s.draw(u);r++;m&&o.disable(o.BLEND)}}u.changeUniformVariableOverride(l,null);u.unbind();n.objects+=r;n.primitives+=p;return n}}}()});c.ForwardRenderPass=b})(XML3D.webgl);
(function(c){var b=function(a,b){c.BaseRenderPass.call(this,a,b);this.program=a.programFactory.getPickingObjectIdProgram();var d=this.context.gl;this.clearBits=d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT};XML3D.createClass(b,c.BaseRenderPass);XML3D.extend(b.prototype,{renderScene:function(){var a=XML3D.math.mat4.create(),b={envBase:{},envOverride:null,sysBase:{}},c=["id","modelViewProjectionMatrix"];return function(e){var g=this.context.gl;this.target.bind();g.enable(g.DEPTH_TEST);g.disable(g.CULL_FACE);
g.disable(g.BLEND);g.viewport(0,0,this.target.getWidth(),this.target.getHeight());g.clear(this.clearBits);e.updateReadyObjectsFromActiveView(this.target.getWidth()/this.target.getHeight());this.program.bind();for(var e=e.ready,g=0,h=e.length;g<h;g++){var i=e[g],j=i.mesh;if(i.isVisible()){i.getModelViewProjectionMatrix(a);var i=g+1,k=i&255,i=i>>8,l=i&255,i=i>>8;b.sysBase.id=[(i&255)/255,l/255,k/255];b.sysBase.modelViewProjectionMatrix=a;this.program.setUniformVariables(null,c,b);j.draw(this.program)}}this.program.unbind();
this.target.unbind()}}(),getRenderObjectFromPickingBuffer:function(a,b,c){b=this.readPixelDataFromBuffer(a,b);if(!b)return null;a=null;b=65536*b[0]+256*b[1]+b[2];0<b&&(a=c.ready[b-1]);return a}});c.PickObjectRenderPass=b})(XML3D.webgl);
(function(c){var b=function(a,b){c.BaseRenderPass.call(this,a,b);this.program=a.programFactory.getPickingPositionProgram();this.objectBoundingBox=XML3D.math.bbox.create()};XML3D.createClass(b,c.BaseRenderPass,{renderObject:function(){var a=XML3D.math.mat4.create(),b=XML3D.math.mat4.create(),c={envBase:{},envOverride:null,sysBase:{}},e=["bbox","modelMatrix","modelViewProjectionMatrix"];return function(g){var h=this.context.gl;this.target.bind();h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT|h.STENCIL_BUFFER_BIT);
h.enable(h.DEPTH_TEST);h.disable(h.CULL_FACE);h.disable(h.BLEND);g.getWorldMatrix(a);g.getObjectSpaceBoundingBox(this.objectBoundingBox);XML3D.math.bbox.transform(this.objectBoundingBox,a,this.objectBoundingBox);this.program.bind();g.getModelViewProjectionMatrix(b);c.sysBase.bbox=this.objectBoundingBox;c.sysBase.modelMatrix=a;c.sysBase.modelViewProjectionMatrix=b;this.program.setUniformVariables(null,e,c);g.mesh.draw(this.program);this.program.unbind();this.target.unbind()}}(),readPositionFromPickingBuffer:function(){var a=
XML3D.math.vec3.create();return function(b,c){var e=this.readPixelDataFromBuffer(b,c);return e?(a[0]=e[0]/255,a[1]=e[1]/255,a[2]=e[2]/255,e=XML3D.math.bbox.size(XML3D.math.vec3.create(),this.objectBoundingBox),e=XML3D.math.vec3.mul(e,a,e),XML3D.math.vec3.add(e,this.objectBoundingBox,e),e):null}}()});c.PickPositionRenderPass=b})(XML3D.webgl);
(function(c){var b=function(a,b){c.BaseRenderPass.call(this,a,b);this.program=a.programFactory.getPickingNormalProgram()};XML3D.createClass(b,c.BaseRenderPass,{renderObject:function(){var a=XML3D.math.mat4.create(),b=XML3D.math.mat4.create(),c=XML3D.math.mat3.create(),e={envBase:{},envOverride:null,sysBase:{}},g=["modelViewProjectionMatrix","normalMatrix"];return function(h){var i=this.context.gl;this.target.bind();i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT);i.enable(i.DEPTH_TEST);
i.disable(i.CULL_FACE);i.disable(i.BLEND);h.getModelViewProjectionMatrix(a);h.getWorldMatrix(b);XML3D.math.mat4.invert(b,b)?(XML3D.math.mat3.fromMat4(c,b),XML3D.math.mat3.transpose(c,c)):XML3D.math.mat3.identity(c);i=this.program;i.bind();e.sysBase.modelViewProjectionMatrix=a;e.sysBase.normalMatrix=c;i.setUniformVariables(null,g,e);h.mesh.draw(i);i.unbind();this.target.unbind()}}(),readNormalFromPickingBuffer:function(){var a=XML3D.math.vec3.create(),b=XML3D.math.vec3.fromValues(1,1,1);return function(c,
e){var g=this.readPixelDataFromBuffer(c,e);if(!g)return null;a[0]=g[0]/254;a[1]=g[1]/254;a[2]=g[2]/254;return XML3D.math.vec3.subtract(XML3D.math.vec3.create(),XML3D.math.vec3.scale(XML3D.math.vec3.create(),a,2),b)}}()});c.PickNormalRenderPass=b})(XML3D.webgl);
(function(c){var b=function(a){this.context=a;this.programs={fallback:null,picking:{id:null,normal:null,position:null}}};XML3D.extend(b.prototype,{getProgramByName:function(a){var b=XML3D.shaders.getScript(a);if(!b||!b.vertex)return XML3D.debug.logError("Unknown shader: ",a),null;a=new c.ShaderDescriptor;XML3D.extend(a,b);a.fragment=XML3D.webgl.addFragmentShaderHeader(a.fragment);b=new c.ShaderClosure(this.context,a);b.createSources({},null,null);b.compile();return b},getFallbackProgram:function(){if(!this.programs.fallback){var a=
new c.ShaderDescriptor;XML3D.extend(a,XML3D.shaders.getScript("matte"));a.fragment=XML3D.webgl.addFragmentShaderHeader(a.fragment);a=new c.ShaderClosure(this.context,a);a.uniformCollection.envBase.diffuseColor=[1,0,0];a.createSources({},null,null);a.compile();this.programs.fallback=a;this.programs.fallback.bind();this.programs.fallback.setUniformVariables(["diffuseColor"],null,{envBase:{diffuseColor:[1,0,0]}});this.programs.fallback.unbind()}return this.programs.fallback},getPickingObjectIdProgram:function(){var a=
this.programs.picking;a.id||(a.id=this.getProgramByName("pickobjectid"));return a.id},getPickingPositionProgram:function(){var a=this.programs.picking;a.position||(a.position=this.getProgramByName("pickedposition"));return a.position},getPickingNormalProgram:function(){var a=this.programs.picking;a.normal||(a.normal=this.getProgramByName("pickedNormals"));return a.normal}});c.ProgramFactory=b})(XML3D.webgl);
(function(c){var b=function(a){this.context=a};XML3D.extend(b.prototype,{createDrawable:function(a){XML3D.debug.logDebug("DrawableFactory::createDrawable",a);var b=new c.MeshClosure(this.context,a.getType(),a.getDataNode(),{boundingBoxChanged:a.setObjectSpaceBoundingBox.bind(a)});a.mesh=b.getMesh();return b}});c.DrawableFactory=b})(XML3D.webgl);
(function(c){var b=function(a,b){this.context=a;this.shaderClosures=[];this.updateLightValues=this.dataChanged=!1;this.request=null;b.addChangeListener(this.onShaderInfoChanged.bind(this))};XML3D.createClass(b,XML3D.util.EventDispatcher,{setShaderInfo:null,updateRequest:function(a){this.request&&this.request.clear();this.request=new Xflow.ComputeRequest(a,this.getRequestFields(),this.onShaderRequestChange.bind(this));this.setShaderRecompile()},onShaderInfoChanged:function(a){this.setShaderInfo(a);
this.setShaderRecompile();this.context.requestRedraw("Shader script changed")},onShaderRequestChange:function(a,b){this.dataChanged=!0;b==Xflow.RESULT_STATE.CHANGED_STRUCTURE&&this.setShaderRecompile();this.context.requestRedraw("Shader data changed")},update:function(a){for(var b=this,c=this.shaderClosures.length;c--;)this.shaderClosures[c].obsolete&&this.shaderClosures.splice(c,1);if(this.shaderClosures.length){if(this.dataChanged){var g=this.getShaderDataResult();this.shaderClosures.forEach(function(a){b.updateClosureFromComputeResult(a,
g)});this.dataChanged=!1}this.updateLightValues&&this.shaderClosures.forEach(function(c){b.updateClosureFromLightParameters(c,a)})}},updateClosureFromComputeResult:function(a,b){b&&b.getOutputMap&&(a.bind(),a.updateUniformsFromComputeResult(b))},updateClosureFromLightParameters:function(a,b){a.bind();a.setSystemUniformVariables(c.GLScene.LIGHT_PARAMETERS,b.systemUniforms)},createShaderClosure:function(){throw Error("AbstractComposer::createShaderClosure needs to be overridden");},createObjectDataRequest:function(){throw Error("AbstractComposer::createObjectDataRequest needs to be overridden");
},distributeObjectShaderData:function(){throw Error("AbstractComposer::distributeObjectShaderData needs to be overridden");},getShaderClosure:function(a,b){var c=this.createShaderClosure();try{c.createSources(a,this.getShaderDataResult(),b)}catch(g){throw Error("Shader: "+g.message);}for(var h=0;h<this.shaderClosures.length;h++)if(this.shaderClosures[h].equals(c))return this.shaderClosures[h].obsolete=!1,this.shaderClosures[h];this.initializeShaderClosure(c,a,b);return c},initializeShaderClosure:function(a,
b){a.compile();this.updateClosureFromComputeResult(a,this.getShaderDataResult());this.updateClosureFromLightParameters(a,b);this.shaderClosures.push(a)},setShaderRecompile:function(){for(var a=0;a<this.shaderClosures.length;++a)this.shaderClosures[a].obsolete=!0;this.dispatchEvent({type:c.ShaderComposerFactory.EVENT_TYPE.MATERIAL_STRUCTURE_CHANGED});this.updateLightValues=this.dataChanged=!0},getShaderDataResult:function(){return this.request?this.request.getResult():null}});var a=function(a){this.context=
a};XML3D.createClass(a,b,{update:function(){},getShaderClosure:function(){return this.context.programFactory.getFallbackProgram()},getShaderAttributes:function(){return{color:null,normal:null}},getRequestFields:function(){return["diffuseColor","useVertexColor"]},createObjectDataRequest:function(a,b){return new Xflow.ComputeRequest(a,["position","color","normal","diffuseColor","useVertexColor"],b)},distributeObjectShaderData:function(a,b,c){var a=a.getResult().getOutputMap(),g=this.getRequestFields(),
h;for(h in a)-1!=g.indexOf(h)?c(h,a[h]):b(h,a[h])}});c.AbstractShaderComposer=b;c.DefaultComposer=a})(XML3D.webgl);
(function(c){var b=function(){this.uniforms={};this.samplers={};this.attributes={};this.vertex=this.fragment=this.name=""};b.prototype.addDirectives=function(){};b.prototype.hasTransparency=function(){return!1};c.ShaderDescriptor=b;var a=function(a,b){c.AbstractShaderComposer.call(this,a,b);this.descriptor=null;this.setShaderInfo(b)};XML3D.createClass(a,c.AbstractShaderComposer,{setShaderInfo:function(a){this.setShaderScript(a.getScriptUri());this.descriptor&&(this.updateRequest(a.getData()),this.descriptor.fragment=
XML3D.webgl.addFragmentShaderHeader(this.descriptor.fragment))},setShaderScript:function(a){if(a)if("urn"!=a.scheme)XML3D.debug.logError("Shader script reference should start with an URN: ",this.adapter.node);else{var c;c=a.path;c=c.substring(c.lastIndexOf(":")+1);(c=XML3D.shaders.getScript(c))?(this.descriptor=new b,XML3D.extend(this.descriptor,c)):XML3D.debug.logError("No Shader registered for urn:",a)}else XML3D.debug.logError("Shader has no script attached: ",this.adapter.node)},getRequestFields:function(){return Object.keys(this.descriptor.uniforms).concat(Object.keys(this.descriptor.samplers))},
getShaderAttributes:function(){return this.descriptor.attributes},createShaderClosure:function(){return new c.ShaderClosure(this.context,this.descriptor)},createObjectDataRequest:function(a,b){var c=["position"];c.push.apply(c,Object.keys(this.descriptor.attributes));c.push.apply(c,Object.keys(this.descriptor.uniforms));c.push.apply(c,Object.keys(this.descriptor.samplers));return new Xflow.ComputeRequest(a,c,b)},distributeObjectShaderData:function(a,b,c){var a=a.getResult().getOutputMap(),g;for(g in a)"position"==
g||void 0!==this.descriptor.attributes[g]?b(g,a[g]):(void 0!==this.descriptor.uniforms[g]||void 0!==this.descriptor.samplers[g])&&c(g,a[g])}});c.URNShaderComposer=a})(XML3D.webgl);
(function(c){var b=function(a,b){c.AbstractShaderComposer.call(this,a,b);if(!window.Shade)throw Error("Shade.js not found");this.context=a;this.sourceTemplate=this.shaderURL=null;this.extractedParams=[];this.request=null;this.setShaderInfo(b)};b.convertEnvName=function(a){return("_env_"+a).replace(/_+/g,"_")};b.convertSysName=function(a){return a};XML3D.createClass(b,c.AbstractShaderComposer,{setShaderInfo:function(a){this.sourceTemplate=a.getScriptCode();try{this.extractedParams=Shade.extractParameters(this.sourceTemplate,
{implementation:"xml3d-glsl-forward"}).shaderParameters}catch(b){this.extractedParams=[]}-1==this.extractedParams.indexOf("position")&&this.extractedParams.push("position");this.extractedParams.length&&this.updateRequest(a.getData())},getRequestFields:function(){return this.extractedParams},getShaderAttributes:function(){return{color:null,normal:null,texcoord:null}},createShaderClosure:function(){return new c.JSShaderClosure(this.context,this.sourceTemplate,this.extractedParams)},createObjectDataRequest:function(a){for(var c=
new Xflow.VSConfig,d=this.extractedParams.slice(),e=0;e<d.length;++e){var g=d[e],h=a.getOutputChannelInfo(g);h&&c.addAttribute(h.type,g,b.convertEnvName(g),!0,"position"==g?Xflow.VS_ATTRIB_TRANSFORM.VIEW_POINT:"normal"==g?Xflow.VS_ATTRIB_TRANSFORM.VIEW_NORMAL:Xflow.VS_ATTRIB_TRANSFORM.NONE)}return new Xflow.VertexShaderRequest(a,c)},distributeObjectShaderData:function(a,b,c){for(var a=a.getResult(),e=a.shaderInputNames,g=0;g<e.length;++g){var h=e[g],i=a.getShaderInputData(h);a.isShaderInputUniform(h)?
c(h,i):b(h,i)}b=a.shaderOutputNames;for(g=0;g<b.length;++g)h=b[g],a.isShaderOutputUniform(h)&&c(a.getShaderOutputSourceName(h),a.getUniformOutputData(h))}});c.JSShaderComposer=b})(XML3D.webgl);
(function(c){var b={"text/shade-javascript":c.JSShaderComposer},a=function(a){this.context=a;this.composers={};this.defaultComposer=new c.DefaultComposer(a)};a.EVENT_TYPE={MATERIAL_STRUCTURE_CHANGED:"material_structure_changed"};XML3D.extend(a.prototype,{createComposerForShaderInfo:function(a){if(!a)return this.defaultComposer;var d=this.composers[a.id];if(!d){if("urn"==a.getScriptUri().scheme)d=new c.URNShaderComposer(this.context,a);else{if(!a.getScriptType())return this.defaultComposer;try{d=new (b[a.getScriptType()])(this.context,
a)}catch(e){return XML3D.debug.logError("No shader found for : "+a.getScriptType()),this.defaultComposer}}d&&(this.composers[a.id]=d,this.context.getStatistics().materials++);return d||this.defaultComposer}return d},getDefaultComposer:function(){return this.defaultComposer},getTemplateById:function(a){return this.composers[a]},update:function(a){for(var b in this.composers)this.composers[b].update(a,{updateLightValues:this.lightValuesDirty});this.lightValuesDirty=!1},setLightStructureDirty:function(){XML3D.debug.logWarning("Light structure changes not yet supported.");
for(var a in this.composers)this.composers[a].setShaderRecompile()},setLightValueChanged:function(){for(var a in this.composers)this.composers[a].updateLightValues=!0}});c.ShaderComposerFactory=a})(XML3D.webgl);
(function(c){var b=null,a={type:"object",kind:"any",info:{coords:{type:"object",kind:"float3",source:"uniform"},viewMatrix:{type:"object",kind:"matrix4",source:"uniform"},MAX_POINTLIGHTS:{type:"int",source:"constant",staticValue:5},pointLightOn:{type:"array",elements:{type:"boolean"},staticSize:5,source:"uniform"},pointLightAttenuation:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,source:"uniform"},pointLightIntensity:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,
source:"uniform"},pointLightPosition:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,source:"uniform"},MAX_DIRECTIONALLIGHTS:{type:"int",source:"constant",staticValue:5},directionalLightOn:{type:"array",elements:{type:"boolean"},staticSize:5,source:"uniform"},directionalLightIntensity:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,source:"uniform"},directionalLightDirection:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,source:"uniform"},MAX_SPOTLIGHTS:{type:"int",
source:"constant",staticValue:5},spotLightOn:{type:"array",elements:{type:"boolean"},staticSize:5,source:"uniform"},spotLightAttenuation:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,source:"uniform"},spotLightIntensity:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,source:"uniform"},spotLightPosition:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,source:"uniform"},spotLightDirection:{type:"array",elements:{type:"object",kind:"float3"},staticSize:5,
source:"uniform"},spotLightCosFalloffAngle:{type:"array",elements:{type:"number"},staticSize:5,source:"uniform"},spotLightCosSoftFalloffAngle:{type:"array",elements:{type:"number"},staticSize:5,source:"uniform"}}};c.getJSSystemConfiguration=function(f){b||(f.getExtensionByName(c.GLContext.EXTENSIONS.STANDARD_DERIVATES)&&(a.info.fwidth={type:Shade.TYPES.FUNCTION},a.info.dFdx={type:Shade.TYPES.FUNCTION},a.info.dFdy={type:Shade.TYPES.FUNCTION}),b=a);return b}})(XML3D.webgl);
(function(c){var b=function(a){this.program=null;this.context=a;this.obsolete=!1;this.id="";this.uniformCollection={envBase:{},envOverride:null,sysBase:null};this.isTransparent=!1;this.source={vertex:"",fragment:""}};Object.defineProperties(b.prototype,{attributes:{writeable:!1,get:function(){return this.program?this.program.attributes:{}}},uniforms:{writeable:!1,get:function(){return this.program?this.program.uniforms:{}}},samplers:{writeable:!1,get:function(){return this.program?this.program.samplers:
{}}}});XML3D.createClass(b,null,{equals:function(a){return this.source.vertex===a.source.vertex&&this.source.fragment===a.source.fragment},hasTransparency:function(){return this.isTransparent},compile:function(){if(!this.source.fragment||!this.source.vertex)XML3D.debug.logError("No source found for shader",this);else{var a=new XML3D.webgl.GLProgramObject(this.context.gl,this.source);this.program=a;this.id=a.id}},bind:function(){this.program.bind()},unbind:function(){this.program.unbind()},isValid:function(){return this.program.isValid()},
updateUniformsFromComputeResult:function(a){var a=a.getOutputMap(),b=this.uniformCollection.envBase={};this.setDefaultUniforms(this.uniformCollection.envBase);for(var d in a){var e=c.getGLUniformValueFromXflowDataEntry(a[d],this.context);b[d]=e}this.setUniformVariables(Object.keys(b),null,this.uniformCollection);this.isTransparent=this.getTransparencyFromInputData(a)},setUniformVariables:function(a,b,c){this.program.setUniformVariables(a,b,c)},setSystemUniformVariables:function(a,b){this.uniformCollection.sysBase=
b;this.setUniformVariables(null,a,this.uniformCollection)},changeUniformVariableOverride:function(a,b){var c=a?Object.keys(a):[];b&&c.push.apply(c,Object.keys(b));this.uniformCollection.envOverride=b;this.setUniformVariables(c,null,this.uniformCollection)}});c.AbstractShaderClosure=b})(XML3D.webgl);
(function(c){var b=function(a,b){c.AbstractShaderClosure.call(this,a);this.descriptor=b};XML3D.createClass(b,c.AbstractShaderClosure);XML3D.extend(b.prototype,{setDefaultUniforms:function(a){XML3D.extend(a,this.descriptor.uniforms)},createSources:function(a,b,d){var e=[],g={};b&&XML3D.extend(g,b.getOutputMap());d&&XML3D.extend(g,d.getOutputMap());for(var h in this.descriptor.attributes)if((b=this.descriptor.attributes[h])&&b.required&&!g[h])throw Error("Mesh is missing '"+h+"' attribute.");this.descriptor.addDirectives(e,
a.lights||{},g);this.source={fragment:this.addDirectivesToSource(e,this.descriptor.fragment),vertex:this.addDirectivesToSource(e,this.descriptor.vertex)};c.SystemNotifier.sendEvent("urnshader",{urnshaderType:"code",vertexShader:this.source.vertex,fragmentShader:this.source.fragment});return!0},addDirectivesToSource:function(a,b){var c="";a.forEach(function(a){c+="#define "+a+"\n"});return c+"\n"+b},getTransparencyFromInputData:function(a){return this.descriptor.hasTransparency(a)}});c.ShaderClosure=
b})(XML3D.webgl);
(function(c){var b={pointLightOn:{staticValue:"MAX_POINTLIGHTS",staticSize:["pointLightOn","pointLightAttenuation","pointLightIntensity","pointLightPosition"]},directionalLightOn:{staticValue:"MAX_DIRECTIONALLIGHTS",staticSize:["directionalLightOn","directionalLightIntensity","directionalLightDirection"]},spotLightOn:{staticValue:"MAX_SPOTLIGHTS",staticSize:"spotLightOn,spotLightAttenuation,spotLightIntensity,spotLightPosition,spotLightDirection,spotLightCosFalloffAngle,spotLightCosSoftFalloffAngle".split(",")}},a=
function(a,b){var c={};switch(a){case Xflow.DATA_TYPE.BOOL:c.type=Shade.TYPES.BOOLEAN;break;case Xflow.DATA_TYPE.INT:c.type=Shade.TYPES.INT;break;case Xflow.DATA_TYPE.FLOAT:c.type=Shade.TYPES.NUMBER;break;case Xflow.DATA_TYPE.FLOAT2:c.type=Shade.TYPES.OBJECT;c.kind=Shade.OBJECT_KINDS.FLOAT2;break;case Xflow.DATA_TYPE.FLOAT3:c.type=Shade.TYPES.OBJECT;c.kind=Shade.OBJECT_KINDS.FLOAT3;break;case Xflow.DATA_TYPE.FLOAT4:c.type=Shade.TYPES.OBJECT;c.kind=Shade.OBJECT_KINDS.FLOAT4;break;case Xflow.DATA_TYPE.TEXTURE:c.type=
Shade.TYPES.OBJECT;c.kind=Shade.OBJECT_KINDS.TEXTURE;break;default:throw Error("Unknown Xflow DataType: "+a);}c.source=b;return c},f=function(a,b,f){c.AbstractShaderClosure.call(this,a);this.sourceTemplate=b;this.extractedParams=f;this.uniformSetter=function(){};this.uniformConverter=[]};XML3D.createClass(f,c.AbstractShaderClosure,{createSources:function(d,e,f){var h={"this":c.getJSSystemConfiguration(this.context),"global.shade":[{extra:{type:"object",kind:"any",global:!0,info:{}}}]},i=d.systemUniforms,
j=h["this"].info,k;for(k in b){var l=b[k],m=i[k]&&i[k].length;j[l.staticValue].staticValue=m;for(d=0;d<l.staticSize.length;++d)j[l.staticSize[d]].staticSize=m}k=h["global.shade"][0].extra.info;e=e&&e.getOutputMap();i=f&&f.shaderOutputNames;for(d=0;d<this.extractedParams.length;++d)j=this.extractedParams[d],l=c.JSShaderComposer.convertEnvName(j),i&&-1!=i.indexOf(l)?k[j]=a(f.getShaderOutputType(l),f.isShaderOutputUniform(l)?Shade.SOURCES.UNIFORM:Shade.SOURCES.VERTEX):e&&e[j]&&(k[j]=a(e[j].type,Shade.SOURCES.UNIFORM));
XML3D.debug.logDebug("CONTEXT:",h);try{var r=Shade.parseAndInferenceExpression(this.sourceTemplate,{inject:h,loc:!0,implementation:"xml3d-glsl-forward"}),p=Shade.compileFragmentShader(r,{useStatic:!0});this.uniformSetter=p.uniformSetter;this.source={fragment:p.source,vertex:f.getGLSLCode()}}catch(q){throw c.SystemNotifier.sendEvent("shadejs",{shadejsType:"error",event:q,code:this.sourceTemplate}),f="Shade.js Compile Error:\n"+q.message+"\n------------\nShader Source:\n------------\n"+XML3D.debug.formatSourceCode(this.sourceTemplate),
Error(f);}XML3D.debug.logDebug(this.source.vertex);XML3D.debug.logDebug(this.source.fragment);c.SystemNotifier.sendEvent("shadejs",{shadejsType:"success",vertexShader:this.source.vertex,fragmentShader:this.source.fragment});return!0},setUniformVariables:function(a,b,c){this.uniformSetter(a,b,c,this.program.setUniformVariable.bind(this.program))},getTransparencyFromInputData:function(){return!1},setDefaultUniforms:function(){}});c.JSShaderClosure=f})(XML3D.webgl);
(function(c){var b=function(a,b){this.context=a;this._type=b;this._valid=!1};b.TYPES={MESH:"mesh",VOLUME:"volume"};b.READY_STATE={COMPLETE:"complete",INCOMPLETE:"incomplete"};XML3D.createClass(b,XML3D.util.EventDispatcher,{getType:function(){return this._type},isValid:function(){return this._valid},setShaderComposer:function(){},update:function(){}});c.DrawableClosure=b})(XML3D.webgl);
(function(c){var b=c.DrawableClosure.READY_STATE,a={};a[WebGLRenderingContext.TRIANGLES]={attributeData:{position:Xflow.DATA_TYPE.FLOAT3},typeData:{index:Xflow.DATA_TYPE.INT,solid:Xflow.DATA_TYPE.BOOL,vertexCount:Xflow.DATA_TYPE.INT},bboxFix:{boundingBox:Xflow.DATA_TYPE.FLOAT3},bboxCompute:{position:Xflow.DATA_TYPE.FLOAT3}};a[WebGLRenderingContext.LINE_STRIP]=a[WebGLRenderingContext.TRIANGLES];a[WebGLRenderingContext.LINES]=a[WebGLRenderingContext.TRIANGLES];a[WebGLRenderingContext.POINTS]=a[WebGLRenderingContext.TRIANGLES];
var f=function(a,b,f,h){c.DrawableClosure.call(this,a,c.DrawableClosure.TYPES.MESH);h=h||{};this.mesh=new c.GLMesh(a,b);this.dataNode=f;this.typeRequest=this.shaderClosure=this.shaderComposer=null;this.typeDataValid=!0;this.objectShaderRequest=null;this.changeState=void 0;this.boundingBoxChanged=h.boundingBoxChanged||function(){};this.initialize()};XML3D.createClass(f,c.DrawableClosure,{initialize:function(){this.typeDataChanged(this.typeRequest,Xflow.RESULT_STATE.CHANGED_STRUCTURE);this.shaderChanged()},
setShaderComposer:function(a){this.bindedShaderChanged||(this.bindedShaderChanged=this.shaderChanged.bind(this));this.shaderComposer&&this.shaderComposer.removeEventListener(c.ShaderComposerFactory.EVENT_TYPE.MATERIAL_STRUCTURE_CHANGED,this.bindedShaderChanged);(this.shaderComposer=a)&&this.shaderComposer.addEventListener(c.ShaderComposerFactory.EVENT_TYPE.MATERIAL_STRUCTURE_CHANGED,this.bindedShaderChanged);this.changeState|=32},update:function(a){if(0!==this.changeState){XML3D.debug.logDebug("Update mesh closure",
this.changeState);var e=!!this.shaderClosure&&this.typeDataValid,f=null,h=!1;try{if(this.changeState&33&&this.mesh.clear(),this.changeState&3&&this.updateTypeData(),h=!0,this.changeState&35&&this.updateIndexBuffer(),this.changeState&33?(this.updateObjectShaderRequest(),this.updateShaderClosure(a),this.updateObjectShaderData()):this.changeState&5&&this.updateObjectShaderData(),this.dataNode.isSubtreeLoading())this.shaderClosure=null,this.typeDataValid=!1}catch(i){f=i,h?this.shaderClosure=null:this.typeDataValid=
!1}a=!!this.shaderClosure&&this.typeDataValid;e!=a&&this.dispatchEvent({type:c.Scene.EVENT_TYPE.DRAWABLE_STATE_CHANGED,newState:a?b.COMPLETE:b.INCOMPLETE,oldState:e?b.COMPLETE:b.INCOMPLETE});this.changeState=0;if(f)throw f;}},calculateBoundingBox:function(){var a=XML3D.math.bbox.create();return function(){var b=this.typeRequest.getResult(),c=b.getOutputData("boundingBox");c?this.boundingBoxChanged(XML3D.webgl.calculateBoundingBox(c.getValue(),null)):(c=b.getOutputData("position"))?(b=b.getOutputData("index"),
this.boundingBoxChanged(XML3D.webgl.calculateBoundingBox(c.getValue(),b?b.getValue():null))):this.boundingBoxChanged(a)}}(),typeDataChanged:function(a,b){this.changeState|=b==Xflow.RESULT_STATE.CHANGED_STRUCTURE?1:2;this.context.requestRedraw("Mesh Type Data Change");XML3D.debug.logInfo("MeshClosure: Type data changed",a,b,this.changeState)},getMesh:function(){return this.mesh},getMeshType:function(){return this.mesh.glType},updateObjectShaderRequest:function(){this.objectShaderRequest&&this.objectShaderRequest.clear();
this.objectShaderRequest=null;this.dataNode.isSubtreeLoading()||(this.objectShaderRequest=this.shaderComposer.createObjectDataRequest(this.dataNode,this.shaderInputDataChanged.bind(this)))},updateShaderClosure:function(a){this.shaderClosure=null;if(!this.dataNode.isSubtreeLoading()&&!this.dataNode.getOutputChannelInfo("position"))throw Error("Mesh does not have 'position' attribute.");this.dataNode.isSubtreeLoading()||(this.shaderClosure=this.shaderComposer.getShaderClosure(a,this.objectShaderRequest.getResult()))},
updateIndexBuffer:function(){var a=this.typeRequest.getResult().getOutputData("index");a&&a.getValue()&&this.handleBuffer("index",a,!0)},updateObjectShaderData:function(){if(this.shaderClosure&&(this.bindedHandleBuffer||(this.bindedHandleBuffer=this.handleBuffer.bind(this)),this.bindedHandleUniform||(this.bindedHandleUniform=this.handleUniform.bind(this)),this.shaderComposer.distributeObjectShaderData(this.objectShaderRequest,this.bindedHandleBuffer,this.bindedHandleUniform),!this.mesh.isReadyToRender()))throw Error("Mesh has empty vertex attributes.");
},updateTypeData:function(){if(this.typeDataValid||this.changeState&1){this.updateTypeRequest();this.calculateBoundingBox();var a=this.typeRequest.getResult().getOutputData("vertexCount");this.mesh.setVertexCount(a&&a.getValue()?a.getValue()[0]:null);this.typeDataValid=!0}},handleBuffer:function(a,b,f){var f=f||!1,h=this.mesh;if("position"==a&&!b)throw Error("'position' attribute of mesh is empty.");if(b)if(b.type==Xflow.DATA_TYPE.TEXTURE)XML3D.debug.logError("Texture as mesh parameter is not yet supported");
else{var i=c.getGLBufferFromXflowDataEntry(b,this.context,"index"==a);f?this.updateIndexRange(b):this.mesh.checkBufferCompatible(a,b);h.setBuffer(a,i)}else this.mesh.removeBuffer(a)},updateIndexRange:function(a){a=XML3D.webgl.getXflowEntryWebGlData(a,this.context.id);this.mesh.setIndexRange(a.minIndex,a.maxIndex)},checkBufferSize:function(a,b){if(b.getIterateCount){var c=b.getIterateCount();if(c>=this.mesh.maxIndex)throw Error("Index range of ["+this.mesh.minIndex+", "+this.mesh.maxIndex+"]  goes beyond element count "+
c+" of attribute '"+a+"'");}},handleUniform:function(a,b){var f=c.getGLUniformValueFromXflowDataEntry(b,this.context);this.mesh.setUniformOverride(a,f)},updateTypeRequest:function(){var b=a[this.getMeshType()];if(b){if(b=this.getTypeRequestNames(b),!this.typeRequest||this.typeRequest.filter!=b)this.typeRequest&&this.typeRequest.clear(),this.typeRequest=new Xflow.ComputeRequest(this.dataNode,b,this.typeDataChanged.bind(this))}else XML3D.debug.logError("Unsupported Mesh request: ",this.mesh,this.getMeshType()),
this.typeDataValid=!1},getTypeRequestNames:function(a){var b=[];b.push.apply(b,Object.keys(a.typeData));b.push.apply(b,Object.keys(a.bboxFix));this.checkXflowTypes(this.dataNode,a.bboxFix)||(this.checkXflowTypes(this.dataNode,a.bboxCompute)||(this.typeDataValid=!1),b.push.apply(b,Object.keys(a.bboxCompute)));return b},checkXflowTypes:function(a,b){for(var c in b){var f=a.getOutputChannelInfo(c);if(!f||f.type!=b[c])return!1}return!0},shaderInputDataChanged:function(a,b){this.changeState|=b!=Xflow.RESULT_STATE.CHANGED_DATA_VALUE?
1:4;this.context.requestRedraw("Mesh Attribute Data Changed");XML3D.debug.logInfo("MeshClosure: Attribute data changed",a,b,this.changeState)},shaderChanged:function(){this.changeState|=32},getProgram:function(){return this.shaderClosure}});c.MeshClosure=f})(XML3D.webgl);(function(c){c.renderers=[];c.rendererFactory=new function(){this.createRenderer=function(b,a,f){return new c.GLRenderer(b,a,f)}}})(XML3D.webgl);
(function(){XML3D.webgl.RenderAdapter=function(c,b){XML3D.base.NodeAdapter.call(this,c,b)};XML3D.createClass(XML3D.webgl.RenderAdapter,XML3D.base.NodeAdapter);XML3D.webgl.RenderAdapter.prototype.getShader=function(){return null};XML3D.webgl.RenderAdapter.prototype.getParentRenderAdapter=function(){return this.factory.getAdapter(this.node.parentElement,XML3D.webgl.RenderAdapter)};XML3D.webgl.RenderAdapter.prototype.initElement=function(c){this.factory.getAdapter(c);this.initChildElements(c)};XML3D.webgl.RenderAdapter.prototype.initChildElements=
function(){this.traverse(this.factory.getAdapter)};XML3D.webgl.RenderAdapter.prototype.applyTransformMatrix=function(c){return c};XML3D.webgl.RenderAdapter.prototype.getScene=function(){return this.factory.renderer.scene};XML3D.webgl.RenderAdapter.prototype.initializeEventAttributes=function(c){var b=this.node.attributes,c=c||[],a;for(a in b){var f=b[a];if(f.name){var d=f.name;"on"==d.substring(2,0)&&(d=d.substring(2),(-1!=XML3D.webgl.events.available.indexOf(d)||-1!=c.indexOf(d))&&this.node.addEventListener(d,
new Function("event",f.value),!1))}}}})();(function(c){var b=function(a,b){c.RenderAdapter.call(this,a,b);this.renderNode=null};XML3D.createClass(b,c.RenderAdapter);XML3D.extend(b.prototype,{onConfigured:function(){},getRenderNode:function(){this.renderNode||(this.renderNode=this.createRenderNode?this.createRenderNode():null);return this.renderNode}});c.TransformableAdapter=b})(XML3D.webgl);
(function(){XML3D.webgl.DefsRenderAdapter=function(c,b){XML3D.webgl.RenderAdapter.call(this,c,b)};XML3D.createClass(XML3D.webgl.DefsRenderAdapter,XML3D.webgl.RenderAdapter)})();
(function(){var c=function(b,a){XML3D.webgl.RenderAdapter.call(this,b,a);this.initializeEventAttributes(["load"])};XML3D.createClass(c,XML3D.webgl.RenderAdapter);XML3D.extend(c.prototype,{updateActiveViewAdapter:function(){var b=this.node.getAttribute("activeView");b?this.connectAdapterHandle("activeView",this.getAdapterHandle(b)):this.disconnectAdapterHandle("activeView")},setViewAdapter:function(b){b=b||this.getConnectedAdapter("activeView");if(!b||!b.getRenderNode)b=this.factory.getAdapter(XML3D.util.getOrCreateActiveView(this.node));
this.factory.getScene().setActiveView(b.getRenderNode())},dispose:function(){this.clearAdapterHandles()}});c.prototype.notifyChanged=function(b){switch(b.type){case XML3D.events.ADAPTER_HANDLE_CHANGED:this.setViewAdapter(b.adapter);return;case XML3D.events.NODE_INSERTED:this.initElement(b.wrapped.target);this.initChildElements(b.wrapped.target);return;case XML3D.events.NODE_REMOVED:return}if("activeView"==(b.internalType||b.attrName||b.wrapped.attrName))this.updateActiveViewAdapter(),this.setViewAdapter()};
c.prototype.onConfigured=function(){this.updateActiveViewAdapter();this.setViewAdapter();var b=function(a){var b=2;return function(){b--;0==b&&XML3D.util.dispatchEvent(a,"load")}}(this.node,this.factory.canvasId);XML3D.base.resourceManager.addLoadCompleteListener(0,b);XML3D.base.resourceManager.addLoadCompleteListener(this.factory.canvasId,b)};c.prototype.getBoundingBox=function(){var b=new window.XML3DBox;Array.prototype.forEach.call(this.node.childNodes,function(a){a.getBoundingBox&&b.extend(a.getBoundingBox())});
return b};c.prototype.getElementByPoint=function(b,a,c,d){var a=XML3D.webgl.convertPageCoords(this.node,b,a),b=a.x,a=a.y,e=this.factory.getRenderer(),g=e.getRenderObjectFromPickingBuffer(b,a);if(g){if(c){var h=e.getWorldSpacePositionByPoint(b,a,g);c.set(h[0],h[1],h[2])}d&&(h=e.getWorldSpaceNormalByPoint(b,a,g),d.set(h[0],h[1],h[2]))}else c&&c.set(NaN,NaN,NaN),d&&d.set(NaN,NaN,NaN);return g?g.node:null};c.prototype.generateRay=function(b,a){var c=XML3D.webgl.convertPageCoords(this.node,b,a);return this.factory.getRenderer().generateRay(c.x,
c.y)};XML3D.webgl.XML3DRenderAdapter=c})();
(function(){function c(a,b){a.requests[b]||(a.requests[b]=a.dataAdapter.getComputeRequest([b],function(b,c){a.dataChanged(b,c)}))}var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.needsUpdate=this.isValid=!0};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype,f=XML3D.math.mat4.identity(XML3D.math.mat4.create());a.init=function(){this.matrix=XML3D.math.mat4.create();this.transform={translate:XML3D.math.mat4.create(),scale:XML3D.math.mat4.create(),scaleOrientationInv:XML3D.math.mat4.create(),
center:XML3D.math.mat4.create(),centerInverse:XML3D.math.mat4.create()};this.needsUpdate=!0};a.updateMatrix=function(){var a=this.node,b=this.transform,c=a.translation._data,h=a.center._data,i=a.scale._data,j=a.scaleOrientation.toMatrix()._data,a=a.rotation.toMatrix()._data;XML3D.math.mat4.translate(b.translate,f,c);XML3D.math.mat4.translate(b.center,f,h);XML3D.math.mat4.translate(b.centerInverse,f,XML3D.math.vec3.negate(h,h));XML3D.math.mat4.scale(b.scale,f,i);XML3D.math.mat4.invert(b.scaleOrientationInv,
j);XML3D.math.mat4.multiply(this.matrix,b.translate,b.center);XML3D.math.mat4.multiply(this.matrix,this.matrix,a);XML3D.math.mat4.multiply(this.matrix,this.matrix,j);XML3D.math.mat4.multiply(this.matrix,this.matrix,b.scale);XML3D.math.mat4.multiply(this.matrix,this.matrix,b.scaleOrientationInv);XML3D.math.mat4.multiply(this.matrix,this.matrix,b.centerInverse);this.needsUpdate=!1};a.getMatrix=function(){this.needsUpdate&&this.updateMatrix();return this.matrix};a.notifyChanged=function(a){1==a.type?
this.needsUpdate=!0:2==a.type&&this.dispose();this.notifyOppositeAdapters()};a.dispose=function(){this.isValid=!1};XML3D.webgl.TransformRenderAdapter=b;b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b)};XML3D.createClass(b,XML3D.webgl.RenderAdapter);a=b.prototype;a.init=function(){this.dataAdapter=XML3D.base.resourceManager.getAdapter(this.node,XML3D.data);this.matrixReady={};this.matrices={};this.requests={}};a.updateMatrix=function(a){c(this,a);this.matrices[a]=XML3D.math.mat4.create();var b=
this.requests[a].getResult();if(b=b.getOutputData(a)&&b.getOutputData(a).getValue()){for(var f=0;16>f;++f)this.matrices[a][f]=b[f];this.matrixReady[a]=!0}else XML3D.math.mat4.identity(this.matrices[a])};a.getMatrix=function(a){!this.matrixReady[a]&&this.updateMatrix(a);return this.matrices[a]};a.dataChanged=function(a){for(var b in this.requests)this.requests[b]==a&&delete this.matrixReady[b];this.notifyOppositeAdapters()};XML3D.webgl.DataRenderAdapter=b})();
(function(){function c(a){var b=a.node.getAttribute("perspective");b?a.connectAdapterHandle("perspective",a.getAdapterHandle(b)):a.disconnectAdapterHandle("perspective")}var b=function(a,b){XML3D.webgl.TransformableAdapter.call(this,a,b);c(this);this.createRenderNode()};XML3D.createClass(b,XML3D.webgl.TransformableAdapter);var a=b.prototype;a.createRenderNode=function(){var a=this.factory.getAdapter(this.node.parentElement,XML3D.webgl.RenderAdapter),a=a.getRenderNode?a.getRenderNode():this.factory.renderer.scene.createRootNode();
this.renderNode=this.factory.renderer.scene.createRenderView({position:this.node.position._data,orientation:this.node.orientation.toMatrix()._data,fieldOfView:this.node.fieldOfView,parent:a,projectionAdapter:this.getConnectedAdapter("perspective")})};a.getViewMatrix=function(){var a=new window.XML3DMatrix;this.renderNode.getWorldToViewMatrix(a._data);return a};a.getWorldMatrix=function(){var a=new window.XML3DMatrix;this.renderNode.getViewToWorldMatrix(a._data);return a};a.notifyChanged=function(a){switch(a.type){case XML3D.events.THIS_REMOVED:this.dispose();
break;case XML3D.events.VALUE_MODIFIED:var b=a.wrapped.attrName;switch(b){case "orientation":this.renderNode.updateOrientation(this.node.orientation.toMatrix()._data);break;case "position":this.renderNode.updatePosition(this.node.position._data);break;case "fieldOfView":this.renderNode.updateFieldOfView(this.node.fieldOfView);break;default:XML3D.debug.logWarning("Unhandled value changed event in view adapter for attribute:"+b)}break;case XML3D.events.ADAPTER_HANDLE_CHANGED:switch(a.key){case "perspective":c(this);
this.renderNode.setProjectionAdapter(this.getConnectedAdapter("perspective"));break;default:XML3D.debug.logWarning("Unhandled adapter handle changed event in view adapter for parameter "+b)}}this.factory.getRenderer().requestRedraw("View changed")};a.dispose=function(){this.getRenderNode().remove();this.clearAdapterHandles()};XML3D.webgl.ViewRenderAdapter=b})();
(function(c){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.dataAdapter=XML3D.base.resourceManager.getAdapter(this.node,XML3D.data);this.shaderInfo=this.createShaderInfo();this.templateId=this.shaderInfo.id;this.updateScript()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);XML3D.extend(b.prototype,{createShaderInfo:function(){return this.getScene().createShaderInfo({data:this.getDataAdapter().getXflowNode()})},updateScript:function(){var a=this.getShaderScriptURI();"urn"!=a.scheme?
this.connectAdapterHandle("script",this.getAdapterHandle(a,XML3D.data,0)):this.disconnectAdapterHandle("script");this.updateShaderInfoDetails()},updateShaderInfoDetails:function(){var a=null,b=null,c=this.getConnectedAdapter("script");c&&c.getScriptType&&(a=c.getScriptType(),b=c.getScriptCode());this.shaderInfo.setScript(this.getShaderScriptURI(),a,b)},getShaderInfo:function(){return this.shaderInfo},getShaderScriptURI:function(){return new XML3D.URI(this.node.getAttribute("script"))},getDataAdapter:function(){return this.dataAdapter},
notifyChanged:function(a){switch(a.type){case XML3D.events.VALUE_MODIFIED:a=a.internalType||a.attrName||a.wrapped.attrName;switch(a){case "script":this.updateScript();break;default:XML3D.debug.logWarning("Unhandled mutation event in shader adapter for parameter '"+a+"'")}break;case XML3D.events.ADAPTER_HANDLE_CHANGED:a.handleStatus==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logError("Could not find script of url '"+a.url+"'"),this.updateShaderInfoDetails()}}});c.ShaderRenderAdapter=b})(XML3D.webgl);
(function(){XML3D.webgl.ImgRenderAdapter=function(c,b){XML3D.webgl.RenderAdapter.call(this,c,b);this.textureAdapter=c.getAdapter(b.parentNode)};XML3D.createClass(XML3D.webgl.ImgRenderAdapter,XML3D.webgl.RenderAdapter);XML3D.webgl.ImgRenderAdapter.prototype.notifyChanged=function(c){this.textureAdapter.notifyChanged(c)}})();
(function(){var c=function(b,a){XML3D.webgl.RenderAdapter.call(this,b,a);this.dataAdapter=XML3D.base.resourceManager.getAdapter(this.node,XML3D.data)};XML3D.createClass(c,XML3D.webgl.RenderAdapter);c.prototype.notifyChanged=function(b){var a=this.factory.getAdapter(this.node.parentElement);a&&a.notifyChanged(b)};c.prototype.getDataTable=function(){return this.dataAdapter.createDataTable()};c.prototype.destroy=function(){};c.prototype.dispose=function(){};XML3D.webgl.TextureRenderAdapter=c})();
XML3D.webgl.MAX_MESH_INDEX_COUNT=65535;
(function(c){var b=function(a,b){c.TransformableAdapter.call(this,a,b);this.initializeEventAttributes();this.createRenderNode()};XML3D.createClass(b,c.TransformableAdapter,{createRenderNode:function(){var a=XML3D.base.resourceManager.getAdapter(this.node,XML3D.data),b=this.getParentRenderAdapter(),b=b.getRenderNode&&b.getRenderNode();this.renderNode=this.getScene().createRenderObject({parent:b,node:this.node,object:{data:a.getXflowNode(),type:this.getMeshType()},name:this.node.id,visible:!this.node.visible?
!1:void 0});this.renderNode.setObjectSpaceBoundingBox(XML3D.math.bbox.create())},getMeshType:function(){return this.node.hasAttribute("type")?this.node.getAttribute("type"):"triangles"},notifyChanged:function(a){switch(a.type){case XML3D.events.ADAPTER_HANDLE_CHANGED:"shader"==a.key&&(this.updateShader(a.adapter),a.handleStatus==XML3D.base.AdapterHandle.STATUS.NOT_FOUND&&XML3D.debug.logWarning("Missing shader with id '"+a.url+"', falling back to default shader."));break;case XML3D.events.THIS_REMOVED:this.dispose();
break;case XML3D.events.VALUE_MODIFIED:this.valueChanged(a.wrapped)}},valueChanged:function(a){var b=a.attrName;switch(b){case "visible":this.renderNode.setLocalVisible("true"===a.newValue);break;case "src":break;case "type":this.renderNode.setType(a.newValue);break;default:XML3D.debug.logWarning("Unhandled mutation event in mesh adapter for parameter '"+b+"'",a)}},dispose:function(){this.getRenderNode().remove();this.clearAdapterHandles()}});XML3D.extend(b.prototype,{getBoundingBox:function(){if(this.renderNode){var a=
new XML3D.math.bbox.create;this.renderNode.getObjectSpaceBoundingBox(a);return XML3D.math.bbox.asXML3DBox(a)}return new window.XML3DBox},getWorldMatrix:function(){var a=new window.XML3DMatrix,b=this.renderNode;b&&b.getWorldMatrix(a._data);return a}});c.MeshRenderAdapter=b})(XML3D.webgl);
(function(){var c=function(a,b){XML3D.webgl.TransformableAdapter.call(this,a,b);this.initializeEventAttributes();this.factory=a;this.updateTransformAdapter();this.createRenderNode()};XML3D.createClass(c,XML3D.webgl.TransformableAdapter);var b=c.prototype;b.createRenderNode=function(){var a=this.getParentRenderAdapter(),a=a.getRenderNode&&a.getRenderNode();this.renderNode=this.getScene().createRenderGroup({parent:a,shaderHandle:this.getShaderHandle(),visible:this.node.visible,name:this.node.id});this.updateLocalMatrix();
this.renderNode.setWorldSpaceBoundingBox(XML3D.math.bbox.create())};b.updateLocalMatrix=function(){var a=XML3D.math.mat4.create();return function(){var b=a,c=XML3D.css.getCSSMatrix(this.node);c?b=XML3D.css.convertCssToMat4(c):(c=this.getConnectedAdapter("transform"))&&(b=c.getMatrix("transform"));this.renderNode.setLocalMatrix(b)}}();b.updateTransformAdapter=function(){this.connectAdapterHandle("transform",this.getAdapterHandle(this.node.transform))};b.notifyChanged=function(a){if(a.type!==XML3D.events.VALUE_MODIFIED)return this.handleConnectedAdapterEvent(a);
var b=a.attrName||a.wrapped.attrName;switch(b){case "shader":this.disconnectAdapterHandle("shader");this.renderNode.setLocalShaderHandle(this.getShaderHandle());this.factory.renderer.requestRedraw("Group shader changed.");break;case "transform":this.updateTransformAdapter();this.updateLocalMatrix();break;case "visible":this.renderNode.setLocalVisible("true"===a.wrapped.newValue);this.factory.renderer.requestRedraw("Group visibility changed.");break;default:XML3D.debug.logWarning("Unhandled mutation event in group adapter for parameter '"+
b+"'")}};b.handleConnectedAdapterEvent=function(a){switch(a.type){case XML3D.events.NODE_INSERTED:this.initElement(a.wrapped.target);this.initChildElements(a.wrapped.target);break;case XML3D.events.THIS_REMOVED:this.dispose();break;case XML3D.events.ADAPTER_HANDLE_CHANGED:"transform"===a.key?(this.updateTransformAdapter(),this.updateLocalMatrix()):"shader"===a.key&&this.renderNode.setLocalShaderHandle(this.getShaderHandle());break;default:XML3D.debug.logWarning("Unhandled connected adapter event for "+
a.key+" in shader adapter")}};b.getShaderHandle=function(){var a=this.node.shader;if(""==a){var b=this.node.getAttribute("style");b&&(b=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(b))&&(a=b[1])}if(a)return this.connectAdapterHandle("shader",this.getAdapterHandle(a)),this.getConnectedAdapterHandle("shader")};b.dispose=function(){this.traverse(function(a){a&&a.destroy&&a.dispose()});this.getRenderNode().remove();this.clearAdapterHandles()};b.getBoundingBox=function(){var a=XML3D.math.bbox.create();this.renderNode.getWorldSpaceBoundingBox(a);
return XML3D.math.bbox.asXML3DBox(a)};b.getLocalMatrix=function(){var a=new window.XML3DMatrix;this.renderNode.getLocalMatrix(a._data);return a};XML3D.math.mat4.create();b.getWorldMatrix=function(){var a=new window.XML3DMatrix;this.renderNode.getWorldMatrix(a._data);return a};XML3D.webgl.GroupRenderAdapter=c})();
(function(c){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.dataAdapter=XML3D.base.resourceManager.getAdapter(this.node,XML3D.data)};XML3D.createClass(b,c.RenderAdapter,{getDataNode:function(){return this.dataAdapter.getXflowNode()},getLightType:function(){var a=this.node.getAttribute("script");if(0===a.indexOf("urn:xml3d:lightshader:"))return a.substring(22,a.length);XML3D.debug.logError("Unsupported light type "+a);return null},notifyChanged:function(a){switch(a.type){case XML3D.events.THIS_REMOVED:this.notifyOppositeAdapters();
break;case XML3D.events.VALUE_MODIFIED:this.notifyOppositeAdapters(XML3D.events.ADAPTER_VALUE_CHANGED)}}});c.LightShaderRenderAdapter=b})(XML3D.webgl);
(function(c){var b=function(a,b){c.TransformableAdapter.call(this,a,b);this.updateLightShader();this.createRenderNode()};XML3D.createClass(b,c.TransformableAdapter);b.prototype.createRenderNode=function(){var a=this.getParentRenderAdapter(),a=a.getRenderNode&&a.getRenderNode(),b=this.getLightShader();this.renderNode=this.factory.getScene().createRenderLight({light:{type:b?b.getLightType():null,data:b?b.getDataNode():null},parent:a,shader:b,visible:!this.node.visible?!1:void 0,localIntensity:this.node.intensity})};
b.prototype.notifyChanged=function(a){switch(a.type){case XML3D.events.THIS_REMOVED:this.dispose();break;case XML3D.events.ADAPTER_HANDLE_CHANGED:if("shader"==a.key){this.renderNode.remove();break}break;case XML3D.events.VALUE_MODIFIED:this.valueModified(a.wrapped.attrName,a.wrapped.newValue);break;case XML3D.events.ADAPTER_VALUE_CHANGED:this.renderNode.setLightType(a.adapter.getLightType())}};b.prototype.valueModified=function(a,b){switch(a){case "visible":this.renderNode.setLocalVisible("true"===
b);break;case "intensity":this.renderNode.setLocalIntensity(b);break;case "shader":this.renderNode.remove(),this.updateLightShader(),this.createRenderNode()}};b.prototype.updateLightShader=function(){var a=this.node.shader;if(!a){var b=this.node.getAttribute("style");b&&(b=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(b))&&(a=b[1])}this.connectAdapterHandle("shader",this.getAdapterHandle(a))};b.prototype.getLightShader=function(){return this.getConnectedAdapter("shader")};b.prototype.dispose=function(){this.getRenderNode().remove();
this.clearAdapterHandles()};b.prototype.getWorldMatrix=function(){var a=new window.XML3DMatrix;this.renderNode.getWorldMatrix(a._data);return a};c.LightRenderAdapter=b})(XML3D.webgl);
(function(){var c=function(a){XML3D.base.NodeAdapterFactory.call(this,XML3D.webgl,a);this.type="RenderAdapterFactory"};XML3D.createClass(c,XML3D.base.NodeAdapterFactory);c.prototype.aspect=XML3D.webgl;XML3D.base.xml3dFormatHandler.registerFactoryClass(c);var b=XML3D.webgl,a={xml3d:b.XML3DRenderAdapter,view:b.ViewRenderAdapter,defs:b.DefsRenderAdapter,mesh:b.MeshRenderAdapter,data:b.DataRenderAdapter,transform:b.TransformRenderAdapter,shader:b.ShaderRenderAdapter,texture:b.TextureRenderAdapter,group:b.GroupRenderAdapter,
img:b.ImgRenderAdapter,light:b.LightRenderAdapter,lightshader:b.LightShaderRenderAdapter};c.prototype.createAdapter=function(b){var c=a[b.localName];return void 0!==c?new c(this,b):null};c.prototype.setScene=function(a){this.scene=a};c.prototype.getScene=function(){return this.scene};c.prototype.setRenderer=function(a){this.renderer=a};c.prototype.getRenderer=function(){return this.renderer};XML3D.webgl.RenderAdapterFactory=c})();
(function(){var c={},b={};c.register=function(a,c){b[a]=c;c.name=a};c.getScript=function(a){return b[a]};XML3D.shaders=c})();
XML3D.shaders.register("matte",{vertex:"attribute vec3 position;\nattribute vec3 color;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n   fragVertexColor = color;\n   gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"uniform vec3 diffuseColor;\nuniform bool useVertexColor;\nvarying vec3 fragVertexColor;\nvoid main(void) {\n    vec3 color = diffuseColor;\n    if (useVertexColor)\n       color *=  fragVertexColor;\n    gl_FragColor = vec4(diffuseColor, 1.0);\n}",uniforms:{diffuseColor:[1,
1,1],useVertexColor:!1},attributes:{color:null}});XML3D.shaders.register("flat",XML3D.shaders.getScript("matte"));
XML3D.shaders.register("diffuse",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nattribute vec2 texcoord;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = texcoord;\n    fragVertexColor = color;\n}",fragment:"uniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float transparency;\nuniform mat4 viewMatrix;\nuniform bool useVertexColor;\n#if HAS_EMISSIVETEXTURE\nuniform sampler2D emissiveTexture;\n#endif\n#if HAS_DIFFUSETEXTURE\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\n#if MAX_POINTLIGHTS > 0\nuniform vec3 pointLightAttenuation[MAX_POINTLIGHTS];\nuniform vec3 pointLightPosition[MAX_POINTLIGHTS];\nuniform vec3 pointLightIntensity[MAX_POINTLIGHTS];\nuniform bool pointLightOn[MAX_POINTLIGHTS];\n#endif\n#if MAX_DIRECTIONALLIGHTS > 0\nuniform vec3 directionalLightDirection[MAX_DIRECTIONALLIGHTS];\nuniform vec3 directionalLightIntensity[MAX_DIRECTIONALLIGHTS];\nuniform bool directionalLightOn[MAX_DIRECTIONALLIGHTS];\n#endif\n#if MAX_SPOTLIGHTS > 0\nuniform vec3 spotLightAttenuation[MAX_SPOTLIGHTS];\nuniform vec3 spotLightPosition[MAX_SPOTLIGHTS];\nuniform vec3 spotLightIntensity[MAX_SPOTLIGHTS];\nuniform bool spotLightOn[MAX_SPOTLIGHTS];\nuniform vec3 spotLightDirection[MAX_SPOTLIGHTS];\nuniform float spotLightCosFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightCosSoftFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightSoftness[MAX_SPOTLIGHTS];\n#endif\nvoid main(void) {\n  float alpha =  max(0.0, 1.0 - transparency);\n  vec3 objDiffuse = diffuseColor;\n  if(useVertexColor)\n    objDiffuse *= fragVertexColor;\n  #if HAS_DIFFUSETEXTURE\n    vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n    alpha *= texDiffuse.a;\n    objDiffuse *= texDiffuse.rgb;\n  #endif\n  if (alpha < 0.05) discard;\n  #if HAS_EMISSIVETEXTURE\n    vec3 color = emissiveColor * texture2D(emissiveTexture, fragTexCoord).rgb + (ambientIntensity * objDiffuse);\n  #else\n    vec3 color = emissiveColor + (ambientIntensity * objDiffuse);\n  #endif\n  #if MAX_POINTLIGHTS > 0\n    for (int i=0; i<MAX_POINTLIGHTS; i++) {\n      if (!pointLightOn[i])\n         continue;\n      vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\n      vec3 L = lPosition.xyz - fragVertexPosition;\n      float dist = length(L);\n      L = normalize(L);\n      float atten = 1.0 / (pointLightAttenuation[i].x + pointLightAttenuation[i].y * dist + pointLightAttenuation[i].z * dist * dist);\n      vec3 Idiff = pointLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n      color = color + atten*Idiff;\n    }\n  #endif\n#if MAX_DIRECTIONALLIGHTS > 0\n  for (int i=0; i<MAX_DIRECTIONALLIGHTS; i++) {\n      if (!directionalLightOn[i])\n         continue;\n    vec4 lDirection = viewMatrix * vec4(directionalLightDirection[i], 0.0);\n    vec3 L =  normalize(-lDirection.xyz);\n    vec3 Idiff = directionalLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    color = color + Idiff;\n  }\n#endif\n#if MAX_SPOTLIGHTS > 0\n  for (int i=0; i<MAX_SPOTLIGHTS; i++) {\n      if (!spotLightOn[i])\n         continue;\n    vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\n    vec3 L = lPosition.xyz - fragVertexPosition;\n    float dist = length(L);\n    L = normalize(L);\n    float atten = 1.0 / (spotLightAttenuation[i].x + spotLightAttenuation[i].y * dist + spotLightAttenuation[i].z * dist * dist);\n    vec3 Idiff = spotLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    vec4 lDirection = viewMatrix * vec4(-spotLightDirection[i], 0.0);\n    vec3 D = normalize(lDirection.xyz);\n    float angle = dot(L, D);\n    if(angle > spotLightCosFalloffAngle[i]) {\n       float softness = 1.0;\n       if (angle < spotLightCosSoftFalloffAngle[i])\n           softness = (angle - spotLightCosFalloffAngle[i]) /  (spotLightCosSoftFalloffAngle[i] -  spotLightCosFalloffAngle[i]);\n       color += atten * softness * Idiff;\n    }\n  }\n#endif\n  gl_FragColor = vec4(color, alpha);\n}",
addDirectives:function(c,b,a){var f=b.directional?b.directional.length:0,d=b.spot?b.spot.length:0;c.push("MAX_POINTLIGHTS "+(b.point?b.point.length:0));c.push("MAX_DIRECTIONALLIGHTS "+f);c.push("MAX_SPOTLIGHTS "+d);c.push("HAS_DIFFUSETEXTURE "+("diffuseTexture"in a?"1":"0"));c.push("HAS_EMISSIVETEXTURE "+("emissiveTexture"in a?"1":"0"))},hasTransparency:function(c){return c.transparency&&0.001<c.transparency.getValue()[0]},uniforms:{diffuseColor:[1,1,1],emissiveColor:[0,0,0],transparency:0,ambientIntensity:0,
useVertexColor:!1},samplers:{diffuseTexture:null,emissiveTexture:null},attributes:{normal:{required:!0},texcoord:null,color:null}});
XML3D.shaders.register("phong",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nattribute vec2 texcoord;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragNormal = normalize(normalMatrix * norm);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = texcoord;\n    fragVertexColor = color;\n}",fragment:"uniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nuniform mat4 viewMatrix;\nuniform bool useVertexColor;\n#if HAS_EMISSIVETEXTURE\nuniform sampler2D emissiveTexture;\n#endif\n#if HAS_DIFFUSETEXTURE\nuniform sampler2D diffuseTexture;\n#endif\n#if HAS_SPECULARTEXTURE\nuniform sampler2D specularTexture;\n#endif\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\n#if MAX_POINTLIGHTS > 0\nuniform vec3 pointLightAttenuation[MAX_POINTLIGHTS];\nuniform vec3 pointLightPosition[MAX_POINTLIGHTS];\nuniform vec3 pointLightIntensity[MAX_POINTLIGHTS];\nuniform bool pointLightOn[MAX_POINTLIGHTS];\n#endif\n#if MAX_DIRECTIONALLIGHTS > 0\nuniform vec3 directionalLightDirection[MAX_DIRECTIONALLIGHTS];\nuniform vec3 directionalLightIntensity[MAX_DIRECTIONALLIGHTS];\nuniform bool directionalLightOn[MAX_DIRECTIONALLIGHTS];\n#endif\n#if MAX_SPOTLIGHTS > 0\nuniform vec3 spotLightAttenuation[MAX_SPOTLIGHTS];\nuniform vec3 spotLightPosition[MAX_SPOTLIGHTS];\nuniform vec3 spotLightIntensity[MAX_SPOTLIGHTS];\nuniform bool spotLightOn[MAX_SPOTLIGHTS];\nuniform vec3 spotLightDirection[MAX_SPOTLIGHTS];\nuniform float spotLightCosFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightCosSoftFalloffAngle[MAX_SPOTLIGHTS];\nuniform float spotLightSoftness[MAX_SPOTLIGHTS];\n#endif\nvoid main(void) {\n  float alpha =  max(0.0, 1.0 - transparency);\n  vec3 objDiffuse = diffuseColor;\n  if(useVertexColor)\n    objDiffuse *= fragVertexColor;\n  #if HAS_DIFFUSETEXTURE\n    vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n    alpha *= texDiffuse.a;\n    objDiffuse *= texDiffuse.rgb;\n  #endif\n  if (alpha < 0.05) discard;\n  #if HAS_EMISSIVETEXTURE\n    vec3 color = emissiveColor * texture2D(emissiveTexture, fragTexCoord).rgb + (ambientIntensity * objDiffuse);\n  #else\n    vec3 color = emissiveColor + (ambientIntensity * objDiffuse);\n  #endif\n  vec3 objSpecular = specularColor;\n  #if HAS_SPECULARTEXTURE\n    objSpecular = objSpecular * texture2D(specularTexture, fragTexCoord).rgb;\n  #endif\n#if MAX_POINTLIGHTS > 0\n  for (int i=0; i<MAX_POINTLIGHTS; i++) {\n    if(!pointLightOn[i])\n      continue;\n    vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\n    vec3 L = lPosition.xyz - fragVertexPosition;\n    float dist = length(L);\n    L = normalize(L);\n    vec3 R = normalize(reflect(L,fragNormal));\n    float atten = 1.0 / (pointLightAttenuation[i].x + pointLightAttenuation[i].y * dist + pointLightAttenuation[i].z * dist * dist);\n    vec3 Idiff = pointLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    vec3 Ispec = pointLightIntensity[i] * objSpecular * pow(max(dot(R,fragEyeVector),0.0), shininess*128.0);\n    color = color + (atten*(Idiff + Ispec));\n  }\n#endif\n#if MAX_DIRECTIONALLIGHTS > 0\n  for (int i=0; i<MAX_DIRECTIONALLIGHTS; i++) {\n    if(!directionalLightOn[i])\n      continue;\n    vec4 lDirection = viewMatrix * vec4(directionalLightDirection[i], 0.0);\n    vec3 L =  normalize(-lDirection.xyz);\n    vec3 R = normalize(reflect(L,fragNormal));\n    vec3 Idiff = directionalLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    vec3 Ispec = directionalLightIntensity[i] * objSpecular * pow(max(dot(R,fragEyeVector),0.0), shininess*128.0);\n    color = color + ((Idiff + Ispec));\n  }\n#endif\n#if MAX_SPOTLIGHTS > 0\n  for (int i=0; i<MAX_SPOTLIGHTS; i++) {\n    if(!spotLightOn[i])\n      continue;\n    vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\n    vec3 L = lPosition.xyz - fragVertexPosition;\n    float dist = length(L);\n    L = normalize(L);\n    vec3 R = normalize(reflect(L,fragNormal));\n    float atten = 1.0 / (spotLightAttenuation[i].x + spotLightAttenuation[i].y * dist + spotLightAttenuation[i].z * dist * dist);\n    vec3 Idiff = spotLightIntensity[i] * objDiffuse * max(dot(fragNormal,L),0.0);\n    vec3 Ispec = spotLightIntensity[i] * objSpecular * pow(max(dot(R,fragEyeVector),0.0), shininess*128.0);\n    vec4 lDirection = viewMatrix * vec4(-spotLightDirection[i], 0.0);\n    vec3 D = normalize(lDirection.xyz);\n    float angle = dot(L, D);\n    if(angle > spotLightCosFalloffAngle[i]) {\n       float softness = 1.0;\n       if (angle < spotLightCosSoftFalloffAngle[i])\n           softness = (angle - spotLightCosFalloffAngle[i]) /  (spotLightCosSoftFalloffAngle[i] -  spotLightCosFalloffAngle[i]);\n       color += atten*softness*(Idiff + Ispec);\n    }\n  }\n#endif\n  gl_FragColor = vec4(color, alpha);\n}",
addDirectives:function(c,b,a){var f=b.directional?b.directional.length:0,d=b.spot?b.spot.length:0;c.push("MAX_POINTLIGHTS "+(b.point?b.point.length:0));c.push("MAX_DIRECTIONALLIGHTS "+f);c.push("MAX_SPOTLIGHTS "+d);c.push("HAS_DIFFUSETEXTURE "+("diffuseTexture"in a?"1":"0"));c.push("HAS_SPECULARTEXTURE "+("specularTexture"in a?"1":"0"));c.push("HAS_EMISSIVETEXTURE "+("emissiveTexture"in a?"1":"0"))},hasTransparency:function(c){return c.transparency&&0.001<c.transparency.getValue()[0]},uniforms:{diffuseColor:[1,
1,1],emissiveColor:[0,0,0],specularColor:[0,0,0],transparency:0,shininess:0.2,ambientIntensity:0,useVertexColor:!1},samplers:{diffuseTexture:null,emissiveTexture:null,specularTexture:null},attributes:{normal:{required:!0},texcoord:null,color:null}});
XML3D.shaders.register("point",{vertex:"attribute vec3 position;\nattribute vec3 color;\nattribute vec2 texcoord;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nuniform float screenWidth;\nuniform float pointSize;\nvoid main(void) {\n    vec3 pos = position;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n    fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n    fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = texcoord;\n    fragVertexColor = color;\n    vec4 pos2 = vec4(fragVertexPosition, 1.0); pos2.x += pointSize;\n    gl_PointSize = distance( gl_Position.xy, (projectionMatrix * pos2).xy ) * screenWidth / gl_Position.w;\n}",fragment:"uniform vec3 diffuseColor;\nuniform float transparency;\nuniform mat4 viewMatrix;\nuniform bool useVertexColor;\nuniform vec2 texCoordOffset;\nuniform vec2 texCoordSize;\n#if HAS_DIFFUSETEXTURE\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nvarying vec3 fragVertexColor;\nvoid main(void) {\n  float alpha =  max(0.0, 1.0 - transparency);\n  vec3 objDiffuse = diffuseColor;\n  if(useVertexColor)\n    objDiffuse *= fragVertexColor;\n  #if HAS_DIFFUSETEXTURE\n    vec2 texCoord = fragTexCoord + texCoordOffset + gl_PointCoord*texCoordSize;\n    texCoord.y = 1.0 - texCoord.y;\n    vec4 texDiffuse = texture2D(diffuseTexture, texCoord);\n    alpha *= texDiffuse.a;\n    objDiffuse *= texDiffuse.rgb;\n  #endif\n  if (alpha < 0.05) discard;\n  gl_FragColor = vec4(objDiffuse, alpha);\n}",
addDirectives:function(c,b,a){c.push("HAS_DIFFUSETEXTURE "+("diffuseTexture"in a?"1":"0"))},hasTransparency:function(c){return c.transparency&&0.001<c.transparency.getValue()[0]},uniforms:{diffuseColor:[1,1,1],texCoordOffset:[0,0],texCoordSize:[1,1],transparency:0,useVertexColor:!1,pointSize:1},samplers:{diffuseTexture:null},attributes:{texcoord:null,color:null}});
XML3D.shaders.register("pickobjectid",{vertex:"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"uniform vec3 id;\nvoid main(void) {\n    gl_FragColor = vec4(id, 0.0);\n}",uniforms:{}});
XML3D.shaders.register("pickedposition",{vertex:"attribute vec3 position;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 bbox[2];\nvarying vec3 worldCoord;\nvoid main(void) {\n    worldCoord = (modelMatrix * vec4(position, 1.0)).xyz;\n    vec3 diff = bbox[1] - bbox[0];\n    worldCoord = worldCoord - bbox[0];\n    worldCoord = worldCoord / diff;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"varying vec3 worldCoord;\nvoid main(void) {\n    gl_FragColor = vec4(worldCoord, 1.0);\n}",
uniforms:{}});XML3D.shaders.register("pickedNormals",{vertex:"attribute vec3 position;\nattribute vec3 normal;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat3 normalMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    fragNormal = normalize(normalMatrix * normal);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"varying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4((fragNormal+1.0)/2.0 * (254.0 / 255.0), 1.0);\n}",uniforms:{}});